<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="如题。"><link rel="canonical" href="https://blog.catcat.work/article/%E5%86%99%E4%B8%80%E4%B8%AA%E5%85%A8%E7%BD%91%E6%9C%80%E5%85%A8%E7%9A%84%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8"><meta property="og:site_name" content="猫头猫的博客"><meta property="og:title" content="写一个全网最全的音乐播放器 · 猫头猫的博客"><meta property="og:description" content="如题。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.catcat.work/article/%E5%86%99%E4%B8%80%E4%B8%AA%E5%85%A8%E7%BD%91%E6%9C%80%E5%85%A8%E7%9A%84%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8"><meta property="og:image" content="https://blog.catcat.work/images/avatar.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="写一个全网最全的音乐播放器 · 猫头猫的博客"><meta name="twitter:description" content="如题。"><meta name="twitter:image" content="https://blog.catcat.work/images/avatar.jpg"><link rel="alternate" type="application/rss+xml" title="猫头猫的博客 RSS" href="/rss.xml"><link rel="icon" href="/images/avatar.jpg"><link rel="preconnect" href="https://chinese-fonts-cdn.deno.dev" crossorigin><link rel="stylesheet" href="https://chinese-fonts-cdn.deno.dev/packages/sypxzs/dist/%E6%80%9D%E6%BA%90%E5%B1%8F%E6%98%BE%E8%87%BB%E5%AE%8B/result.css"><title>写一个全网最全的音乐播放器 · 猫头猫的博客</title> <meta property="article:author" content="猫头猫"> <meta property="article:published_time" content="2022-10-04T12:42:01.000Z"><script type="application/ld+json">
      {JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'BlogPosting',
        headline: post.data.title,
        description,
        datePublished: publishedTime,
        author: {
          '@type': 'Person',
          name: SITE_AUTHOR,
        },
        mainEntityOfPage: {
          '@type': 'WebPage',
          '@id': new URL(`/article/${post.id}`, SITE_URL).toString(),
        },
        image: new URL(SITE_IMAGE, SITE_URL).toString(),
      })}
    </script> <link rel="stylesheet" href="/assets/about.O-mVYgHJ.css">
<link rel="stylesheet" href="/assets/_id_.BjwhDr6Z.css"></head> <body class="min-h-screen flex flex-col"> <div class="noise-overlay"></div> <nav class="fixed top-0 left-0 w-full z-40 bg-warm-bg/80 dark:bg-night-bg/80 backdrop-blur-md transition-colors duration-500 border-b border-warm-text/5 dark:border-night-text/5"> <div class="max-w-4xl mx-auto px-6 h-20 flex items-center justify-between"> <a href="/" class="font-serif text-2xl tracking-wide text-warm-text dark:text-night-text hover:text-warm-accent dark:hover:text-warm-accent transition-colors">
猫头猫的博客
</a> <div class="hidden md:flex items-center space-x-8"> <a href="/" class="text-sm tracking-widest uppercase hover:text-warm-sage transition-colors text-warm-text dark:text-night-text"> 首页 </a><a href="/article" class="text-sm tracking-widest uppercase hover:text-warm-sage transition-colors text-warm-accent underline underline-offset-4"> 文章 </a><a href="/works" class="text-sm tracking-widest uppercase hover:text-warm-sage transition-colors text-warm-text dark:text-night-text"> 作品 </a><a href="/about" class="text-sm tracking-widest uppercase hover:text-warm-sage transition-colors text-warm-text dark:text-night-text"> 关于我 </a> <button type="button" data-theme-toggle class="ml-4 p-2 rounded-full hover:bg-warm-text/5 dark:hover:bg-night-text/10 transition-colors" aria-label="Toggle Dark Mode"> <span data-theme-icon="sun" class="inline-flex"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="20" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" class="lucide lucide-sun text-warm-text">  <circle cx="12" cy="12" r="4"></circle> <path d="M12 2v2"></path> <path d="M12 20v2"></path> <path d="m4.93 4.93 1.41 1.41"></path> <path d="m17.66 17.66 1.41 1.41"></path> <path d="M2 12h2"></path> <path d="M20 12h2"></path> <path d="m6.34 17.66-1.41 1.41"></path> <path d="m19.07 4.93-1.41 1.41"></path>  </svg> </span> <span data-theme-icon="moon" class="inline-flex hidden"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="20" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" class="lucide lucide-moon text-warm-text dark:text-night-text">  <path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"></path>  </svg> </span> </button> </div> <div class="md:hidden flex items-center gap-4"> <button type="button" data-theme-toggle class="p-2" aria-label="Toggle Dark Mode"> <span data-theme-icon="sun" class="inline-flex"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="20" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" class="lucide lucide-sun text-warm-text">  <circle cx="12" cy="12" r="4"></circle> <path d="M12 2v2"></path> <path d="M12 20v2"></path> <path d="m4.93 4.93 1.41 1.41"></path> <path d="m17.66 17.66 1.41 1.41"></path> <path d="M2 12h2"></path> <path d="M20 12h2"></path> <path d="m6.34 17.66-1.41 1.41"></path> <path d="m19.07 4.93-1.41 1.41"></path>  </svg> </span> <span data-theme-icon="moon" class="inline-flex hidden"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="20" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" class="lucide lucide-moon text-night-text">  <path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"></path>  </svg> </span> </button> <button type="button" data-menu-toggle data-menu-target="mobile-menu" aria-label="Menu"> <span data-menu-icon="open" class="inline-flex"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="24" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.6" class="lucide lucide-menu text-warm-text dark:text-night-text">  <path d="M4 5h16"></path> <path d="M4 12h16"></path> <path d="M4 19h16"></path>  </svg> </span> <span data-menu-icon="close" class="inline-flex hidden"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="24" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.6" class="lucide lucide-x text-warm-text dark:text-night-text">  <path d="M18 6 6 18"></path> <path d="m6 6 12 12"></path>  </svg> </span> </button> </div> </div> <div id="mobile-menu" data-open="false" class="md:hidden bg-warm-bg dark:bg-night-bg overflow-hidden border-b border-warm-text/5 max-h-0 opacity-0 transition-all duration-500"> <div class="flex flex-col items-center py-6 space-y-4"> <a href="/" class="text-lg font-serif text-warm-text dark:text-night-text"> 首页 </a><a href="/article" class="text-lg font-serif text-warm-accent"> 文章 </a><a href="/works" class="text-lg font-serif text-warm-text dark:text-night-text"> 作品 </a><a href="/about" class="text-lg font-serif text-warm-text dark:text-night-text"> 关于我 </a> </div> </div> </nav> <main class="flex-grow pt-28 px-6 w-full max-w-4xl mx-auto">   <article id="article-top" class="py-12 md:py-20 max-w-5xl mx-auto"> <aside class="article-toc" aria-label="文章导航"><div class="article-toc-card"><div class="article-toc-title">目录</div><nav><ol class="article-toc-list"><li><a href="#前言"><span class="article-toc-index">01</span><span class="article-toc-text">前言</span></a></li><li><a href="#技术选型react-native-flutter"><span class="article-toc-index">02</span><span class="article-toc-text">技术选型：React Native? Flutter?</span></a></li><li><a href="#框架聚合解耦"><span class="article-toc-index">03</span><span class="article-toc-text">框架：聚合？解耦?</span></a></li><li><a href="#插件怎么实现"><span class="article-toc-index">04</span><span class="article-toc-text">插件：怎么实现？</span></a></li><li><a href="#播放队列"><span class="article-toc-index">05</span><span class="article-toc-text">播放队列</span></a></li><li><a href="#歌词关联"><span class="article-toc-index">06</span><span class="article-toc-text">歌词关联</span></a></li><li><a href="#其他细节"><span class="article-toc-index">07</span><span class="article-toc-text">其他细节</span></a></li><li><a href="#结语"><span class="article-toc-index">08</span><span class="article-toc-text">结语</span></a></li></ol></nav><a class="article-toc-back" href="#article-top">返回顶部</a></div></aside> <div class="animate-slide-up"> <a href="/" class="inline-flex items-center text-warm-text/50 hover:text-warm-text transition-colors mb-8 text-sm uppercase tracking-widest font-sans group"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="16" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.6" class="lucide lucide-arrow-left mr-2 transform group-hover:-translate-x-1 transition-transform">  <path d="m12 19-7-7 7-7"></path> <path d="M19 12H5"></path>  </svg>
Back to Home
</a> <header class="mb-12 text-center"> <div class="flex items-center justify-center gap-4 text-xs text-warm-text/50 dark:text-night-text/50 uppercase tracking-widest mb-6 font-sans"> <span class="flex items-center gap-1"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="12" height="12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.6" class="lucide lucide-calendar">  <path d="M8 2v4"></path> <path d="M16 2v4"></path> <rect width="18" height="18" x="3" y="4" rx="2"></rect> <path d="M3 10h18"></path>  </svg> 2022/10/04 </span> <span>•</span> <span class="flex items-center gap-1 text-warm-accent"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="12" height="12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.6" class="lucide lucide-tag">  <path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"></path> <circle cx="7.5" cy="7.5" r=".5" fill="currentColor"></circle>  </svg> 前端 </span> </div> <h1 class="text-4xl md:text-5xl font-serif text-warm-text dark:text-night-text leading-tight mb-6"> 写一个全网最全的音乐播放器 </h1> <div class="flex items-center justify-center gap-2 text-warm-text/40 text-sm font-sans italic"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="14" height="14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.6" class="lucide lucide-clock">  <path d="M12 6v6l4 2"></path> <circle cx="12" cy="12" r="10"></circle>  </svg> 14 分钟 </div> </header> <div class="article-layout"> <div class="article-content prose prose-lg md:prose-xl prose-stone dark:prose-invert font-serif prose-headings:font-serif"> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/112345c7ffef475685fffd086a2193d2~tplv-k3u1fbpfcp-watermark.image?" alt="web 1920.png"></p>
<h2 id="前言">前言</h2>
<p>说起音乐播放器，其实目前已经有很多相关的轮子了。之前也看到了很多，无论是多源合一的<em>聚合类型播放器</em>，还是精美的<em>模仿播放器</em>，或多或少都有些小问题（众口难调嘛 也不奇怪）：</p>
<ul>
<li><strong>源不全</strong>：音源可能不稳定，修改或新增源需要开发者修改代码（说不定还有律师函警告）</li>
<li><strong>功能不全</strong>：其实多源聚合的播放器还有蛮多优化空间的，比如怎么解决某些源没有歌词的问题等等</li>
<li><strong>样式有点呆</strong>：这个就……不多说了，虽然我写的也好看不到哪里去。。。</li>
</ul>
<p>所以…如标题，不如写一个<strong>全网最全的，专注功能的，不太丑</strong>的音乐播放器。写个播放器既可以巩固学过的知识，多多思考，又能解决的自己问题，还能打发时间，何乐而不为呢，当然，为了解决上述问题，架构还是要好好设计一下的。</p>
<h2 id="技术选型react-native-flutter">技术选型：React Native? Flutter?</h2>
<p>其实我21年就曾经用<a href="https://github.com/maotoumao/mixin_music">flutter写过一个音乐播放器</a>。当时是想要一个功能简单，能满足日常需求（不用来回切app）的播放器，恰好那会快毕业闲着没事干，就花了几天学了下flutter现学现卖写了一个集成了B站、咪咕和网易云的播放器。App还是很流畅的，但是弊端也很明显：过了几个月当我想再捡起来继续维护的时候，我发现已经看不懂了。在此向这位同学说声抱歉，我真不是故意鸽的，因为我真tm忘了该怎么写了…： <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e73e6b87f82469ab75a155e89197727~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<p>所以这次我选择了RN。至少在熟悉的技术栈里，我可以更容易地专注于功能和性能。恰好这次想法冒出来的时候RN发布了0.69版本（好像是，懒得看了）；距离我上次使用RN也有了不少啸改动，不妨再试它一次。对于个人开发者来说，似乎也没必要讲究太多，能解决问题的就是好东西。</p>
<h2 id="框架聚合解耦">框架：聚合？解耦?</h2>
<p>首先我们先回到需求，对我个人来说，我的核心诉求也很简单：</p>
<ul>
<li><strong>多源聚合</strong>：不想来回切app听歌</li>
<li><strong>扩展性、稳定性</strong>：希望app的音源是可以低成本扩展的，甚至网络上只要可以搜得到的资源都可以播放</li>
<li><strong>尽可能完备</strong>：希望播放器可以对所有音源提供尽可能完整的，且相似的功能（否则扩展性似乎也就不存在了）</li>
</ul>
<p>听起来似乎很矛盾：又要尽可能多的源，又要可扩展，还不想写代码，净想好事了。事实上，破局的方法很简单：如果能把音乐相关的操作抽象出来，和app本身的功能解耦开，问题就迎刃而解了。说得再明白一点：对于一个音乐播放器来说，它所需要的核心功能：搜索（音乐、专辑、歌手）、播放、下载、歌词、导入、查看专辑歌手信息等等，这些功能对于不同的音源来说，输入和输出的<strong>结构</strong>是可以<strong>完全一致</strong>的。</p>
<p>考虑到可扩展性，自然而然就想到把这些核心功能按照特定的协议以插件的形式外置，这样一来，音乐播放器只需要考虑到如何管理音乐媒体，某些时机触发某些核心行为得到固定格式的输出，而所有的核心行为都由插件去实现；如果需要扩展音源或者遇到音源不稳定的情况，也只需要修改插件就好了。换句话说：<strong>只需要通过安装不同的插件就可以播放你能搜到的任何音源</strong>。</p>
<p>举个例子：当用户搜索“作者 猫头猫”的时候，对于播放器来说，它只需要知道要去调用这样一个函数:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> serach</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">query</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">type</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">page</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Artist</span><span style="color:#E1E4E8">[]></span></span></code></pre>
<p>并把得到的结果渲染到屏幕上；至于这个东西是什么，那就交给插件吧。</p>
<p>综上所述，我们得到了大概的核心框架图： <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/274ad02f59b548c8ade875db4128d038~tplv-k3u1fbpfcp-zoom-1.image" alt="1.drawio.png"></p>
<h2 id="插件怎么实现">插件：怎么实现？</h2>
<p>在上一节中提到了，插件是实现某些特定功能的一个函数。那么接下来又是一个难题：怎么把插件钩入到app中去？回顾下技术选型，这次选择的是RN，那么这个问题其实很容易解决：反正运行时自带一个js引擎，那就直接读取外部文件，然后直接整个Function呗。试了一下，发现方案可行。具体来说，是这样一个<a href="https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L63">自执行函数</a>：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>const plugin = Function(`</span></span>
<span class="line"><span>                'use strict';</span></span>
<span class="line"><span>                try {</span></span>
<span class="line"><span>                  return ${funcCode};</span></span>
<span class="line"><span>                } catch(e) {</span></span>
<span class="line"><span>                  return null;</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>    `)()()</span></span></code></pre>
<p>其中，funcCode就是从外部读入的插件。方便起见，可以把一些常用的包（网络请求、加密解密、日期转化、html解析等等）通过参数传递给插件，从而减轻插件开发的工作量：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>const plugin = Function(`</span></span>
<span class="line"><span>                'use strict';</span></span>
<span class="line"><span>                try {</span></span>
<span class="line"><span>                  return ${funcCode};</span></span>
<span class="line"><span>                } catch(e) {</span></span>
<span class="line"><span>                  return null;</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>    `)()({CryptoJs, axios, dayjs, cheerio, bigInt, qs})</span></span></code></pre>
<p>到这里，从app侧解析插件的工作就做完了。接下来的问题是：插件内部（也就是上边的funcCode）应该长什么样子。所以接下来我们就需要制定具体的<strong>插件协议</strong>了。根据上边的解析方式，插件的基本结构如下：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>function pluginName(packages){</span></span>
<span class="line"><span>    // 一些辅助函数或者全局变量</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return {</span></span>
<span class="line"><span>      // ... 插件要实现的核心功能</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre>
<p>插件函数的返回值，也就是我们可以具体在app中获取到的插件信息，可以在这一部分定义一层统一的<strong>插件协议</strong>，以定义某些核心操作所触发的行为。至于什么时候调用交给app统一控制。这里就不赘述协议定义的细节了，大概贴一下demo估计就够了，具体的插件可以参考<a href="https://github.com/maotoumao/MusicFreePlugins">这个仓库</a>：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>// packages里面预置了一些常用的包，包括axios，dayjs，cryptojs和cheerio，应该够用了</span></span>
<span class="line"><span>function pluginName(packages){</span></span>
<span class="line"><span>    // 在这里可以编写一些逻辑，存储全局变量之类的;</span></span>
<span class="line"><span>    return {</span></span>
<span class="line"><span>        platform: '插件名称', // [必选] 插件名，这个名字没取好，于是将错就错了</span></span>
<span class="line"><span>        cacheControl: 'no-cache', // [可选] 插件的缓存控制方案，用来缓存插件信息</span></span>
<span class="line"><span>        version: '0.0.0', // [可选] 插件版本号</span></span>
<span class="line"><span>        primaryKey: ['id'], // [可选] 主键名，可在此字段中填写插件函数入参中必备的字段</span></span>
<span class="line"><span>        appVersion: '>0.0', // [可选] 兼容此插件的app版本号，预防后续协议更新出现不兼容格式时报错的情况。</span></span>
<span class="line"><span>        defaultSearchType: 'music', // [可选] 插件在搜索时，首屏默认请求的搜索类型。</span></span>
<span class="line"><span>        /** 搜索 */</span></span>
<span class="line"><span>        search: function(query, page, type) { // 三个参数分别为: 查询的keyword，当前页码，搜索类型</span></span>
<span class="line"><span>            if(type === 'music') {</span></span>
<span class="line"><span>                // 网络请求</span></span>
<span class="line"><span>                return {</span></span>
<span class="line"><span>                    isEnd: true, // 分页请求是否结束</span></span>
<span class="line"><span>                    data: [], // MusicItem类型的列表</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            if(type === 'album') {</span></span>
<span class="line"><span>                // 网络请求</span></span>
<span class="line"><span>                return {</span></span>
<span class="line"><span>                    isEnd: true, // 分页请求是否结束</span></span>
<span class="line"><span>                    data: [], // AlbumItem类型的列表</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            if(type === 'artist') {</span></span>
<span class="line"><span>                // 网络请求</span></span>
<span class="line"><span>                return {</span></span>
<span class="line"><span>                    isEnd: true, // 分页请求是否结束</span></span>
<span class="line"><span>                    data: [], // ArtistItem类型的列表</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        /** 获取真实的播放源 */</span></span>
<span class="line"><span>        getMediaSource: function (musicItem) { // 入参：搜索结果中MusicItem类型的音乐</span></span>
<span class="line"><span>            return {</span></span>
<span class="line"><span>                headers: undefined, // [可选] headers</span></span>
<span class="line"><span>                url: 'https://', // 真实url,</span></span>
<span class="line"><span>                userAgent: undefined, // [可选] 如果不填，会取headers的user-agent字段</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        /** 根据mediaBase信息（包括primaryKey） 获取歌曲的详细信息 [!!此函数暂时用不到 ] */</span></span>
<span class="line"><span>        getMusicInfo: function (mediaBase) {</span></span>
<span class="line"><span>            return musicItem;</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        /** 获取歌词 */</span></span>
<span class="line"><span>        getLyric: function (musicItem){</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            return {</span></span>
<span class="line"><span>                lrc: 'http:///', //歌词源,</span></span>
<span class="line"><span>                rawLrc: '[00:00.000]这是一句歌词', //纯文本的歌词</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        /** 获取专辑详细信息 */</span></span>
<span class="line"><span>        getAlbumInfo: function (albumItem) {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            return {</span></span>
<span class="line"><span>                ...albumItem,</span></span>
<span class="line"><span>                musicList: []</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        /** 查询作者的详细信息 */</span></span>
<span class="line"><span>        getArtistWorks: function (artistItem, page, type) {</span></span>
<span class="line"><span>            if(type === 'music') {</span></span>
<span class="line"><span>                // 网络请求</span></span>
<span class="line"><span>                return {</span></span>
<span class="line"><span>                    isEnd: false,</span></span>
<span class="line"><span>                    data: [], // MusicItem类型音乐列表</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>            } </span></span>
<span class="line"><span>            if(type === 'album') {</span></span>
<span class="line"><span>                // 网络请求</span></span>
<span class="line"><span>                return {</span></span>
<span class="line"><span>                    isEnd: false,</span></span>
<span class="line"><span>                    data: [], // AlbumItem类型音乐列表</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        /** 导入单曲 */</span></span>
<span class="line"><span>        importMusicItem: function (urlLike) {</span></span>
<span class="line"><span>            return musicItem;</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        /** 导入歌单 */</span></span>
<span class="line"><span>        importMusicSheet: function (urlLike) {</span></span>
<span class="line"><span>            const musicItems = [];</span></span>
<span class="line"><span>            return musicItems;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>       /** more */</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre>
<p>由于涉及到缓存，并且其实我们并没有办法完全信任第三方插件的返回结果，因此在app中基于插件又封装了一层<a href="https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L132">PluginMethods</a>，实际使用的时候调用的是这些方法。当需要开发新的功能（比如获取热门歌单…时），也只需要补充一下插件协议，然后开发对应的页面即可。插件机制在app中的完整实现可以参考<a href="https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L132">这里</a>。</p>
<p>最终的效果也确实符合预期（能搜到的都能播），甚至可以播放某K歌的音乐： <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f462be5be74a4f8abff34f047325c48a~tplv-k3u1fbpfcp-zoom-1.image" alt="IW58ZJ$40F&#x60;32SN7)G43T.png"></p>
<h2 id="播放队列">播放队列</h2>
<p>音乐的播放使用了<a href="https://github.com/doublesymmetry/react-native-track-player">react-native-track-player</a>(以下简称rntp)。这是一个功能比较完善的播放器，提供了播放音乐、播放队列管理等功能。首先来看下它的<a href="https://react-native-track-player.js.org/docs/basics/getting-started/#adding-tracks-to-the-playback-queue">使用方式</a>：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>var track1 = {</span></span>
<span class="line"><span>    url: 'http://example.com/avaritia.mp3', // Load media from the network</span></span>
<span class="line"><span>    title: 'Avaritia',</span></span>
<span class="line"><span>    artist: 'deadmau5',</span></span>
<span class="line"><span>    album: 'while(1&#x3C;2)',</span></span>
<span class="line"><span>    genre: 'Progressive House, Electro House',</span></span>
<span class="line"><span>    date: '2014-05-20T07:00:00+00:00', // RFC 3339</span></span>
<span class="line"><span>    artwork: 'http://example.com/cover.png', // Load artwork from the network</span></span>
<span class="line"><span>    duration: 402 // Duration in seconds</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span>await TrackPlayer.add([track1]);</span></span></code></pre>
<p>其中url字段标记着媒体文件的播放源。这里就有了一个隐藏的问题：假如我们需要搜索某首歌（这里搜索一定是通过插件实现的）并点击播放；搜索结果中可能每一首音乐并不包含音频源的url，需要发起额外的网络请求，而这个时候如果我们为搜索结果的每一首歌都发起这样的请求，显然有些过分了。因此，获取某个音频的真实播放源的操作需要放在插件中，并且在播放前（点击播放、继续播放、播放结束切换到下一首）时执行。</p>
<p>rntp内置的播放队列并不支持在播放前执行一个hook，同时按照文档中的描述，它也不支持在播放时替换正在播放的音频的url。因此在这里，我们需要用一点小小的黑魔法来解决问题——舍弃rntp内置的播放队列，基于它封装一个<a href="https://github.com/maotoumao/MusicFree/blob/master/src/core/musicQueue.ts">符合我们需求的播放队列</a>。</p>
<p>新的播放队列中维护着当前正在播放的音乐列表。每当播放某个音乐(musicItem)的时候，我们都需要首先根据musicItem获取真实的源(调用对应插件的getMediaSource方法)，然后再把音乐信息和源信息一起送给rntp的队列中播放，至此，点击播放的问题就解决了。</p>
<p>然而除了点击播放之外，顺序播放依然存在问题：如果正常一首歌曲播放完成，rntp会自动播放其内部队列中的下一首歌，而不会走到封装的播放逻辑。rntp提供了一些事件，比如当歌曲切换时会触发PlaybackTrackChanged事件，播放队列结束时会触发PlaybackQueueEnded事件等等。我们可以让rntp中只存在一首歌，每当触发PlaybackQueueEnded事件时，我们就知道这首歌播放结束了，这个时候就需要自动的执行下一首歌的逻辑了。</p>
<p>事实上，在具体代码实现中，是使用了<a href="https://github.com/maotoumao/MusicFree/blob/master/src/service/index.ts#L39">PlaybackTrackChanged事件</a>来监听播放结束的。这是因为rntp的安卓部分内部使用了exo player，在它的设计中，如果当前播放队列仅仅有一首歌，并且播放模式是顺序播放的话，那么在通知栏里面不会出现切换下一首歌的图标（向右的小箭头）。为此，具体实现中rntp的内部队列始终维护两首歌（当前正在播放，当前的下一首），track变化时便是播放结束的时机，此时执行我们封装好的skipNext函数即可：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span> TrackPlayer.addEventListener(Event.PlaybackTrackChanged, async evt => {</span></span>
<span class="line"><span>        if (</span></span>
<span class="line"><span>            evt.nextTrack === 1 &#x26;&#x26;</span></span>
<span class="line"><span>            !(await TrackPlayer.getTrack(evt.nextTrack))?.url</span></span>
<span class="line"><span>        ) {</span></span>
<span class="line"><span>            if (MusicQueue.getRepeatMode() === 'SINGLE') {</span></span>
<span class="line"><span>                await MusicQueue.play(undefined, true);</span></span>
<span class="line"><span>            } else {</span></span>
<span class="line"><span>                const queue = await TrackPlayer.getQueue();</span></span>
<span class="line"><span>                // 要跳到的下一个就是当前的，并且队列里面有多首歌</span></span>
<span class="line"><span>                if (</span></span>
<span class="line"><span>                    isSameMediaItem(</span></span>
<span class="line"><span>                        queue[1] as unknown as ICommon.IMediaBase,</span></span>
<span class="line"><span>                        MusicQueue.getCurrentMusicItem(),</span></span>
<span class="line"><span>                    ) &#x26;&#x26;</span></span>
<span class="line"><span>                    MusicQueue.getMusicQueue().length > 1</span></span>
<span class="line"><span>                ) {</span></span>
<span class="line"><span>                    return;</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                await MusicQueue.skipToNext();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    });</span></span></code></pre>
<h2 id="歌词关联">歌词关联</h2>
<p>上文中还提到，某些平台并不提供歌词（比如某些视频源）。对于这种情况，其实可以把不同源的歌词关联到一起。举个例子：我要播放B站源的歌曲，但是没有歌词。这个时候，我可以将其他源的歌词（尽管其他源可能没有版权，但是很多翻唱还是有歌词的）关联到这首歌：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fd52606524ce48c49c299e2241b20e6c~tplv-k3u1fbpfcp-watermark.image?" alt="Screenshot_20221004_173946_fun.upup.musicfree.jpg"></p>
<p>这一部分的逻辑也是封装在<a href="https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L248">插件方法</a>里的，简单来讲，这些关联的歌词形成了一个链表，关联歌词本质上就是一个链表的递归： <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa291994f5e44f36bd14900ac3bfdc4a~tplv-k3u1fbpfcp-zoom-1.image" alt="2.drawio.png"> 每次都从链表末尾调用获取歌词的方法即可。需要注意的是，歌词关联可能会形成环路，当递归遇到环路时，需要识别并自动断开环。</p>
<h2 id="其他细节">其他细节</h2>
<p>不得不说，要做一个完备的播放器要考虑到的东西还是挺多的，包括<a href="https://github.com/maotoumao/MusicFree/blob/master/src/core/lrcParser.ts">歌词解析</a>、<a href="https://github.com/maotoumao/MusicFree/blob/master/src/core/config.ts">状态持久化</a>、<a href="https://github.com/maotoumao/MusicFree/blob/master/src/core/download.ts">下载队列</a>、<a href="https://github.com/maotoumao/MusicFree/blob/master/src/core/cache.ts">缓存</a>等等，牵扯到不少的知识点（比如递归、LRU、react、native相关甚至js引擎层的知识等等），也踩了不少坑。如果有人想知道的话再写吧，这里就不赘述了（写累了不想写了…）。</p>
<h2 id="结语">结语</h2>
<p>目前这个播放器还是测试版本（但是基本功能已经差不多，日常使用没问题了），插件协议可能还会有变动。代码基于GPL协议开源：<a href="https://github.com/maotoumao/MusicFree/">https://github.com/maotoumao/MusicFree/</a> （打不开就github换gitee），下载地址在<a href="https://github.com/maotoumao/MusicFree/releases">github发布页</a>，使用方式在readme（实在不知道咋用的话直接问我吧…）。之后打算好好维护，能解决自己和身边朋友的问题就已经达到最初的预期了。</p>
<p>如果你觉得这个项目还不错，欢迎给个star~ 点个关注鼓励一下也行。也可以关注b站：<a href="https://space.bilibili.com/12866223">不想睡觉猫头猫</a>或者公众号↓（刚整了个还没怎么发东西）；不发水文，平时会更多分享一些自己做的好玩的小东西，学以致用才更有动力。谢谢你看到这里，下次想起来更新的时候再见~</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62999875eeca415c9428adb6a678ad7a~tplv-k3u1fbpfcp-zoom-1.image" alt="httpweixin.q.png"></p> </div> </div> <div class="mt-20 pt-12 border-t border-warm-text/10 flex justify-between items-center"> <div class="text-warm-text/50 text-sm italic font-serif">
Thanks for reading.
</div> <div class="flex gap-4"> <button class="text-warm-text/50 hover:text-warm-accent text-sm uppercase tracking-widest">Share</button> </div> </div> </div> <a class="article-backtop" href="#article-top" aria-label="返回顶部"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="16" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.6" class="lucide lucide-arrow-up">  <path d="m5 12 7-7 7 7"></path> <path d="M12 19V5"></path>  </svg> </a> </article>  </main> <footer class="w-full py-12 mt-20 border-t border-warm-text/5 dark:border-night-text/5"> <div class="max-w-4xl mx-auto px-6 flex flex-col items-center"> <div class="flex space-x-6 mb-6"> <div class="relative group"> <button type="button" class="text-warm-text/60 dark:text-night-text/60 hover:text-warm-sage transition-colors" aria-label="微信公众号"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" class="h-5 w-5 fill-current" aria-hidden="true" focusable="false"> <path d="M11.176 14.429c-2.665 0-4.826-1.8-4.826-4.018 0-2.22 2.159-4.02 4.824-4.02S16 8.191 16 10.411c0 1.21-.65 2.301-1.666 3.036a.32.32 0 0 0-.12.366l.218.81a.6.6 0 0 1 .029.117.166.166 0 0 1-.162.162.2.2 0 0 1-.092-.03l-1.057-.61a.5.5 0 0 0-.256-.074.5.5 0 0 0-.142.021 5.7 5.7 0 0 1-1.576.22M9.064 9.542a.647.647 0 1 0 .557-1 .645.645 0 0 0-.646.647.6.6 0 0 0 .09.353Zm3.232.001a.646.646 0 1 0 .546-1 .645.645 0 0 0-.644.644.63.63 0 0 0 .098.356"></path> <path d="M0 6.826c0 1.455.781 2.765 2.001 3.656a.385.385 0 0 1 .143.439l-.161.6-.1.373a.5.5 0 0 0-.032.14.19.19 0 0 0 .193.193q.06 0 .111-.029l1.268-.733a.6.6 0 0 1 .308-.088q.088 0 .171.025a6.8 6.8 0 0 0 1.625.26 4.5 4.5 0 0 1-.177-1.251c0-2.936 2.785-5.02 5.824-5.02l.15.002C10.587 3.429 8.392 2 5.796 2 2.596 2 0 4.16 0 6.826m4.632-1.555a.77.77 0 1 1-1.54 0 .77.77 0 0 1 1.54 0m3.875 0a.77.77 0 1 1-1.54 0 .77.77 0 0 1 1.54 0"></path> </svg> </button> <div class="pointer-events-none absolute left-1/2 bottom-10 z-10 w-40 -translate-x-1/2 opacity-0 scale-95 transition-all duration-200 group-hover:opacity-100 group-hover:scale-100 group-focus-within:opacity-100 group-focus-within:scale-100"> <div class="rounded-xl border border-warm-text/10 dark:border-night-text/10 bg-white/95 dark:bg-night-surface/95 p-2 shadow-lg"> <img src="/images/wechat_channel.jpg" alt="微信公众号二维码" class="h-36 w-36 rounded-lg object-cover"> </div> </div> </div> <a href="https://space.bilibili.com/12866223" class="text-warm-text/60 dark:text-night-text/60 hover:text-warm-sage transition-colors" aria-label="B站" title="B站" target="_blank" rel="noreferrer"> <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 fill-current" aria-hidden="true" focusable="false"> <title>Bilibili</title> <path d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .355-.124.657-.373.906zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373Z"></path> </svg> </a> <a href="https://www.xiaohongshu.com/user/profile/5ce6085200000000050213a6?xhsshare=CopyLink&appuid=5ce6085200000000050213a6&apptime=1714394544" class="text-warm-text/60 dark:text-night-text/60 hover:text-warm-sage transition-colors" aria-label="小红书" title="小红书" target="_blank" rel="noreferrer"> <svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" class="h-5 w-5" aria-hidden="true" focusable="false"> <title>小红书</title> <path d="M289.44,256H477.67c17.93,0,33.86,15.57,34.33,33.48V477.72A35.09,35.09,0,0,1,477.66,512H289.5A35.14,35.14,0,0,1,256,477.64V289.56C256.43,271.93,271.81,256.5,289.44,256Zm16.73,91.44c-.13,19.87-.06,39.75-.16,59.63a2.1,2.1,0,0,1-2.13,2.6c-2.39.14-4.79.06-7.19.08,1.61,4,3.35,7.86,5.15,11.73,4.52-.15,9.68.79,13.54-2.17,3.47-2.58,4.58-7.17,4.51-11.3,0-20.19,0-40.39-.09-60.58C315.26,347.41,310.71,347.4,306.17,347.44Zm56.08-.9q-5.08,11.67-10.36,23.24c-1,2.31-2.21,5.37-.11,7.46,2.69,2.44,6.64,1.5,9.94,1.72-2.29,5.78-5.3,11.27-7.23,17.19-1.07,2.92,1.6,5.89,4.52,5.92,5.29.36,10.6,0,15.9.14,1.73-3.87,3.47-7.73,5.17-11.62-3.09,0-6.21.22-9.25-.39,3.29-8.26,7.19-16.25,10.68-24.41-4.27-.5-9.1.89-13-.77,1.9-6.4,5.36-12.27,7.8-18.5C371.61,346.5,366.93,346.47,362.25,346.54Zm72.75.05,0,5.21c-3.06,0-6.12,0-9.18,0q0,7,0,13.93c3.07,0,6.13,0,9.19.06q.12,6,0,12.08c-4.6.09-9.21,0-13.81.07-.06,4.64-.05,9.27,0,13.9,4.61.05,9.23,0,13.84,0,0,9.86,0,19.73,0,29.59,4.62,0,9.23,0,13.85,0q0-14.79,0-29.57c6.74,0,13.47-.1,20.21,0,2.37-.2,5.08,1.46,5,4.07a110.67,110.67,0,0,1,0,11.08,2.26,2.26,0,0,1-2.12,2.39c-3.85.28-7.71,0-11.57.13,1.7,4,3.35,8,5.28,11.95,6.35-.33,14.11,1.27,18.95-4,4.6-4.26,3.22-11,3.41-16.56-.29-5.85,1.14-12.46-2.49-17.58-3.09-4.34-8.66-5.52-13.68-5.61-.3-7,1.37-15.19-3.78-20.88-4.8-5.38-12.53-5.4-19.17-5.14l0-5.2C444.23,346.56,439.61,346.57,435,346.59Zm-49.42,5.22q0,7,0,13.92c2.9,0,5.79,0,8.69,0,0,13.91,0,27.83,0,41.74-4.15.07-8.31,0-12.46.05-2.15,4.62-4.25,9.26-6.34,13.9,15.48.06,31,0,46.44,0q0-6.94,0-13.9c-4.45,0-8.91,0-13.36-.05q0-20.88,0-41.77c2.91,0,5.81,0,8.72,0,0-4.64,0-9.29,0-13.93C406.73,351.79,396.16,351.77,385.58,351.81Zm91.35,1.28c-3.88,2.94-2.61,8.32-2.78,12.51,2.59,0,5.19.14,7.78-.09,4.16-.38,7.29-5.23,5.62-9.15C486.24,352.06,480.43,350.19,476.93,353.09ZM283,365.72c-.7,9.12-1.41,18.23-2.07,27.35a22.12,22.12,0,0,1-1.32,6.06c2.34,5.35,4.68,10.7,7.18,16,5.6-7.49,7.68-16.93,8.26-26.1.49-7.8,1.36-15.59,1.64-23.4C292.1,365.79,287.54,365.68,283,365.72Zm46.13,0q1,12.69,2,25.37c.73,8.48,2.92,17.12,8.1,24,2.47-5.29,4.83-10.63,7.17-16A21.67,21.67,0,0,1,345,393c-.66-9.09-1.38-18.18-2.08-27.27Q336,365.69,329.1,365.72Zm17.16,54.69c7.08,2.09,14.58.66,21.85,1.05,2.14-4.63,4.27-9.27,6.35-13.93-7.27-.28-14.67.76-21.8-1.07Q349.42,413.41,346.26,420.41Z" transform="translate(-256 -256)" style="fill:#ff2741"></path> <path d="M448.77,365.77c3,.43,7-1.22,9.29,1.2.38,3.65.1,7.32.14,11-3.11,0-6.23,0-9.34,0Q448.77,371.87,448.77,365.77Z" transform="translate(-256 -256)" style="fill:#ff2741"></path> <path d="M306.17,347.44c4.54,0,9.09,0,13.63,0,.13,20.19.08,40.39.09,60.58.07,4.13-1,8.72-4.51,11.3-3.86,3-9,2-13.54,2.17-1.8-3.87-3.54-7.77-5.15-11.73,2.4,0,4.8.06,7.19-.08a2.1,2.1,0,0,0,2.13-2.6C306.11,387.19,306,367.31,306.17,347.44Z" transform="translate(-256 -256)" style="fill:#fff"></path> <path d="M362.25,346.54c4.68-.07,9.36,0,14,0-2.44,6.23-5.9,12.1-7.8,18.5,3.92,1.66,8.75.27,13,.77-3.49,8.16-7.39,16.15-10.68,24.41,3,.61,6.16.39,9.25.39-1.7,3.89-3.44,7.75-5.17,11.62-5.3-.09-10.61.22-15.9-.14-2.92,0-5.59-3-4.52-5.92,1.93-5.92,4.94-11.41,7.23-17.19-3.3-.22-7.25.72-9.94-1.72-2.1-2.09-.88-5.15.11-7.46Q357.14,358.2,362.25,346.54Z" transform="translate(-256 -256)" style="fill:#fff"></path> <path d="M435,346.59c4.61,0,9.23,0,13.84,0l0,5.2c6.64-.26,14.37-.24,19.17,5.14,5.15,5.69,3.48,13.9,3.78,20.88,5,.09,10.59,1.27,13.68,5.61,3.63,5.12,2.2,11.73,2.49,17.58-.19,5.57,1.19,12.3-3.41,16.56-4.84,5.23-12.6,3.63-18.95,4-1.93-3.91-3.58-7.94-5.28-11.95,3.86-.11,7.72.15,11.57-.13a2.26,2.26,0,0,0,2.12-2.39,110.67,110.67,0,0,0,0-11.08c.07-2.61-2.64-4.27-5-4.07-6.74-.1-13.47,0-20.21,0q0,14.79,0,29.57c-4.62,0-9.23,0-13.85,0,0-9.86,0-19.73,0-29.59-4.61,0-9.23,0-13.84,0,0-4.63,0-9.26,0-13.9,4.6,0,9.21,0,13.81-.07q.13-6,0-12.08c-3.06-.05-6.12-.09-9.19-.06q0-7,0-13.93c3.06,0,6.12,0,9.18,0Zm13.77,19.18q0,6.1.09,12.2c3.11,0,6.23,0,9.34,0,0-3.66.24-7.33-.14-11C455.77,364.55,451.77,366.2,448.77,365.77Z" transform="translate(-256 -256)" style="fill:#fff"></path> <path d="M385.58,351.81c10.58,0,21.15,0,31.72,0,0,4.64,0,9.29,0,13.93-2.91,0-5.81,0-8.72,0q0,20.89,0,41.77c4.45.05,8.91,0,13.36.05q0,6.94,0,13.9c-15.48,0-31,0-46.44,0,2.09-4.64,4.19-9.28,6.34-13.9,4.15,0,8.31,0,12.46-.05,0-13.91,0-27.83,0-41.74-2.9,0-5.79,0-8.69,0Q385.55,358.77,385.58,351.81Z" transform="translate(-256 -256)" style="fill:#fff"></path> <path d="M476.93,353.09c3.5-2.9,9.31-1,10.62,3.27,1.67,3.92-1.46,8.77-5.62,9.15-2.59.23-5.19.1-7.78.09C474.32,361.41,473.05,356,476.93,353.09Z" transform="translate(-256 -256)" style="fill:#fff"></path> <path d="M283,365.72c4.57,0,9.13.07,13.69-.11-.28,7.81-1.15,15.6-1.64,23.4-.58,9.17-2.66,18.61-8.26,26.1-2.5-5.28-4.84-10.63-7.18-16a22.12,22.12,0,0,0,1.32-6.06C281.56,384,282.27,374.84,283,365.72Z" transform="translate(-256 -256)" style="fill:#fff"></path> <path d="M329.1,365.72q6.91,0,13.83,0c.7,9.09,1.42,18.18,2.08,27.27a21.67,21.67,0,0,0,1.32,6.15c-2.34,5.35-4.7,10.69-7.17,16-5.18-6.91-7.37-15.55-8.1-24S329.77,374.18,329.1,365.72Z" transform="translate(-256 -256)" style="fill:#fff"></path> <path d="M346.26,420.41q3.17-7,6.4-13.95c7.13,1.83,14.53.79,21.8,1.07-2.08,4.66-4.21,9.3-6.35,13.93C360.84,421.07,353.34,422.5,346.26,420.41Z" transform="translate(-256 -256)" style="fill:#fff"></path> </svg> </a> <a href="https://github.com/maotoumao" class="text-warm-text/60 dark:text-night-text/60 hover:text-warm-sage transition-colors" aria-label="GitHub" title="GitHub" target="_blank" rel="noreferrer"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="20" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" class="lucide lucide-github">  <path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path> <path d="M9 18c-4.51 2-5-2-7-2"></path>  </svg> </a> </div> <p class="font-serif text-sm text-warm-text/40 dark:text-night-text/40">
© <span id="footer-year"></span> 猫头猫的博客. All rights reserved.
</p> </div> <script>
    document.getElementById('footer-year').textContent = new Date().getFullYear();
  </script> </footer> <script>
      const root = document.documentElement;
      const stored = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initialTheme = stored || (prefersDark ? 'dark' : 'light');

      const applyTheme = (theme) => {
        root.classList.remove('light', 'dark');
        root.classList.add(theme);
        localStorage.setItem('theme', theme);
        const showSun = theme === 'light';
        document.querySelectorAll('[data-theme-icon="sun"]').forEach((el) => el.classList.toggle('hidden', !showSun));
        document.querySelectorAll('[data-theme-icon="moon"]').forEach((el) => el.classList.toggle('hidden', showSun));
      };

      applyTheme(initialTheme);

      document.querySelectorAll('[data-theme-toggle]').forEach((button) => {
        button.addEventListener('click', () => {
          const next = root.classList.contains('dark') ? 'light' : 'dark';
          applyTheme(next);
        });
      });

      document.querySelectorAll('[data-menu-toggle]').forEach((button) => {
        const targetId = button.getAttribute('data-menu-target');
        const menu = document.getElementById(targetId);
        if (!menu) return;

        button.addEventListener('click', () => {
          const isOpen = menu.dataset.open === 'true';
          menu.dataset.open = (!isOpen).toString();
          menu.classList.toggle('max-h-0', isOpen);
          menu.classList.toggle('max-h-96', !isOpen);
          menu.classList.toggle('opacity-0', isOpen);
          menu.classList.toggle('opacity-100', !isOpen);
          button.querySelector('[data-menu-icon="open"]').classList.toggle('hidden', !isOpen);
          button.querySelector('[data-menu-icon="close"]').classList.toggle('hidden', isOpen);
        });
      });
    </script> </body> </html>