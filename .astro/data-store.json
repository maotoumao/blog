[["Map",1,2,9,10],"meta::meta",["Map",3,4,5,6,7,8],"astro-version","5.17.1","content-config-digest","df1d827830910665","astro-config-digest","{\"root\":{},\"srcDir\":{},\"publicDir\":{},\"outDir\":{},\"cacheDir\":{},\"compressHTML\":true,\"base\":\"/\",\"trailingSlash\":\"ignore\",\"output\":\"static\",\"scopedStyleStrategy\":\"attribute\",\"build\":{\"format\":\"directory\",\"client\":{},\"server\":{},\"assets\":\"_astro\",\"serverEntry\":\"entry.mjs\",\"redirects\":true,\"inlineStylesheets\":\"auto\",\"concurrency\":1},\"server\":{\"open\":false,\"host\":false,\"port\":4321,\"streaming\":true,\"allowedHosts\":[]},\"redirects\":{},\"image\":{\"endpoint\":{\"route\":\"/_image\"},\"service\":{\"entrypoint\":\"astro/assets/services/sharp\",\"config\":{}},\"domains\":[],\"remotePatterns\":[],\"responsiveStyles\":false},\"devToolbar\":{\"enabled\":true},\"markdown\":{\"syntaxHighlight\":{\"type\":\"shiki\",\"excludeLangs\":[\"math\"]},\"shikiConfig\":{\"langs\":[],\"langAlias\":{},\"theme\":\"github-dark\",\"themes\":{},\"wrap\":false,\"transformers\":[]},\"remarkPlugins\":[],\"rehypePlugins\":[],\"remarkRehype\":{},\"gfm\":true,\"smartypants\":true},\"security\":{\"checkOrigin\":true,\"allowedDomains\":[]},\"env\":{\"schema\":{},\"validateSecrets\":false},\"experimental\":{\"clientPrerender\":false,\"contentIntellisense\":false,\"headingIdCompat\":false,\"preserveScriptOrder\":false,\"liveContentCollections\":false,\"csp\":false,\"staticImportMetaEnv\":false,\"chromeDevtoolsWorkspace\":false,\"failOnPrerenderConflict\":false,\"svgo\":false},\"legacy\":{\"collections\":false}}","posts",["Map",11,12,43,44,68,69,94,95,117,118,268,269,313,314,338,339,379,380,400,401,425,426,458,459,523,524,574,575,592,593,630,631,670,671,687,688,722,723,745,746,787,788,812,813,835,836,866,867,890,891,944,945,970,971,992,993,1032,1033,1049,1050,1077,1078,1094,1095,1131,1132,1156,1157,1173,1174,1212,1213,1243,1244],"ai开发小程序",{"id":11,"data":13,"body":18,"filePath":19,"digest":20,"rendered":21},{"title":14,"pubDate":15,"category":16,"excerpt":17},"AI开发小程序",["Date","2025-04-05T19:21:06.000Z"],"算法&AI","用AI做个小程序吧~","## 前言\n\n这是一个用AI开发小程序的全过程的记录，小程序的界面样式、95%的前端代码、95%的后端代码（剩下的5%是我手动修改了一些些，但约等于全都是用AI实现了😂）都是由AI生成的，不得不说 AI 发展的实在太快了。\n\n早些时候关注我的小伙伴可能还记得之前尝试做过一个 AI 测运势的小程序，当时是用 Midjourney 生成了一些小程序上用到的配图，用 ChatGPT 生成了一些文案，界面设计、小程序前端、后端都是自己写的。\n\n不过这个小程序很快被封掉了，理由是个人小程序不能接入大模型，并且小程序不能和占卜测算相关（吐槽一下tx灵活的审核机制，这么多占卜测算小程序都没被封..）\n\n前不久看到一些用 AI 生成视觉稿的教程，想实践一下，于是想起了这个尘封已久的小程序，把它改成了一个星座运势的工具，这样就和占卜没关系了。\n\n\n## 需求描述\n\n既然是一个星座运势小程序，那首页至少需要可以展示十二星座、每个星座的运势文案。另外为了让它的功能显得稍微多点，可以再加一个 tab，做一个【答案之书】页面。\n\n需求看起来很简单（一句话需求，深得产品经理真传），然后就可以开始准备开发了 —— 首先是要做一个视觉稿，接下来开发小程序的前端和后端，最后是部署上线。\n\n## 视觉稿\n\n虽然之前切过不少图，但还是不擅长视觉设计，之前做一些小项目基本上都是简单画一个草图，然后直接开始写代码。\n\n但现在，可以通过大模型直接生成视觉稿了，甚至可以根据视觉稿直接生成前端页面。实测下来，`Claude3.7`，`Gemini 2.5 Pro` 生成视觉稿的效果都不错。\n\n可以使用 `Github Copilot`、字节的 `Trae` 来使用 `Claude3.7` 和 `Gemini 2.5 Pro`；也可以直接在谷歌AI studio官网上直接使用 `Gemini 2.5 Pro`。\n\n为了生成视觉稿，我们只需要套用下面的提示词模板，然后把任务描述清楚就好了，比如：\n\n```plaintext\n#角色\n你是一位资深交互设计师，擅长使用HTML/CSS/SVG等技术完成UI/UX设计。你的设计风格优雅舒适，能够吸引用户使用，动线设计合理，具有细腻的微交互。你可以自由使用渐变、毛玻璃等任何你觉得能达到最佳视觉效果的设计。\n\n#技术规格\n1、单个页面尺寸为 375x812px，带有描边，模拟手机边框\n2. 每个功能点都需要有单独页面的设计稿，并列出详细的交互方案\n3. 多个页面的设计稿，横向排列；如果空间不足，则可以横向滚动，除此之外不显示任何非移动端元素；\n4、图标使用 Lucide Static CDN 方式引入，示例如下：\n\n```html\n\u003C!DOCTYPE html>\n\u003Cbody>\n  \u003Ci data-lucide=\"volume-2\" class=\"my-class\">\u003C/i>\n  \u003Ci data-lucide=\"x\">\u003C/i>\n  \u003Ci data-lucide=\"menu\">\u003C/i>\n\n  \u003Cscript src=\"https://unpkg.com/lucide@latest\">\u003C/script>\n  \u003Cscript>\n    lucide.createIcons();\n  \u003C/script>\n\u003C/body>\n\\```\n5、图片: 使用开源图片网站unsplash链接的形式引入\n6、样式必须引入 tailwindcss CDN 来完成\n7、不要显示状态栏以及时间、信号等信息\n8、不要显示非移动端元素，如滚动条\n9. 不需要考虑实际功能实现，只需要从设计和交互的角度考虑\n10. 你需要先把整个设计稿的框架搭出，接下来向其中填充具体设计的页面\n11. 每次输出2个页面，等我审阅后再继续输出接下来的2个页面\n\n#任务\n{任务描述}\n\n模拟产品经理输出详细功能设计、信息架构设计，结合角色和技术规格输出一套UI设计方案。\n生成一个UI.html文件，放入所有页面，横向排列。\n\n#优秀案例\n以下是一个优秀的设计案例，你可以参考这个案例的设计风格，但不要照搬，要根据自己的风格、要求和技术规格进行设计。\n尤其是类，你的每个页面的类名都使用 phone-frame。\n\n{视觉稿示例}\n```\n\n把里面的 `{任务描述}` 和 `{视觉稿示例}` 替换掉。比如我们想生成一个名字叫 \"MusicFree\" 的音乐播放器的视觉稿，`任务描述` 可以这样写：\n\n```\n这是一个插件化的【音乐播放器】软件，将要使用React Native进行开发，主要考虑安卓端。\n软件没有登录功能，本身是一个音乐播放器的空壳，通过安装不同的插件实现播放不同源的音乐。\n\n软件有以下页面：\n- 主页，功能如下：\n  - 顶部是侧边栏入口和搜索框；\n  - 推荐歌单、榜单、最近播放、本地音乐四个页面的入口\n  - 展示我创建的所有歌单\n  - 展示我收藏的所有歌单\n  - 底部是音乐播放栏，展示当前正在播放的音乐和状态\n\n- 正在播放的音乐详情页，功能如下：\n  - 歌曲名称\n  - 歌曲专辑\n  - 歌曲来源\n  - 歌曲作者\n  - 歌曲专辑封面\n  - 播放状态\n  - 切换上一首/下一首等功能按钮\n  - 歌词（以及相关的调整功能）\n\n- 搜索页\n  - 点击主页的搜索按钮会跳转到一个单独的搜索页，顶部是一个输入框，底部是最近搜索的关键字；\n  - 搜索结果页：\n    搜索结果类型有：歌曲、专辑、歌单、作者；\n    每个类别下，按插件列出搜索结果，应该是一个级联的tabview\n```\n\n任务描述的核心思路就是描述清楚想要的功能，给 AI 一个大概的方向。 `{视觉稿示例}` 部分可以贴一个其他的 html 格式的视觉稿的代码示例给 AI 做参考。\n\n播放器的视觉稿效果大概如下：\n\n![视觉稿](/images/musicfree-ui.png)\n\n回到主题，用类似的方式去生成一个星座小程序的视觉稿，视觉效果如下：\n\n![视觉稿](/images/astro-ui.png)\n\n看上去还是有模有样的，比我自己做的视觉稿好看多了~\n\n## 前端\n\n因为生成的视觉稿是 HTML 形式的，所以转换成前端代码可以说是非常方便了。\n\n小程序用的是 Taro + React 开发的，按照官方文档初始化一个空的 Taro 项目，剩下的就可以交给 AI 了。\n\n用 Copilot Chat 的 `Claude 3.7 Thinking` 模型的话，只需要把要做的任务详细描述清楚，AI 就会自己开始生成代码了。这里我感觉没有什么固定的模板，把最终效果描述清楚，然后把上一步生成的html视觉稿贴进去就够了：\n\n```plaintext\n这是一个星座运势小程序，使用Taro+react实现。css使用scss，基本样式单位为rpx。你无法使用tailwindcss，所以请重新规划样式，确保和视觉稿完全一致。\n请你帮我还原视觉稿，我将会给你html格式的视觉稿，你需要帮我还原出第一个页面、第二个页面，它们分别是加载中、出错了界面。\n\n要求：视觉稿需要绝对还原，不需要考虑底部的导航栏。视觉稿是375x812px的，1rem=16px。每个页面单独封装成一个组件。第一个页面中，进度条会逐渐向右走，在两秒内走到尽头。所有svg、图片使用Image标签，src留白。不要额外新创建styles文件夹。\n\n视觉稿如下：\n...\n```\n\n![Copilot](/images/copilot-chat-example.png)\n\n按下回车之后，等待生成代码就好了（有种当老板的感觉）。生成代码之后就可以在微信开发者工具里面预览效果，如果有不合适的地方告诉 AI 哪里不合适，它就会自己更新代码。\n\n简单切图的话，AI 还原度还是很高的，代码生成完之后基本上只需要做一些简单的修补就可以了，比完全从头开发工作量小多了。\n\n## 后端\n\n前端页面开发完成后，还需要后端来提供服务，具体来说还需要一个查询星座信息的接口。\n\n考虑到我的服务器内存比较小，所以这次就不写 nodejs 了，让 AI 帮我用 go 语言写。\n\n同样，写一系列要求，比如：\n- 我要用 go 语言写一个服务端，用于星座运势小程序，其中有以下接口，xxx （需求描述）\n- 请你帮我初始化项目结构，确保符合企业级后端应用的最佳实践 （任务）\n- 要求使用 gin 框架，使用 wire 进行依赖注入，使用 MVC 架构 （细节限制防止跑偏）\n\n这次我使用了 trae（cursor太贵了开不起会员），直接在 builder 模式下输入任务要求，然后按回车就好了。\n\nbuilder 模式类似 cursor 的 \"agent\" 模式，会自动生成代码，执行一些指令，自动修复一些执行过程中遇到的报错。\n\n但其实使用 trae 的过程中会遇到一些奇奇怪怪的问题，比如提示遇到错误，或者提示需要排队，很影响体验，但好在最后生成了个能运行的程序。\n\n这里就不赘述细节啦，几乎没有手动写代码~\n\n## 部署\n\n现在要发布一个小程序也挺麻烦，先备案，然后要再给微信交 30 块钱保护费，完事之后才可以上线。\n\n前后总共花了快一个月，才把这个尘封已久的小程序放出来。成品如下~\n\n![小程序](/images/astro-miniprogram.png)\n\n\n---\n\n用 AI 做软件的成本越来越低了，找时间可以尝试用 AI 写个简单的小游戏试试~","src/content/posts/AI开发小程序.md","a936f9fa81b3ee79",{"html":22,"metadata":23},"\u003Ch2 id=\"前言\">前言\u003C/h2>\n\u003Cp>这是一个用AI开发小程序的全过程的记录，小程序的界面样式、95%的前端代码、95%的后端代码（剩下的5%是我手动修改了一些些，但约等于全都是用AI实现了😂）都是由AI生成的，不得不说 AI 发展的实在太快了。\u003C/p>\n\u003Cp>早些时候关注我的小伙伴可能还记得之前尝试做过一个 AI 测运势的小程序，当时是用 Midjourney 生成了一些小程序上用到的配图，用 ChatGPT 生成了一些文案，界面设计、小程序前端、后端都是自己写的。\u003C/p>\n\u003Cp>不过这个小程序很快被封掉了，理由是个人小程序不能接入大模型，并且小程序不能和占卜测算相关（吐槽一下tx灵活的审核机制，这么多占卜测算小程序都没被封..）\u003C/p>\n\u003Cp>前不久看到一些用 AI 生成视觉稿的教程，想实践一下，于是想起了这个尘封已久的小程序，把它改成了一个星座运势的工具，这样就和占卜没关系了。\u003C/p>\n\u003Ch2 id=\"需求描述\">需求描述\u003C/h2>\n\u003Cp>既然是一个星座运势小程序，那首页至少需要可以展示十二星座、每个星座的运势文案。另外为了让它的功能显得稍微多点，可以再加一个 tab，做一个【答案之书】页面。\u003C/p>\n\u003Cp>需求看起来很简单（一句话需求，深得产品经理真传），然后就可以开始准备开发了 —— 首先是要做一个视觉稿，接下来开发小程序的前端和后端，最后是部署上线。\u003C/p>\n\u003Ch2 id=\"视觉稿\">视觉稿\u003C/h2>\n\u003Cp>虽然之前切过不少图，但还是不擅长视觉设计，之前做一些小项目基本上都是简单画一个草图，然后直接开始写代码。\u003C/p>\n\u003Cp>但现在，可以通过大模型直接生成视觉稿了，甚至可以根据视觉稿直接生成前端页面。实测下来，\u003Ccode>Claude3.7\u003C/code>，\u003Ccode>Gemini 2.5 Pro\u003C/code> 生成视觉稿的效果都不错。\u003C/p>\n\u003Cp>可以使用 \u003Ccode>Github Copilot\u003C/code>、字节的 \u003Ccode>Trae\u003C/code> 来使用 \u003Ccode>Claude3.7\u003C/code> 和 \u003Ccode>Gemini 2.5 Pro\u003C/code>；也可以直接在谷歌AI studio官网上直接使用 \u003Ccode>Gemini 2.5 Pro\u003C/code>。\u003C/p>\n\u003Cp>为了生成视觉稿，我们只需要套用下面的提示词模板，然后把任务描述清楚就好了，比如：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>#角色\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>你是一位资深交互设计师，擅长使用HTML/CSS/SVG等技术完成UI/UX设计。你的设计风格优雅舒适，能够吸引用户使用，动线设计合理，具有细腻的微交互。你可以自由使用渐变、毛玻璃等任何你觉得能达到最佳视觉效果的设计。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>#技术规格\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>1、单个页面尺寸为 375x812px，带有描边，模拟手机边框\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>2. 每个功能点都需要有单独页面的设计稿，并列出详细的交互方案\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>3. 多个页面的设计稿，横向排列；如果空间不足，则可以横向滚动，除此之外不显示任何非移动端元素；\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>4、图标使用 Lucide Static CDN 方式引入，示例如下：\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>```html\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>&#x3C;!DOCTYPE html>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>&#x3C;body>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  &#x3C;i data-lucide=\"volume-2\" class=\"my-class\">&#x3C;/i>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  &#x3C;i data-lucide=\"x\">&#x3C;/i>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  &#x3C;i data-lucide=\"menu\">&#x3C;/i>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  &#x3C;script src=\"https://unpkg.com/lucide@latest\">&#x3C;/script>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  &#x3C;script>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    lucide.createIcons();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  &#x3C;/script>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>&#x3C;/body>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\\```\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>5、图片: 使用开源图片网站unsplash链接的形式引入\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>6、样式必须引入 tailwindcss CDN 来完成\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>7、不要显示状态栏以及时间、信号等信息\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>8、不要显示非移动端元素，如滚动条\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>9. 不需要考虑实际功能实现，只需要从设计和交互的角度考虑\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>10. 你需要先把整个设计稿的框架搭出，接下来向其中填充具体设计的页面\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>11. 每次输出2个页面，等我审阅后再继续输出接下来的2个页面\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>#任务\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>{任务描述}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>模拟产品经理输出详细功能设计、信息架构设计，结合角色和技术规格输出一套UI设计方案。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>生成一个UI.html文件，放入所有页面，横向排列。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>#优秀案例\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>以下是一个优秀的设计案例，你可以参考这个案例的设计风格，但不要照搬，要根据自己的风格、要求和技术规格进行设计。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>尤其是类，你的每个页面的类名都使用 phone-frame。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>{视觉稿示例}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>把里面的 \u003Ccode>{任务描述}\u003C/code> 和 \u003Ccode>{视觉稿示例}\u003C/code> 替换掉。比如我们想生成一个名字叫 “MusicFree” 的音乐播放器的视觉稿，\u003Ccode>任务描述\u003C/code> 可以这样写：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>这是一个插件化的【音乐播放器】软件，将要使用React Native进行开发，主要考虑安卓端。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>软件没有登录功能，本身是一个音乐播放器的空壳，通过安装不同的插件实现播放不同源的音乐。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>软件有以下页面：\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- 主页，功能如下：\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 顶部是侧边栏入口和搜索框；\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 推荐歌单、榜单、最近播放、本地音乐四个页面的入口\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 展示我创建的所有歌单\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 展示我收藏的所有歌单\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 底部是音乐播放栏，展示当前正在播放的音乐和状态\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- 正在播放的音乐详情页，功能如下：\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 歌曲名称\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 歌曲专辑\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 歌曲来源\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 歌曲作者\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 歌曲专辑封面\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 播放状态\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 切换上一首/下一首等功能按钮\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 歌词（以及相关的调整功能）\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- 搜索页\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 点击主页的搜索按钮会跳转到一个单独的搜索页，顶部是一个输入框，底部是最近搜索的关键字；\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  - 搜索结果页：\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    搜索结果类型有：歌曲、专辑、歌单、作者；\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    每个类别下，按插件列出搜索结果，应该是一个级联的tabview\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>任务描述的核心思路就是描述清楚想要的功能，给 AI 一个大概的方向。 \u003Ccode>{视觉稿示例}\u003C/code> 部分可以贴一个其他的 html 格式的视觉稿的代码示例给 AI 做参考。\u003C/p>\n\u003Cp>播放器的视觉稿效果大概如下：\u003C/p>\n\u003Cp>\u003Cimg src=\"/images/musicfree-ui.png\" alt=\"视觉稿\">\u003C/p>\n\u003Cp>回到主题，用类似的方式去生成一个星座小程序的视觉稿，视觉效果如下：\u003C/p>\n\u003Cp>\u003Cimg src=\"/images/astro-ui.png\" alt=\"视觉稿\">\u003C/p>\n\u003Cp>看上去还是有模有样的，比我自己做的视觉稿好看多了~\u003C/p>\n\u003Ch2 id=\"前端\">前端\u003C/h2>\n\u003Cp>因为生成的视觉稿是 HTML 形式的，所以转换成前端代码可以说是非常方便了。\u003C/p>\n\u003Cp>小程序用的是 Taro + React 开发的，按照官方文档初始化一个空的 Taro 项目，剩下的就可以交给 AI 了。\u003C/p>\n\u003Cp>用 Copilot Chat 的 \u003Ccode>Claude 3.7 Thinking\u003C/code> 模型的话，只需要把要做的任务详细描述清楚，AI 就会自己开始生成代码了。这里我感觉没有什么固定的模板，把最终效果描述清楚，然后把上一步生成的html视觉稿贴进去就够了：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>这是一个星座运势小程序，使用Taro+react实现。css使用scss，基本样式单位为rpx。你无法使用tailwindcss，所以请重新规划样式，确保和视觉稿完全一致。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>请你帮我还原视觉稿，我将会给你html格式的视觉稿，你需要帮我还原出第一个页面、第二个页面，它们分别是加载中、出错了界面。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>要求：视觉稿需要绝对还原，不需要考虑底部的导航栏。视觉稿是375x812px的，1rem=16px。每个页面单独封装成一个组件。第一个页面中，进度条会逐渐向右走，在两秒内走到尽头。所有svg、图片使用Image标签，src留白。不要额外新创建styles文件夹。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>视觉稿如下：\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>...\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cimg src=\"/images/copilot-chat-example.png\" alt=\"Copilot\">\u003C/p>\n\u003Cp>按下回车之后，等待生成代码就好了（有种当老板的感觉）。生成代码之后就可以在微信开发者工具里面预览效果，如果有不合适的地方告诉 AI 哪里不合适，它就会自己更新代码。\u003C/p>\n\u003Cp>简单切图的话，AI 还原度还是很高的，代码生成完之后基本上只需要做一些简单的修补就可以了，比完全从头开发工作量小多了。\u003C/p>\n\u003Ch2 id=\"后端\">后端\u003C/h2>\n\u003Cp>前端页面开发完成后，还需要后端来提供服务，具体来说还需要一个查询星座信息的接口。\u003C/p>\n\u003Cp>考虑到我的服务器内存比较小，所以这次就不写 nodejs 了，让 AI 帮我用 go 语言写。\u003C/p>\n\u003Cp>同样，写一系列要求，比如：\u003C/p>\n\u003Cul>\n\u003Cli>我要用 go 语言写一个服务端，用于星座运势小程序，其中有以下接口，xxx （需求描述）\u003C/li>\n\u003Cli>请你帮我初始化项目结构，确保符合企业级后端应用的最佳实践 （任务）\u003C/li>\n\u003Cli>要求使用 gin 框架，使用 wire 进行依赖注入，使用 MVC 架构 （细节限制防止跑偏）\u003C/li>\n\u003C/ul>\n\u003Cp>这次我使用了 trae（cursor太贵了开不起会员），直接在 builder 模式下输入任务要求，然后按回车就好了。\u003C/p>\n\u003Cp>builder 模式类似 cursor 的 “agent” 模式，会自动生成代码，执行一些指令，自动修复一些执行过程中遇到的报错。\u003C/p>\n\u003Cp>但其实使用 trae 的过程中会遇到一些奇奇怪怪的问题，比如提示遇到错误，或者提示需要排队，很影响体验，但好在最后生成了个能运行的程序。\u003C/p>\n\u003Cp>这里就不赘述细节啦，几乎没有手动写代码~\u003C/p>\n\u003Ch2 id=\"部署\">部署\u003C/h2>\n\u003Cp>现在要发布一个小程序也挺麻烦，先备案，然后要再给微信交 30 块钱保护费，完事之后才可以上线。\u003C/p>\n\u003Cp>前后总共花了快一个月，才把这个尘封已久的小程序放出来。成品如下~\u003C/p>\n\u003Cp>\u003Cimg src=\"/images/astro-miniprogram.png\" alt=\"小程序\">\u003C/p>\n\u003Chr>\n\u003Cp>用 AI 做软件的成本越来越低了，找时间可以尝试用 AI 写个简单的小游戏试试~\u003C/p>",{"headings":24,"localImagePaths":38,"remoteImagePaths":39,"frontmatter":40,"imagePaths":42},[25,28,30,32,34,36],{"depth":26,"slug":27,"text":27},2,"前言",{"depth":26,"slug":29,"text":29},"需求描述",{"depth":26,"slug":31,"text":31},"视觉稿",{"depth":26,"slug":33,"text":33},"前端",{"depth":26,"slug":35,"text":35},"后端",{"depth":26,"slug":37,"text":37},"部署",[],[],{"title":14,"pubDate":41,"category":16,"excerpt":17},["Date","2025-04-05T19:21:06.000Z"],[],"co-play开发记录",{"id":43,"data":45,"body":49,"filePath":50,"digest":51,"rendered":52},{"title":43,"pubDate":46,"category":47,"excerpt":48},["Date","2020-03-28T00:17:03.000Z"],"项目/作品","co-play是一个同步看片的工具。你可以选择包含影视资源的网站，然后和好友同步的观看这个网站的资源。","项目是基于electron8.0开发，2020.3.28进行重构。整个过程中遇到的问题记录如下：\n\n#### 原始版记录(electron+jquery)\n- 关于electron\n    在开发的过程中才突然明白main和renderer的区别。主进程相当于是浏览器，可以控制浏览器的各种行为，renderer进程相当于是每一个页面，换句话说，每一个html中引入的js文件所在环境是renderer进程，而创建这个html窗口的js所在环境是主进程。\n- 引入了jquery和bootstrap的样式：\n    引入样式没什么好说的，页面引入jquery的时候提示$不存在，\n    参考jquery源码，electron执行环境为node，使用commonJS模块化标准，node环境没有window对象，这种情况下，jquery将导出到module.exports对象上，需要手工绑定到当前的window窗口，即可解决。\n- socketio:\n    在客户端进行emit，如果需要知道提交之后的结果，可以在第三个参数上写回调函数，在服务器端监听事件之后调用回调函数，使得客户端执行相应的行为。\n- 犯蠢： jsx写习惯了忘了html是怎么写的了，javascript引入的格式写错了。。\n\n- 本地存储：\n    使用了electron-store，因为是多页面需要共用状态，所以我单独写了个js模块，导出一个新的store对象，并对这个对象进行操作。\n    electron-store是操作本地磁盘的，所有写在上面的数据都和磁盘文件相对应，因此退出时需要进行store.clear()删除缓存。\n\n- 犯蠢：for in 和for of， for in迭代的是key， for of迭代的是value\n\n- 打包：\n    参考了很多文章，一开始使用electron-packager这个包，结果卡住不动，换源也没用（淘宝源的路径不对）；\n    然后换成electron-builder，手动下载包到缓存路径，总算生成了未打包但是能运行的文件夹，但是还是报一个Fatal error: Unable to commit changes的错误，导致错误的原因是电脑自带的杀毒软件。。。。。关闭macfee就好了。。。\n\n- 服务器：\n    nodejs+express+socketio，体验还好。就是自己代码组织的不怎么样。\n\n- document.querySelector()这个函数，如果找不到返回的是null，我当成了undefined来判断，所以出错了。\n\n- 渲染进程中的sendSync()这个函数，如果等不到返回值，会一直卡着，直到等到返回值，因为是同步的。\n\n\n---\n#### 重构记录(electron+react)\n- 安装electron\n- 渲染进程require electron出错，TypeError: fs.existsSync is not a function，原因是没有nodejs环境。解决：\n渲染进程：\n```javascript\n    const { ipcRenderer } = window.require('electron');\n```\n主进程：\n``` javascript\nconst win = new BrowserWindow({\n    webPreferences: {\n      nodeIntegration: true\n    }\n  })\n```\n  从而为electron工程提供了node环境，但是如果直接从浏览器打开3000端口，则会报错。因为浏览器没有node环境\n- 引入了ant design库，但是好像没有按需加载，之后再说吧，咕咕咕。\n- 用hooks实现了一个简单的状态管理，暂时也用不到本地存储，就没装electron-store库。\n\n- 打包，需要同时指定：\n```\nregistry=https://registry.npm.taobao.org/\nelectron_custom_dir=8.2.0\nelectron_mirror=http://npm.taobao.org/mirrors/electron/ \n```\n才可以。如果不写第三个，会自己去github找，然后就报错了。\n\n- 打包需要打包主进程和渲染进程 main和render,因此打包时两个都要在同一个文件夹内。打包的内容可以最小化，只包含react build之后的dist和主进程main\n\n- 服务端重写了一下逻辑，这次看着舒服多了。\n\n- 可以自动化的点：\n  根据运行环境是生产模式还是开发环境，这决定了程序的入口(奈何webpack还没学会)\n\n[客户端源码指路](https://github.com/maotoumao/coplay-react)(readme都没写，不愧是我)","src/content/posts/co-play开发记录.md","c628d8481a499096",{"html":53,"metadata":54},"\u003Cp>项目是基于electron8.0开发，2020.3.28进行重构。整个过程中遇到的问题记录如下：\u003C/p>\n\u003Ch4 id=\"原始版记录electronjquery\">原始版记录(electron+jquery)\u003C/h4>\n\u003Cul>\n\u003Cli>\n\u003Cp>关于electron\n在开发的过程中才突然明白main和renderer的区别。主进程相当于是浏览器，可以控制浏览器的各种行为，renderer进程相当于是每一个页面，换句话说，每一个html中引入的js文件所在环境是renderer进程，而创建这个html窗口的js所在环境是主进程。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>引入了jquery和bootstrap的样式：\n引入样式没什么好说的，页面引入jquery的时候提示$不存在，\n参考jquery源码，electron执行环境为node，使用commonJS模块化标准，node环境没有window对象，这种情况下，jquery将导出到module.exports对象上，需要手工绑定到当前的window窗口，即可解决。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>socketio:\n在客户端进行emit，如果需要知道提交之后的结果，可以在第三个参数上写回调函数，在服务器端监听事件之后调用回调函数，使得客户端执行相应的行为。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>犯蠢： jsx写习惯了忘了html是怎么写的了，javascript引入的格式写错了。。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>本地存储：\n使用了electron-store，因为是多页面需要共用状态，所以我单独写了个js模块，导出一个新的store对象，并对这个对象进行操作。\nelectron-store是操作本地磁盘的，所有写在上面的数据都和磁盘文件相对应，因此退出时需要进行store.clear()删除缓存。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>犯蠢：for in 和for of， for in迭代的是key， for of迭代的是value\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>打包：\n参考了很多文章，一开始使用electron-packager这个包，结果卡住不动，换源也没用（淘宝源的路径不对）；\n然后换成electron-builder，手动下载包到缓存路径，总算生成了未打包但是能运行的文件夹，但是还是报一个Fatal error: Unable to commit changes的错误，导致错误的原因是电脑自带的杀毒软件。。。。。关闭macfee就好了。。。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>服务器：\nnodejs+express+socketio，体验还好。就是自己代码组织的不怎么样。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>document.querySelector()这个函数，如果找不到返回的是null，我当成了undefined来判断，所以出错了。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>渲染进程中的sendSync()这个函数，如果等不到返回值，会一直卡着，直到等到返回值，因为是同步的。\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Chr>\n\u003Ch4 id=\"重构记录electronreact\">重构记录(electron+react)\u003C/h4>\n\u003Cul>\n\u003Cli>安装electron\u003C/li>\n\u003Cli>渲染进程require electron出错，TypeError: fs.existsSync is not a function，原因是没有nodejs环境。解决：\n渲染进程：\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { \u003C/span>\u003Cspan style=\"color:#79B8FF\">ipcRenderer\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> } \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> window.\u003C/span>\u003Cspan style=\"color:#B392F0\">require\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'electron'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>主进程：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> win\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> new\u003C/span>\u003Cspan style=\"color:#B392F0\"> BrowserWindow\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    webPreferences: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      nodeIntegration: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  })\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>从而为electron工程提供了node环境，但是如果直接从浏览器打开3000端口，则会报错。因为浏览器没有node环境\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>引入了ant design库，但是好像没有按需加载，之后再说吧，咕咕咕。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>用hooks实现了一个简单的状态管理，暂时也用不到本地存储，就没装electron-store库。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>打包，需要同时指定：\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>registry=https://registry.npm.taobao.org/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>electron_custom_dir=8.2.0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>electron_mirror=http://npm.taobao.org/mirrors/electron/ \u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>才可以。如果不写第三个，会自己去github找，然后就报错了。\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>打包需要打包主进程和渲染进程 main和render,因此打包时两个都要在同一个文件夹内。打包的内容可以最小化，只包含react build之后的dist和主进程main\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>服务端重写了一下逻辑，这次看着舒服多了。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>可以自动化的点：\n根据运行环境是生产模式还是开发环境，这决定了程序的入口(奈何webpack还没学会)\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Ca href=\"https://github.com/maotoumao/coplay-react\">客户端源码指路\u003C/a>(readme都没写，不愧是我)\u003C/p>",{"headings":55,"localImagePaths":63,"remoteImagePaths":64,"frontmatter":65,"imagePaths":67},[56,60],{"depth":57,"slug":58,"text":59},4,"原始版记录electronjquery","原始版记录(electron+jquery)",{"depth":57,"slug":61,"text":62},"重构记录electronreact","重构记录(electron+react)",[],[],{"title":43,"pubDate":66,"category":47,"excerpt":48},["Date","2020-03-28T00:17:03.000Z"],[],"js的块作用域小结",{"id":68,"data":70,"body":73,"filePath":74,"digest":75,"rendered":76},{"title":68,"pubDate":71,"category":33,"excerpt":72},["Date","2019-08-27T16:35:07.000Z"],"关于js的块作用域的一个小总结。","作用域是一种根据标识符名称去**查找变量的一套规则**。众所周知，js中主要存在的作用域是函数作用域，也就是说，在函数内使用var定义的变量会被封存起来，不被外界获取到。然而，js中也存在其他类型的作用域，也就是块作用域。\n\njs中块作用域主要有三种：\n\n### with\n**不建议使用with语句，因为可能会造成变量泄露，性能也会变差**  \n用with从对象中创建的作用域只在with代码块中生效。   \n举个例子：\n``` javascript\nvar o = {a:1};\nwith(o){\n    console.log(a);\n}\nconsole.log(a); //报错\n```\n也就是说，只有在with声明的块作用域内，才可以直接使用对象的属性名来查找变量，在外部则查找不到，因此with内部是一个块作用域。\n\n### try/catch\ntry/catch的catch分句会创建一个块作用域，其中声明的变量仅仅在catch内部有效。  \n注意，这里说的声明指的是catch后边的括号内的声明。也就是说：\n``` javascript\nconsole.log(b); //undefined\ntry{\n    throw 1;\n}catch(a){\n    console.log(a); //1\n    console.log(b); //undefined\n    var b = 2;\n}\nconsole.log(a); //报错\nconsole.log(b); //2\n```\n可以发现，变量a仅仅在catch内部才生效，在外部是获取不到的。而根据var的行为，我们知道，在编译阶段，var声明的变量被提升到当前上下文的顶端（也就是当前函数作用域的顶端），因此在catch内部使用var声明的变量依然可以在外部被访问到。换句话说，整个代码是在同一个函数作用域中的。  \n根据catch子句的特性，我们便可以在ES5之前模拟ES6中的let：\n```javascript\ntry{\n    throw 2;\n}catch(a){\n    console.log('1 ', a);\n}\nconsole.log('2 ', a); // 报错\n```\n相当于ES6中的：\n```javascript\n{\n    let a = 2;\n    console.log('1 ', a);\n}\nconsole.log('2 ', a); // 报错\n```\n### let/const(ES6)\nlet关键字将变量绑定到所在的{}块作用域。let变量不会进行提升。在let变量所在的块作用域内，其声明之前，这个变量都被认为是不存在的。\nconst关键字也可以用来创建块作用域变量，但是其值是固定的。","src/content/posts/js的块作用域小结.md","b07344805a470b2b",{"html":77,"metadata":78},"\u003Cp>作用域是一种根据标识符名称去\u003Cstrong>查找变量的一套规则\u003C/strong>。众所周知，js中主要存在的作用域是函数作用域，也就是说，在函数内使用var定义的变量会被封存起来，不被外界获取到。然而，js中也存在其他类型的作用域，也就是块作用域。\u003C/p>\n\u003Cp>js中块作用域主要有三种：\u003C/p>\n\u003Ch3 id=\"with\">with\u003C/h3>\n\u003Cp>\u003Cstrong>不建议使用with语句，因为可能会造成变量泄露，性能也会变差\u003C/strong>\u003Cbr>\n用with从对象中创建的作用域只在with代码块中生效。\u003Cbr>\n举个例子：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> o \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {a:\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">with\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(o){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(a);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(a); \u003C/span>\u003Cspan style=\"color:#6A737D\">//报错\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>也就是说，只有在with声明的块作用域内，才可以直接使用对象的属性名来查找变量，在外部则查找不到，因此with内部是一个块作用域。\u003C/p>\n\u003Ch3 id=\"trycatch\">try/catch\u003C/h3>\n\u003Cp>try/catch的catch分句会创建一个块作用域，其中声明的变量仅仅在catch内部有效。\u003Cbr>\n注意，这里说的声明指的是catch后边的括号内的声明。也就是说：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(b); \u003C/span>\u003Cspan style=\"color:#6A737D\">//undefined\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    throw\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003Cspan style=\"color:#F97583\">catch\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(a){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(a); \u003C/span>\u003Cspan style=\"color:#6A737D\">//1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(b); \u003C/span>\u003Cspan style=\"color:#6A737D\">//undefined\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> b \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(a); \u003C/span>\u003Cspan style=\"color:#6A737D\">//报错\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(b); \u003C/span>\u003Cspan style=\"color:#6A737D\">//2\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>可以发现，变量a仅仅在catch内部才生效，在外部是获取不到的。而根据var的行为，我们知道，在编译阶段，var声明的变量被提升到当前上下文的顶端（也就是当前函数作用域的顶端），因此在catch内部使用var声明的变量依然可以在外部被访问到。换句话说，整个代码是在同一个函数作用域中的。\u003Cbr>\n根据catch子句的特性，我们便可以在ES5之前模拟ES6中的let：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    throw\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003Cspan style=\"color:#F97583\">catch\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(a){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'1 '\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, a);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'2 '\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, a); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 报错\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>相当于ES6中的：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> a \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'1 '\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, a);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'2 '\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, a); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 报错\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"letconstes6\">let/const(ES6)\u003C/h3>\n\u003Cp>let关键字将变量绑定到所在的{}块作用域。let变量不会进行提升。在let变量所在的块作用域内，其声明之前，这个变量都被认为是不存在的。\nconst关键字也可以用来创建块作用域变量，但是其值是固定的。\u003C/p>",{"headings":79,"localImagePaths":89,"remoteImagePaths":90,"frontmatter":91,"imagePaths":93},[80,83,86],{"depth":81,"slug":82,"text":82},3,"with",{"depth":81,"slug":84,"text":85},"trycatch","try/catch",{"depth":81,"slug":87,"text":88},"letconstes6","let/const(ES6)",[],[],{"title":68,"pubDate":92,"category":33,"excerpt":72},["Date","2019-08-27T16:35:07.000Z"],[],"es5-apply-call-bind-网易云课堂听课笔记",{"id":94,"data":96,"body":100,"filePath":101,"digest":102,"rendered":103},{"title":97,"pubDate":98,"category":33,"excerpt":99},"es5 apply call bind-网易云课堂听课笔记",["Date","2019-06-21T15:58:43.000Z"],"关于apply、call和bind的听课笔记。","### call & apply\n\n- call和apply是为了改变某个函数运行时的上下文而存在的。或者说，为了改变函数体内部的this指向。\n- call与apply作用完全相同，只是接受参数的方式不同：\ncall是将参数依次传入；\napply是将参数按照列表形式传入。\n\n- apply中第一个参数写null时，在BOM模型（浏览器环境）中，它与window相同。在node环境中，它与global相同\n- 构造函数一般使用大写，比如：\n``` javascript\n function Person(){}\n```\n- call和apply就是一个对象冒充：将函数运行时的this指向指定的对象。\n---\n一道面试题：\n``` javascript\n    function log(msg){\n        console.log(msg);\n    }\n    log(4);\n    log(4,5); \n```\n输出结果是：4 4\n如果想都输出？\n``` javascript\n    function log(){\n    var args = arguments\n        console.log.apply(null/console/window/this, args);\n    }\n    log(4);\n    log(4,5); \n```\n四种写法相同。\n相当于将args对象输出内部的值。\n\n---\n\napply和call的使用情况：\n1. 数组之间追加：\n``` javascript\n    var arr1 = [22, 23, 25];\n    var arr2 = [45, 128, 600]; //如何合并？\n    \n    Array.prototype.push.apply(arr1, arr2)\n    console.log(arr1)\n```\n相当于：arr1调用数组的push方法，传入参数依次为45, 128, 600, 也就是arr1.push(45, 128, 600)\n\n2. 获取数组中的最大值和最小值\n``` javascript\n    var arr1 = [22, 23, 25]\n    \n    var maxNum = Math.max.apply(null/window/Math, arr1)\n```\n相当于：Math.max(22, 23, 25)；可以这样写是因为max的实现没用到this\n\n3. 验证是否为数组\n``` javascript\n    Object.prototype.toString.call(obj) === '[object Array]'\n```\n写一些库的时候可以采用这种方式判断传入参数是否为一个数组；数组调用toString时结果是[object Array]\n\n4. 类数组、伪数组使用数组方法\n类数组：有类似数组的属性，如arguments，DOM中的children获取的对象；\n也就是：具有索引属性，有length属性。\n\n比如arguments，它没有一些诸如slice的方法。如果想将arguments转化为一个数组，那么可以使用slice：\n```javascript\n    Array.prototype.slice.call(arguments, 0)\n```\n\n\n---\n\n### bind\nbind：返回对应的函数，改变当前的this，便于稍后调用\napply, call:立即调用\n\nbind在事件使用的比较多。由于函数，如一些onclick事件是指向调用处的，如果想改变this，就需要用bind。ES6有箭头函数，因此可以代替bind\n\n---\nbind的使用方法：\n``` javascript\n    this.num = 1;\n    var mymodule = {\n        num: 2,\n        getNum: function(){\n            console.log(this.num)\n        }\n    }\n    mymodule.getNum() // 输出2，this指向mymodule\n    \n    \n    var a = mymoudule.getNum;\n    a() // 输出1，因为此时的this指向window\n    \n    // 如果还是要输出2，那么：\n    var b = a.bind(mymodule)()\n    var b = a.call(mymodule)\n    var b = a.apply(mymodule)\n```\n\nthis：方法没有调用者的时候，this赋值为window，有的时候指向调用者。\n\n``` javascript\nthis.num = 1;\nvar x = {\n\tnum: 2,\n\tgetNum: function(){\n\t\tconsole.log(this.num);\n\t}\n}\n\nvar y = {\n\tnum: 3,\n\txgetnum: x.getNum,\n\tgetN: function(){\n\t\tthis.xgetnum()\n\t}\n}\nx.getNum() //2\ny.xgetnum() //3\ny.getN() //3\n// var z = y.getN\n// z() //报错，因为window下没有xgetnum\nvar z = x.getNum\nz() //在sublime text下执行node，会输出undefined，直接在node运行，得出1\n\n```\n原因：Node在命令行条件下，this===global，而在文件环境下，Node的this被编译为{}。\n\n---\n\n- bind能否连环调用？ // 很多地方都用到了\n``` javascript\n    var bar = function(){\n        console.log(this.x);\n    }\n    \n    var foo = {\n        x : 1\n    }\n    \n    var foo1 = {\n        x : 2\n    }\n    \n    var foo2 = {\n        x : 3\n    }\n    \n    var func = bar.bind(foo)\n    func();\n    // 输出1\n    \n    var func1 = bar.bind(foo).bind(foo1)\n    // 输出1\n    \n    var func2 = bar.bind(foo).bind(foo1).bind(foo2)\n    // 输出1\n```\n需要从bind的内部实现去理解。\n相当于循环嵌套了函数，比如第三个：\n``` javascript\nfunction(){\n    this = foo\n    function bar()\n    {\n        console.log(this.x)\n    }\n}\n```\n第二次绑定：\n``` javascript\nfunction(){\n    this = foo1\n    function (){\n        this = foo\n        function bar(){\n            console.log(this.x)\n        }\n    }\n}\n```\n.... \n尽管经过再多次的绑定，结果依然是最初的结果。\n\n---\n\n收获：多学基础，了解底层，手撸原理。","src/content/posts/es5-apply-call-bind-网易云课堂听课笔记.md","a7a1731b2295d3e2",{"html":104,"metadata":105},"\u003Ch3 id=\"call--apply\">call &#x26; apply\u003C/h3>\n\u003Cul>\n\u003Cli>\n\u003Cp>call和apply是为了改变某个函数运行时的上下文而存在的。或者说，为了改变函数体内部的this指向。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>call与apply作用完全相同，只是接受参数的方式不同：\ncall是将参数依次传入；\napply是将参数按照列表形式传入。\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>apply中第一个参数写null时，在BOM模型（浏览器环境）中，它与window相同。在node环境中，它与global相同\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>构造函数一般使用大写，比如：\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> Person\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>call和apply就是一个对象冒充：将函数运行时的this指向指定的对象。\u003C/li>\n\u003C/ul>\n\u003Chr>\n\u003Cp>一道面试题：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    function\u003C/span>\u003Cspan style=\"color:#B392F0\"> log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">msg\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(msg);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">5\u003C/span>\u003Cspan style=\"color:#E1E4E8\">); \u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>输出结果是：4 4\n如果想都输出？\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    function\u003C/span>\u003Cspan style=\"color:#B392F0\"> log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> args \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> arguments\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.log.\u003C/span>\u003Cspan style=\"color:#B392F0\">apply\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">null\u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#E1E4E8\">console\u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#E1E4E8\">window\u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, args);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">5\u003C/span>\u003Cspan style=\"color:#E1E4E8\">); \u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>四种写法相同。\n相当于将args对象输出内部的值。\u003C/p>\n\u003Chr>\n\u003Cp>apply和call的使用情况：\u003C/p>\n\u003Col>\n\u003Cli>数组之间追加：\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> arr1 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">22\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">23\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">25\u003C/span>\u003Cspan style=\"color:#E1E4E8\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> arr2 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">45\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">128\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">600\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]; \u003C/span>\u003Cspan style=\"color:#6A737D\">//如何合并？\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    Array\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">prototype\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.push.\u003C/span>\u003Cspan style=\"color:#B392F0\">apply\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(arr1, arr2)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(arr1)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>相当于：arr1调用数组的push方法，传入参数依次为45, 128, 600, 也就是arr1.push(45, 128, 600)\u003C/p>\n\u003Col start=\"2\">\n\u003Cli>获取数组中的最大值和最小值\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> arr1 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">22\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">23\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">25\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> maxNum \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Math.max.\u003C/span>\u003Cspan style=\"color:#B392F0\">apply\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">null\u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#E1E4E8\">window\u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#E1E4E8\">Math, arr1)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>相当于：Math.max(22, 23, 25)；可以这样写是因为max的实现没用到this\u003C/p>\n\u003Col start=\"3\">\n\u003Cli>验证是否为数组\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    Object\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">prototype\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.toString.\u003C/span>\u003Cspan style=\"color:#B392F0\">call\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(obj) \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> '[object Array]'\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>写一些库的时候可以采用这种方式判断传入参数是否为一个数组；数组调用toString时结果是[object Array]\u003C/p>\n\u003Col start=\"4\">\n\u003Cli>类数组、伪数组使用数组方法\n类数组：有类似数组的属性，如arguments，DOM中的children获取的对象；\n也就是：具有索引属性，有length属性。\u003C/li>\n\u003C/ol>\n\u003Cp>比如arguments，它没有一些诸如slice的方法。如果想将arguments转化为一个数组，那么可以使用slice：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    Array\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">prototype\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.slice.\u003C/span>\u003Cspan style=\"color:#B392F0\">call\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">arguments\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Chr>\n\u003Ch3 id=\"bind\">bind\u003C/h3>\n\u003Cp>bind：返回对应的函数，改变当前的this，便于稍后调用\napply, call:立即调用\u003C/p>\n\u003Cp>bind在事件使用的比较多。由于函数，如一些onclick事件是指向调用处的，如果想改变this，就需要用bind。ES6有箭头函数，因此可以代替bind\u003C/p>\n\u003Chr>\n\u003Cp>bind的使用方法：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.num \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mymodule \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        num: \u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">        getNum\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.num)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    mymodule.\u003C/span>\u003Cspan style=\"color:#B392F0\">getNum\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() \u003C/span>\u003Cspan style=\"color:#6A737D\">// 输出2，this指向mymodule\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> a \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mymoudule.getNum;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    a\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() \u003C/span>\u003Cspan style=\"color:#6A737D\">// 输出1，因为此时的this指向window\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 如果还是要输出2，那么：\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> b \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> a.\u003C/span>\u003Cspan style=\"color:#B392F0\">bind\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(mymodule)()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> b \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> a.\u003C/span>\u003Cspan style=\"color:#B392F0\">call\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(mymodule)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> b \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> a.\u003C/span>\u003Cspan style=\"color:#B392F0\">apply\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(mymodule)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>this：方法没有调用者的时候，this赋值为window，有的时候指向调用者。\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.num \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tnum: \u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tgetNum\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tconsole.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.num);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> y \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tnum: \u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\txgetnum: x.getNum,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tgetN\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">\t\tthis\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">xgetnum\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">x.\u003C/span>\u003Cspan style=\"color:#B392F0\">getNum\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() \u003C/span>\u003Cspan style=\"color:#6A737D\">//2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">y.\u003C/span>\u003Cspan style=\"color:#B392F0\">xgetnum\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() \u003C/span>\u003Cspan style=\"color:#6A737D\">//3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">y.\u003C/span>\u003Cspan style=\"color:#B392F0\">getN\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() \u003C/span>\u003Cspan style=\"color:#6A737D\">//3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// var z = y.getN\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// z() //报错，因为window下没有xgetnum\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> z \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x.getNum\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">z\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() \u003C/span>\u003Cspan style=\"color:#6A737D\">//在sublime text下执行node，会输出undefined，直接在node运行，得出1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>原因：Node在命令行条件下，this===global，而在文件环境下，Node的this被编译为{}。\u003C/p>\n\u003Chr>\n\u003Cul>\n\u003Cli>bind能否连环调用？ // 很多地方都用到了\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#B392F0\"> bar\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.x);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> foo \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        x : \u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> foo1 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        x : \u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> foo2 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        x : \u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> func \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> bar.\u003C/span>\u003Cspan style=\"color:#B392F0\">bind\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(foo)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    func\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 输出1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> func1 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> bar.\u003C/span>\u003Cspan style=\"color:#B392F0\">bind\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(foo).\u003C/span>\u003Cspan style=\"color:#B392F0\">bind\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(foo1)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 输出1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> func2 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> bar.\u003C/span>\u003Cspan style=\"color:#B392F0\">bind\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(foo).\u003C/span>\u003Cspan style=\"color:#B392F0\">bind\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(foo1).\u003C/span>\u003Cspan style=\"color:#B392F0\">bind\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(foo2)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 输出1\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>需要从bind的内部实现去理解。\n相当于循环嵌套了函数，比如第三个：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    this\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> foo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    function\u003C/span>\u003Cspan style=\"color:#B392F0\"> bar\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.x)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>第二次绑定：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    this\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> foo1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    function\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        this\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> foo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        function\u003C/span>\u003Cspan style=\"color:#B392F0\"> bar\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.x)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>…\n尽管经过再多次的绑定，结果依然是最初的结果。\u003C/p>\n\u003Chr>\n\u003Cp>收获：多学基础，了解底层，手撸原理。\u003C/p>",{"headings":106,"localImagePaths":112,"remoteImagePaths":113,"frontmatter":114,"imagePaths":116},[107,110],{"depth":81,"slug":108,"text":109},"call--apply","call & apply",{"depth":81,"slug":111,"text":111},"bind",[],[],{"title":97,"pubDate":115,"category":33,"excerpt":99},["Date","2019-06-21T15:58:43.000Z"],[],"javascript语言精粹读书笔记",{"id":117,"data":119,"body":123,"filePath":124,"digest":125,"rendered":126},{"title":120,"pubDate":121,"category":33,"excerpt":122},"Javascript语言精粹读书笔记",["Date","2019-08-15T16:22:08.000Z"],"Js语言精粹，一本小薄书的读书笔记，把一些感觉重要的内容记了下来。","前面是按章节列出的一些感觉比较重要的注意事项，每一个注意事项之后都附注有解释或者自己的思考，代码也会和原书不太一样。最后会写一些感想。加粗表示应当注意，斜体表示可能存疑。\n\n---\n### 语法部分\n#### 注释\n要精确描述代码，尽量避免采用/* */块注释，而使用//行注释代替。  \n> 原因：块注释对于被注释的代码块来说不安全，因为如果注释中包含有**正则表达式**则可能会出错。\n#### 变量命名\n不允许使用保留字作为变量名，比如for等，但是一些本应当作为保留字的却可以作为变量名，如undefined。\n> - 如果声明某一个变量名为undefined，会把原有的undefined覆盖掉。  \n> - 书上提到，保留字*不可以作为*对象的属性名，但是我在ES6中尝试将一个对象obj的属性命名为for，调用obj.for是可以得到输出的。总之，**避免敏感词**作为变量名或属性名。 \n#### 数字\n只有一个数字类型Number，在内部被表示为**64位浮点数**。  \nNaN表示一个不能产生正常结果的运算结果，**不等于任何值**，包括它自身，采用isNaN()检测NaN。  \nInfinity表示所有大于1.79769313486231570e+308的值，(这也是js表示数字的最大值)\n> - NaN和Infinity都是**Number类型**的值。NaN表示这是个**无效的数**，而Infinity就是数学上的**无穷**，**有正负**之分。  \n> - 两个值为NaN的变量**不相等**，但是两个值为Infinity的变量**相等**（也就是，所有超过某个数的值都被认定为同一个数），但是判断一个数是不是无穷，还是使用isFinite()函数更为恰当。\n> - 个人认为从数学角度理解这两个值会更好一些。比如1/0，得到的值是Infinity，因为如果令1/x取x趋向于0，会得到一个无穷大的值。而0/0得到的值是没有意义的，因为如果用极限的思路去考虑，这取决于分子和分母哪一个接近0的速度更快。因此，这个值是NaN。\n#### 声明与作用域\nvar语句被用在函数内部时，它定义的是这个函数的私有变量。（也就是说，ES5之前变量的作用域是函数作用域）\n> - ES6中定义了let关键字，使用let声明的变量作用域为块作用域，也就是一对花括号之间。而var声明的变量作用域依然为函数作用域，也就是在一个函数内部。\n#### 表达式\n``` javascript\n    false, null, undefined, '', 0, NaN\n```\n的值会被当做假值。\n> ES6定义了七种数据类型：Boolean, null, undefined, String, Number, Symbol, Object，其中前六种为简单类型，Object也就是对象，是引用类型。可以简单的记为，前五种类型的**默认空值**都被视为假，而任意的Symbol(独一无二的变量名)和任意的Object(对象)都是真的。\n#### for语句\nfor in语句会枚举一个对象的所有属性名（或者键名），包括来自**原型链**中的属性。\n> js的for in对数组来说遍历的是下标，对对象来说是遍历每一个属性。ES6中新加了for of语句，可以取出迭代对象的每一个值，和python的for in类似。\n#### return语句\n当没有指定返回表达式时，返回值是undefined\n#### typeof运算符\n该运算符可以产生的值有\n``` javascript\n    boolean, undefined, string, number, symbol, object, function\n```\n也就是说，typeof运算符会将null和数组识别成对象object。\n\n#### 逻辑与或\n逻辑或返回第一个为真的运算数的值，或最后一个值。\n\n--- \n### 关于对象\n#### 对象是什么\n对象是可变的**键控集合(keyed collections)**，是属性的容器。除了简单数据类型外，其他所有的值都是对象。对象的属性值可以是*除了undefined外*的任意值。\n> 在node环境下，给对象的属性取名叫null和undefined都没有问题，不过还是尽量**避免敏感词**。\n#### 对象字面量\n就是包裹在一对花括号中的键值对。其中，属性名可以是任意字符串，如果属性名是一个合法的标识符，那么可以不用引号括住属性名。\n> 也就是说，使用引号围起来的属性和不使用引号围起来的属性是**相同**的，都可以用.操作符和[]操作符去访问属性的值。但是.操作符只能访问是合法的标识符的属性。\n#### 对象的检索\n检索一个不存在的属性时，将会返回undefined，从undefined中检索属性时，会报错。\n> 从null中检索属性时，也会出现TypeError异常。对于其他简单数据类型，因为js默认给他们进行了包装，所以不会报错，检索不存在的属性时会返回undefined。\n#### 对象的更新\n如果对象没有某个属性名，会将属性扩充到对象中。\n#### 对象的引用\n对象之间的赋值是通过引用的方式，也就是传递地址。\n> 对于其他简单数据类型，对象之间的赋值是值传递(ES6新定义的Symbol类型也是值传递)。\n#### 对象的原型\n每个对象都连接到一个原型对象，通过字面量直接创建的对象连接到Object.prototype。\n#### 关于全局变量\n为了减少全局变量污染，可以采用两种方法：a) 只创建一个唯一的全局变量 b) 使用闭包进行信息隐藏\n\n---\n### 关于函数\n#### 函数是对象\n函数对象在创建时连接到Function.prototype。由于函数也是对象，因此函数内部也可以定义函数。\n#### 匿名函数\n函数可以没有名字，这样的函数称为**匿名函数**。\n#### 函数调用的四种模式  \n##### 方法调用模式\n函数作为对象的属性被调用(写在冒号前边)，这种函数也被称为**方法**。  \n这种情况下，this到对象的绑定发生在函数被调用的时候。\n    > - 如果既说明了属性名，也说明了函数名，那么使用这两种方法引用函数字面量都是可以的，如下面这个例子。\n    ```javascript\n        // 以递归的方式完成倒计数\n        var obj = {\n            func: function f(value){\n                console.log(value)\n                if(value){\n                    return true;\n                }\n                return this.func(--value);\n                // 下面的方式也是可以的\n                return f(--value)\n            }\n        }\n        obj.func(3)\n    ```\n    > - 需要注意的是，从obj对象访问该函数，只能使用obj.func()函数，因为对于obj对象来说，它只能识别func属性的存在。  \n    > - 在递归调用时，如果使用this.func()进行递归，那么之后相当于还是引用obj对象的func属性，因此这个时候递归之后函数内部的this指向的还是obj。  \n    > - 而如果在函数内部使用f()进行递归，那么之后相当于是使用了下面提到的 b) 函数调用模式进行调用，因此这个时候递归之后函数内部的this指向的是全局对象(在node环境中就是global)\n    > - 总之，将函数作为对象的属性时，如果不想引起this指向错乱，还是将函数写成**匿名函数**，调用时使用**this**更合适，从而避免引起一系列不必要的问题。  \n\n##### 函数调用模式\n直接声明函数，而不作为对象属性的值  \n    这种情况下，this直接被绑定到全局变量。(也就是上边例子中的f)\n    > 这会导致，方法中如果定义内部函数，会导致this指针指向全局变量。解决的办法有三种：  \n    > - 在方法中定义变量**that**指向this，并在内部函数中使用that进行操作。\n    > - 在函数字面量之后使用.bind(this)绑定this指针。\n    > - ES6中的箭头函数(箭头函数的this指向**函数定义**时的this值，而不是调用时的)。\n\n##### 构造器调用模式  \n    > 调用时使用new，然后这个函数相当于一个构造函数。（具体细节在下一章中）\n##### apply调用模式\n#### 函数的参数\n函数有一个默认的arguments参数，用来获得传递过来的所有参数。\n> arguments参数**不是**一个**真正**的数组。它虽然有length，也可以按下标访问，但是它**没有**任何数组的方法。这是一个设计错误。\n#### 返回值\n- 如果函数没有指定返回值，返回undefined\n- 如果采用构造器调用模式：\n    - 返回值不是对象时（其他六种简单类型的变量），默认返回this\n    - 返回值是对象时（包括数组，函数等等），返回指定对象\n\n> 在构造器函数中，如果不写返回值，相当于在最后一行加了一句，return undefined，而根据构造器调用模式的规则，最终返回的值是this.\n#### 异常\n##### throw\n抛出一个异常对象，该对象基本结构为：\n```javascript\n{\n    name: '错误类型',\n    message: '错误提示'\n}\n```\n也可以添加其他属性。\n##### try-catch-finally：\ntry用来执行代码块，如果出现异常跳转到catch语句内捕获，然后执行finally。finally块中内容一定会被执行。\n#### 闭包：函数可以访问被创建时的上下文环境，就是闭包。\n> 对于定义在函数内部的函数，它可以访问被创建时的上下文环境，也就是外部函数的参数，定义的变量等。因此它是一个闭包。  \n> 时刻注意：内部函数可以访问外部函数中的实际变量，而**不需要复制**。\n举例说明如下：\n```javascript\n    var f = function(n){\n    var result = []\n    for (var i = 0; i \u003C n; ++i){\n        result[i] = function(){\n            console.log(i);\n        }\n    }\n    return result;\n}\n\nvar result = f(4);\nfor(let fi in result){\n    result[fi](); // 4 4 4 4\n}\n```\n> f函数：意图是返回一个顺序输出的数组。但是，由于result[i]是定义了一个新的内部函数，而内部函数保持着对外部函数实际变量(也就是i)的引用，因此最终，内部函数引用的i是最后一次循环完毕后i的值，也就是4.   \n> 而在每一次for循环中，result[i]相当于是将i传入result中，因此是一个类似函数参数传递的操作，而非访问外部变量的操作，因此不会有错误。\n\n```javascript\nvar f = function(n){\n    var result = []\n    for (let i = 0; i \u003C n; ++i){\n        result[i] = function(){\n            console.log(i);\n        }\n    }\n    return result;\n}\n\nvar result = f(4);\nfor(let fi in result){\n    result[fi](); // 0 1 2 3\n}\n```\n> (ES6)将var改成let之后，相当于每次循环都重新定义了i，这个i与上一个i是不一样的。因此，函数内部的i引用的是外部的不同的i，因此可以得到正确的结果。\n\n```javascript\nvar f = function(n){\n    var result = []\n    for (var i = 0; i \u003C n; ++i){\n        (function(i){\n            result[i] = function(){\n                console.log(i)\n            }\n        })(i);\n    }\n    return result;\n}\n\nvar result = f(4);\nfor(let fi in result){\n    result[fi](); // 0 1 2 3\n}\n```\n> (书上推荐的方式)这种情况下也能得到正确结果。因为内部定义了一个匿名自执行函数，所以内部引用的i是每一次执行得到的形参i，相当于是把外部的i每次都复制给了一个新的值，然后引用，所以这样在console.log(i)使用时可以得到正确的i。\n\n```javascript\nvar f = function(n){\n    var result = []\n    for (var i = 0; i \u003C n; ++i){\n        result[i] = function(i){\n            console.log(i);\n        }.bind(this, i)\n    }\n    return result;\n}\n\nvar result = f(4);\nfor(let fi in result){\n    result[fi](); // 0 1 2 3\n}\n```\n> (自己想的方式)这种方式也是正确的。利用bind，首先每个result内还是一个函数，其次由于bind的作用，函数内部引用的i是经过传参得到的，也就是说引用的并不是外部的那同一个i。\n#### 模块\n提供**接口**，但是**隐藏状态与实现**的**函数或对象**。  \n- 模块模式的一般形式：一个定义了私有变量和函数的函数，利用闭包创建可以访问私有变量和函数的特权函数，最后返回这个特权函数，或将它保存到一个可以访问到的地方。\n- 模块模式通常和单例模式结合使用。\n#### 记忆\n这可以说是代码的一种优化形式，将可能重复计算的值保存起来，从而避免无谓的计算。这个缓存可以写在闭包内，从而不被外部读取。\n\n---\n\n### 继承\n#### 使用构造器调用模式的执行方式：  \na) 创建一个新对象，继承构造器函数的prototype。  \nb) 调用构造器函数，将this绑定到新对象上。(执行构造函数。)   \nc) 构造函数的返回值:如果不是对象类型，则返回创建的新对象。\n#### 继承父类\n可以通过实例化一个父类对象，并将子类的prototype该指向父类对象即可。\n> 这样一来，this.prototype就相当于this.parent，可以调用父类的方法。\n\n---\n### 数组\n1. js中没有其他语言的数组（如C）类似的数据结构，但是提供了一种类数组特性的对象。它将数组的下标转变成字符串。它比真正的数组慢，但是使用起来更加方便。\n> - 也就是说，定义一个数组：var a = [1,2,3];，其实a的值相当于{'0':1, '1':2, '2':3}，假定要访问第0个元素，那么a[0]和a['0']都是可以的。由于0不是一个合法的标识符名，因此不能用a.0来访问。  \n> - 如果采用对象字面量的方式来定义数组，那么它与使用[]定义的数组有所不同：首先，使用对象字面量构建的对象继承自Object.prototype，而使用[]定义的对象继承自Array.prototype，并且使用对象字面量的方式定义的“数组”没有length属性。\n2. length不一定是数组里所有属性的个数，而是最大的整数属性名+1。  \n3. 属性名是小而连续的整数时，使用数组，否则使用对象。\n---\n### 方法\n这一章主要讲的是js中预先定义好的一些方法。\n- array.sort(fn)：js中数组的排序默认是将元素全部作为**字符串**，因此如果需要比较数字的时候，需要自己定义比较函数。比较函数有两个参数，如果希望第一个排在前面，则返回负数，否则返回正数。sort函数**不稳定**。\n```javascript\n    var a = [1,2,3,11,14,25];\n    console.log(a.sort()); // [ 1, 11, 14, 2, 25, 3 ]\n```\n```javascript\n    var a = [1,2,3,11,14,25];\n    console.log(a.sort(function(a, b){\n        return (a > b) ? 1 : -1; // [ 1, 2, 3, 11, 14, 25 ]\n    }))\n```\n\n---\n### 毒瘤\n#### 全局变量  \n定义全局变量的方式有三种：在任何函数之外使用var定义变量；使用window/global定义变量；使用未声明的变量（隐式的全局变量）。\n\n#### 作用域  \n最好在每个函数定义开始时，将所有变量列出来。\n\n#### 自动插入分号  \njs的自动修复机制：自动插入分号，来修复有缺损的程序，但是这样可能出现问题，比如：\n```javascript\n    return \n    {\n        status: true;\n    }\n```\n返回始终是undefined。因为自动插入分号，使得return后边多了个分号。  \n> 所以从代码风格角度考虑，应该把花括号写在return的同一行\n#### typeof  \ntypeof运算符返回一个用来识别运算数类型的字符串。但是：  \n- 它无法识别null与对象；\n- typeof NaN === number，而NaN并不是一个数字，只是属于number类型而已；\n- typeof array === object；\n- 对于正则表达式，typeof的结果可能不一致。\n\n#### parseInt  \nparseInt函数在遇到非数字时会**停止解析**，并且不会提示。  \n如果要解析的字符串第一个字符是0，那么就会*当作八进制*进行处理。\n> ES5严格模式中，八进制不允许用前缀0表示，所以在node环境下测试，0开头的字符串可以得到正确结果。ES6进一步明确，使用前缀0o表示；二进制使用0b表示。\n> parseInt在ES6中被定义在了Number类中，但是直接使用全局的也可以。\n#### 浮点数\n二进制的浮点数不能正确的处理十进制的小数。但是**整数**不会出现问题。\n#### NaN\nNaN不等同于它自己，判断是否是NaN使用isNaN函数。判断一个数是否为有效的数字，可以使用isFinite函数。\n- isNaN和isFinite如果遇到非数字输入，都会先将其尝试转化为数字，再进行判断。因此，得到的不一定是预期的结果：\n```javascript\n    isNaN('NaN'); //true\n```\n> ES6提供了Number.isNaN和Number.isFinite两个函数，对于不是数字类型的参数，直接返回false\n\n#### hasOwnProperty\n注意它可能会被替换，因为它是一个函数，而非运算符。\n#### 对象  \njs中的对象永远不可能是真正的空对象。因为对象可以从原型链中获取属性。所以当使用对象时，需要当心是否与原型链中的属性**重名**。\n\n### 糟粕\n#### ==  \n永远不要使用==和!=运算符，尽量使用===和!==代替。  \n==会在类型不同时进行强制类型转换，这个规则极其的复杂，并且在某些情况下不满足传递性。\n#### with  \nwith语句是设置代码在特定对象中的作用域，也就是限定with(obj){state}的state部分的作用域改为obj，但是**不会改变this指针**。\n> 避免使用：因为效率低，比较混乱，并且可能会导致兼容性问题。\n#### eval\n避免使用eval，它会导致代码更难以阅读。\n- 避免使用Function构造器，因为它是eval的另一种形式。\n- 避免使用setInterval和setTimeout的字符串参数。\n\n#### continue\ncontinue语句对性能不利，尽量避免\n#### switch穿越\n每个case下都应该跟一个break;\n#### 代码块\n尽量采用花括号将代码块括起来。\n#### ++和-\\-\n尽可能避免使用。\n#### 位运算符\n尽量避免使用位运算符。因为js没有整数类型，只有双精度浮点数，因此在进行位操作时会先把浮点数转化位整数。\n#### function语句/function表达式\n一个function语句相当于一个function表达式。  \n一个语句不能以函数表达式开头，否则会被认定为一个function语句。\n#### 类型的包装对象  \njs有一套类型的包装对象，这个对象有一个valueOf方法会返回被包装的对象的值。这没有必要，应当避免使用。  \n#### void\nvoid接收一个参数，返回undefined，没什么用，不需要去使用。\n\n\n---\n### 总结\n这本书介绍了js的一些语法、用法以及注意事项。除此之外，作者还列出了js的一些精华和糟粕（但是感觉好像糟粕更多啊..，不过话说回来，这些精华确实非常的小巧和具有表现力），之后写代码的过程中需要尽量的避免使用到书中提到的糟粕，保持良好的代码习惯。","src/content/posts/Javascript语言精粹读书笔记.md","96358cd3a2266d15",{"html":127,"metadata":128},"\u003Cp>前面是按章节列出的一些感觉比较重要的注意事项，每一个注意事项之后都附注有解释或者自己的思考，代码也会和原书不太一样。最后会写一些感想。加粗表示应当注意，斜体表示可能存疑。\u003C/p>\n\u003Chr>\n\u003Ch3 id=\"语法部分\">语法部分\u003C/h3>\n\u003Ch4 id=\"注释\">注释\u003C/h4>\n\u003Cp>要精确描述代码，尽量避免采用/* */块注释，而使用//行注释代替。\u003C/p>\n\u003Cblockquote>\n\u003Cp>原因：块注释对于被注释的代码块来说不安全，因为如果注释中包含有\u003Cstrong>正则表达式\u003C/strong>则可能会出错。\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"变量命名\">变量命名\u003C/h4>\n\u003Cp>不允许使用保留字作为变量名，比如for等，但是一些本应当作为保留字的却可以作为变量名，如undefined。\u003C/p>\n\u003Cblockquote>\n\u003Cul>\n\u003Cli>如果声明某一个变量名为undefined，会把原有的undefined覆盖掉。\u003C/li>\n\u003Cli>书上提到，保留字\u003Cem>不可以作为\u003C/em>对象的属性名，但是我在ES6中尝试将一个对象obj的属性命名为for，调用obj.for是可以得到输出的。总之，\u003Cstrong>避免敏感词\u003C/strong>作为变量名或属性名。\u003C/li>\n\u003C/ul>\n\u003C/blockquote>\n\u003Ch4 id=\"数字\">数字\u003C/h4>\n\u003Cp>只有一个数字类型Number，在内部被表示为\u003Cstrong>64位浮点数\u003C/strong>。\u003Cbr>\nNaN表示一个不能产生正常结果的运算结果，\u003Cstrong>不等于任何值\u003C/strong>，包括它自身，采用isNaN()检测NaN。\u003Cbr>\nInfinity表示所有大于1.79769313486231570e+308的值，(这也是js表示数字的最大值)\u003C/p>\n\u003Cblockquote>\n\u003Cul>\n\u003Cli>NaN和Infinity都是\u003Cstrong>Number类型\u003C/strong>的值。NaN表示这是个\u003Cstrong>无效的数\u003C/strong>，而Infinity就是数学上的\u003Cstrong>无穷\u003C/strong>，\u003Cstrong>有正负\u003C/strong>之分。\u003C/li>\n\u003Cli>两个值为NaN的变量\u003Cstrong>不相等\u003C/strong>，但是两个值为Infinity的变量\u003Cstrong>相等\u003C/strong>（也就是，所有超过某个数的值都被认定为同一个数），但是判断一个数是不是无穷，还是使用isFinite()函数更为恰当。\u003C/li>\n\u003Cli>个人认为从数学角度理解这两个值会更好一些。比如1/0，得到的值是Infinity，因为如果令1/x取x趋向于0，会得到一个无穷大的值。而0/0得到的值是没有意义的，因为如果用极限的思路去考虑，这取决于分子和分母哪一个接近0的速度更快。因此，这个值是NaN。\u003C/li>\n\u003C/ul>\n\u003C/blockquote>\n\u003Ch4 id=\"声明与作用域\">声明与作用域\u003C/h4>\n\u003Cp>var语句被用在函数内部时，它定义的是这个函数的私有变量。（也就是说，ES5之前变量的作用域是函数作用域）\u003C/p>\n\u003Cblockquote>\n\u003Cul>\n\u003Cli>ES6中定义了let关键字，使用let声明的变量作用域为块作用域，也就是一对花括号之间。而var声明的变量作用域依然为函数作用域，也就是在一个函数内部。\u003C/li>\n\u003C/ul>\n\u003C/blockquote>\n\u003Ch4 id=\"表达式\">表达式\u003C/h4>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">null\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">undefined\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">NaN\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>的值会被当做假值。\u003C/p>\n\u003Cblockquote>\n\u003Cp>ES6定义了七种数据类型：Boolean, null, undefined, String, Number, Symbol, Object，其中前六种为简单类型，Object也就是对象，是引用类型。可以简单的记为，前五种类型的\u003Cstrong>默认空值\u003C/strong>都被视为假，而任意的Symbol(独一无二的变量名)和任意的Object(对象)都是真的。\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"for语句\">for语句\u003C/h4>\n\u003Cp>for in语句会枚举一个对象的所有属性名（或者键名），包括来自\u003Cstrong>原型链\u003C/strong>中的属性。\u003C/p>\n\u003Cblockquote>\n\u003Cp>js的for in对数组来说遍历的是下标，对对象来说是遍历每一个属性。ES6中新加了for of语句，可以取出迭代对象的每一个值，和python的for in类似。\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"return语句\">return语句\u003C/h4>\n\u003Cp>当没有指定返回表达式时，返回值是undefined\u003C/p>\n\u003Ch4 id=\"typeof运算符\">typeof运算符\u003C/h4>\n\u003Cp>该运算符可以产生的值有\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    boolean, \u003C/span>\u003Cspan style=\"color:#79B8FF\">undefined\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, string, number, symbol, object, \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>也就是说，typeof运算符会将null和数组识别成对象object。\u003C/p>\n\u003Ch4 id=\"逻辑与或\">逻辑与或\u003C/h4>\n\u003Cp>逻辑或返回第一个为真的运算数的值，或最后一个值。\u003C/p>\n\u003Chr>\n\u003Ch3 id=\"关于对象\">关于对象\u003C/h3>\n\u003Ch4 id=\"对象是什么\">对象是什么\u003C/h4>\n\u003Cp>对象是可变的\u003Cstrong>键控集合(keyed collections)\u003C/strong>，是属性的容器。除了简单数据类型外，其他所有的值都是对象。对象的属性值可以是\u003Cem>除了undefined外\u003C/em>的任意值。\u003C/p>\n\u003Cblockquote>\n\u003Cp>在node环境下，给对象的属性取名叫null和undefined都没有问题，不过还是尽量\u003Cstrong>避免敏感词\u003C/strong>。\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"对象字面量\">对象字面量\u003C/h4>\n\u003Cp>就是包裹在一对花括号中的键值对。其中，属性名可以是任意字符串，如果属性名是一个合法的标识符，那么可以不用引号括住属性名。\u003C/p>\n\u003Cblockquote>\n\u003Cp>也就是说，使用引号围起来的属性和不使用引号围起来的属性是\u003Cstrong>相同\u003C/strong>的，都可以用.操作符和[]操作符去访问属性的值。但是.操作符只能访问是合法的标识符的属性。\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"对象的检索\">对象的检索\u003C/h4>\n\u003Cp>检索一个不存在的属性时，将会返回undefined，从undefined中检索属性时，会报错。\u003C/p>\n\u003Cblockquote>\n\u003Cp>从null中检索属性时，也会出现TypeError异常。对于其他简单数据类型，因为js默认给他们进行了包装，所以不会报错，检索不存在的属性时会返回undefined。\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"对象的更新\">对象的更新\u003C/h4>\n\u003Cp>如果对象没有某个属性名，会将属性扩充到对象中。\u003C/p>\n\u003Ch4 id=\"对象的引用\">对象的引用\u003C/h4>\n\u003Cp>对象之间的赋值是通过引用的方式，也就是传递地址。\u003C/p>\n\u003Cblockquote>\n\u003Cp>对于其他简单数据类型，对象之间的赋值是值传递(ES6新定义的Symbol类型也是值传递)。\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"对象的原型\">对象的原型\u003C/h4>\n\u003Cp>每个对象都连接到一个原型对象，通过字面量直接创建的对象连接到Object.prototype。\u003C/p>\n\u003Ch4 id=\"关于全局变量\">关于全局变量\u003C/h4>\n\u003Cp>为了减少全局变量污染，可以采用两种方法：a) 只创建一个唯一的全局变量 b) 使用闭包进行信息隐藏\u003C/p>\n\u003Chr>\n\u003Ch3 id=\"关于函数\">关于函数\u003C/h3>\n\u003Ch4 id=\"函数是对象\">函数是对象\u003C/h4>\n\u003Cp>函数对象在创建时连接到Function.prototype。由于函数也是对象，因此函数内部也可以定义函数。\u003C/p>\n\u003Ch4 id=\"匿名函数\">匿名函数\u003C/h4>\n\u003Cp>函数可以没有名字，这样的函数称为\u003Cstrong>匿名函数\u003C/strong>。\u003C/p>\n\u003Ch4 id=\"函数调用的四种模式\">函数调用的四种模式\u003C/h4>\n\u003Ch5 id=\"方法调用模式\">方法调用模式\u003C/h5>\n\u003Cp>函数作为对象的属性被调用(写在冒号前边)，这种函数也被称为\u003Cstrong>方法\u003C/strong>。\u003Cbr>\n这种情况下，this到对象的绑定发生在函数被调用的时候。\n> - 如果既说明了属性名，也说明了函数名，那么使用这两种方法引用函数字面量都是可以的，如下面这个例子。\n\u003Ccode>javascript         // 以递归的方式完成倒计数         var obj = {             func: function f(value){                 console.log(value)                 if(value){                     return true;                 }                 return this.func(--value);                 // 下面的方式也是可以的                 return f(--value)             }         }         obj.func(3)     \u003C/code>\n> - 需要注意的是，从obj对象访问该函数，只能使用obj.func()函数，因为对于obj对象来说，它只能识别func属性的存在。\u003Cbr>\n> - 在递归调用时，如果使用this.func()进行递归，那么之后相当于还是引用obj对象的func属性，因此这个时候递归之后函数内部的this指向的还是obj。\u003Cbr>\n> - 而如果在函数内部使用f()进行递归，那么之后相当于是使用了下面提到的 b) 函数调用模式进行调用，因此这个时候递归之后函数内部的this指向的是全局对象(在node环境中就是global)\n> - 总之，将函数作为对象的属性时，如果不想引起this指向错乱，还是将函数写成\u003Cstrong>匿名函数\u003C/strong>，调用时使用\u003Cstrong>this\u003C/strong>更合适，从而避免引起一系列不必要的问题。\u003C/p>\n\u003Ch5 id=\"函数调用模式\">函数调用模式\u003C/h5>\n\u003Cp>直接声明函数，而不作为对象属性的值\u003Cbr>\n这种情况下，this直接被绑定到全局变量。(也就是上边例子中的f)\n> 这会导致，方法中如果定义内部函数，会导致this指针指向全局变量。解决的办法有三种：\u003Cbr>\n> - 在方法中定义变量\u003Cstrong>that\u003C/strong>指向this，并在内部函数中使用that进行操作。\n> - 在函数字面量之后使用.bind(this)绑定this指针。\n> - ES6中的箭头函数(箭头函数的this指向\u003Cstrong>函数定义\u003C/strong>时的this值，而不是调用时的)。\u003C/p>\n\u003Ch5 id=\"构造器调用模式\">构造器调用模式\u003C/h5>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>> 调用时使用new，然后这个函数相当于一个构造函数。（具体细节在下一章中）\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch5 id=\"apply调用模式\">apply调用模式\u003C/h5>\n\u003Ch4 id=\"函数的参数\">函数的参数\u003C/h4>\n\u003Cp>函数有一个默认的arguments参数，用来获得传递过来的所有参数。\u003C/p>\n\u003Cblockquote>\n\u003Cp>arguments参数\u003Cstrong>不是\u003C/strong>一个\u003Cstrong>真正\u003C/strong>的数组。它虽然有length，也可以按下标访问，但是它\u003Cstrong>没有\u003C/strong>任何数组的方法。这是一个设计错误。\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"返回值\">返回值\u003C/h4>\n\u003Cul>\n\u003Cli>如果函数没有指定返回值，返回undefined\u003C/li>\n\u003Cli>如果采用构造器调用模式：\n\u003Cul>\n\u003Cli>返回值不是对象时（其他六种简单类型的变量），默认返回this\u003C/li>\n\u003Cli>返回值是对象时（包括数组，函数等等），返回指定对象\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cblockquote>\n\u003Cp>在构造器函数中，如果不写返回值，相当于在最后一行加了一句，return undefined，而根据构造器调用模式的规则，最终返回的值是this.\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"异常\">异常\u003C/h4>\n\u003Ch5 id=\"throw\">throw\u003C/h5>\n\u003Cp>抛出一个异常对象，该对象基本结构为：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    name\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'错误类型'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    message\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'错误提示'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>也可以添加其他属性。\u003C/p>\n\u003Ch5 id=\"try-catch-finally\">try-catch-finally：\u003C/h5>\n\u003Cp>try用来执行代码块，如果出现异常跳转到catch语句内捕获，然后执行finally。finally块中内容一定会被执行。\u003C/p>\n\u003Ch4 id=\"闭包函数可以访问被创建时的上下文环境就是闭包\">闭包：函数可以访问被创建时的上下文环境，就是闭包。\u003C/h4>\n\u003Cblockquote>\n\u003Cp>对于定义在函数内部的函数，它可以访问被创建时的上下文环境，也就是外部函数的参数，定义的变量等。因此它是一个闭包。\u003Cbr>\n时刻注意：内部函数可以访问外部函数中的实际变量，而\u003Cstrong>不需要复制\u003C/strong>。\n举例说明如下：\u003C/p>\n\u003C/blockquote>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#B392F0\"> f\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">n\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; i \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> n; \u003C/span>\u003Cspan style=\"color:#F97583\">++\u003C/span>\u003Cspan style=\"color:#E1E4E8\">i){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        result[i] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(i);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> f\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fi \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result[fi](); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 4 4 4 4\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>f函数：意图是返回一个顺序输出的数组。但是，由于result[i]是定义了一个新的内部函数，而内部函数保持着对外部函数实际变量(也就是i)的引用，因此最终，内部函数引用的i是最后一次循环完毕后i的值，也就是4.\u003Cbr>\n而在每一次for循环中，result[i]相当于是将i传入result中，因此是一个类似函数参数传递的操作，而非访问外部变量的操作，因此不会有错误。\u003C/p>\n\u003C/blockquote>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#B392F0\"> f\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">n\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; i \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> n; \u003C/span>\u003Cspan style=\"color:#F97583\">++\u003C/span>\u003Cspan style=\"color:#E1E4E8\">i){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        result[i] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(i);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> f\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fi \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result[fi](); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 0 1 2 3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>(ES6)将var改成let之后，相当于每次循环都重新定义了i，这个i与上一个i是不一样的。因此，函数内部的i引用的是外部的不同的i，因此可以得到正确的结果。\u003C/p>\n\u003C/blockquote>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#B392F0\"> f\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">n\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; i \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> n; \u003C/span>\u003Cspan style=\"color:#F97583\">++\u003C/span>\u003Cspan style=\"color:#E1E4E8\">i){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        (\u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">i\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            result[i] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(i)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        })(i);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> f\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fi \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result[fi](); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 0 1 2 3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>(书上推荐的方式)这种情况下也能得到正确结果。因为内部定义了一个匿名自执行函数，所以内部引用的i是每一次执行得到的形参i，相当于是把外部的i每次都复制给了一个新的值，然后引用，所以这样在console.log(i)使用时可以得到正确的i。\u003C/p>\n\u003C/blockquote>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#B392F0\"> f\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">n\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; i \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> n; \u003C/span>\u003Cspan style=\"color:#F97583\">++\u003C/span>\u003Cspan style=\"color:#E1E4E8\">i){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        result[i] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">i\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(i);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }.\u003C/span>\u003Cspan style=\"color:#B392F0\">bind\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, i)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> f\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fi \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result[fi](); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 0 1 2 3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>(自己想的方式)这种方式也是正确的。利用bind，首先每个result内还是一个函数，其次由于bind的作用，函数内部引用的i是经过传参得到的，也就是说引用的并不是外部的那同一个i。\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"模块\">模块\u003C/h4>\n\u003Cp>提供\u003Cstrong>接口\u003C/strong>，但是\u003Cstrong>隐藏状态与实现\u003C/strong>的\u003Cstrong>函数或对象\u003C/strong>。\u003C/p>\n\u003Cul>\n\u003Cli>模块模式的一般形式：一个定义了私有变量和函数的函数，利用闭包创建可以访问私有变量和函数的特权函数，最后返回这个特权函数，或将它保存到一个可以访问到的地方。\u003C/li>\n\u003Cli>模块模式通常和单例模式结合使用。\u003C/li>\n\u003C/ul>\n\u003Ch4 id=\"记忆\">记忆\u003C/h4>\n\u003Cp>这可以说是代码的一种优化形式，将可能重复计算的值保存起来，从而避免无谓的计算。这个缓存可以写在闭包内，从而不被外部读取。\u003C/p>\n\u003Chr>\n\u003Ch3 id=\"继承\">继承\u003C/h3>\n\u003Ch4 id=\"使用构造器调用模式的执行方式\">使用构造器调用模式的执行方式：\u003C/h4>\n\u003Cp>a) 创建一个新对象，继承构造器函数的prototype。\u003Cbr>\nb) 调用构造器函数，将this绑定到新对象上。(执行构造函数。)\u003Cbr>\nc) 构造函数的返回值:如果不是对象类型，则返回创建的新对象。\u003C/p>\n\u003Ch4 id=\"继承父类\">继承父类\u003C/h4>\n\u003Cp>可以通过实例化一个父类对象，并将子类的prototype该指向父类对象即可。\u003C/p>\n\u003Cblockquote>\n\u003Cp>这样一来，this.prototype就相当于this.parent，可以调用父类的方法。\u003C/p>\n\u003C/blockquote>\n\u003Chr>\n\u003Ch3 id=\"数组\">数组\u003C/h3>\n\u003Col>\n\u003Cli>js中没有其他语言的数组（如C）类似的数据结构，但是提供了一种类数组特性的对象。它将数组的下标转变成字符串。它比真正的数组慢，但是使用起来更加方便。\u003C/li>\n\u003C/ol>\n\u003Cblockquote>\n\u003Cul>\n\u003Cli>也就是说，定义一个数组：var a = [1,2,3];，其实a的值相当于{‘0’:1, ‘1’:2, ‘2’:3}，假定要访问第0个元素，那么a[0]和a[‘0’]都是可以的。由于0不是一个合法的标识符名，因此不能用a.0来访问。\u003C/li>\n\u003Cli>如果采用对象字面量的方式来定义数组，那么它与使用[]定义的数组有所不同：首先，使用对象字面量构建的对象继承自Object.prototype，而使用[]定义的对象继承自Array.prototype，并且使用对象字面量的方式定义的“数组”没有length属性。\u003C/li>\n\u003C/ul>\n\u003C/blockquote>\n\u003Col start=\"2\">\n\u003Cli>length不一定是数组里所有属性的个数，而是最大的整数属性名+1。\u003C/li>\n\u003Cli>属性名是小而连续的整数时，使用数组，否则使用对象。\u003C/li>\n\u003C/ol>\n\u003Chr>\n\u003Ch3 id=\"方法\">方法\u003C/h3>\n\u003Cp>这一章主要讲的是js中预先定义好的一些方法。\u003C/p>\n\u003Cul>\n\u003Cli>array.sort(fn)：js中数组的排序默认是将元素全部作为\u003Cstrong>字符串\u003C/strong>，因此如果需要比较数字的时候，需要自己定义比较函数。比较函数有两个参数，如果希望第一个排在前面，则返回负数，否则返回正数。sort函数\u003Cstrong>不稳定\u003C/strong>。\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> a \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">11\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">14\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">25\u003C/span>\u003Cspan style=\"color:#E1E4E8\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(a.\u003C/span>\u003Cspan style=\"color:#B392F0\">sort\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()); \u003C/span>\u003Cspan style=\"color:#6A737D\">// [ 1, 11, 14, 2, 25, 3 ]\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> a \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">11\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">14\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#79B8FF\">25\u003C/span>\u003Cspan style=\"color:#E1E4E8\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(a.\u003C/span>\u003Cspan style=\"color:#B392F0\">sort\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">a\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">b\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (a \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> b) \u003C/span>\u003Cspan style=\"color:#F97583\">?\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#F97583\"> :\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; \u003C/span>\u003Cspan style=\"color:#6A737D\">// [ 1, 2, 3, 11, 14, 25 ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }))\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Chr>\n\u003Ch3 id=\"毒瘤\">毒瘤\u003C/h3>\n\u003Ch4 id=\"全局变量\">全局变量\u003C/h4>\n\u003Cp>定义全局变量的方式有三种：在任何函数之外使用var定义变量；使用window/global定义变量；使用未声明的变量（隐式的全局变量）。\u003C/p>\n\u003Ch4 id=\"作用域\">作用域\u003C/h4>\n\u003Cp>最好在每个函数定义开始时，将所有变量列出来。\u003C/p>\n\u003Ch4 id=\"自动插入分号\">自动插入分号\u003C/h4>\n\u003Cp>js的自动修复机制：自动插入分号，来修复有缺损的程序，但是这样可能出现问题，比如：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">        status\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>返回始终是undefined。因为自动插入分号，使得return后边多了个分号。\u003C/p>\n\u003Cblockquote>\n\u003Cp>所以从代码风格角度考虑，应该把花括号写在return的同一行\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"typeof\">typeof\u003C/h4>\n\u003Cp>typeof运算符返回一个用来识别运算数类型的字符串。但是：\u003C/p>\n\u003Cul>\n\u003Cli>它无法识别null与对象；\u003C/li>\n\u003Cli>typeof NaN === number，而NaN并不是一个数字，只是属于number类型而已；\u003C/li>\n\u003Cli>typeof array === object；\u003C/li>\n\u003Cli>对于正则表达式，typeof的结果可能不一致。\u003C/li>\n\u003C/ul>\n\u003Ch4 id=\"parseint\">parseInt\u003C/h4>\n\u003Cp>parseInt函数在遇到非数字时会\u003Cstrong>停止解析\u003C/strong>，并且不会提示。\u003Cbr>\n如果要解析的字符串第一个字符是0，那么就会\u003Cem>当作八进制\u003C/em>进行处理。\u003C/p>\n\u003Cblockquote>\n\u003Cp>ES5严格模式中，八进制不允许用前缀0表示，所以在node环境下测试，0开头的字符串可以得到正确结果。ES6进一步明确，使用前缀0o表示；二进制使用0b表示。\nparseInt在ES6中被定义在了Number类中，但是直接使用全局的也可以。\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"浮点数\">浮点数\u003C/h4>\n\u003Cp>二进制的浮点数不能正确的处理十进制的小数。但是\u003Cstrong>整数\u003C/strong>不会出现问题。\u003C/p>\n\u003Ch4 id=\"nan\">NaN\u003C/h4>\n\u003Cp>NaN不等同于它自己，判断是否是NaN使用isNaN函数。判断一个数是否为有效的数字，可以使用isFinite函数。\u003C/p>\n\u003Cul>\n\u003Cli>isNaN和isFinite如果遇到非数字输入，都会先将其尝试转化为数字，再进行判断。因此，得到的不一定是预期的结果：\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    isNaN\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'NaN'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">); \u003C/span>\u003Cspan style=\"color:#6A737D\">//true\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>ES6提供了Number.isNaN和Number.isFinite两个函数，对于不是数字类型的参数，直接返回false\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"hasownproperty\">hasOwnProperty\u003C/h4>\n\u003Cp>注意它可能会被替换，因为它是一个函数，而非运算符。\u003C/p>\n\u003Ch4 id=\"对象\">对象\u003C/h4>\n\u003Cp>js中的对象永远不可能是真正的空对象。因为对象可以从原型链中获取属性。所以当使用对象时，需要当心是否与原型链中的属性\u003Cstrong>重名\u003C/strong>。\u003C/p>\n\u003Ch3 id=\"糟粕\">糟粕\u003C/h3>\n\u003Ch4 id=\"\">==\u003C/h4>\n\u003Cp>永远不要使用==和!=运算符，尽量使用===和!==代替。\u003Cbr>\n==会在类型不同时进行强制类型转换，这个规则极其的复杂，并且在某些情况下不满足传递性。\u003C/p>\n\u003Ch4 id=\"with\">with\u003C/h4>\n\u003Cp>with语句是设置代码在特定对象中的作用域，也就是限定with(obj){state}的state部分的作用域改为obj，但是\u003Cstrong>不会改变this指针\u003C/strong>。\u003C/p>\n\u003Cblockquote>\n\u003Cp>避免使用：因为效率低，比较混乱，并且可能会导致兼容性问题。\u003C/p>\n\u003C/blockquote>\n\u003Ch4 id=\"eval\">eval\u003C/h4>\n\u003Cp>避免使用eval，它会导致代码更难以阅读。\u003C/p>\n\u003Cul>\n\u003Cli>避免使用Function构造器，因为它是eval的另一种形式。\u003C/li>\n\u003Cli>避免使用setInterval和setTimeout的字符串参数。\u003C/li>\n\u003C/ul>\n\u003Ch4 id=\"continue\">continue\u003C/h4>\n\u003Cp>continue语句对性能不利，尽量避免\u003C/p>\n\u003Ch4 id=\"switch穿越\">switch穿越\u003C/h4>\n\u003Cp>每个case下都应该跟一个break;\u003C/p>\n\u003Ch4 id=\"代码块\">代码块\u003C/h4>\n\u003Cp>尽量采用花括号将代码块括起来。\u003C/p>\n\u003Ch4 id=\"和\">++和—\u003C/h4>\n\u003Cp>尽可能避免使用。\u003C/p>\n\u003Ch4 id=\"位运算符\">位运算符\u003C/h4>\n\u003Cp>尽量避免使用位运算符。因为js没有整数类型，只有双精度浮点数，因此在进行位操作时会先把浮点数转化位整数。\u003C/p>\n\u003Ch4 id=\"function语句function表达式\">function语句/function表达式\u003C/h4>\n\u003Cp>一个function语句相当于一个function表达式。\u003Cbr>\n一个语句不能以函数表达式开头，否则会被认定为一个function语句。\u003C/p>\n\u003Ch4 id=\"类型的包装对象\">类型的包装对象\u003C/h4>\n\u003Cp>js有一套类型的包装对象，这个对象有一个valueOf方法会返回被包装的对象的值。这没有必要，应当避免使用。\u003C/p>\n\u003Ch4 id=\"void\">void\u003C/h4>\n\u003Cp>void接收一个参数，返回undefined，没什么用，不需要去使用。\u003C/p>\n\u003Chr>\n\u003Ch3 id=\"总结\">总结\u003C/h3>\n\u003Cp>这本书介绍了js的一些语法、用法以及注意事项。除此之外，作者还列出了js的一些精华和糟粕（但是感觉好像糟粕更多啊..，不过话说回来，这些精华确实非常的小巧和具有表现力），之后写代码的过程中需要尽量的避免使用到书中提到的糟粕，保持良好的代码习惯。\u003C/p>",{"headings":129,"localImagePaths":263,"remoteImagePaths":264,"frontmatter":265,"imagePaths":267},[130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168,170,172,174,177,179,181,183,185,187,189,191,194,197,199,201,203,206,208,210,212,214,216,218,220,222,225,227,230,233,235,237,240,241,243,245,247,249,252,254,257,259,261],{"depth":81,"slug":131,"text":131},"语法部分",{"depth":57,"slug":133,"text":133},"注释",{"depth":57,"slug":135,"text":135},"变量命名",{"depth":57,"slug":137,"text":137},"数字",{"depth":57,"slug":139,"text":139},"声明与作用域",{"depth":57,"slug":141,"text":141},"表达式",{"depth":57,"slug":143,"text":143},"for语句",{"depth":57,"slug":145,"text":145},"return语句",{"depth":57,"slug":147,"text":147},"typeof运算符",{"depth":57,"slug":149,"text":149},"逻辑与或",{"depth":81,"slug":151,"text":151},"关于对象",{"depth":57,"slug":153,"text":153},"对象是什么",{"depth":57,"slug":155,"text":155},"对象字面量",{"depth":57,"slug":157,"text":157},"对象的检索",{"depth":57,"slug":159,"text":159},"对象的更新",{"depth":57,"slug":161,"text":161},"对象的引用",{"depth":57,"slug":163,"text":163},"对象的原型",{"depth":57,"slug":165,"text":165},"关于全局变量",{"depth":81,"slug":167,"text":167},"关于函数",{"depth":57,"slug":169,"text":169},"函数是对象",{"depth":57,"slug":171,"text":171},"匿名函数",{"depth":57,"slug":173,"text":173},"函数调用的四种模式",{"depth":175,"slug":176,"text":176},5,"方法调用模式",{"depth":175,"slug":178,"text":178},"函数调用模式",{"depth":175,"slug":180,"text":180},"构造器调用模式",{"depth":175,"slug":182,"text":182},"apply调用模式",{"depth":57,"slug":184,"text":184},"函数的参数",{"depth":57,"slug":186,"text":186},"返回值",{"depth":57,"slug":188,"text":188},"异常",{"depth":175,"slug":190,"text":190},"throw",{"depth":175,"slug":192,"text":193},"try-catch-finally","try-catch-finally：",{"depth":57,"slug":195,"text":196},"闭包函数可以访问被创建时的上下文环境就是闭包","闭包：函数可以访问被创建时的上下文环境，就是闭包。",{"depth":57,"slug":198,"text":198},"模块",{"depth":57,"slug":200,"text":200},"记忆",{"depth":81,"slug":202,"text":202},"继承",{"depth":57,"slug":204,"text":205},"使用构造器调用模式的执行方式","使用构造器调用模式的执行方式：",{"depth":57,"slug":207,"text":207},"继承父类",{"depth":81,"slug":209,"text":209},"数组",{"depth":81,"slug":211,"text":211},"方法",{"depth":81,"slug":213,"text":213},"毒瘤",{"depth":57,"slug":215,"text":215},"全局变量",{"depth":57,"slug":217,"text":217},"作用域",{"depth":57,"slug":219,"text":219},"自动插入分号",{"depth":57,"slug":221,"text":221},"typeof",{"depth":57,"slug":223,"text":224},"parseint","parseInt",{"depth":57,"slug":226,"text":226},"浮点数",{"depth":57,"slug":228,"text":229},"nan","NaN",{"depth":57,"slug":231,"text":232},"hasownproperty","hasOwnProperty",{"depth":57,"slug":234,"text":234},"对象",{"depth":81,"slug":236,"text":236},"糟粕",{"depth":57,"slug":238,"text":239},"","==",{"depth":57,"slug":82,"text":82},{"depth":57,"slug":242,"text":242},"eval",{"depth":57,"slug":244,"text":244},"continue",{"depth":57,"slug":246,"text":246},"switch穿越",{"depth":57,"slug":248,"text":248},"代码块",{"depth":57,"slug":250,"text":251},"和","++和—",{"depth":57,"slug":253,"text":253},"位运算符",{"depth":57,"slug":255,"text":256},"function语句function表达式","function语句/function表达式",{"depth":57,"slug":258,"text":258},"类型的包装对象",{"depth":57,"slug":260,"text":260},"void",{"depth":81,"slug":262,"text":262},"总结",[],[],{"title":120,"pubDate":266,"category":33,"excerpt":122},["Date","2019-08-15T16:22:08.000Z"],[],"hexo博客自动部署记录",{"id":268,"data":270,"body":275,"filePath":276,"digest":277,"rendered":278},{"title":271,"pubDate":272,"category":273,"excerpt":274},"hexo自动部署记录",["Date","2020-06-22T22:12:55.000Z"],"服务端","写了点代码，可以让hexo博客在本地更新后，自动部署到服务器上。","# 前言\n\n之前用hexo在自己的服务器上搭建了博客。每次更新博客的时候，都需要执行如下操作：\n```\n    npm run clean\n    npm run build\n    npm run deploy\n    手动把/public文件夹复制到服务器上\n```\n其中，前三个是写在package.json文件中的操作，分别执行删除、构建和发布的过程。明显可以看到，这四个步骤，有很大的精简空间。因此，我们希望可以通过运行一次操作，就自动的把最新的博客内容更新到服务器上。\n\n---\n# 指令合并\n\n观察上边的四步操作，其中，前三步都是指令。既然是依次执行的指令，那么我们就可以把它合并。在博客根目录下的package.json文件中的scripts中编写脚本：\n```json\n    \"publish\": \"hexo clean & hexo g -d\"\n```\n这样，我们便把三步指令合并成了一步，我们通过:\n```\n    npm run publish\n```\n即可执行。当然，这并不是这次记录的重点。重点是，如何将第四步与前三步进行合并。\n\n---\n\n# 自动部署的方案\n我们再次回顾前三个步骤。clean和build都不用说，这都是在本地执行的操作，一个是删除当前目录下的/public文件，一个是根据当前的博客生成/public文件。\n而对于deploy，它是将我们的博客，也就是build之后的/public文件夹，发布到指定的远程仓库。执行deploy操作首先需要在根目录下的_config.yml文件中进行配置：\n```\ndeploy:\n  type: git\n  repository: your/remote/repository/path\n  branch: master\n```\n然后，当执行hexo deploy指令时，它便会自动的将/public文件夹推送到我们配置的仓库中去。既然这样，我们脑海中自然就有了如下三个方案：\n\n## 使用github的静态博客页\n这种方案的话，我们直接在上边的配置中把repository配置为github.io博客即可。接下来给我们自己的域名设置一个重定向，当访问我们自己的域名时，重定向到github.io静态博客。直接在nginx上配置即可。\n    \n> 不想用它，难受。\n\n## 在服务器搭建一个git仓库\n至于这种方案，我们首先需要在我们的服务器上搭建一个git仓库；开启一个进程时刻监听着这个文件夹，一旦博客仓库有更新，就把它拷贝到nginx目录下html中的对应文件夹去。\n\n> 需要搭建git仓库；还要写个监听程序；懒得弄。\n\n## webhook\n这是我最后采用的方案。\n    \nWebhook是github中提供的功能，WebHook被触发后，发送HTTP/HTTPS的目标通知地址。我们只需要配置一个url，然后再服务器的相应端口开启服务。当相应的动作，如push，被触发的时候，github会自动发送一个post请求，参数中附带着这个仓库的基本信息。我们可以根据这个信息知道博客被更新了，需要拉下来新的代码。\n\n也就是，如果采用这种方案，只需要执行npm run publish，博客即可自动更新，\n\n---\n\n# 设计思路\n大体思路是这样的：\n```\n    deploy => 触发webhook => 发送post请求 => 服务器收到请求 => 把远程仓库克隆到本地的某个文件夹 => 将本地文件夹复制到目标文件夹\n```\n当然也不一定这么做，其实可以直接clone到目标文件夹，但是我想，从下载下来到复制到目标文件夹的过程，中间可能还可以加一些什么骚操作，所以就分开了。\n\n---\n# 代码思路\n代码思路就按照上述设计思路来了，代码在[这里](https://github.com/maotoumao/webhook-server)，改一下config，配一下webhook然后部署到服务器上应该就可以了。简要记录一下用到的库和一些小坑：\n\n## 库\n```\n    http： 用来开启一个服务，监听请求。\n    nodegit： 操作git，完成clone服务。\n    path： 完成path的相关操作。\n    fs： 文件操作。\n    ncp： 递归的进行复制。\n    chalk： 在控制台输出带样式的文字。\n```\n\n## 小坑\n- nodegit的clone，从github克隆的时候很慢，所以我直接切到了码云，比github快多了，功能也一样。\n- nodegit的clone，只能克隆到空目录。\n- fs的mkdir必须要有回调函数。\n- ncp的第三个参数是错误回调函数，如果没有错误，参数是null，照样会输出错误（据我观察是这样，因为拷贝成功了）。\n\n\n## TODO\n- 支持一下私有仓库；\n- 逻辑完善一下，可以使用WebHook密码增加安全性。\n\n---\n# 2020.08.01补充\n服务器迁移到了cent os系统，因此对这一部分代码也重构了，直接用了fs-extra库去操作文件，但是这次git clone的时候遇到了问题，一直提示SSL未认证，找到解决方案如下：https://stackoverflow.com/questions/29479131/nodegit-cloning-not-working","src/content/posts/hexo博客自动部署记录.md","ffb2e789dc611be2",{"html":279,"metadata":280},"\u003Ch1 id=\"前言\">前言\u003C/h1>\n\u003Cp>之前用hexo在自己的服务器上搭建了博客。每次更新博客的时候，都需要执行如下操作：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    npm run clean\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    npm run build\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    npm run deploy\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    手动把/public文件夹复制到服务器上\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>其中，前三个是写在package.json文件中的操作，分别执行删除、构建和发布的过程。明显可以看到，这四个步骤，有很大的精简空间。因此，我们希望可以通过运行一次操作，就自动的把最新的博客内容更新到服务器上。\u003C/p>\n\u003Chr>\n\u003Ch1 id=\"指令合并\">指令合并\u003C/h1>\n\u003Cp>观察上边的四步操作，其中，前三步都是指令。既然是依次执行的指令，那么我们就可以把它合并。在博客根目录下的package.json文件中的scripts中编写脚本：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"json\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"publish\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"hexo clean &#x26; hexo g -d\"\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>这样，我们便把三步指令合并成了一步，我们通过:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    npm run publish\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>即可执行。当然，这并不是这次记录的重点。重点是，如何将第四步与前三步进行合并。\u003C/p>\n\u003Chr>\n\u003Ch1 id=\"自动部署的方案\">自动部署的方案\u003C/h1>\n\u003Cp>我们再次回顾前三个步骤。clean和build都不用说，这都是在本地执行的操作，一个是删除当前目录下的/public文件，一个是根据当前的博客生成/public文件。\n而对于deploy，它是将我们的博客，也就是build之后的/public文件夹，发布到指定的远程仓库。执行deploy操作首先需要在根目录下的_config.yml文件中进行配置：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>deploy:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  type: git\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  repository: your/remote/repository/path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  branch: master\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>然后，当执行hexo deploy指令时，它便会自动的将/public文件夹推送到我们配置的仓库中去。既然这样，我们脑海中自然就有了如下三个方案：\u003C/p>\n\u003Ch2 id=\"使用github的静态博客页\">使用github的静态博客页\u003C/h2>\n\u003Cp>这种方案的话，我们直接在上边的配置中把repository配置为github.io博客即可。接下来给我们自己的域名设置一个重定向，当访问我们自己的域名时，重定向到github.io静态博客。直接在nginx上配置即可。\u003C/p>\n\u003Cblockquote>\n\u003Cp>不想用它，难受。\u003C/p>\n\u003C/blockquote>\n\u003Ch2 id=\"在服务器搭建一个git仓库\">在服务器搭建一个git仓库\u003C/h2>\n\u003Cp>至于这种方案，我们首先需要在我们的服务器上搭建一个git仓库；开启一个进程时刻监听着这个文件夹，一旦博客仓库有更新，就把它拷贝到nginx目录下html中的对应文件夹去。\u003C/p>\n\u003Cblockquote>\n\u003Cp>需要搭建git仓库；还要写个监听程序；懒得弄。\u003C/p>\n\u003C/blockquote>\n\u003Ch2 id=\"webhook\">webhook\u003C/h2>\n\u003Cp>这是我最后采用的方案。\u003C/p>\n\u003Cp>Webhook是github中提供的功能，WebHook被触发后，发送HTTP/HTTPS的目标通知地址。我们只需要配置一个url，然后再服务器的相应端口开启服务。当相应的动作，如push，被触发的时候，github会自动发送一个post请求，参数中附带着这个仓库的基本信息。我们可以根据这个信息知道博客被更新了，需要拉下来新的代码。\u003C/p>\n\u003Cp>也就是，如果采用这种方案，只需要执行npm run publish，博客即可自动更新，\u003C/p>\n\u003Chr>\n\u003Ch1 id=\"设计思路\">设计思路\u003C/h1>\n\u003Cp>大体思路是这样的：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    deploy => 触发webhook => 发送post请求 => 服务器收到请求 => 把远程仓库克隆到本地的某个文件夹 => 将本地文件夹复制到目标文件夹\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>当然也不一定这么做，其实可以直接clone到目标文件夹，但是我想，从下载下来到复制到目标文件夹的过程，中间可能还可以加一些什么骚操作，所以就分开了。\u003C/p>\n\u003Chr>\n\u003Ch1 id=\"代码思路\">代码思路\u003C/h1>\n\u003Cp>代码思路就按照上述设计思路来了，代码在\u003Ca href=\"https://github.com/maotoumao/webhook-server\">这里\u003C/a>，改一下config，配一下webhook然后部署到服务器上应该就可以了。简要记录一下用到的库和一些小坑：\u003C/p>\n\u003Ch2 id=\"库\">库\u003C/h2>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    http： 用来开启一个服务，监听请求。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    nodegit： 操作git，完成clone服务。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    path： 完成path的相关操作。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    fs： 文件操作。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    ncp： 递归的进行复制。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    chalk： 在控制台输出带样式的文字。\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"小坑\">小坑\u003C/h2>\n\u003Cul>\n\u003Cli>nodegit的clone，从github克隆的时候很慢，所以我直接切到了码云，比github快多了，功能也一样。\u003C/li>\n\u003Cli>nodegit的clone，只能克隆到空目录。\u003C/li>\n\u003Cli>fs的mkdir必须要有回调函数。\u003C/li>\n\u003Cli>ncp的第三个参数是错误回调函数，如果没有错误，参数是null，照样会输出错误（据我观察是这样，因为拷贝成功了）。\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"todo\">TODO\u003C/h2>\n\u003Cul>\n\u003Cli>支持一下私有仓库；\u003C/li>\n\u003Cli>逻辑完善一下，可以使用WebHook密码增加安全性。\u003C/li>\n\u003C/ul>\n\u003Chr>\n\u003Ch1 id=\"20200801补充\">2020.08.01补充\u003C/h1>\n\u003Cp>服务器迁移到了cent os系统，因此对这一部分代码也重构了，直接用了fs-extra库去操作文件，但是这次git clone的时候遇到了问题，一直提示SSL未认证，找到解决方案如下：\u003Ca href=\"https://stackoverflow.com/questions/29479131/nodegit-cloning-not-working\">https://stackoverflow.com/questions/29479131/nodegit-cloning-not-working\u003C/a>\u003C/p>",{"headings":281,"localImagePaths":308,"remoteImagePaths":309,"frontmatter":310,"imagePaths":312},[282,284,286,288,290,292,294,296,298,300,302,305],{"depth":283,"slug":27,"text":27},1,{"depth":283,"slug":285,"text":285},"指令合并",{"depth":283,"slug":287,"text":287},"自动部署的方案",{"depth":26,"slug":289,"text":289},"使用github的静态博客页",{"depth":26,"slug":291,"text":291},"在服务器搭建一个git仓库",{"depth":26,"slug":293,"text":293},"webhook",{"depth":283,"slug":295,"text":295},"设计思路",{"depth":283,"slug":297,"text":297},"代码思路",{"depth":26,"slug":299,"text":299},"库",{"depth":26,"slug":301,"text":301},"小坑",{"depth":26,"slug":303,"text":304},"todo","TODO",{"depth":283,"slug":306,"text":307},"20200801补充","2020.08.01补充",[],[],{"title":271,"pubDate":311,"category":273,"excerpt":274},["Date","2020-06-22T22:12:55.000Z"],[],"musicfree首屏优化记录",{"id":313,"data":315,"body":320,"filePath":321,"digest":322,"rendered":323},{"title":316,"pubDate":317,"category":318,"excerpt":319},"MusicFree首屏优化记录",["Date","2025-10-11T12:47:12.000Z"],"MusicFree","小小记录一下首屏优化~","在安卓版发布0.6.0之后，有好多小伙伴反馈说首屏太慢了，甚至打开软件要在开屏界面卡10秒，具体时间会随着安装插件的增加而变长。\r\n\r\n趁着国庆假期优化了一下，这里记录下问题原因和修复的方案。\r\n\r\n# 问题原因\r\n\r\n在软件启动时，会经历一个初始化的阶段。在这个阶段，软件会初始化所有的歌单、播放器内核、**插件**、主题等等。\r\n\r\n在此期间，软件会一直展示一个固定的开屏界面，直到初始化完成。那为啥在 0.6.0 之前，没有感觉到这个问题呢？\r\n\r\n因为 0.6.0 之前的版本有 bug，在初始化完成之前就展示了主界面，所以造成了启动很快的错觉，但其实展示主界面之后，软件还在默默地初始化...   \r\n而在 0.6.0 版本尝试修复了这个bug，反而看起来像是一个负优化。\r\n\r\n所以，0.6.0 版本之前的现象是：软件启动可能要花费 6 秒，但在 2 秒后就展示了主界面，所以大家感觉启动很快；并且大家一般不会在刚打开软件的瞬间就去执行搜索之类的行为，所以大概率也感受不到初始化未完成带来的问题。\r\n\r\n而 0.6.0 版本之后的现象是：软件启动可能要花费 6 秒，并且在 6 秒后才展示主界面，实打实等了 6 秒，那感觉就慢下来了。\r\n\r\n\r\n# 问题定位\r\n\r\n解决首屏问题的思路，无论是前端应用还是跨端应用，个人感觉是类似的 —— \r\n\r\n首先找到影响首屏的关键因素，对于首屏必须的数据，能缓存的缓存，能提前获取的提前获取；  \r\n对于首屏没那么必要的数据或逻辑，能异步的异步，能延迟的延迟。\r\n\r\n在代码里打日志测试了一下初始化每个子步骤所消耗的时间，果然发现插件初始化占了将近一半的时间：\r\n\r\n插件初始化的逻辑是：从本地特定的文件夹读取所有已安装的插件，然后解析。这里就有了两个瓶颈：加载 和 解析。\r\n\r\n加载指的是读取文件夹和读取文件内容；解析指的是通过 JavaScript 的 `new Function` 来把插件代码转化成可执行的函数。\r\n\r\n如果插件体积比较大、或者经过混淆，就会花费更多的加载和解析时间。\r\n\r\n# 解决方案\r\n\r\n按照上面的优化思路，关键因素找到了，是插件初始化。\r\n\r\n首屏加载时其实只需要知道插件的接口，或者说，有哪些插件、每个插件的基本信息；  \r\n至于每个插件的具体逻辑 （比如获取音源、获取歌词），完全可以等到真正使用到的时候再懒加载。\r\n\r\n所以，解决问题的思路就有了：\r\n1. 缓存已加载插件的所有基础信息（包括插件内定义的属性，方法列表，安装路径）；当插件发生变动（添加、删除、更新）时，顺便更新缓存。\r\n2. 首屏加载时，先读取已安装的所有插件列表（大概20ms），然后根据插件路径读取缓存。\r\n3. 对于命中缓存的插件，拿到缓存的插件的基础信息，然后跳过加载和解析，直接创建一个未初始化的插件实例，并标记为需要懒加载。\r\n3. 对于没有命中缓存的插件，还是走原来的初始化流程，读取文件内容并解析，这样就保证了即使手动添加了插件文件，也能正常解析。\r\n4. 当插件被真正使用（比如调用插件的函数获取音源等）时，或软件空闲时，会初始化需要懒加载的插件，并在初始化完成后更新插件缓存。这样能保证插件的缓存是最新的，并且不会影响功能。\r\n\r\n\r\n为了防止改出来啥问题，加了一个【启用插件懒加载】的设置项，默认是关闭的。把这个开关打开，就能体验到优化后的效果啦。\r\n\r\n---\r\n\r\n莫名想到了之前在淘宝做某互动游戏的时候，首屏加载时间很长，但有个定时更新的假进度条，这样就不会让用户感觉像卡死了，加载久一点也就没那么难熬。这也算是一种优化吧😂","src/content/posts/MusicFree首屏优化记录.md","cc8ad774adac1a73",{"html":324,"metadata":325},"\u003Cp>在安卓版发布0.6.0之后，有好多小伙伴反馈说首屏太慢了，甚至打开软件要在开屏界面卡10秒，具体时间会随着安装插件的增加而变长。\u003C/p>\n\u003Cp>趁着国庆假期优化了一下，这里记录下问题原因和修复的方案。\u003C/p>\n\u003Ch1 id=\"问题原因\">问题原因\u003C/h1>\n\u003Cp>在软件启动时，会经历一个初始化的阶段。在这个阶段，软件会初始化所有的歌单、播放器内核、\u003Cstrong>插件\u003C/strong>、主题等等。\u003C/p>\n\u003Cp>在此期间，软件会一直展示一个固定的开屏界面，直到初始化完成。那为啥在 0.6.0 之前，没有感觉到这个问题呢？\u003C/p>\n\u003Cp>因为 0.6.0 之前的版本有 bug，在初始化完成之前就展示了主界面，所以造成了启动很快的错觉，但其实展示主界面之后，软件还在默默地初始化…\u003Cbr>\n而在 0.6.0 版本尝试修复了这个bug，反而看起来像是一个负优化。\u003C/p>\n\u003Cp>所以，0.6.0 版本之前的现象是：软件启动可能要花费 6 秒，但在 2 秒后就展示了主界面，所以大家感觉启动很快；并且大家一般不会在刚打开软件的瞬间就去执行搜索之类的行为，所以大概率也感受不到初始化未完成带来的问题。\u003C/p>\n\u003Cp>而 0.6.0 版本之后的现象是：软件启动可能要花费 6 秒，并且在 6 秒后才展示主界面，实打实等了 6 秒，那感觉就慢下来了。\u003C/p>\n\u003Ch1 id=\"问题定位\">问题定位\u003C/h1>\n\u003Cp>解决首屏问题的思路，无论是前端应用还是跨端应用，个人感觉是类似的 ——\u003C/p>\n\u003Cp>首先找到影响首屏的关键因素，对于首屏必须的数据，能缓存的缓存，能提前获取的提前获取；\u003Cbr>\n对于首屏没那么必要的数据或逻辑，能异步的异步，能延迟的延迟。\u003C/p>\n\u003Cp>在代码里打日志测试了一下初始化每个子步骤所消耗的时间，果然发现插件初始化占了将近一半的时间：\u003C/p>\n\u003Cp>插件初始化的逻辑是：从本地特定的文件夹读取所有已安装的插件，然后解析。这里就有了两个瓶颈：加载 和 解析。\u003C/p>\n\u003Cp>加载指的是读取文件夹和读取文件内容；解析指的是通过 JavaScript 的 \u003Ccode>new Function\u003C/code> 来把插件代码转化成可执行的函数。\u003C/p>\n\u003Cp>如果插件体积比较大、或者经过混淆，就会花费更多的加载和解析时间。\u003C/p>\n\u003Ch1 id=\"解决方案\">解决方案\u003C/h1>\n\u003Cp>按照上面的优化思路，关键因素找到了，是插件初始化。\u003C/p>\n\u003Cp>首屏加载时其实只需要知道插件的接口，或者说，有哪些插件、每个插件的基本信息；\u003Cbr>\n至于每个插件的具体逻辑 （比如获取音源、获取歌词），完全可以等到真正使用到的时候再懒加载。\u003C/p>\n\u003Cp>所以，解决问题的思路就有了：\u003C/p>\n\u003Col>\n\u003Cli>缓存已加载插件的所有基础信息（包括插件内定义的属性，方法列表，安装路径）；当插件发生变动（添加、删除、更新）时，顺便更新缓存。\u003C/li>\n\u003Cli>首屏加载时，先读取已安装的所有插件列表（大概20ms），然后根据插件路径读取缓存。\u003C/li>\n\u003Cli>对于命中缓存的插件，拿到缓存的插件的基础信息，然后跳过加载和解析，直接创建一个未初始化的插件实例，并标记为需要懒加载。\u003C/li>\n\u003Cli>对于没有命中缓存的插件，还是走原来的初始化流程，读取文件内容并解析，这样就保证了即使手动添加了插件文件，也能正常解析。\u003C/li>\n\u003Cli>当插件被真正使用（比如调用插件的函数获取音源等）时，或软件空闲时，会初始化需要懒加载的插件，并在初始化完成后更新插件缓存。这样能保证插件的缓存是最新的，并且不会影响功能。\u003C/li>\n\u003C/ol>\n\u003Cp>为了防止改出来啥问题，加了一个【启用插件懒加载】的设置项，默认是关闭的。把这个开关打开，就能体验到优化后的效果啦。\u003C/p>\n\u003Chr>\n\u003Cp>莫名想到了之前在淘宝做某互动游戏的时候，首屏加载时间很长，但有个定时更新的假进度条，这样就不会让用户感觉像卡死了，加载久一点也就没那么难熬。这也算是一种优化吧😂\u003C/p>",{"headings":326,"localImagePaths":333,"remoteImagePaths":334,"frontmatter":335,"imagePaths":337},[327,329,331],{"depth":283,"slug":328,"text":328},"问题原因",{"depth":283,"slug":330,"text":330},"问题定位",{"depth":283,"slug":332,"text":332},"解决方案",[],[],{"title":316,"pubDate":336,"category":318,"excerpt":319},["Date","2025-10-11T12:47:12.000Z"],[],"musicfree桌面版",{"id":338,"data":340,"body":344,"filePath":345,"digest":346,"rendered":347},{"title":341,"pubDate":342,"category":33,"excerpt":343},"MusicFree 桌面版来啦",["Date","2023-07-23T22:38:39.000Z"],"MusicFree桌面版","MusicFree 第一个桌面版来啦，功能还不完善，但是大概能用了，先发出来测试一下好了~\r\n\r\n依然是 GPL3.0 协议开源，代码地址：https://github.com/maotoumao/MusicFreeDesktop\r\n打不开的话就把链接的 github 换 gitee。求star ~\r\n\r\n来不及写 Readme 了，过两天补上；蓝奏云下载地址：https://wwzb.lanzoue.com/b042daj1a，也可以点击阅读原文下载（只打包了windows的安装包，实测mac也可以打包成功，就是有些功能上的bug，比如桌面歌词无法移动位置）。先大概介绍下功能👇\r\n\r\n## 功能简介\r\n\r\n主要思路和安卓版一致，也是一个本地音乐播放器，但是可以通过插件的形式扩展音源；且插件协议和安卓版**完全一致**。（也就是同一个插件在安卓版和桌面版都可以用）\r\n\r\n### 技术选型\r\n\r\n想了半天，electron 最合适。其他方案也行得通，但为了实现插件化，开发成本可能会很大。如果有人感兴趣的话，之后倒是可以详细写写技术选型的过程。\r\n\r\n### 主要功能\r\n\r\n- 播放本地音乐\r\n- 插件化播放网络音乐（兼容安卓版的所有功能）\r\n- 桌面歌词（mac 和 linux 还有没解决的 bug）\r\n- 收藏歌单\r\n- 自定义主题\r\n\r\n\r\n## 关于 logo\r\n\r\n暂时先用安卓版的 logo 代替，这两天有位热心小伙伴帮忙做了个 logo，近期考虑换掉~\r\n\r\n## 播放本地音乐\r\n\r\n直接把本地音乐拖拽进软件，就可以直接播放了：\r\n\r\n![792fb45b99a08fdd3d1448e7ad6bf92c.gif](https://i.mji.rip/2023/07/23/792fb45b99a08fdd3d1448e7ad6bf92c.gif)\r\n\r\n也可以拖拽包含音乐的文件夹：\r\n![4e313e79d58b527cb6129bd0585afe49.gif](https://i.mji.rip/2023/07/23/4e313e79d58b527cb6129bd0585afe49.gif)\r\n\r\n\r\n## 安装插件\r\n\r\n可以从本地安装插件，也可以从网络安装插件。示例插件地址和安卓版的相同。\r\n\r\n![f1137c8f492489f00e1b5e58cec31ce6.gif](https://i.mji.rip/2023/07/23/f1137c8f492489f00e1b5e58cec31ce6.gif)\r\n\r\n\r\n## 桌面歌词\r\n\r\nwindows版的功能是正常的（歌词超过一定宽度的时候会被截断，已知问题但是一直没时间改）：\r\n\r\n![710e8d7add5ba7907bc11d26edb8e540.gif](https://i.mji.rip/2023/07/23/710e8d7add5ba7907bc11d26edb8e540.gif)\r\n\r\nmac版的话不能移动位置（虽然有些比较奇怪的办法可以暂时改下位置。。。）\r\n\r\n## 播放控制\r\n\r\n可以通过右下角图标或者控制中心去控制播放：\r\n\r\n![9bcae437957669cdb47fd10b5f839d23.png](https://i.mji.rip/2023/07/23/9bcae437957669cdb47fd10b5f839d23.png)\r\n\r\n![0c809651c4da0a568d9d9b5a89accd12.png](https://i.mji.rip/2023/07/23/0c809651c4da0a568d9d9b5a89accd12.png)\r\n\r\n\r\n## 自定义主题\r\n\r\n这次在自定义主题上费了些功夫。桌面版支持自定义主题包，具体来说支持定义**软件中所有的界面样式**，以及**6块主要区域的背景**。\r\n\r\n### 常规样式\r\n\r\n先说界面样式，这个应该比较好理解，就是定义一些颜色，布局之类的，比如通过主题包定义的暗黑模式：\r\n\r\n![d9c68e0c544f2f281d08a232de095b6a.png](https://i.mji.rip/2023/07/23/d9c68e0c544f2f281d08a232de095b6a.png)\r\n\r\n也可以定义一些静态的背景图：\r\n\r\n![ce43ab5f98a94c9cc0df5a074cdca42d.png](https://i.mji.rip/2023/07/23/ce43ab5f98a94c9cc0df5a074cdca42d.png)\r\n\r\n### 高级样式\r\n\r\n除了这些常规功能外，为了让背景更加有想象力一点，因此开放出了6个主要区域的背景自定义，具体来说是可以用任意的html文件来定义背景，这样就可以在背景上实现一些比较酷炫的动效，或者做一些实用的功能，比如跟随当天的天气切换背景等（不过要注意性能）。\r\n\r\n6个主要区域包括：\r\n\r\n1. 整个窗口（app）\r\n![ce43ab5f98a94c9cc0df5a074cdca42d.png](https://i.mji.rip/2023/07/23/ce43ab5f98a94c9cc0df5a074cdca42d.png)\r\n\r\n2. 顶部（header）\r\n![fd6d7934976e1b134a8b8ef77813b2f3.png](https://i.mji.rip/2023/07/23/fd6d7934976e1b134a8b8ef77813b2f3.png)\r\n\r\n3. 侧边栏+主页面（body）\r\n![9d82627eeb0edbade46bc7e3490c9e62.png](https://i.mji.rip/2023/07/23/9d82627eeb0edbade46bc7e3490c9e62.png)\r\n\r\n4. 侧边栏（side-bar）\r\n![f32e3ce9de3294fb560e1a60b1cdfd05.png](https://i.mji.rip/2023/07/23/f32e3ce9de3294fb560e1a60b1cdfd05.png)\r\n\r\n5. 主页面（page）\r\n![3ff6ca8b972d05c1877987d402594942.png](https://i.mji.rip/2023/07/23/3ff6ca8b972d05c1877987d402594942.png)\r\n\r\n6. 音乐播放栏（music-bar）\r\n![9f7a3b6edc73498248bc8bb0e13c6fb2.png](https://i.mji.rip/2023/07/23/9f7a3b6edc73498248bc8bb0e13c6fb2.png)\r\n\r\n\r\n接下来看几个效果（代码是从 codepen 上随便拷的）：\r\n先是几个动效：\r\n\r\n![e79f43f799e88b8a82e7e62d500af7e0.gif](https://i.mji.rip/2023/07/23/e79f43f799e88b8a82e7e62d500af7e0.gif)\r\n\r\n![f234216320596d46f81e2f287135b0ba.gif](https://i.mji.rip/2023/07/23/f234216320596d46f81e2f287135b0ba.gif)\r\n\r\n下面这个背景是当前时间：\r\n\r\n![01100ab7c54fe1394d18c4c27044e29d.gif](https://i.mji.rip/2023/07/23/01100ab7c54fe1394d18c4c27044e29d.gif)\r\n\r\n---\r\n\r\n先写这么多吧~~ bug 应该有一些，也只能慢慢修了... 至少现在凑合能用了\r\n\r\n最后再求一个star~  https://github.com/maotoumao/MusicFreeDesktop\r\n\r\nbtw 最近上班的感受是：为什么这些人都不下班……","src/content/posts/MusicFree桌面版.md","5175298c1e2aaa74",{"html":348,"metadata":349},"\u003Cp>MusicFree 第一个桌面版来啦，功能还不完善，但是大概能用了，先发出来测试一下好了~\u003C/p>\n\u003Cp>依然是 GPL3.0 协议开源，代码地址：\u003Ca href=\"https://github.com/maotoumao/MusicFreeDesktop\">https://github.com/maotoumao/MusicFreeDesktop\u003C/a>\r\n打不开的话就把链接的 github 换 gitee。求star ~\u003C/p>\n\u003Cp>来不及写 Readme 了，过两天补上；蓝奏云下载地址：\u003Ca href=\"https://wwzb.lanzoue.com/b042daj1a%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%82%B9%E5%87%BB%E9%98%85%E8%AF%BB%E5%8E%9F%E6%96%87%E4%B8%8B%E8%BD%BD%EF%BC%88%E5%8F%AA%E6%89%93%E5%8C%85%E4%BA%86windows%E7%9A%84%E5%AE%89%E8%A3%85%E5%8C%85%EF%BC%8C%E5%AE%9E%E6%B5%8Bmac%E4%B9%9F%E5%8F%AF%E4%BB%A5%E6%89%93%E5%8C%85%E6%88%90%E5%8A%9F%EF%BC%8C%E5%B0%B1%E6%98%AF%E6%9C%89%E4%BA%9B%E5%8A%9F%E8%83%BD%E4%B8%8A%E7%9A%84bug%EF%BC%8C%E6%AF%94%E5%A6%82%E6%A1%8C%E9%9D%A2%E6%AD%8C%E8%AF%8D%E6%97%A0%E6%B3%95%E7%A7%BB%E5%8A%A8%E4%BD%8D%E7%BD%AE%EF%BC%89%E3%80%82%E5%85%88%E5%A4%A7%E6%A6%82%E4%BB%8B%E7%BB%8D%E4%B8%8B%E5%8A%9F%E8%83%BD%F0%9F%91%87\">https://wwzb.lanzoue.com/b042daj1a，也可以点击阅读原文下载（只打包了windows的安装包，实测mac也可以打包成功，就是有些功能上的bug，比如桌面歌词无法移动位置）。先大概介绍下功能👇\u003C/a>\u003C/p>\n\u003Ch2 id=\"功能简介\">功能简介\u003C/h2>\n\u003Cp>主要思路和安卓版一致，也是一个本地音乐播放器，但是可以通过插件的形式扩展音源；且插件协议和安卓版\u003Cstrong>完全一致\u003C/strong>。（也就是同一个插件在安卓版和桌面版都可以用）\u003C/p>\n\u003Ch3 id=\"技术选型\">技术选型\u003C/h3>\n\u003Cp>想了半天，electron 最合适。其他方案也行得通，但为了实现插件化，开发成本可能会很大。如果有人感兴趣的话，之后倒是可以详细写写技术选型的过程。\u003C/p>\n\u003Ch3 id=\"主要功能\">主要功能\u003C/h3>\n\u003Cul>\n\u003Cli>播放本地音乐\u003C/li>\n\u003Cli>插件化播放网络音乐（兼容安卓版的所有功能）\u003C/li>\n\u003Cli>桌面歌词（mac 和 linux 还有没解决的 bug）\u003C/li>\n\u003Cli>收藏歌单\u003C/li>\n\u003Cli>自定义主题\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"关于-logo\">关于 logo\u003C/h2>\n\u003Cp>暂时先用安卓版的 logo 代替，这两天有位热心小伙伴帮忙做了个 logo，近期考虑换掉~\u003C/p>\n\u003Ch2 id=\"播放本地音乐\">播放本地音乐\u003C/h2>\n\u003Cp>直接把本地音乐拖拽进软件，就可以直接播放了：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.mji.rip/2023/07/23/792fb45b99a08fdd3d1448e7ad6bf92c.gif\" alt=\"792fb45b99a08fdd3d1448e7ad6bf92c.gif\">\u003C/p>\n\u003Cp>也可以拖拽包含音乐的文件夹：\r\n\u003Cimg src=\"https://i.mji.rip/2023/07/23/4e313e79d58b527cb6129bd0585afe49.gif\" alt=\"4e313e79d58b527cb6129bd0585afe49.gif\">\u003C/p>\n\u003Ch2 id=\"安装插件\">安装插件\u003C/h2>\n\u003Cp>可以从本地安装插件，也可以从网络安装插件。示例插件地址和安卓版的相同。\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.mji.rip/2023/07/23/f1137c8f492489f00e1b5e58cec31ce6.gif\" alt=\"f1137c8f492489f00e1b5e58cec31ce6.gif\">\u003C/p>\n\u003Ch2 id=\"桌面歌词\">桌面歌词\u003C/h2>\n\u003Cp>windows版的功能是正常的（歌词超过一定宽度的时候会被截断，已知问题但是一直没时间改）：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.mji.rip/2023/07/23/710e8d7add5ba7907bc11d26edb8e540.gif\" alt=\"710e8d7add5ba7907bc11d26edb8e540.gif\">\u003C/p>\n\u003Cp>mac版的话不能移动位置（虽然有些比较奇怪的办法可以暂时改下位置。。。）\u003C/p>\n\u003Ch2 id=\"播放控制\">播放控制\u003C/h2>\n\u003Cp>可以通过右下角图标或者控制中心去控制播放：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.mji.rip/2023/07/23/9bcae437957669cdb47fd10b5f839d23.png\" alt=\"9bcae437957669cdb47fd10b5f839d23.png\">\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.mji.rip/2023/07/23/0c809651c4da0a568d9d9b5a89accd12.png\" alt=\"0c809651c4da0a568d9d9b5a89accd12.png\">\u003C/p>\n\u003Ch2 id=\"自定义主题\">自定义主题\u003C/h2>\n\u003Cp>这次在自定义主题上费了些功夫。桌面版支持自定义主题包，具体来说支持定义\u003Cstrong>软件中所有的界面样式\u003C/strong>，以及\u003Cstrong>6块主要区域的背景\u003C/strong>。\u003C/p>\n\u003Ch3 id=\"常规样式\">常规样式\u003C/h3>\n\u003Cp>先说界面样式，这个应该比较好理解，就是定义一些颜色，布局之类的，比如通过主题包定义的暗黑模式：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.mji.rip/2023/07/23/d9c68e0c544f2f281d08a232de095b6a.png\" alt=\"d9c68e0c544f2f281d08a232de095b6a.png\">\u003C/p>\n\u003Cp>也可以定义一些静态的背景图：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.mji.rip/2023/07/23/ce43ab5f98a94c9cc0df5a074cdca42d.png\" alt=\"ce43ab5f98a94c9cc0df5a074cdca42d.png\">\u003C/p>\n\u003Ch3 id=\"高级样式\">高级样式\u003C/h3>\n\u003Cp>除了这些常规功能外，为了让背景更加有想象力一点，因此开放出了6个主要区域的背景自定义，具体来说是可以用任意的html文件来定义背景，这样就可以在背景上实现一些比较酷炫的动效，或者做一些实用的功能，比如跟随当天的天气切换背景等（不过要注意性能）。\u003C/p>\n\u003Cp>6个主要区域包括：\u003C/p>\n\u003Col>\n\u003Cli>\n\u003Cp>整个窗口（app）\r\n\u003Cimg src=\"https://i.mji.rip/2023/07/23/ce43ab5f98a94c9cc0df5a074cdca42d.png\" alt=\"ce43ab5f98a94c9cc0df5a074cdca42d.png\">\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>顶部（header）\r\n\u003Cimg src=\"https://i.mji.rip/2023/07/23/fd6d7934976e1b134a8b8ef77813b2f3.png\" alt=\"fd6d7934976e1b134a8b8ef77813b2f3.png\">\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>侧边栏+主页面（body）\r\n\u003Cimg src=\"https://i.mji.rip/2023/07/23/9d82627eeb0edbade46bc7e3490c9e62.png\" alt=\"9d82627eeb0edbade46bc7e3490c9e62.png\">\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>侧边栏（side-bar）\r\n\u003Cimg src=\"https://i.mji.rip/2023/07/23/f32e3ce9de3294fb560e1a60b1cdfd05.png\" alt=\"f32e3ce9de3294fb560e1a60b1cdfd05.png\">\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>主页面（page）\r\n\u003Cimg src=\"https://i.mji.rip/2023/07/23/3ff6ca8b972d05c1877987d402594942.png\" alt=\"3ff6ca8b972d05c1877987d402594942.png\">\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>音乐播放栏（music-bar）\r\n\u003Cimg src=\"https://i.mji.rip/2023/07/23/9f7a3b6edc73498248bc8bb0e13c6fb2.png\" alt=\"9f7a3b6edc73498248bc8bb0e13c6fb2.png\">\u003C/p>\n\u003C/li>\n\u003C/ol>\n\u003Cp>接下来看几个效果（代码是从 codepen 上随便拷的）：\r\n先是几个动效：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.mji.rip/2023/07/23/e79f43f799e88b8a82e7e62d500af7e0.gif\" alt=\"e79f43f799e88b8a82e7e62d500af7e0.gif\">\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.mji.rip/2023/07/23/f234216320596d46f81e2f287135b0ba.gif\" alt=\"f234216320596d46f81e2f287135b0ba.gif\">\u003C/p>\n\u003Cp>下面这个背景是当前时间：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.mji.rip/2023/07/23/01100ab7c54fe1394d18c4c27044e29d.gif\" alt=\"01100ab7c54fe1394d18c4c27044e29d.gif\">\u003C/p>\n\u003Chr>\n\u003Cp>先写这么多吧~~ bug 应该有一些，也只能慢慢修了… 至少现在凑合能用了\u003C/p>\n\u003Cp>最后再求一个star~  \u003Ca href=\"https://github.com/maotoumao/MusicFreeDesktop\">https://github.com/maotoumao/MusicFreeDesktop\u003C/a>\u003C/p>\n\u003Cp>btw 最近上班的感受是：为什么这些人都不下班……\u003C/p>",{"headings":350,"localImagePaths":374,"remoteImagePaths":375,"frontmatter":376,"imagePaths":378},[351,353,355,357,360,362,364,366,368,370,372],{"depth":26,"slug":352,"text":352},"功能简介",{"depth":81,"slug":354,"text":354},"技术选型",{"depth":81,"slug":356,"text":356},"主要功能",{"depth":26,"slug":358,"text":359},"关于-logo","关于 logo",{"depth":26,"slug":361,"text":361},"播放本地音乐",{"depth":26,"slug":363,"text":363},"安装插件",{"depth":26,"slug":365,"text":365},"桌面歌词",{"depth":26,"slug":367,"text":367},"播放控制",{"depth":26,"slug":369,"text":369},"自定义主题",{"depth":81,"slug":371,"text":371},"常规样式",{"depth":81,"slug":373,"text":373},"高级样式",[],[],{"title":341,"pubDate":377,"category":33,"excerpt":343},["Date","2023-07-23T22:38:39.000Z"],[],"nginx端口转发记录",{"id":379,"data":381,"body":384,"filePath":385,"digest":386,"rendered":387},{"title":379,"pubDate":382,"category":273,"excerpt":383},["Date","2020-07-05T21:44:26.000Z"],"在玩微信公众号的时候遇到的nginx端口转发的问题。","# 起因\n事情的开始是这样的。我准备试一下用服务器接收一下用户发给公众号的消息，就是当用户给公众号发消息的时候，微信会自动的给配置的服务器发送一个post请求，其中包含着消息。结果发现，微信公众平台配置的服务器地址只能是80端口。但是80端口放的是这个博客啊… 一个端口又不能被两个进程同时监听，于是只好端口转发。\n\n# nginx端口转发\n其实只需要在nginx中配置一下就好了。  \n由于我的80端口是blog的地址，也就是说我可以把微信公众号的监听服务开启在其他端口，但是把经由80端口的请求转交给其他端口。这样在外边看起来，请求的还是80端口。  \n\n首先配置一下端口转发，如下：\n```\nlocation / {\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header Host $http_host;\n            proxy_set_header X-NginX-Proxy true;\n            proxy_pass http://127.0.0.1:targetPort/;\n        }\n```\nproxy_set_header可以重新定义传递给代理服务器的请求头。也就是直接跟在proxy_set_header后半的诸如X-Real-IP这样的东西。  \n然后设置一下目标端口就好啦，这样就相当于用nginx转发了请求，就会将经由80端口的所有请求转发到目标端口。但是这样会有问题，因为请求我的博客的get请求也会被转发掉。因此，还需要再将与博客相关的请求过滤掉：\n```\n    location ~ .*\\.(htm|html)$ {\n            root   html/blog;\n            index  index.html index.htm;\n        }\n```\n意思是这样的：  \n第一行的~表示区分大小写的正则匹配，后边的就是正则式啦。  \n不过这样子还是有一点问题，就是对于二级路径什么的都不能匹配，而且感觉这样子需要手动过滤的东西太多了，不是一个很好的方案。。。（之后再想吧）","src/content/posts/nginx端口转发记录.md","6638639df65a33fc",{"html":388,"metadata":389},"\u003Ch1 id=\"起因\">起因\u003C/h1>\n\u003Cp>事情的开始是这样的。我准备试一下用服务器接收一下用户发给公众号的消息，就是当用户给公众号发消息的时候，微信会自动的给配置的服务器发送一个post请求，其中包含着消息。结果发现，微信公众平台配置的服务器地址只能是80端口。但是80端口放的是这个博客啊… 一个端口又不能被两个进程同时监听，于是只好端口转发。\u003C/p>\n\u003Ch1 id=\"nginx端口转发\">nginx端口转发\u003C/h1>\n\u003Cp>其实只需要在nginx中配置一下就好了。\u003Cbr>\n由于我的80端口是blog的地址，也就是说我可以把微信公众号的监听服务开启在其他端口，但是把经由80端口的请求转交给其他端口。这样在外边看起来，请求的还是80端口。\u003C/p>\n\u003Cp>首先配置一下端口转发，如下：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>location / {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            proxy_set_header X-Real-IP $remote_addr;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            proxy_set_header Host $http_host;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            proxy_set_header X-NginX-Proxy true;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            proxy_pass http://127.0.0.1:targetPort/;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>proxy_set_header可以重新定义传递给代理服务器的请求头。也就是直接跟在proxy_set_header后半的诸如X-Real-IP这样的东西。\u003Cbr>\n然后设置一下目标端口就好啦，这样就相当于用nginx转发了请求，就会将经由80端口的所有请求转发到目标端口。但是这样会有问题，因为请求我的博客的get请求也会被转发掉。因此，还需要再将与博客相关的请求过滤掉：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    location ~ .*\\.(htm|html)$ {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            root   html/blog;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            index  index.html index.htm;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>意思是这样的：\u003Cbr>\n第一行的~表示区分大小写的正则匹配，后边的就是正则式啦。\u003Cbr>\n不过这样子还是有一点问题，就是对于二级路径什么的都不能匹配，而且感觉这样子需要手动过滤的东西太多了，不是一个很好的方案。。。（之后再想吧）\u003C/p>",{"headings":390,"localImagePaths":395,"remoteImagePaths":396,"frontmatter":397,"imagePaths":399},[391,393],{"depth":283,"slug":392,"text":392},"起因",{"depth":283,"slug":394,"text":394},"nginx端口转发",[],[],{"title":379,"pubDate":398,"category":273,"excerpt":383},["Date","2020-07-05T21:44:26.000Z"],[],"centos系统下nginx服务器配置https",{"id":400,"data":402,"body":405,"filePath":406,"digest":407,"rendered":408},{"title":400,"pubDate":403,"category":273,"excerpt":404},["Date","2020-09-05T13:45:32.000Z"],"申请ssl证书，并把它配置到centos系统的nginx服务器上。","最近遇到两个场景需要用到https，一个是微信小程序的服务需要https，另一个是浏览器的某些api，比如navigator.mediaDevices只能在https下才可用。对于第一个场景，配置过一次https，是在阿里云领的免费的SSL证书。当时的证书通用名称填的是service.maotoumao.xyz，因为当时想的是提供一些https服务。但是对于网页来说，用https://service.maotoumao.xyz/xxxx实在是有点不好看，因此索性又在freessl.cn上又领了个证书，然后配置了一下，顺便做一个记录。\n\n## 创建与配置\n创建证书其实挺简单的，打开freessl.cn，输入域名，点击创建免费的ssl证书，即可。\n![freessl.cn首页](http://imgs.maotoumao.xyz/freessl_index.png)\n接下来需要填写一下邮箱，CSR生成选浏览器生成就好了。\n![freessl.cn邮箱](http://imgs.maotoumao.xyz/freessl_email.png)\n单击点击创建就好啦。\n\n接下来，需要在域名管理的地方设置一下解析，然后再把网站提供的密钥和证书存储到服务器某个位置。\n接下来就打开nginx的配置项，在里面加上https的相关配置：\n``` ini\n    server {\n       listen       443 ssl;\n       server_name  maotoumao.xyz;\n       \n       ssl_certificate      \"你的pem文件的路径\";\n       ssl_certificate_key  \"你的key文件的路径\";\n\n       ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n\n    }\n```\n接下来，执行：\n``` shell\n    nginx -s reload\n```\n**按理说**应该就好了。\n\n## 遇到问题\n但是这个时候就遇到问题了。无论怎么改动nginx的配置，配置都没有生效。那么问题来了，这不是玄学吗？？？？\n### 排查过程\n1. 检测配置文件\n``` shell\n    nginx -t\n```\n执行上述代码可以看到，会弹出一个提示框，告诉我们配置文件的地址和语法是否正确。我们发现我们改动的配置项是对的。\n2. 那为什么不生效??\n> 万能大法： 重启。。\n原因可能是这样的：有其他的nginx进程启动，占用了这个配置文件，导致不生效。解决方案如下：\n```\n    sudo pkill -f nginx & wait $!\n    nginx\n```\n重启一下，发现就好了。\n\n---\n## 参考文献\n1. [nginx - nginx: [emerg] bind() to [::]:80 failed (98: Address already in use)\n](https://stackoverflow.com/questions/14972792/nginx-nginx-emerg-bind-to-80-failed-98-address-already-in-use#:~:text=%5B%3A%3A%5D%3A80%20is,%5B%3A%3A%5D%3A80%20.&text=i%20fixed%20this%20by%20running,starting%20on%20the%20desired%20port.)","src/content/posts/centos系统下nginx服务器配置https.md","20142a68c974f8a0",{"html":409,"metadata":410},"\u003Cp>最近遇到两个场景需要用到https，一个是微信小程序的服务需要https，另一个是浏览器的某些api，比如navigator.mediaDevices只能在https下才可用。对于第一个场景，配置过一次https，是在阿里云领的免费的SSL证书。当时的证书通用名称填的是service.maotoumao.xyz，因为当时想的是提供一些https服务。但是对于网页来说，用\u003Ca href=\"https://service.maotoumao.xyz/xxxx%E5%AE%9E%E5%9C%A8%E6%98%AF%E6%9C%89%E7%82%B9%E4%B8%8D%E5%A5%BD%E7%9C%8B%EF%BC%8C%E5%9B%A0%E6%AD%A4%E7%B4%A2%E6%80%A7%E5%8F%88%E5%9C%A8freessl.cn%E4%B8%8A%E5%8F%88%E9%A2%86%E4%BA%86%E4%B8%AA%E8%AF%81%E4%B9%A6%EF%BC%8C%E7%84%B6%E5%90%8E%E9%85%8D%E7%BD%AE%E4%BA%86%E4%B8%80%E4%B8%8B%EF%BC%8C%E9%A1%BA%E4%BE%BF%E5%81%9A%E4%B8%80%E4%B8%AA%E8%AE%B0%E5%BD%95%E3%80%82\">https://service.maotoumao.xyz/xxxx实在是有点不好看，因此索性又在freessl.cn上又领了个证书，然后配置了一下，顺便做一个记录。\u003C/a>\u003C/p>\n\u003Ch2 id=\"创建与配置\">创建与配置\u003C/h2>\n\u003Cp>创建证书其实挺简单的，打开freessl.cn，输入域名，点击创建免费的ssl证书，即可。\n\u003Cimg src=\"http://imgs.maotoumao.xyz/freessl_index.png\" alt=\"freessl.cn首页\">\n接下来需要填写一下邮箱，CSR生成选浏览器生成就好了。\n\u003Cimg src=\"http://imgs.maotoumao.xyz/freessl_email.png\" alt=\"freessl.cn邮箱\">\n单击点击创建就好啦。\u003C/p>\n\u003Cp>接下来，需要在域名管理的地方设置一下解析，然后再把网站提供的密钥和证书存储到服务器某个位置。\n接下来就打开nginx的配置项，在里面加上https的相关配置：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ini\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    server {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">       listen       443 ssl\u003C/span>\u003Cspan style=\"color:#6A737D\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">       server_name  maotoumao.xyz\u003C/span>\u003Cspan style=\"color:#6A737D\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">       \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">       ssl_certificate      \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"你的pem文件的路径\"\u003C/span>\u003Cspan style=\"color:#6A737D\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">       ssl_certificate_key  \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"你的key文件的路径\"\u003C/span>\u003Cspan style=\"color:#6A737D\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">       ssl_protocols TLSv1 TLSv1.1 TLSv1.2\u003C/span>\u003Cspan style=\"color:#6A737D\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>接下来，执行：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"shell\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    nginx\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -s\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> reload\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>按理说\u003C/strong>应该就好了。\u003C/p>\n\u003Ch2 id=\"遇到问题\">遇到问题\u003C/h2>\n\u003Cp>但是这个时候就遇到问题了。无论怎么改动nginx的配置，配置都没有生效。那么问题来了，这不是玄学吗？？？？\u003C/p>\n\u003Ch3 id=\"排查过程\">排查过程\u003C/h3>\n\u003Col>\n\u003Cli>检测配置文件\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"shell\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    nginx\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -t\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>执行上述代码可以看到，会弹出一个提示框，告诉我们配置文件的地址和语法是否正确。我们发现我们改动的配置项是对的。\n2. 那为什么不生效??\u003C/p>\n\u003Cblockquote>\n\u003Cp>万能大法： 重启。。\n原因可能是这样的：有其他的nginx进程启动，占用了这个配置文件，导致不生效。解决方案如下：\u003C/p>\n\u003C/blockquote>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    sudo pkill -f nginx &#x26; wait $!\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    nginx\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>重启一下，发现就好了。\u003C/p>\n\u003Chr>\n\u003Ch2 id=\"参考文献\">参考文献\u003C/h2>\n\u003Col>\n\u003Cli>\u003Ca href=\"https://stackoverflow.com/questions/14972792/nginx-nginx-emerg-bind-to-80-failed-98-address-already-in-use#:~:text=%5B%3A%3A%5D%3A80%20is,%5B%3A%3A%5D%3A80%20.&#x26;text=i%20fixed%20this%20by%20running,starting%20on%20the%20desired%20port.\">nginx - nginx: [emerg] bind() to [::]:80 failed (98: Address already in use)\n\u003C/a>\u003C/li>\n\u003C/ol>",{"headings":411,"localImagePaths":420,"remoteImagePaths":421,"frontmatter":422,"imagePaths":424},[412,414,416,418],{"depth":26,"slug":413,"text":413},"创建与配置",{"depth":26,"slug":415,"text":415},"遇到问题",{"depth":81,"slug":417,"text":417},"排查过程",{"depth":26,"slug":419,"text":419},"参考文献",[],[],{"title":400,"pubDate":423,"category":273,"excerpt":404},["Date","2020-09-05T13:45:32.000Z"],[],"webpack学习entry",{"id":425,"data":427,"body":431,"filePath":432,"digest":433,"rendered":434},{"title":428,"pubDate":429,"category":33,"excerpt":430},"webpack学习 —— entry",["Date","2021-01-31T20:44:28.000Z"],"以前对于webpack的配置一直感觉云里雾里，包括实习的时候对webpack的配置也是摸不清楚，所以学习一下webpack，并记录一下学习过程中遇到的问题。","## 基本思想\n在开始之前，首先想一下，如果不用各种框架，我们会怎么去开发一个web前端页面。页面的骨架由html组成，html内可能以内嵌或者引入外部文件的方式来加载css和js。为了使得代码不至于太臃肿，我们会倾向于选择引入外部文件。对于想尽快完成任务的人来说，都会优先选择一些别人开发好的外部js库来提升效率，比如说在我们自己的js代码**之前**使用script标签引入jquery库，由于jquery在window对象下挂载了一个名为$的变量，并且它在页面加载时优先于我们自定义的代码被执行，因此我们可以在我们的代码中尽情使用jquery。那么问题来了：当规模比较庞大，需要引入很多很多外部的库的时候，或者我们的代码量很大，需要由不同的人写一些重复功能的代码的时候，代码整体的组织势必会混乱，单人开发可能都会难以管理，何况多人协同。同时，我们也不能保证我们引入的库是否挂载在同名变量下，也就是可能会有命名空间的冲突。\n\n这个时候，我们想一下我们以前学过的其他语言是怎么做的：比如说我们需要使用python实现某个功能，我们可能会把部分工具代码作为一个模块，写在一个文件中，在其他需要使用到地方进行导入。这种方式有显而易见的好处：最直接的是，命名空间不会被污染（因为并没有挂载到相同的全局变量下），除此之外，模块之间耦合程度低，增加了代码的可维护性。不过，在以前(ES6之前)，这种方式在浏览器中对于js来说是行不通的。\n\n这个时候，webpack就体现出了它的作用。webpack认为，工程中的每一个文件都可以看作一个模块，我们可以在代码中以commonjs的标准定义js模块，当我们在配置中指定某一个js文件作为根入口(entry)时，webpack可以根据我们导入的其他模块来自动的递归的生成依赖树，把所有涉及到的js文件按顺序打包到一个或多个js文件中，并插入到html文档中。webpack默认是只对js文件进行操作，但是，我们也可以通过使用loader对其他的非js的文件进行加载。\n\n那么接下来，我们从最开始的入口——entry开始吧。\n\n## entry的定义\n> entry是配置模块的入口，可抽象成输入，Webpack 执行构建的第一步将从入口开始搜寻及递归解析出所有入口依赖的模块。(参考：https://webpack.wuhaolin.cn/2%E9%85%8D%E7%BD%AE/2-1Entry.html)\n\n在webpack.config.js中我们可以这样去定义：\n```js\nmodule.exports = {\n    entry: 'xxx' \n}\n```\n其中，entry的值有三种：\n- 字符串：string\n    这种类型指定了一个入口，于是webpack会以这个文件作为入口，输出一个打包后的bundle.js（不一定叫这个名字）\n- 字符串数组：string[]\n    这种类型指定了多个入口，webpack会依次以这些入口递归的分析并打包，输出一个打包后的bundle.js。\n- 对象：object\u003Cstring, string|string[]>\n    这种类型指定了多个入口，webpack会把这些值作为入口依次进行递归的分析并打包，输出**多个**打包后的文件，每个文件默认的名字是对象中的key的名字。\n\n看上去都是很好理解的概念，但是接下来问题就来了：\n\n## 入口的文件存在引用怎么处理?\n假如有两个文件：\n```javascript\n/***** src/a.js *****/\nimport './b.js'\n\nconsole.log('load a');\n\n/***** src/b.js *****/\nconsole.log('load b')\n```\n\n\n### array类型\n假如根目录下的webpack.config.js的入口指定为：\n```javascript\nmodule.exports = {\n    entry: [\n        './src/a.js',\n        './src/b.js'\n    ]\n}\n```\n我们可以看到，首先，webpack会以a为入口，a引入了b，所以先加载b，然后加载a，因此输出load b，load a。然后以b为入口，由于这种模式下会打包到同一个文件中，而这个文件已经引入了b，所以此时不会再引入b，因此最终的输出就是：load b和load a。\n\n### object类型：\n假如根目录下的webpack.config.js的入口指定为：\n```javascript\nmodule.exports = {\n    entry: [\n        e1: './src/a.js',\n        e2: './src/b.js'\n    ]\n}\n```\n\n这种情况下，我们知道，默认会被打包成2个文件，一个名为e1，一个名为e2。首先以e1为入口，分析发现，引入了b的代码，因此输出load b。然后输出load a。此时e1打包完成。但是与array不一样的是，object类型的每一个键值对都会被打包成一个js文件，在这种情况下，还是会以b为入口，再次去进行递归检索。此时又会输出load b。因此最终的输出是 load b， load a和load b。\n\n\n## 循环引用怎么处理？\n假如有两个文件：\n```javascript\n/***** src/a.js *****/\nimport './b.js'\n\nconsole.log('load a');\n\n/***** src/b.js *****/\nimport './a.js'\n\nconsole.log('load b')\n```\n\n假如根目录下的webpack.config.js的入口指定为：\n```javascript\nmodule.exports = {\n    entry: [\n        e1: './src/a.js',\n        e2: './src/b.js'\n    ]\n}\n```\n经过测试，这种情况下webpack会采用一个类似于标记是否访问过的策略。首先以a为入口，a导入了b，那么先输出load b，然后发现b导入了a，这个时候认为a已经导入过了，便输出一个load a，就结束了。object同理。\n\n当然，这种情况下，如果使用到了另一个模块中未定义的变量，最终打包后的文件就会出现未初始化的错误。并且还存在于类似于懒加载的机制：假如引入了另一个文件，但是并没有使用其中的变量，那么它也不会报错，比如：\n``` javascript\n/***** src/a.js *****/\nimport b from './b.js'\n\nconsole.log('load a', b);\n\nexport default 'a';\n/***** src/b.js *****/\nimport a from './a.js'\n\nconsole.log('load b') ; // 如果按照上边entry的写法，写console.log(a)就会报错\n\nexport default 'b';\n```","src/content/posts/webpack学习——entry.md","4aae805f80974002",{"html":435,"metadata":436},"\u003Ch2 id=\"基本思想\">基本思想\u003C/h2>\n\u003Cp>在开始之前，首先想一下，如果不用各种框架，我们会怎么去开发一个web前端页面。页面的骨架由html组成，html内可能以内嵌或者引入外部文件的方式来加载css和js。为了使得代码不至于太臃肿，我们会倾向于选择引入外部文件。对于想尽快完成任务的人来说，都会优先选择一些别人开发好的外部js库来提升效率，比如说在我们自己的js代码\u003Cstrong>之前\u003C/strong>使用script标签引入jquery库，由于jquery在window对象下挂载了一个名为$的变量，并且它在页面加载时优先于我们自定义的代码被执行，因此我们可以在我们的代码中尽情使用jquery。那么问题来了：当规模比较庞大，需要引入很多很多外部的库的时候，或者我们的代码量很大，需要由不同的人写一些重复功能的代码的时候，代码整体的组织势必会混乱，单人开发可能都会难以管理，何况多人协同。同时，我们也不能保证我们引入的库是否挂载在同名变量下，也就是可能会有命名空间的冲突。\u003C/p>\n\u003Cp>这个时候，我们想一下我们以前学过的其他语言是怎么做的：比如说我们需要使用python实现某个功能，我们可能会把部分工具代码作为一个模块，写在一个文件中，在其他需要使用到地方进行导入。这种方式有显而易见的好处：最直接的是，命名空间不会被污染（因为并没有挂载到相同的全局变量下），除此之外，模块之间耦合程度低，增加了代码的可维护性。不过，在以前(ES6之前)，这种方式在浏览器中对于js来说是行不通的。\u003C/p>\n\u003Cp>这个时候，webpack就体现出了它的作用。webpack认为，工程中的每一个文件都可以看作一个模块，我们可以在代码中以commonjs的标准定义js模块，当我们在配置中指定某一个js文件作为根入口(entry)时，webpack可以根据我们导入的其他模块来自动的递归的生成依赖树，把所有涉及到的js文件按顺序打包到一个或多个js文件中，并插入到html文档中。webpack默认是只对js文件进行操作，但是，我们也可以通过使用loader对其他的非js的文件进行加载。\u003C/p>\n\u003Cp>那么接下来，我们从最开始的入口——entry开始吧。\u003C/p>\n\u003Ch2 id=\"entry的定义\">entry的定义\u003C/h2>\n\u003Cblockquote>\n\u003Cp>entry是配置模块的入口，可抽象成输入，Webpack 执行构建的第一步将从入口开始搜寻及递归解析出所有入口依赖的模块。(参考：\u003Ca href=\"https://webpack.wuhaolin.cn/2%E9%85%8D%E7%BD%AE/2-1Entry.html\">https://webpack.wuhaolin.cn/2%E9%85%8D%E7%BD%AE/2-1Entry.html\u003C/a>)\u003C/p>\n\u003C/blockquote>\n\u003Cp>在webpack.config.js中我们可以这样去定义：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"js\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">module\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">exports\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    entry: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'xxx'\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>其中，entry的值有三种：\u003C/p>\n\u003Cul>\n\u003Cli>字符串：string\n这种类型指定了一个入口，于是webpack会以这个文件作为入口，输出一个打包后的bundle.js（不一定叫这个名字）\u003C/li>\n\u003Cli>字符串数组：string[]\n这种类型指定了多个入口，webpack会依次以这些入口递归的分析并打包，输出一个打包后的bundle.js。\u003C/li>\n\u003Cli>对象：object&#x3C;string, string|string[]>\n这种类型指定了多个入口，webpack会把这些值作为入口依次进行递归的分析并打包，输出\u003Cstrong>多个\u003C/strong>打包后的文件，每个文件默认的名字是对象中的key的名字。\u003C/li>\n\u003C/ul>\n\u003Cp>看上去都是很好理解的概念，但是接下来问题就来了：\u003C/p>\n\u003Ch2 id=\"入口的文件存在引用怎么处理\">入口的文件存在引用怎么处理?\u003C/h2>\n\u003Cp>假如有两个文件：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/***** src/a.js *****/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> './b.js'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'load a'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/***** src/b.js *****/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'load b'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"array类型\">array类型\u003C/h3>\n\u003Cp>假如根目录下的webpack.config.js的入口指定为：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">module\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">exports\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    entry: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        './src/a.js'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        './src/b.js'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>我们可以看到，首先，webpack会以a为入口，a引入了b，所以先加载b，然后加载a，因此输出load b，load a。然后以b为入口，由于这种模式下会打包到同一个文件中，而这个文件已经引入了b，所以此时不会再引入b，因此最终的输出就是：load b和load a。\u003C/p>\n\u003Ch3 id=\"object类型\">object类型：\u003C/h3>\n\u003Cp>假如根目录下的webpack.config.js的入口指定为：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">module\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">exports\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    entry: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        e1: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'./src/a.js'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        e2: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'./src/b.js'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>这种情况下，我们知道，默认会被打包成2个文件，一个名为e1，一个名为e2。首先以e1为入口，分析发现，引入了b的代码，因此输出load b。然后输出load a。此时e1打包完成。但是与array不一样的是，object类型的每一个键值对都会被打包成一个js文件，在这种情况下，还是会以b为入口，再次去进行递归检索。此时又会输出load b。因此最终的输出是 load b， load a和load b。\u003C/p>\n\u003Ch2 id=\"循环引用怎么处理\">循环引用怎么处理？\u003C/h2>\n\u003Cp>假如有两个文件：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/***** src/a.js *****/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> './b.js'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'load a'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/***** src/b.js *****/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> './a.js'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'load b'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>假如根目录下的webpack.config.js的入口指定为：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">module\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">exports\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    entry: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        e1: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'./src/a.js'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        e2: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'./src/b.js'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>经过测试，这种情况下webpack会采用一个类似于标记是否访问过的策略。首先以a为入口，a导入了b，那么先输出load b，然后发现b导入了a，这个时候认为a已经导入过了，便输出一个load a，就结束了。object同理。\u003C/p>\n\u003Cp>当然，这种情况下，如果使用到了另一个模块中未定义的变量，最终打包后的文件就会出现未初始化的错误。并且还存在于类似于懒加载的机制：假如引入了另一个文件，但是并没有使用其中的变量，那么它也不会报错，比如：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/***** src/a.js *****/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> b \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> './b.js'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'load a'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, b);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">export\u003C/span>\u003Cspan style=\"color:#F97583\"> default\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'a'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/***** src/b.js *****/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> a \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> './a.js'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'load b'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) ; \u003C/span>\u003Cspan style=\"color:#6A737D\">// 如果按照上边entry的写法，写console.log(a)就会报错\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">export\u003C/span>\u003Cspan style=\"color:#F97583\"> default\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'b'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>",{"headings":437,"localImagePaths":453,"remoteImagePaths":454,"frontmatter":455,"imagePaths":457},[438,440,442,445,447,450],{"depth":26,"slug":439,"text":439},"基本思想",{"depth":26,"slug":441,"text":441},"entry的定义",{"depth":26,"slug":443,"text":444},"入口的文件存在引用怎么处理","入口的文件存在引用怎么处理?",{"depth":81,"slug":446,"text":446},"array类型",{"depth":81,"slug":448,"text":449},"object类型","object类型：",{"depth":26,"slug":451,"text":452},"循环引用怎么处理","循环引用怎么处理？",[],[],{"title":428,"pubDate":456,"category":33,"excerpt":430},["Date","2021-01-31T20:44:28.000Z"],[],"reactnative性能优化拖拽排序",{"id":458,"data":460,"body":464,"filePath":465,"digest":466,"rendered":467},{"title":461,"pubDate":462,"category":33,"excerpt":463},"【干货】React Native性能优化——长列表拖拽排序",["Date","2023-01-09T20:24:18.000Z"],"拖拽排序的简单优化方案，顺便记录下一些RN通用的优化思路。","# 前言\r\n这是在做业余项目[MusicFree](https://github.com/maotoumao/MusicFree)时的一些技术探索，简单记录一下优化过程和思考方式。前情可以戳[这篇文章](http://blog.upup.fun/2022/10/04/%E5%86%99%E4%B8%80%E4%B8%AA%E5%85%A8%E7%BD%91%E6%9C%80%E5%85%A8%E7%9A%84%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8/)。\r\n\r\n先来看最终的效果，再来说需求和实现：\r\n\r\n\u003Cvideo src=\"http://storage.upup.fun/musicfree/313DA58C945D3DD5A4F005C0A6CDD29F.mp4\" controls >\u003C/video>\r\n\r\n在上述视频中可以看到，这是一个由628首歌曲构成的歌单**长列表**，主要功能是对歌单里面的歌曲进行**拖拽排序**和**批量选择操作**，看起来还是比较流畅的。\r\n\r\n\r\n# 需求分析&实现思路\r\n首先来明确一下需求，或者说最终要达到的目标吧。其实在前言部分已经够明确了，关键词就是**长列表**、**拖拽排序**和**批量选择**；作为一个业余项目，最终要达到的目标也掺杂着强烈的个人偏好：**不卡、实用**。\r\n\r\n## 方案1：做一个调包侠\r\n为了实现以上效果，第一反应就是寻找社区开源项目，看有没有类似的库。网上搜了一圈，还在维护的貌似就只有这个[react-native-draggable-flatlist](https://github.com/computerjazz/react-native-draggable-flatlist)库了。\r\n\r\n抱着试试看的心态，我们把[代码写好](https://github.com/maotoumao/MusicFree/blob/draggable-flatlist/src/pages/musicListEditor/components/musicList.tsx)：\r\n> 其实最早期简单试用了一下，就把这个方案否决掉了。原因也很简单，一方面是有点卡，另一方面是它不知道为啥会导致模拟器debug时崩溃。下面的对比实验视频是在最后确定方案之后做的，忽略交互方式和一些底色之类的，相关的优化都是相同的。\r\n\r\n\u003Cvideo src=\"http://storage.upup.fun/musicfree/SVID_20230109_230717_1.mp4\" controls>\u003C/video>\r\n\r\n可以发现其中有几点体验较差的地方：\r\n1. 拖拽到顶自动滑动的时候，选中的元素好像一直在抖\r\n2. 单选时选中状态反应较快（和最终版速度差不多，因为这里的优化一样）；但**全选、全不选有明显延迟**(~1s)\r\n3. 拖拽结束后，**花费大量时间执行回调函数**（可以观察一下颜色，停止拖拽后选中的元素还会保持很长一段时间的选中态）\r\n\r\n回顾下目标：\r\n- 卡吗？卡。\r\n- 实用吗？凑合能用。\r\n- 满意吗？凑合能用可以，卡的这么明显忍不了。\r\n- 那怎么办？自己写个吧。\r\n\r\n## 方案2：自己实现\r\n### 通用？定制？\r\n既然要自己实现，那么还是得好好设计一下。第一个要思考的问题便是：要做一个通用方案还是做一个定制的方案。因为这可能会涉及到方案设计，如果要做一个通用方案，那可能会更少的trick，更多的配置来满足通用性和灵活性。如果是一个仅仅在当前项目中使用的方案，那就可以加很多**前提条件**和**折中技巧**了。      \r\n仔细想了想，首先我在短期内不太会用React Native开一个新的有长列表的坑，其次我也不见得做的会比react-native-draggable-flatlist更好，也不必顾此失彼，先用个项目中的定制方案满足自己的需求就足够了。\r\n\r\n### 怎么才能不卡？\r\n第二个要思考的问题理所当然是如何实现目标了。那么自然有个问题：为啥会卡？   \r\n想一想我们用的库是什么：react-native-draggable-**flatlist**。对，flatlist。简单来说，Flatlist在每次滚动时会**批量预渲染**一定区域内的元素，并把区域外的元素**销毁**。我们来看一下这张图就明白了：\r\n\r\n![flatlist](http://storage.upup.fun/musicfree/K4BF_4TJA%7D1%7DISIGJ%5B%7DWEAT.png)\r\n\r\n可以看出，始终会保持**120个元素**在内存中，每次滑动时会**销毁**不在区域中的元素。Shopify团队针对这一点进行优化开发了[Flashlist](https://shopify.github.io/flash-list/)，它的原理大概是首先渲染一定量的初始元素；但在滑动时滑出视窗的元素不会销毁，而是重复利用：\r\n\r\n![flashlist](http://storage.upup.fun/musicfree/%29OM6%604OYJ%7BVK%7DP%29%28W%24IFZLC.png)\r\n\r\n同时，由于其一次渲染到屏幕上的元素较少（20个之于120个），当**全选**时需要重新渲染的元素数目也会大大减少（简单算一下，少渲染5/6的内容）。它们官网上说相对于原生的Flatlist性能有5~10倍的提升，既然这样，那就用Flashlist好了。\r\n\r\n![官网](http://storage.upup.fun/musicfree/G%7D%24VCM1F0I2W%28NGH%60_D%7B%28%40N.png)\r\n\r\n### 拖拽排序怎么实现？\r\n#### 再来一个问题\r\n以上两个问题思考完了：为了达成目标，我们可以随意在实现时加一些前提/trick，并且我们要把flatlist切换成flashlist以提升长列表性能。接下来就是比较麻烦的地方了：**如何实现拖拽排序**。都思考了这么多问题了，不妨再多加一个问题：最终要实现的效果是**侧重UI交互**还是**侧重功能**？\r\n\r\n如果侧重交互的话，可以大概设计一下理想的效果：\r\n1. 在按住某一个元素上下拖动时，它需要出现在它正确的位置;\r\n2. 并且它的兄弟元素都会被顺滑的挤到一边；\r\n3. 滑动的位置越靠两端，滑动速度越快；\r\n4. 在放手的一瞬间，它会立刻出现在它被移动到位置上。\r\n\r\n从实现角度来说：\r\n1. 在选中一个元素的一瞬间，它的zIndex会被重新设置;\r\n2. 随着手指的拖动，它和它的兄弟元素的y轴位置都会通过setNativeProps调整；\r\n3. 同时需要记录下手指位置距离列表两端的距离来决定是否需要继续scroll，以及下一个scroll的位置；\r\n4. 在放手的一瞬间，这些元素的位置和y轴位置（因为通过setNativeProps改过了）会被重新计算。\r\n\r\n确实，想的挺好，但Flatlist（Flashlist的参数和原生flatlist类似）连scroll的速度都难控制，更别说这些特殊的效果了。再想想目标，交互可以砍一些，果断**侧重功能**。\r\n\r\n#### 前提条件\r\n啰嗦了这么多，其实都是为了给最终实现减少难度。现在我们可以比较放肆的给拖拽排序列表加前提条件了：\r\n- 列表距离顶部和底部的距离已知\r\n> 反正是个个人项目，那我有理由要求整个APP中所有的拖拽列表样式保持一致。这也就意味着列表高度可以直接简单算出来。\r\n\r\n- 列表里面的元素高度、布局稳定，不会随着状态的变化有较大变化\r\n> 这样即便有需要传进来的样式，可以用ref存下样式；参数变化导致重新渲染时不需要重新创建样式对象；同时很多布局信息，如当前位置等也可以简单的算出来。\r\n\r\n- 交互方式固定，每个元素的右边有个小按钮，只能靠这个按钮进行拖拽\r\n> 统一交互的话，这样控制拖拽的逻辑可以直接做在列表组件内部了。具体一点说，通过列表传入的renderItem参数渲染的组件仅仅是下图中的红色部分；蓝色区域用来控制拖拽；拖拽的逻辑和样式仅仅由列表组件内部控制：\r\n\r\n> ![](http://storage.upup.fun/musicfree/iPhone%2014_13%20Pro.png)\r\n\r\n- 目标元素拖动时，它的兄弟元素位置不会出现变化；目标元素拖到哪个元素的上方，就代表它最终会被移动到哪个位置\r\n> 这样只需要通过setNativeProps改变一个元素的属性，甚至可以通过一些trick完全不改动列表元素。\r\n\r\n前提条件加完了，是时候开始设计技术方案了。\r\n\r\n# 技术方案\r\n\r\n把拖拽排序这个问题分解一下，又可以拆成几个子问题：\r\n- 滚动行为\r\n- 高亮元素\r\n- 结束回调  \r\n接下来就尝试从这几个角度去设计一下。\r\n\r\n## 滚动行为\r\n### 整体结构\r\n滚动行为还是比较明了的。首先，列表是一个FlashList（删掉了很多无关代码，代码多了不好看），相关的事件以及需要在这些事件内关注的行为如下：\r\n```typescript\r\n\r\n/** */\r\nfunction SortableFlatList() {\r\n    // 不要干扰原始数据\r\n    const [_data, _setData] = useState([...(data ?? [])]);\r\n    // 是否禁止滚动\r\n    const [scrollEnabled, setScrollEnabled] = useState(true);\r\n    // 是否处在激活状态, -1表示无，其他表示当前激活的下标\r\n    const activeRef = useRef(-1);\r\n    // content偏移值 用来记录滚动距离\r\n    const contentOffsetYRef = useRef\u003Cnumber>(-1);\r\n    // 目标在屏幕内移动距离\r\n    const targetOffsetYRef = useRef\u003Cnumber>(0);\r\n    // 当前移动的方向，0表示不移动，1表示向下，-1表示向上\r\n    const direction = useSharedValue(0);\r\n\r\n    return \u003CFlashList\r\n                scrollEnabled={scrollEnabled}\r\n                ref={_ => {\r\n                    // list的引用，需要用它控制滚动\r\n                }}\r\n                onLayout={evt => {\r\n                    // 布局信息，需要用它拿到尺寸\r\n                }}\r\n                data={_data}\r\n                estimatedItemSize={itemHeight} // 这里其实是每一个元素的高度，直接固定了，也是一个优化项\r\n                scrollEventThrottle={16} // 滚动事件的节流回调\r\n                onTouchStart={e => {\r\n                    if(activeRef.current !== -1) {\r\n                        // 触摸开始时，如果是在拖动状态，那就需要记录下初始位置\r\n                        // 高亮元素\r\n                    }\r\n                }}\r\n                onTouchMove={e => {\r\n                    if(activeRef.current !== -1) {\r\n                        // 移动时，如果在拖动状态，需要更新滚动速度，并记录移动的距离\r\n                        // 修改高亮元素位置\r\n                    }\r\n                }}\r\n                onTouchEnd={e => {\r\n                    if(activeRef.current !== -1) {\r\n                        // 如果是拖动状态，那就执行最终的回调\r\n                        // 重置样式\r\n                    }\r\n                }}\r\n                onTouchCancel={() => {\r\n                    // 取消时所有的符号位和状态\r\n                }}\r\n                onScroll={e => {\r\n                    // 在这里记录下y轴的偏移\r\n                    if(activeRef.current !== -1) {\r\n                        // 滚动时，如果在拖动状态\r\n                    }\r\n                }}\r\n                renderItem={({item, index}) => {\r\n                    return (\r\n                        \u003CSortableFlatListItem/> // 渲染一个满足前提条件的特定元素：它固定右侧是一个用来拖拽的小按钮，高度也是固定的。\r\n                    );\r\n                }}\r\n            />\r\n}\r\n\r\n\r\nfunction _SortableFlatListItem(props: ISortableFlatListItemProps) {\r\n    const {\r\n        setScrollEnabled,\r\n        renderItem,\r\n        setActiveItem,\r\n        item,\r\n        index,\r\n        activeRef,\r\n    } = props;\r\n\r\n\r\n    return (\r\n        \u003CView>\r\n            {renderItem({item, index})}\r\n            \u003CPressable\r\n                onTouchStart={() => {\r\n                    if (activeRef.current !== -1) {\r\n                        return;\r\n                    }\r\n                    /** 使用ref避免其它组件重新渲染; 由于事件冒泡，这里会先触发 */\r\n                    activeRef.current = index;\r\n                    /** 锁定滚动 */\r\n                    setScrollEnabled(false);\r\n                    setActiveItem(item);\r\n                }}\r\n                style={styleRef.current.btn}>\r\n                \u003CIcon name=\"menu\"/>\r\n            \u003C/Pressable>\r\n        \u003C/View>\r\n    );\r\n}\r\n\r\nconst SortableFlatListItem = memo(\r\n    _SortableFlatListItem,\r\n    (prev, curr) => prev.index === curr.index && prev.item === curr.item,\r\n);\r\n```\r\n以上代码中SortableFlatList就是暴露给外部模块直接使用的列表，列表内部其实是用SortableFlatListItem，它由两部分构成，左边一半是使用renderItem直接渲染的组件，右边一半是仅可以用来拖拽的一个Icon按钮。  \r\n\r\n我们会遇到的第一个问题是**禁用滚动的时机**。当拖拽组件时，整个列表需要禁用滚动（仅可以由列表的ref手动控制滚动），不然的话随着拖拽可能触发了滚动事件，导致拖拽失效。由于禁用/启用滚动一定需要重新渲染列表，因此scrollEnabled是一个state，在_SortableFlatListItem的Icon按钮的触摸事件中设置它为false即可，也就是代码中锁定滚动注释的下面那行。\r\n\r\n第二个问题则是，如何记录**当前正在拖拽的元素**，以及这个元素的**初始位置**。根据之前的描述，正在拖拽的元素具有高亮效果，这个高亮效果必然是通过一个**state**控制的；我们可以在SortableFlatListItem中Icon按钮的onPress事件中触发setActiveItem，来更新当前的选中项。而为了得到这个元素的初始位置，我们必须想办法把用户**触碰Icon按钮时的坐标**传递给SortableFlatList。\r\n\r\n为了得到这一部分，这里用了一些小小的trick：我们知道React Native的事件也有**冒泡机制**，也就意味着事件会从子组件冒泡到父组件。\r\n\r\n具体一些说：子组件SortableFlatListItem中Icon按钮的onTouchStart会先触发，接下来会冒泡到SortableFlat的onTouchStart事件。这就给了我们一些可乘之机：我们可以再使用一个ref记录当前是否处于拖拽态，也就是代码中的activeRef，至于它的值，存放**拖拽中元素的下标**就完全足够了。\r\n\r\n如果触发拖拽，那么在Icon按钮的onTouchStart中同时更新activeItem和这个activeRef。接下来，事件会冒泡到SortableFlatList中，这时父组件的onTouchStart捕获到的activeRef已经被标记为处于拖拽状态，根据它的值便可以轻松判断当前的状态，并决定要不要记录下在列表中的初始位置；而此时activeItem作为一个state还没有被更新为最新的状态。总之，**在父组件（也就是列表中）所有的eventhandler中都使用activeRef判断，activeItem作为状态仅仅用于更新高亮状态。**\r\n\r\n### autoscroll\r\n整体结构说完了，接下来要考虑的就是拖拽到两端的情况了。React Native的scroll还是有点难用的，没办法控制滚动速度。而为了达到最初设想的：拖拽到两端时会自动滚动，且滚动速度和距离两端的位置有关，那就不得不用点trick。\r\n\r\ntrick的原理其实也比较好理解：\r\n1. 如果当前在滚动中，不做处理。\r\n2. 如果当前拖拽的元素超过了某一阈值，且当前没有在滚动中，那么根据**当前拖拽元素的位置**计算**方向**以及**滚动的目标位置**，并触发滚动。\r\n3. 在onScroll事件中监听（注意节流），在当前滚动的距离与目标位置比较接近时，判断**触发下一次滚动**\r\n4. 如果当前位置已经无法在滚动，停止滚动。\r\n\r\n除了上述方案，不断地setTimeout或者setInterval也可以完成目的，事实上最初的版本也确实这么做的，只不过看起来会忽快忽慢。\r\n\r\n在实现的过程中，也使用了reanimated提供的useSharedValue来存储方向，并使用useDerivedValue在方向变化时及时地在不触发重新渲染的情况下进行滚动。\r\n\r\n控制滚动的代码如下：\r\n``` typescript\r\nfunction scrollToTarget(forceScroll = false) {\r\n    // 未进行拖拽\r\n    if (activeRef.current === -1) {\r\n        scrollingRef.current = false;\r\n        return;\r\n    }\r\n    // 滚动中就不滚了 \r\n    if (scrollingRef.current && !forceScroll) {\r\n        scrollingRef.current = true;\r\n        return;\r\n    }\r\n    // 方向是0, 也就是没有在滚动\r\n    if (direction.value === 0) {\r\n        scrollingRef.current = false;\r\n        return;\r\n    }\r\n    // 下一次滚动到的位置\r\n    const nextTarget =\r\n        Math.sign(direction.value) *\r\n            Math.max(Math.abs(direction.value), 0.3) *\r\n            300 +\r\n        contentOffsetYRef.current;\r\n    // 当前到极限了\r\n    if (\r\n        (contentOffsetYRef.current \u003C= 2 &&\r\n            nextTarget \u003C contentOffsetYRef.current) ||\r\n        (contentOffsetYRef.current >=\r\n            listContentHeight - (layoutRef.current?.height ?? 0) - 2 &&\r\n            nextTarget > contentOffsetYRef.current)\r\n    ) {\r\n        scrollingRef.current = false;\r\n        return;\r\n    }\r\n    scrollingRef.current = true;\r\n    // 超出区域\r\n    targetOffsetYRef.current = Math.min(\r\n        Math.max(0, nextTarget),\r\n        listContentHeight - (layoutRef.current?.height ?? 0),\r\n    );\r\n    // 开始滚动\r\n    listRef.current?.scrollToOffset({\r\n        animated: true,\r\n        offset: targetOffsetYRef.current,\r\n    });\r\n}\r\n\r\n```\r\n列表中onScroll的事件也十分简单粗暴：\r\n```typescript\r\nonScroll={e => {\r\n    contentOffsetYRef.current = e.nativeEvent.contentOffset.y;\r\n    // 与目标距离小于2像素就强制再滚一次\r\n    if (\r\n        activeRef.current !== -1 &&\r\n        Math.abs(\r\n            contentOffsetYRef.current -\r\n                targetOffsetYRef.current,\r\n        ) \u003C 2\r\n    ) {\r\n        scrollToTarget(true);\r\n    }\r\n}}\r\n```\r\n\r\n## 高亮元素\r\n根据上边的一大通分析，在这里已经把高亮简化成了“浮在列表上，且拖拽中的兄弟元素不需要移动位置”。在这个前提下，我们考虑到的思路有两种：\r\n\r\n- 给list传入一个额外的extra字段，其中放上activeItem；当activeItem变化时逐个元素进行比较，并更新对应元素的样式\r\n- list完全不动，在列表上再浮一个长的一模一样的列表元素，直接更新它就好了\r\n\r\n显然是第二种思路更简单一些。并且由于list的元素有memo，在拖拽时甚至list中的元素都不会重新渲染：\r\n![代码截图](http://storage.upup.fun/musicfree/QQ%E5%9B%BE%E7%89%8720230110234021.png)\r\n\r\n而对这个“假高亮”的控制，只需要通过setNativeProps在开始拖拽时更新它的top、opacity和zIndex，滑动时更新它的top，并在拖拽结束时更新zIndex为-1，opacity为0隐藏掉，看起来似乎就是完全跟手的了：\r\n```typescript\r\n    // ...\r\n    onTouchMove={e => {\r\n        fakeItemRef.current!.setNativeProps({\r\n            top: offsetRef.current,\r\n            opacity: 1,\r\n            zIndex: 100,\r\n        });\r\n    }}\r\n    onTouchEnd={e => {\r\n        fakeItemRef.current!.setNativeProps({\r\n            top: 0,\r\n            opacity: 0,\r\n            zIndex: -1,\r\n        });\r\n    }}\r\n    onTouchCancel={e => {\r\n        fakeItemRef.current!.setNativeProps({\r\n            top: 0,\r\n            opacity: 0,\r\n            zIndex: -1,\r\n        });\r\n    }}\r\n\r\n```\r\n\r\n## 执行回调\r\n接下来就需要拖拽结束后的处理了，这里其实是比较轻松的一步。在一通操作之下，我们记录下了某个元素在屏幕内移动的距离和列表滚动的距离，又强行限制住了列表的高度，那拖拽后的位置就很容易计算出来了：\r\n```typescript\r\n    onTouchEnd={(e) => {\r\n            // ...\r\n            // activeRef.current是初始下标，计算一下偏移即可\r\n            index =\r\n                activeRef.current +\r\n                Math.round(\r\n                    (e.nativeEvent.pageY -\r\n                        initDragPageY.current +\r\n                        initDragLocationY.current) /\r\n                        itemHeight,\r\n                );\r\n            // 注意范围约束\r\n            index = Math.min(data.length, Math.max(index, 0));\r\n            // 起始下标: activeRef.current  结束下标: index\r\n            if (activeRef.current !== index) {\r\n                // 计算下排序后的数组\r\n                let nData = _data\r\n                    .slice(0, activeRef.current)\r\n                    .concat(_data.slice(activeRef.current + 1));\r\n                nData.splice(index, 0, activeItem as T);\r\n                // 执行回调\r\n                onSortEnd?.(nData);\r\n            }\r\n        }\r\n    }           \r\n```\r\n\r\n\r\n\r\n到这里就算差不多了，最终的效果也如开头的视频那样，大概看起来还可以。不过细看还是有瑕疵，比如点击时的水波纹效果无法扩散到拖拽按钮的位置，这也可以通过优化布局来解决（设置列表项宽度为屏幕宽度，拖拽按钮的position设置为absolute并放在列表项上层，也就是并排改成折叠）。但总体问题不大。\r\n\r\n# 其他优化思路\r\n这些是我在做的过程中的一些其他的优化思路和想法，也简单记录一下吧。\r\n## 状态合并\r\n这里指的是把和一个对象相关的一一对应的状态合并到一个对象中，或者说如果某些状态之前有比较强的关联关系，那似乎可以合在一起。比如：\r\n```typescript\r\n[list, setList] = useState\u003Cany[]>([]);\r\n[listChecked, setListChecked] = useState\u003Cboolean[]>([]);\r\n```\r\n可以合并成：\r\n```typescript\r\n[checkList, setCheckList] = useState\u003CArray\u003C{listItem: any, checked: boolean}>>([]);\r\n```\r\n因为如果分开，需要修改list和listChecked时某些情况下可能会使元素被渲染两次，并且用memo优化时也需要写两个判断条件。\r\n\r\n## 把renderItem返回的组件用memo进行缓存\r\n就以本文中的选中为例，所有的选中状态都存在一个数组中，当一个元素被选中时，这个数组也会整个更新（重新生成一个新的数组），从而引发列表重新渲染，每个renderItem都会被调用一遍，而显然其他的所有元素都是不需要重新渲染的。因此用memo做缓存就很有必要。  \r\n个人感觉，给renderItem的组件做memo似乎更重要一些，但官网只写了renderItem不要用匿名函数（尽管我总觉得这个好像没啥用，因为重新渲染的话不管用不用匿名函数都会重新生成一个函数对象，也可能是我理解不到位吧）。同时renderItem要尽可能的轻量（减少副作用，组件尽量的简单一些），这样重新渲染的压力也会小一些。\r\n\r\n## useRef\r\n某些用来做标志位的值存在ref中就够了，完全不需要使用state。如果用了state，引发重新渲染不说，依赖这个标志位的callback如果使用useCallback优化了，那好像也没啥用，反正标志位一变就会重新生成个函数对象。以及一个作为标志位的state，如果在useEffect里面用到，那它写进useEffect的依赖中可能没什么必要，不写的话又违反hooks的使用规范，就挺尴尬的。\r\n\r\n\r\n# 结尾\r\n大概就是这么多，拖了很久才决定写这么一个小总结（要不然过一阵子就更想不起来了）。顺带再简单介绍下MusicFree，这是个基于React Native开发的开源音乐播放器，可以通过写一个简单的js脚本来扩展音源，简单的介绍可以看github。\r\n\r\n本文中的所有代码也都在github上可以看到：[可以戳这里](https://github.com/maotoumao/MusicFree/blob/master/src/components/base/SortableFlatList.tsx)；这个项目尽管说有些地方写的还是不好，但是感觉还是比较适合初学者的，拿来练手也不错。\r\n\r\n如果你喜欢我的内容，也可以关注下公众号【一只猫头猫】，平时工作之余的一些想法以及做的一些其他的有趣的事情也会分享在公众号。应该不太会为了维持关注发水文，尽量发一些有意义的东西。感兴趣就随缘关注下吧~~~ 过一段时间*说不准*会更新个刷题系列，可以一起鸭~","src/content/posts/ReactNative性能优化——拖拽排序.md","0678a864a238e3b8",{"html":468,"metadata":469},"\u003Ch1 id=\"前言\">前言\u003C/h1>\n\u003Cp>这是在做业余项目\u003Ca href=\"https://github.com/maotoumao/MusicFree\">MusicFree\u003C/a>时的一些技术探索，简单记录一下优化过程和思考方式。前情可以戳\u003Ca href=\"http://blog.upup.fun/2022/10/04/%E5%86%99%E4%B8%80%E4%B8%AA%E5%85%A8%E7%BD%91%E6%9C%80%E5%85%A8%E7%9A%84%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8/\">这篇文章\u003C/a>。\u003C/p>\n\u003Cp>先来看最终的效果，再来说需求和实现：\u003C/p>\n\u003Cp>\u003Cvideo src=\"http://storage.upup.fun/musicfree/313DA58C945D3DD5A4F005C0A6CDD29F.mp4\" controls>\u003C/video>\u003C/p>\n\u003Cp>在上述视频中可以看到，这是一个由628首歌曲构成的歌单\u003Cstrong>长列表\u003C/strong>，主要功能是对歌单里面的歌曲进行\u003Cstrong>拖拽排序\u003C/strong>和\u003Cstrong>批量选择操作\u003C/strong>，看起来还是比较流畅的。\u003C/p>\n\u003Ch1 id=\"需求分析实现思路\">需求分析&#x26;实现思路\u003C/h1>\n\u003Cp>首先来明确一下需求，或者说最终要达到的目标吧。其实在前言部分已经够明确了，关键词就是\u003Cstrong>长列表\u003C/strong>、\u003Cstrong>拖拽排序\u003C/strong>和\u003Cstrong>批量选择\u003C/strong>；作为一个业余项目，最终要达到的目标也掺杂着强烈的个人偏好：\u003Cstrong>不卡、实用\u003C/strong>。\u003C/p>\n\u003Ch2 id=\"方案1做一个调包侠\">方案1：做一个调包侠\u003C/h2>\n\u003Cp>为了实现以上效果，第一反应就是寻找社区开源项目，看有没有类似的库。网上搜了一圈，还在维护的貌似就只有这个\u003Ca href=\"https://github.com/computerjazz/react-native-draggable-flatlist\">react-native-draggable-flatlist\u003C/a>库了。\u003C/p>\n\u003Cp>抱着试试看的心态，我们把\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/draggable-flatlist/src/pages/musicListEditor/components/musicList.tsx\">代码写好\u003C/a>：\u003C/p>\n\u003Cblockquote>\n\u003Cp>其实最早期简单试用了一下，就把这个方案否决掉了。原因也很简单，一方面是有点卡，另一方面是它不知道为啥会导致模拟器debug时崩溃。下面的对比实验视频是在最后确定方案之后做的，忽略交互方式和一些底色之类的，相关的优化都是相同的。\u003C/p>\n\u003C/blockquote>\n\u003Cp>\u003Cvideo src=\"http://storage.upup.fun/musicfree/SVID_20230109_230717_1.mp4\" controls>\u003C/video>\u003C/p>\n\u003Cp>可以发现其中有几点体验较差的地方：\u003C/p>\n\u003Col>\n\u003Cli>拖拽到顶自动滑动的时候，选中的元素好像一直在抖\u003C/li>\n\u003Cli>单选时选中状态反应较快（和最终版速度差不多，因为这里的优化一样）；但\u003Cstrong>全选、全不选有明显延迟\u003C/strong>(~1s)\u003C/li>\n\u003Cli>拖拽结束后，\u003Cstrong>花费大量时间执行回调函数\u003C/strong>（可以观察一下颜色，停止拖拽后选中的元素还会保持很长一段时间的选中态）\u003C/li>\n\u003C/ol>\n\u003Cp>回顾下目标：\u003C/p>\n\u003Cul>\n\u003Cli>卡吗？卡。\u003C/li>\n\u003Cli>实用吗？凑合能用。\u003C/li>\n\u003Cli>满意吗？凑合能用可以，卡的这么明显忍不了。\u003C/li>\n\u003Cli>那怎么办？自己写个吧。\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"方案2自己实现\">方案2：自己实现\u003C/h2>\n\u003Ch3 id=\"通用定制\">通用？定制？\u003C/h3>\n\u003Cp>既然要自己实现，那么还是得好好设计一下。第一个要思考的问题便是：要做一个通用方案还是做一个定制的方案。因为这可能会涉及到方案设计，如果要做一个通用方案，那可能会更少的trick，更多的配置来满足通用性和灵活性。如果是一个仅仅在当前项目中使用的方案，那就可以加很多\u003Cstrong>前提条件\u003C/strong>和\u003Cstrong>折中技巧\u003C/strong>了。\u003Cbr>\n仔细想了想，首先我在短期内不太会用React Native开一个新的有长列表的坑，其次我也不见得做的会比react-native-draggable-flatlist更好，也不必顾此失彼，先用个项目中的定制方案满足自己的需求就足够了。\u003C/p>\n\u003Ch3 id=\"怎么才能不卡\">怎么才能不卡？\u003C/h3>\n\u003Cp>第二个要思考的问题理所当然是如何实现目标了。那么自然有个问题：为啥会卡？\u003Cbr>\n想一想我们用的库是什么：react-native-draggable-\u003Cstrong>flatlist\u003C/strong>。对，flatlist。简单来说，Flatlist在每次滚动时会\u003Cstrong>批量预渲染\u003C/strong>一定区域内的元素，并把区域外的元素\u003Cstrong>销毁\u003C/strong>。我们来看一下这张图就明白了：\u003C/p>\n\u003Cp>\u003Cimg src=\"http://storage.upup.fun/musicfree/K4BF_4TJA%7D1%7DISIGJ%5B%7DWEAT.png\" alt=\"flatlist\">\u003C/p>\n\u003Cp>可以看出，始终会保持\u003Cstrong>120个元素\u003C/strong>在内存中，每次滑动时会\u003Cstrong>销毁\u003C/strong>不在区域中的元素。Shopify团队针对这一点进行优化开发了\u003Ca href=\"https://shopify.github.io/flash-list/\">Flashlist\u003C/a>，它的原理大概是首先渲染一定量的初始元素；但在滑动时滑出视窗的元素不会销毁，而是重复利用：\u003C/p>\n\u003Cp>\u003Cimg src=\"http://storage.upup.fun/musicfree/%29OM6%604OYJ%7BVK%7DP%29%28W%24IFZLC.png\" alt=\"flashlist\">\u003C/p>\n\u003Cp>同时，由于其一次渲染到屏幕上的元素较少（20个之于120个），当\u003Cstrong>全选\u003C/strong>时需要重新渲染的元素数目也会大大减少（简单算一下，少渲染5/6的内容）。它们官网上说相对于原生的Flatlist性能有5~10倍的提升，既然这样，那就用Flashlist好了。\u003C/p>\n\u003Cp>\u003Cimg src=\"http://storage.upup.fun/musicfree/G%7D%24VCM1F0I2W%28NGH%60_D%7B%28%40N.png\" alt=\"官网\">\u003C/p>\n\u003Ch3 id=\"拖拽排序怎么实现\">拖拽排序怎么实现？\u003C/h3>\n\u003Ch4 id=\"再来一个问题\">再来一个问题\u003C/h4>\n\u003Cp>以上两个问题思考完了：为了达成目标，我们可以随意在实现时加一些前提/trick，并且我们要把flatlist切换成flashlist以提升长列表性能。接下来就是比较麻烦的地方了：\u003Cstrong>如何实现拖拽排序\u003C/strong>。都思考了这么多问题了，不妨再多加一个问题：最终要实现的效果是\u003Cstrong>侧重UI交互\u003C/strong>还是\u003Cstrong>侧重功能\u003C/strong>？\u003C/p>\n\u003Cp>如果侧重交互的话，可以大概设计一下理想的效果：\u003C/p>\n\u003Col>\n\u003Cli>在按住某一个元素上下拖动时，它需要出现在它正确的位置;\u003C/li>\n\u003Cli>并且它的兄弟元素都会被顺滑的挤到一边；\u003C/li>\n\u003Cli>滑动的位置越靠两端，滑动速度越快；\u003C/li>\n\u003Cli>在放手的一瞬间，它会立刻出现在它被移动到位置上。\u003C/li>\n\u003C/ol>\n\u003Cp>从实现角度来说：\u003C/p>\n\u003Col>\n\u003Cli>在选中一个元素的一瞬间，它的zIndex会被重新设置;\u003C/li>\n\u003Cli>随着手指的拖动，它和它的兄弟元素的y轴位置都会通过setNativeProps调整；\u003C/li>\n\u003Cli>同时需要记录下手指位置距离列表两端的距离来决定是否需要继续scroll，以及下一个scroll的位置；\u003C/li>\n\u003Cli>在放手的一瞬间，这些元素的位置和y轴位置（因为通过setNativeProps改过了）会被重新计算。\u003C/li>\n\u003C/ol>\n\u003Cp>确实，想的挺好，但Flatlist（Flashlist的参数和原生flatlist类似）连scroll的速度都难控制，更别说这些特殊的效果了。再想想目标，交互可以砍一些，果断\u003Cstrong>侧重功能\u003C/strong>。\u003C/p>\n\u003Ch4 id=\"前提条件\">前提条件\u003C/h4>\n\u003Cp>啰嗦了这么多，其实都是为了给最终实现减少难度。现在我们可以比较放肆的给拖拽排序列表加前提条件了：\u003C/p>\n\u003Cul>\n\u003Cli>列表距离顶部和底部的距离已知\u003C/li>\n\u003C/ul>\n\u003Cblockquote>\n\u003Cp>反正是个个人项目，那我有理由要求整个APP中所有的拖拽列表样式保持一致。这也就意味着列表高度可以直接简单算出来。\u003C/p>\n\u003C/blockquote>\n\u003Cul>\n\u003Cli>列表里面的元素高度、布局稳定，不会随着状态的变化有较大变化\u003C/li>\n\u003C/ul>\n\u003Cblockquote>\n\u003Cp>这样即便有需要传进来的样式，可以用ref存下样式；参数变化导致重新渲染时不需要重新创建样式对象；同时很多布局信息，如当前位置等也可以简单的算出来。\u003C/p>\n\u003C/blockquote>\n\u003Cul>\n\u003Cli>交互方式固定，每个元素的右边有个小按钮，只能靠这个按钮进行拖拽\u003C/li>\n\u003C/ul>\n\u003Cblockquote>\n\u003Cp>统一交互的话，这样控制拖拽的逻辑可以直接做在列表组件内部了。具体一点说，通过列表传入的renderItem参数渲染的组件仅仅是下图中的红色部分；蓝色区域用来控制拖拽；拖拽的逻辑和样式仅仅由列表组件内部控制：\u003C/p>\n\u003C/blockquote>\n\u003Cblockquote>\n\u003Cp>\u003Cimg src=\"http://storage.upup.fun/musicfree/iPhone%2014_13%20Pro.png\" alt=\"\">\u003C/p>\n\u003C/blockquote>\n\u003Cul>\n\u003Cli>目标元素拖动时，它的兄弟元素位置不会出现变化；目标元素拖到哪个元素的上方，就代表它最终会被移动到哪个位置\u003C/li>\n\u003C/ul>\n\u003Cblockquote>\n\u003Cp>这样只需要通过setNativeProps改变一个元素的属性，甚至可以通过一些trick完全不改动列表元素。\u003C/p>\n\u003C/blockquote>\n\u003Cp>前提条件加完了，是时候开始设计技术方案了。\u003C/p>\n\u003Ch1 id=\"技术方案\">技术方案\u003C/h1>\n\u003Cp>把拖拽排序这个问题分解一下，又可以拆成几个子问题：\u003C/p>\n\u003Cul>\n\u003Cli>滚动行为\u003C/li>\n\u003Cli>高亮元素\u003C/li>\n\u003Cli>结束回调\u003Cbr>\n接下来就尝试从这几个角度去设计一下。\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"滚动行为\">滚动行为\u003C/h2>\n\u003Ch3 id=\"整体结构\">整体结构\u003C/h3>\n\u003Cp>滚动行为还是比较明了的。首先，列表是一个FlashList（删掉了很多无关代码，代码多了不好看），相关的事件以及需要在这些事件内关注的行为如下：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/** */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> SortableFlatList\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 不要干扰原始数据\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">_data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">_setData\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> useState\u003C/span>\u003Cspan style=\"color:#E1E4E8\">([\u003C/span>\u003Cspan style=\"color:#F97583\">...\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data \u003C/span>\u003Cspan style=\"color:#F97583\">??\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [])]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 是否禁止滚动\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">scrollEnabled\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">setScrollEnabled\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> useState\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 是否处在激活状态, -1表示无，其他表示当前激活的下标\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> activeRef\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> useRef\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // content偏移值 用来记录滚动距离\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> contentOffsetYRef\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> useRef\u003C/span>\u003Cspan style=\"color:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\">number\u003C/span>\u003Cspan style=\"color:#E1E4E8\">>(\u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 目标在屏幕内移动距离\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> targetOffsetYRef\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> useRef\u003C/span>\u003Cspan style=\"color:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\">number\u003C/span>\u003Cspan style=\"color:#E1E4E8\">>(\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 当前移动的方向，0表示不移动，1表示向下，-1表示向上\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> direction\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> useSharedValue\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> &#x3C;\u003C/span>\u003Cspan style=\"color:#B392F0\">FlashList\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                scrollEnabled\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={\u003C/span>\u003Cspan style=\"color:#FFAB70\">scrollEnabled\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                ref\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={\u003C/span>\u003Cspan style=\"color:#FFAB70\">_\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    // list的引用，需要用它控制滚动\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                onLayout\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={\u003C/span>\u003Cspan style=\"color:#FFAB70\">evt\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    // 布局信息，需要用它拿到尺寸\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={\u003C/span>\u003Cspan style=\"color:#FFAB70\">_data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                estimatedItemSize\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={\u003C/span>\u003Cspan style=\"color:#FFAB70\">itemHeight\u003C/span>\u003Cspan style=\"color:#E1E4E8\">} \u003C/span>\u003Cspan style=\"color:#6A737D\">// 这里其实是每一个元素的高度，直接固定了，也是一个优化项\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                scrollEventThrottle\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={\u003C/span>\u003Cspan style=\"color:#79B8FF\">16\u003C/span>\u003Cspan style=\"color:#E1E4E8\">} \u003C/span>\u003Cspan style=\"color:#6A737D\">// 滚动事件的节流回调\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                onTouchStart\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={\u003C/span>\u003Cspan style=\"color:#FFAB70\">e\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(activeRef.current !== -1) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                        // 触摸开始时，如果是在拖动状态，那就需要记录下初始位置\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                        // 高亮元素\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                onTouchMove\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={\u003C/span>\u003Cspan style=\"color:#FFAB70\">e\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(activeRef.current !== -1) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                        // 移动时，如果在拖动状态，需要更新滚动速度，并记录移动的距离\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                        // 修改高亮元素位置\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                onTouchEnd\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={\u003C/span>\u003Cspan style=\"color:#FFAB70\">e\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(activeRef.current !== -1) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                        // 如果是拖动状态，那就执行最终的回调\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                        // 重置样式\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                onTouchCancel\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={() \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    // 取消时所有的符号位和状态\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                onScroll\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={\u003C/span>\u003Cspan style=\"color:#FFAB70\">e\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    // 在这里记录下y轴的偏移\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(activeRef.current !== -1) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                        // 滚动时，如果在拖动状态\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                renderItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">={({\u003C/span>\u003Cspan style=\"color:#FFAB70\">item\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">index\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        &#x3C;\u003C/span>\u003Cspan style=\"color:#FFAB70\">SortableFlatListItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">/> \u003C/span>\u003Cspan style=\"color:#6A737D\">// 渲染一个满足前提条件的特定元素：它固定右侧是一个用来拖拽的小按钮，高度也是固定的。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    );\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            />\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> _SortableFlatListItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">props\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> ISortableFlatListItemProps\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        setScrollEnabled\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        renderItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        setActiveItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        item\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        index\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        activeRef\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    } \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> props;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        &#x3C;\u003C/span>\u003Cspan style=\"color:#B392F0\">View\u003C/span>\u003Cspan style=\"color:#E1E4E8\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            {\u003C/span>\u003Cspan style=\"color:#FFAB70\">renderItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003Cspan style=\"color:#FFAB70\">item\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">index\u003C/span>\u003Cspan style=\"color:#E1E4E8\">})}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            &#x3C;\u003C/span>\u003Cspan style=\"color:#FFAB70\">Pressable\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                onTouchStart\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{() => {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (activeRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">!==\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    /** 使用ref避免其它组件重新渲染; 由于事件冒泡，这里会先触发 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    activeRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> index;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    /** 锁定滚动 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                    setScrollEnabled\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                    setActiveItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(item);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                style\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{styleRef.current.btn}\u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                &#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">Icon name\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"menu\"\u003C/span>\u003Cspan style=\"color:#F97583\">/>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            &#x3C;/\u003C/span>\u003Cspan style=\"color:#E1E4E8\">Pressable\u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        &#x3C;/\u003C/span>\u003Cspan style=\"color:#E1E4E8\">View\u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    );\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> SortableFlatListItem\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> memo\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    _SortableFlatListItem,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    (\u003C/span>\u003Cspan style=\"color:#FFAB70\">prev\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">curr\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> prev.index \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> curr.index \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> prev.item \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> curr.item,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>以上代码中SortableFlatList就是暴露给外部模块直接使用的列表，列表内部其实是用SortableFlatListItem，它由两部分构成，左边一半是使用renderItem直接渲染的组件，右边一半是仅可以用来拖拽的一个Icon按钮。\u003C/p>\n\u003Cp>我们会遇到的第一个问题是\u003Cstrong>禁用滚动的时机\u003C/strong>。当拖拽组件时，整个列表需要禁用滚动（仅可以由列表的ref手动控制滚动），不然的话随着拖拽可能触发了滚动事件，导致拖拽失效。由于禁用/启用滚动一定需要重新渲染列表，因此scrollEnabled是一个state，在_SortableFlatListItem的Icon按钮的触摸事件中设置它为false即可，也就是代码中锁定滚动注释的下面那行。\u003C/p>\n\u003Cp>第二个问题则是，如何记录\u003Cstrong>当前正在拖拽的元素\u003C/strong>，以及这个元素的\u003Cstrong>初始位置\u003C/strong>。根据之前的描述，正在拖拽的元素具有高亮效果，这个高亮效果必然是通过一个\u003Cstrong>state\u003C/strong>控制的；我们可以在SortableFlatListItem中Icon按钮的onPress事件中触发setActiveItem，来更新当前的选中项。而为了得到这个元素的初始位置，我们必须想办法把用户\u003Cstrong>触碰Icon按钮时的坐标\u003C/strong>传递给SortableFlatList。\u003C/p>\n\u003Cp>为了得到这一部分，这里用了一些小小的trick：我们知道React Native的事件也有\u003Cstrong>冒泡机制\u003C/strong>，也就意味着事件会从子组件冒泡到父组件。\u003C/p>\n\u003Cp>具体一些说：子组件SortableFlatListItem中Icon按钮的onTouchStart会先触发，接下来会冒泡到SortableFlat的onTouchStart事件。这就给了我们一些可乘之机：我们可以再使用一个ref记录当前是否处于拖拽态，也就是代码中的activeRef，至于它的值，存放\u003Cstrong>拖拽中元素的下标\u003C/strong>就完全足够了。\u003C/p>\n\u003Cp>如果触发拖拽，那么在Icon按钮的onTouchStart中同时更新activeItem和这个activeRef。接下来，事件会冒泡到SortableFlatList中，这时父组件的onTouchStart捕获到的activeRef已经被标记为处于拖拽状态，根据它的值便可以轻松判断当前的状态，并决定要不要记录下在列表中的初始位置；而此时activeItem作为一个state还没有被更新为最新的状态。总之，\u003Cstrong>在父组件（也就是列表中）所有的eventhandler中都使用activeRef判断，activeItem作为状态仅仅用于更新高亮状态。\u003C/strong>\u003C/p>\n\u003Ch3 id=\"autoscroll\">autoscroll\u003C/h3>\n\u003Cp>整体结构说完了，接下来要考虑的就是拖拽到两端的情况了。React Native的scroll还是有点难用的，没办法控制滚动速度。而为了达到最初设想的：拖拽到两端时会自动滚动，且滚动速度和距离两端的位置有关，那就不得不用点trick。\u003C/p>\n\u003Cp>trick的原理其实也比较好理解：\u003C/p>\n\u003Col>\n\u003Cli>如果当前在滚动中，不做处理。\u003C/li>\n\u003Cli>如果当前拖拽的元素超过了某一阈值，且当前没有在滚动中，那么根据\u003Cstrong>当前拖拽元素的位置\u003C/strong>计算\u003Cstrong>方向\u003C/strong>以及\u003Cstrong>滚动的目标位置\u003C/strong>，并触发滚动。\u003C/li>\n\u003Cli>在onScroll事件中监听（注意节流），在当前滚动的距离与目标位置比较接近时，判断\u003Cstrong>触发下一次滚动\u003C/strong>\u003C/li>\n\u003Cli>如果当前位置已经无法在滚动，停止滚动。\u003C/li>\n\u003C/ol>\n\u003Cp>除了上述方案，不断地setTimeout或者setInterval也可以完成目的，事实上最初的版本也确实这么做的，只不过看起来会忽快忽慢。\u003C/p>\n\u003Cp>在实现的过程中，也使用了reanimated提供的useSharedValue来存储方向，并使用useDerivedValue在方向变化时及时地在不触发重新渲染的情况下进行滚动。\u003C/p>\n\u003Cp>控制滚动的代码如下：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> scrollToTarget\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">forceScroll\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#79B8FF\"> false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 未进行拖拽\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (activeRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        scrollingRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 滚动中就不滚了 \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (scrollingRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"color:#F97583\"> !\u003C/span>\u003Cspan style=\"color:#E1E4E8\">forceScroll) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        scrollingRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 方向是0, 也就是没有在滚动\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (direction.value \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        scrollingRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 下一次滚动到的位置\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> nextTarget\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        Math.\u003C/span>\u003Cspan style=\"color:#B392F0\">sign\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(direction.value) \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            Math.\u003C/span>\u003Cspan style=\"color:#B392F0\">max\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(Math.\u003C/span>\u003Cspan style=\"color:#B392F0\">abs\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(direction.value), \u003C/span>\u003Cspan style=\"color:#79B8FF\">0.3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">            300\u003C/span>\u003Cspan style=\"color:#F97583\"> +\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        contentOffsetYRef.current;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 当前到极限了\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        (contentOffsetYRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 2\u003C/span>\u003Cspan style=\"color:#F97583\"> &#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            nextTarget \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> contentOffsetYRef.current) \u003C/span>\u003Cspan style=\"color:#F97583\">||\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        (contentOffsetYRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">>=\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            listContentHeight \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (layoutRef.current?.height \u003C/span>\u003Cspan style=\"color:#F97583\">??\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 2\u003C/span>\u003Cspan style=\"color:#F97583\"> &#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            nextTarget \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> contentOffsetYRef.current)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        scrollingRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    scrollingRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 超出区域\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    targetOffsetYRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Math.\u003C/span>\u003Cspan style=\"color:#B392F0\">min\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        Math.\u003C/span>\u003Cspan style=\"color:#B392F0\">max\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, nextTarget),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        listContentHeight \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (layoutRef.current?.height \u003C/span>\u003Cspan style=\"color:#F97583\">??\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    );\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 开始滚动\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    listRef.current?.\u003C/span>\u003Cspan style=\"color:#B392F0\">scrollToOffset\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        animated: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        offset: targetOffsetYRef.current,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>列表中onScroll的事件也十分简单粗暴：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">onScroll\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003Cspan style=\"color:#FFAB70\">e\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    contentOffsetYRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e.nativeEvent.contentOffset.y;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 与目标距离小于2像素就强制再滚一次\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        activeRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">!==\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#F97583\"> &#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        Math.\u003C/span>\u003Cspan style=\"color:#B392F0\">abs\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            contentOffsetYRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                targetOffsetYRef.current,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        ) \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">        scrollToTarget\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"高亮元素\">高亮元素\u003C/h2>\n\u003Cp>根据上边的一大通分析，在这里已经把高亮简化成了“浮在列表上，且拖拽中的兄弟元素不需要移动位置”。在这个前提下，我们考虑到的思路有两种：\u003C/p>\n\u003Cul>\n\u003Cli>给list传入一个额外的extra字段，其中放上activeItem；当activeItem变化时逐个元素进行比较，并更新对应元素的样式\u003C/li>\n\u003Cli>list完全不动，在列表上再浮一个长的一模一样的列表元素，直接更新它就好了\u003C/li>\n\u003C/ul>\n\u003Cp>显然是第二种思路更简单一些。并且由于list的元素有memo，在拖拽时甚至list中的元素都不会重新渲染：\r\n\u003Cimg src=\"http://storage.upup.fun/musicfree/QQ%E5%9B%BE%E7%89%8720230110234021.png\" alt=\"代码截图\">\u003C/p>\n\u003Cp>而对这个“假高亮”的控制，只需要通过setNativeProps在开始拖拽时更新它的top、opacity和zIndex，滑动时更新它的top，并在拖拽结束时更新zIndex为-1，opacity为0隐藏掉，看起来似乎就是完全跟手的了：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    onTouchMove\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003Cspan style=\"color:#FFAB70\">e\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fakeItemRef.current\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">setNativeProps\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            top: offsetRef.current,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            opacity: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            zIndex: \u003C/span>\u003Cspan style=\"color:#79B8FF\">100\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    onTouchEnd\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003Cspan style=\"color:#FFAB70\">e\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fakeItemRef.current\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">setNativeProps\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            top: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            opacity: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            zIndex: \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    onTouchCancel\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003Cspan style=\"color:#FFAB70\">e\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fakeItemRef.current\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">setNativeProps\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            top: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            opacity: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            zIndex: \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"执行回调\">执行回调\u003C/h2>\n\u003Cp>接下来就需要拖拽结束后的处理了，这里其实是比较轻松的一步。在一通操作之下，我们记录下了某个元素在屏幕内移动的距离和列表滚动的距离，又强行限制住了列表的高度，那拖拽后的位置就很容易计算出来了：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    onTouchEnd\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{(e) => {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            // activeRef.current是初始下标，计算一下偏移即可\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            index \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                activeRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                Math.\u003C/span>\u003Cspan style=\"color:#B392F0\">round\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    (e.nativeEvent.pageY \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        initDragPageY.current \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        initDragLocationY.current) \u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        itemHeight,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                );\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            // 注意范围约束\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            index \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Math.\u003C/span>\u003Cspan style=\"color:#B392F0\">min\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data.\u003C/span>\u003Cspan style=\"color:#79B8FF\">length\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, Math.\u003C/span>\u003Cspan style=\"color:#B392F0\">max\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(index, \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            // 起始下标: activeRef.current  结束下标: index\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (activeRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">!==\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> index) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                // 计算下排序后的数组\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nData \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> _data\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    .\u003C/span>\u003Cspan style=\"color:#B392F0\">slice\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, activeRef.current)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    .\u003C/span>\u003Cspan style=\"color:#B392F0\">concat\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(_data.\u003C/span>\u003Cspan style=\"color:#B392F0\">slice\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(activeRef.current \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                nData.\u003C/span>\u003Cspan style=\"color:#B392F0\">splice\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(index, \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, activeItem \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#B392F0\"> T\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                // 执行回调\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                onSortEnd\u003C/span>\u003Cspan style=\"color:#E1E4E8\">?.(nData);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }           \u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>到这里就算差不多了，最终的效果也如开头的视频那样，大概看起来还可以。不过细看还是有瑕疵，比如点击时的水波纹效果无法扩散到拖拽按钮的位置，这也可以通过优化布局来解决（设置列表项宽度为屏幕宽度，拖拽按钮的position设置为absolute并放在列表项上层，也就是并排改成折叠）。但总体问题不大。\u003C/p>\n\u003Ch1 id=\"其他优化思路\">其他优化思路\u003C/h1>\n\u003Cp>这些是我在做的过程中的一些其他的优化思路和想法，也简单记录一下吧。\u003C/p>\n\u003Ch2 id=\"状态合并\">状态合并\u003C/h2>\n\u003Cp>这里指的是把和一个对象相关的一一对应的状态合并到一个对象中，或者说如果某些状态之前有比较强的关联关系，那似乎可以合在一起。比如：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">[list, setList] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> useState\u003C/span>\u003Cspan style=\"color:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\">any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[]>([]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">[listChecked, setListChecked] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> useState\u003C/span>\u003Cspan style=\"color:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\">boolean\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[]>([]);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>可以合并成：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">[checkList, setCheckList] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> useState\u003C/span>\u003Cspan style=\"color:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"color:#B392F0\">Array\u003C/span>\u003Cspan style=\"color:#E1E4E8\">&#x3C;{\u003C/span>\u003Cspan style=\"color:#FFAB70\">listItem\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">checked\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> boolean\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}>>([]);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>因为如果分开，需要修改list和listChecked时某些情况下可能会使元素被渲染两次，并且用memo优化时也需要写两个判断条件。\u003C/p>\n\u003Ch2 id=\"把renderitem返回的组件用memo进行缓存\">把renderItem返回的组件用memo进行缓存\u003C/h2>\n\u003Cp>就以本文中的选中为例，所有的选中状态都存在一个数组中，当一个元素被选中时，这个数组也会整个更新（重新生成一个新的数组），从而引发列表重新渲染，每个renderItem都会被调用一遍，而显然其他的所有元素都是不需要重新渲染的。因此用memo做缓存就很有必要。\u003Cbr>\n个人感觉，给renderItem的组件做memo似乎更重要一些，但官网只写了renderItem不要用匿名函数（尽管我总觉得这个好像没啥用，因为重新渲染的话不管用不用匿名函数都会重新生成一个函数对象，也可能是我理解不到位吧）。同时renderItem要尽可能的轻量（减少副作用，组件尽量的简单一些），这样重新渲染的压力也会小一些。\u003C/p>\n\u003Ch2 id=\"useref\">useRef\u003C/h2>\n\u003Cp>某些用来做标志位的值存在ref中就够了，完全不需要使用state。如果用了state，引发重新渲染不说，依赖这个标志位的callback如果使用useCallback优化了，那好像也没啥用，反正标志位一变就会重新生成个函数对象。以及一个作为标志位的state，如果在useEffect里面用到，那它写进useEffect的依赖中可能没什么必要，不写的话又违反hooks的使用规范，就挺尴尬的。\u003C/p>\n\u003Ch1 id=\"结尾\">结尾\u003C/h1>\n\u003Cp>大概就是这么多，拖了很久才决定写这么一个小总结（要不然过一阵子就更想不起来了）。顺带再简单介绍下MusicFree，这是个基于React Native开发的开源音乐播放器，可以通过写一个简单的js脚本来扩展音源，简单的介绍可以看github。\u003C/p>\n\u003Cp>本文中的所有代码也都在github上可以看到：\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/components/base/SortableFlatList.tsx\">可以戳这里\u003C/a>；这个项目尽管说有些地方写的还是不好，但是感觉还是比较适合初学者的，拿来练手也不错。\u003C/p>\n\u003Cp>如果你喜欢我的内容，也可以关注下公众号【一只猫头猫】，平时工作之余的一些想法以及做的一些其他的有趣的事情也会分享在公众号。应该不太会为了维持关注发水文，尽量发一些有意义的东西。感兴趣就随缘关注下吧~~~ 过一段时间\u003Cem>说不准\u003C/em>会更新个刷题系列，可以一起鸭~\u003C/p>",{"headings":470,"localImagePaths":518,"remoteImagePaths":519,"frontmatter":520,"imagePaths":522},[471,472,475,478,481,484,487,490,492,494,496,498,500,502,504,506,508,510,513,516],{"depth":283,"slug":27,"text":27},{"depth":283,"slug":473,"text":474},"需求分析实现思路","需求分析&实现思路",{"depth":26,"slug":476,"text":477},"方案1做一个调包侠","方案1：做一个调包侠",{"depth":26,"slug":479,"text":480},"方案2自己实现","方案2：自己实现",{"depth":81,"slug":482,"text":483},"通用定制","通用？定制？",{"depth":81,"slug":485,"text":486},"怎么才能不卡","怎么才能不卡？",{"depth":81,"slug":488,"text":489},"拖拽排序怎么实现","拖拽排序怎么实现？",{"depth":57,"slug":491,"text":491},"再来一个问题",{"depth":57,"slug":493,"text":493},"前提条件",{"depth":283,"slug":495,"text":495},"技术方案",{"depth":26,"slug":497,"text":497},"滚动行为",{"depth":81,"slug":499,"text":499},"整体结构",{"depth":81,"slug":501,"text":501},"autoscroll",{"depth":26,"slug":503,"text":503},"高亮元素",{"depth":26,"slug":505,"text":505},"执行回调",{"depth":283,"slug":507,"text":507},"其他优化思路",{"depth":26,"slug":509,"text":509},"状态合并",{"depth":26,"slug":511,"text":512},"把renderitem返回的组件用memo进行缓存","把renderItem返回的组件用memo进行缓存",{"depth":26,"slug":514,"text":515},"useref","useRef",{"depth":283,"slug":517,"text":517},"结尾",[],[],{"title":461,"pubDate":521,"category":33,"excerpt":463},["Date","2023-01-09T20:24:18.000Z"],[],"musicfree插件实现原理",{"id":523,"data":525,"body":529,"filePath":530,"digest":531,"rendered":532},{"title":526,"pubDate":527,"category":33,"excerpt":528},"MusicFree插件实现原理",["Date","2023-03-27T21:59:32.000Z"],"MusicFree插件的实现原理。","上周整理了MusicFree插件的[开发文档](http://musicfree.upup.fun/docs/tutorial-plugin/intro/)，整理完想着还是把插件的原理写的再明白些比较好，所以还是记录下吧。\r\n\r\n# 背景\r\nMusicFree播放器是一个基于**React Native**的**插件化**的音乐播放器。所谓插件化，就是APP内部会调用插件内定义的函数，去完成播放音乐、搜索音乐等行为，简单的架构如下图所示。早期的设计思路[可以点击这里](https://juejin.cn/post/7150589489881022478)；前阵子改了一版，虽然插件协议有所改动，但原理大同小异。\r\n\r\n![ingN93.png](https://i.328888.xyz/2023/03/27/ingN93.png)\r\n\r\n\r\n# 插件原理\r\n## 从零开始\r\n既然是插件，显然它会以外部文件(.js)的形式独立于APP存在。为了实现插件，第一件要做的事情就是**读入外部文件**（也就是所谓插件）的代码，然后将具备这个特定功能的插件代码在APP运行时hook入程序中。   \r\n\r\n为了获取到插件内的信息，我们需要插件整体是一个**函数**，通过执行这个函数得到的返回值获取插件提供的信息。 \r\n\r\n由于React Native自带一个js引擎，因此这部分只需要采用javascript原生的Function语法实现即可：\r\n``` javascript\r\n/// plugin.js\r\nfunction rawPlugin(){\r\n\r\n    return {\r\n        platform: \"插件名\",\r\n        getLyric() {\r\n            return \"我是歌词\";\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n``` typescript\r\n/// pluginManager.ts\r\n\r\nimport {readFile} from 'react-native-fs';\r\n\r\n// 从某个路径加载插件\r\nasync function loadPlugin(pluginPath: string) {\r\n    const rawCode = await readFile(pluginPath, 'utf8'); // 得到文本格式的代码\r\n\r\n    // 创建一个自执行函数\r\n    const pluginInstance = Function(`\r\n        'use strict';\r\n        try {\r\n            return ${rawCode};\r\n        } catch (e) {\r\n            return () => {};\r\n        }\r\n    `)()();\r\n\r\n    return pluginInstance;\r\n}\r\n\r\nloadPlugin('plugin.js')\r\n```\r\n以上代码也比较直白：  \r\n1. 第一步：读入外部文件；\r\n2. 第二步：创建一个Function，函数体为一个字符串（执行完成后得到这个函数）；\r\n3. 第三步：执行这个Function，得到函数rawCode（别忘了，插件是一个函数），也就是第一个括号；\r\n4. 第四步：执行插件函数(其实就是rawPlugin())，得到插件提供的信息（也就是rawCode内部的返回值）。\r\n\r\n## 勾入运行时环境\r\n由于插件运行在客户端APP上，也就是运行时环境中；在APP调用插件的时候也可以通过**插件的入参**来为插件提供一些**运行时的上下文**，比如：\r\n``` javascript\r\n/// plugin.js\r\nfunction rawPlugin(runtimeContext){\r\n\r\n    // app内调用插件的时候，这里会打印出一些运行时的信息\r\n    console.log(runtimeContext);\r\n\r\n    return {\r\n        platform: \"插件名\",\r\n        getLyric() {\r\n            return \"我是歌词\";\r\n        }\r\n    }\r\n}\r\n```\r\n``` typescript\r\n/// pluginManager.ts\r\n\r\nimport {readFile} from 'react-native-fs';\r\n\r\n// 从某个路径加载插件\r\nasync function loadPlugin(pluginPath: string) {\r\n    const rawCode = await readFile(pluginPath, 'utf8'); // 得到文本格式的代码\r\n    const runtimeContext = {\r\n        foo: 'bar'\r\n    };\r\n\r\n    // 创建一个自执行函数\r\n    const pluginInstance = Function(`\r\n        'use strict';\r\n        try {\r\n            return ${rawCode};\r\n        } catch (e) {\r\n            return () => {};\r\n        }\r\n    `)()(runtimeContext);\r\n\r\n    return pluginInstance;\r\n}\r\n\r\nloadPlugin('plugin.js')  // 控制台输出：{\"foo\": \"bar\"}\r\n```\r\n仔细回顾一下上一小节的流程，实质上就是在运行插件函数的时候传递了runtimeContext的入参，使得插件内部可以获取到运行时的信息。\r\n\r\n在实际的实现中，runtime主要包括一些**内置的npm包**，从而使得插件可以与APP共享某些npm包以简化开发流程，如axios、he、cheerio等。\r\n\r\n这样，基本的插件原理实现了，实际上这也就是最早版本插件的实现方式。但是这样写起来并不怎么舒服。\r\n\r\n# 插件与模块\r\n## 弊端\r\n上述写法固然实现了目的，但看起来不是最好的解决方案。原因有二：**1. 难调试 2. 难开发**。  \r\n### 难调试\r\n先说第一点，难调试。由于之前的插件都是形如：\r\n``` typescript \r\n/// plugin.js\r\nfunction pluginName(npmPackages: INpmPackages) {\r\n\r\n    return {\r\n        platform: \"插件名\",\r\n        async someMethod(){\r\n\r\n        },\r\n        // ...\r\n    } as PluginInstance\r\n}\r\n```\r\n的函数，因此调试便成了很大的问题。  \r\n如果要调试，由于插件不支持模块导入（无论是ES6还是CommonJS），为了不影响插件内容，需要复制到一个新的文件：\r\n``` javascript\r\n/// test.ts\r\nimport axios from \"axios\";\r\nimport cheerio from \"cheerio\";\r\n// ...\r\n\r\n/** 以下是复制的插件代码 */\r\nfunction pluginName(npmPackages: INpmPackages) {\r\n\r\n    return {\r\n        platform: \"插件名\",\r\n        async someMethod(){\r\n\r\n        },\r\n        // ...\r\n    } as PluginInstance\r\n}\r\n\r\nconst pluginInstance = pluginName({\r\n    axios,\r\n    cheerio\r\n});\r\n/** 以上是复制的插件代码 */\r\n\r\nconsole.log(pluginInstance.platform); // 输出: 插件名\r\n\r\n```\r\n需要写一大堆辅助代码之后，才可以开始调试验证。这也导致之前有反馈说：不知道怎么调试，APP环境也比较难启动；  \r\n并且就算用APP环境下加载插件调试，也需要不停地把插件从电脑上拷贝到手机上，然后再在APP内加载，然后再看错误日志，非常麻烦。\r\n\r\n### 难开发\r\n再看第二点：难开发。由于插件本质上是一个嵌入Function内的单文件js函数，因此模块导入/导出语法用不了，进而webpack、esbuild等工程化工具用起来也会很麻烦：  \r\n需要把target设置成IIFE，打包出来的bundle导入APP的时候还不一定会出什么问题。\r\n\r\n基于以上弊端，对插件做了一次改版。\r\n\r\n## 模块\r\n其实，如果**把插件看作一个模块**，问题似乎就迎刃而解了：\r\n\r\n1. 插件是一段**职责单一**的js代码，不同的插件之间功能**无任何交集**。\r\n2. 插件的入参是**运行时环境**，返回值是**插件实例**。\r\n3. 目前已经有**标准的模块规范**(ES6模块/CommonJS)，其中通过import/require来加载npm包或其他模块；通过export或者module.exports导出当前模块。\r\n\r\n基于以上，似乎也可以把插件看作一个CommonJS模块：  \r\n- 通过**require或者类似“全局变量”**的方式获取运行时环境；\r\n- 通过**module.exports**导出插件实例。\r\n\r\n完美扣上CommonJS模块的概念。同时，由于nodejs的模块化方案就是**CommonJS**，因此采用模块方案定义的插件可以在node.js环境下直接调用，不需要任何的复制粘贴以及辅助脚本。\r\n\r\n## CommonJS\r\n先来看下CommonJS模块规范吧。由于这块太过基础，因此就简单带下。CommonJS认为，每个文件都是一个模块。每个模块内都可以获取一些全局变量，用来导入或者导出模块，分别是：module、require、exports。   \r\n\r\n### module & exports\r\nmodule代表着当前模块，是一个对象。其中，有一个特殊的字段“exports”，指代着当前模块的导出对象；你可以通过给这个字段赋值来控制当前模块的导出：\r\n\r\n```javascript\r\n/// module1.js\r\nmodule.exports = {\r\n    foo: 'bar'\r\n}\r\n```\r\n同时，exports全局变量也指向着module.exports，因此也可以通过如下方式改变导出的对象：\r\n```javascript\r\n/// module2.js\r\nexports.foo = 'bar';\r\n```\r\n\r\n### require\r\nrequire是一个函数，用来导入模块，其实也就是获取其他模块的module.exports导出的字段：\r\n```javascript\r\n/// module3.js\r\nconst module1 = require('module1.js'); /// {foo: 'bar'}\r\n```\r\n\r\n接下来需要思考的是：如何让MusicFree支持形如:\r\n```javascript\r\n/// pluginNew.js\r\nconst axios = require('axios');\r\n\r\nmodule.exports = {\r\n    platform: \"插件名\",\r\n    async getLyric(){\r\n        // ...\r\n    }\r\n}\r\n```\r\n的插件。\r\n\r\n## 模块化的插件\r\n我们可以试下把上述代码贴到浏览器控制台会发生什么：\r\n![ine1ov.png](https://i.328888.xyz/2023/03/27/ine1ov.png)  \r\n\r\n显然，缺少上文提到的三个全局变量：require、module和exports。接下来我们要做的是给加载“插件模块”的过程做一些改造(假定rawCode是上边pluginNew.js内的文本)：\r\n\r\n```javascript\r\n    // ...\r\n    const pluginInstance = Function(`\r\n        'use strict';\r\n        try {\r\n            return ${rawCode}; // 这里会出问题\r\n        } catch (e) {\r\n            return () => {};\r\n        }\r\n    `)()(_require, _module, _exports);\r\n    // ...\r\n\r\n```\r\n\r\n由于**rawCode现在不是函数**了，为了让插件内部可以获取到三个特定的全局变量，我们需要手动地包一层函数：\r\n```javascript\r\n    // ...\r\n    const pluginInstance = Function(`\r\n        'use strict';\r\n        try {\r\n            return function(require, module, exports) {\r\n                ${rawCode}\r\n            }\r\n        } catch (e) {\r\n            return () => {};\r\n        }\r\n    `)()(_require, _module, _exports);\r\n    // ...\r\n\r\n```\r\n现在再分析一下过程：  \r\n\r\n1. 创建一个Function\r\n2. 执行Function，得到函数内部的返回值\r\n3. 执行：\r\n```javascript\r\n(function(require, module, exports) {\r\n    ${rawCode}\r\n})(_require, _module, _exports)\r\n```\r\n\r\n思考一下，此时rawCode内获取到的require、module和exports是APP内**运行时环境下提供给插件**的，当这个函数执行完毕后，我们可以从module.exports中获取到我们需要的插件返回值；同时也可以用require加载APP内部的npm包。\r\n\r\n最后一步要做的，便是重新定义一下require，module和exports了。\r\n\r\n## 定义全局变量\r\n根据上文，module和exports其实很好办：\r\n```javascript\r\n// 注意：此段代码是在APP内部ReactNative环境下实现\r\nconst _module = {\r\n    exports: {\r\n\r\n    }\r\n};\r\n\r\nconst _exports = _module.exports;\r\n```\r\n\r\nrequire相对来说复杂点，我们整理一下我们目前的信息：\r\n1. require是个函数\r\n2. require入参是npm包名（在加载npm包的情况下）\r\n3. require的返回值会直接被模块使用\r\n\r\n因此，我们可以做一个简单的模拟require:\r\n``` javascript\r\n// 注意：此段代码是在APP内部ReactNative环境下实现\r\nimport axios from 'axios';\r\nimport cheerio from 'cheerio';\r\nimport CryptoJS from 'crypto-js';\r\n\r\n// 在app内安装的npm包\r\nconst packages = {\r\n    axios,\r\n    cheerio\r\n    'crypto-js': CryptoJS,\r\n    // ... \r\n}\r\n\r\nconst _require = (packageName: string) => {\r\n    let pkg = packages[packageName];\r\n    return pkg;\r\n}\r\n```\r\n\r\n## 总结\r\n现在回过头看，新的“模块化插件”已经诞生了，最终的插件信息会挂载到module.exports上：\r\n``` typescript\r\nimport axios from 'axios';\r\nimport cheerio from 'cheerio';\r\nimport CryptoJS from 'crypto-js';\r\n\r\nimport {readFile} from 'react-native-fs';\r\n\r\n\r\n// 在app内安装的npm包\r\nconst packages = {\r\n    axios,\r\n    cheerio\r\n    'crypto-js': CryptoJS,\r\n    // 其他内置的包... \r\n}\r\n\r\nconst _require = (packageName: string) => {\r\n    let pkg = packages[packageName];\r\n    return pkg;\r\n}\r\n\r\n// 从某个路径加载插件\r\nasync function loadPlugin(pluginPath: string) {\r\n    const rawCode = await readFile(pluginPath, 'utf8'); // 得到文本格式的代码\r\n    \r\n    // 初始化模块信息\r\n    const _module = {\r\n        exports: {\r\n\r\n        }\r\n    };\r\n    const _exports = _module.exports;\r\n\r\n    const pluginInstance = Function(`\r\n        'use strict';\r\n        try {\r\n            return function(require, module, exports) {\r\n                ${rawCode}\r\n            }\r\n        } catch (e) {\r\n            return () => {};\r\n        }\r\n    `)()(_require, _module, _exports);\r\n\r\n    return _module.exports; // 模块的导出\r\n}\r\n\r\nloadPlugin('pluginNew.js')  \r\n```\r\n\r\n仔细看看这段代码，是不是和经常被问到的所谓“commonjs模块原理是什么”差不多呢？\r\n\r\n# 代码是用来解决问题的\r\n这章标题是随便取的，其实也是我的一个小观念。在写了一堆代码之后，自然要看一下这样子一通折腾有没有解决最初的两个问题。\r\n\r\n从开发上来说，由于使用了commonjs模块，我可以使用更多的技术去降低开发成本：使用typescript、使用webpack等工程化工具，并且只需要把最终打包时的target设置为CommonJS即可。开发时也不再仅限于“只能写一个单文件”；甚至可以引入一些没有内置的npm包，只需要最终打包时把源码打进插件就可以了。\r\n\r\n从调试上来说，nodejs环境下运行插件与APP环境下运行插件几乎无区别，因此可以直接一边开发一边调试以验证插件是否符合预期，大大降低了成本：\r\n\r\n![inFRLk.png](https://i.328888.xyz/2023/03/27/inFRLk.png)\r\n\r\n以及，除了对上述require、module和exports的实现外，也可以用类似的方式屏蔽掉插件内所有的console.log，只需要用类似的方式重新定义一下console对象即可。\r\n\r\n# 结尾\r\n本文中的主要代码可以在[这里](https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts)看到。\r\n\r\nMusicFree是一个基于GPL3开源的免费音乐播放器，源代码地址：https://github.com/maotoumao/MusicFree，欢迎点个star~\r\n\r\n感兴趣的话也可以[戳这里](https://wwzb.lanzoue.com/b041xm5fg)下载。个人业余作品，只是用于满足个人需求和技术探索。仅供学习参考，不要用于商业目的~","src/content/posts/MusicFree插件实现原理.md","0009c824a318b44f",{"html":533,"metadata":534},"\u003Cp>上周整理了MusicFree插件的\u003Ca href=\"http://musicfree.upup.fun/docs/tutorial-plugin/intro/\">开发文档\u003C/a>，整理完想着还是把插件的原理写的再明白些比较好，所以还是记录下吧。\u003C/p>\n\u003Ch1 id=\"背景\">背景\u003C/h1>\n\u003Cp>MusicFree播放器是一个基于\u003Cstrong>React Native\u003C/strong>的\u003Cstrong>插件化\u003C/strong>的音乐播放器。所谓插件化，就是APP内部会调用插件内定义的函数，去完成播放音乐、搜索音乐等行为，简单的架构如下图所示。早期的设计思路\u003Ca href=\"https://juejin.cn/post/7150589489881022478\">可以点击这里\u003C/a>；前阵子改了一版，虽然插件协议有所改动，但原理大同小异。\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/03/27/ingN93.png\" alt=\"ingN93.png\">\u003C/p>\n\u003Ch1 id=\"插件原理\">插件原理\u003C/h1>\n\u003Ch2 id=\"从零开始\">从零开始\u003C/h2>\n\u003Cp>既然是插件，显然它会以外部文件(.js)的形式独立于APP存在。为了实现插件，第一件要做的事情就是\u003Cstrong>读入外部文件\u003C/strong>（也就是所谓插件）的代码，然后将具备这个特定功能的插件代码在APP运行时hook入程序中。\u003C/p>\n\u003Cp>为了获取到插件内的信息，我们需要插件整体是一个\u003Cstrong>函数\u003C/strong>，通过执行这个函数得到的返回值获取插件提供的信息。\u003C/p>\n\u003Cp>由于React Native自带一个js引擎，因此这部分只需要采用javascript原生的Function语法实现即可：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// plugin.js\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> rawPlugin\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        platform: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"插件名\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">        getLyric\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"我是歌词\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// pluginManager.ts\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {readFile} \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'react-native-fs'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 从某个路径加载插件\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">async\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> loadPlugin\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">pluginPath\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> rawCode\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#B392F0\"> readFile\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(pluginPath, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'utf8'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 得到文本格式的代码\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 创建一个自执行函数\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> pluginInstance\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> Function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'use strict';\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        try {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            return ${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">rawCode\u003C/span>\u003Cspan style=\"color:#9ECBFF\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        } catch (e) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            return () => {};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    `\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)()();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pluginInstance;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">loadPlugin\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'plugin.js'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>以上代码也比较直白：\u003C/p>\n\u003Col>\n\u003Cli>第一步：读入外部文件；\u003C/li>\n\u003Cli>第二步：创建一个Function，函数体为一个字符串（执行完成后得到这个函数）；\u003C/li>\n\u003Cli>第三步：执行这个Function，得到函数rawCode（别忘了，插件是一个函数），也就是第一个括号；\u003C/li>\n\u003Cli>第四步：执行插件函数(其实就是rawPlugin())，得到插件提供的信息（也就是rawCode内部的返回值）。\u003C/li>\n\u003C/ol>\n\u003Ch2 id=\"勾入运行时环境\">勾入运行时环境\u003C/h2>\n\u003Cp>由于插件运行在客户端APP上，也就是运行时环境中；在APP调用插件的时候也可以通过\u003Cstrong>插件的入参\u003C/strong>来为插件提供一些\u003Cstrong>运行时的上下文\u003C/strong>，比如：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// plugin.js\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> rawPlugin\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">runtimeContext\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // app内调用插件的时候，这里会打印出一些运行时的信息\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(runtimeContext);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        platform: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"插件名\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">        getLyric\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"我是歌词\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// pluginManager.ts\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {readFile} \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'react-native-fs'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 从某个路径加载插件\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">async\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> loadPlugin\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">pluginPath\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> rawCode\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#B392F0\"> readFile\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(pluginPath, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'utf8'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 得到文本格式的代码\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> runtimeContext\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        foo: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'bar'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 创建一个自执行函数\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> pluginInstance\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> Function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'use strict';\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        try {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            return ${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">rawCode\u003C/span>\u003Cspan style=\"color:#9ECBFF\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        } catch (e) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            return () => {};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    `\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)()(runtimeContext);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pluginInstance;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">loadPlugin\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'plugin.js'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)  \u003C/span>\u003Cspan style=\"color:#6A737D\">// 控制台输出：{\"foo\": \"bar\"}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>仔细回顾一下上一小节的流程，实质上就是在运行插件函数的时候传递了runtimeContext的入参，使得插件内部可以获取到运行时的信息。\u003C/p>\n\u003Cp>在实际的实现中，runtime主要包括一些\u003Cstrong>内置的npm包\u003C/strong>，从而使得插件可以与APP共享某些npm包以简化开发流程，如axios、he、cheerio等。\u003C/p>\n\u003Cp>这样，基本的插件原理实现了，实际上这也就是最早版本插件的实现方式。但是这样写起来并不怎么舒服。\u003C/p>\n\u003Ch1 id=\"插件与模块\">插件与模块\u003C/h1>\n\u003Ch2 id=\"弊端\">弊端\u003C/h2>\n\u003Cp>上述写法固然实现了目的，但看起来不是最好的解决方案。原因有二：\u003Cstrong>1. 难调试 2. 难开发\u003C/strong>。\u003C/p>\n\u003Ch3 id=\"难调试\">难调试\u003C/h3>\n\u003Cp>先说第一点，难调试。由于之前的插件都是形如：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// plugin.js\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> pluginName\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">npmPackages\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> INpmPackages\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        platform: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"插件名\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        async\u003C/span>\u003Cspan style=\"color:#B392F0\"> someMethod\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    } \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#B392F0\"> PluginInstance\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>的函数，因此调试便成了很大的问题。\u003Cbr>\n如果要调试，由于插件不支持模块导入（无论是ES6还是CommonJS），为了不影响插件内容，需要复制到一个新的文件：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// test.ts\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> axios \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"axios\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> cheerio \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"cheerio\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/** 以下是复制的插件代码 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> pluginName\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">npmPackages\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> INpmPackages\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        platform: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"插件名\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        async\u003C/span>\u003Cspan style=\"color:#B392F0\"> someMethod\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    } \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#B392F0\"> PluginInstance\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> pluginInstance\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> pluginName\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    axios,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    cheerio\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">});\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/** 以上是复制的插件代码 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(pluginInstance.platform); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 输出: 插件名\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>需要写一大堆辅助代码之后，才可以开始调试验证。这也导致之前有反馈说：不知道怎么调试，APP环境也比较难启动；\u003Cbr>\n并且就算用APP环境下加载插件调试，也需要不停地把插件从电脑上拷贝到手机上，然后再在APP内加载，然后再看错误日志，非常麻烦。\u003C/p>\n\u003Ch3 id=\"难开发\">难开发\u003C/h3>\n\u003Cp>再看第二点：难开发。由于插件本质上是一个嵌入Function内的单文件js函数，因此模块导入/导出语法用不了，进而webpack、esbuild等工程化工具用起来也会很麻烦：\u003Cbr>\n需要把target设置成IIFE，打包出来的bundle导入APP的时候还不一定会出什么问题。\u003C/p>\n\u003Cp>基于以上弊端，对插件做了一次改版。\u003C/p>\n\u003Ch2 id=\"模块\">模块\u003C/h2>\n\u003Cp>其实，如果\u003Cstrong>把插件看作一个模块\u003C/strong>，问题似乎就迎刃而解了：\u003C/p>\n\u003Col>\n\u003Cli>插件是一段\u003Cstrong>职责单一\u003C/strong>的js代码，不同的插件之间功能\u003Cstrong>无任何交集\u003C/strong>。\u003C/li>\n\u003Cli>插件的入参是\u003Cstrong>运行时环境\u003C/strong>，返回值是\u003Cstrong>插件实例\u003C/strong>。\u003C/li>\n\u003Cli>目前已经有\u003Cstrong>标准的模块规范\u003C/strong>(ES6模块/CommonJS)，其中通过import/require来加载npm包或其他模块；通过export或者module.exports导出当前模块。\u003C/li>\n\u003C/ol>\n\u003Cp>基于以上，似乎也可以把插件看作一个CommonJS模块：\u003C/p>\n\u003Cul>\n\u003Cli>通过**require或者类似“全局变量”**的方式获取运行时环境；\u003C/li>\n\u003Cli>通过\u003Cstrong>module.exports\u003C/strong>导出插件实例。\u003C/li>\n\u003C/ul>\n\u003Cp>完美扣上CommonJS模块的概念。同时，由于nodejs的模块化方案就是\u003Cstrong>CommonJS\u003C/strong>，因此采用模块方案定义的插件可以在node.js环境下直接调用，不需要任何的复制粘贴以及辅助脚本。\u003C/p>\n\u003Ch2 id=\"commonjs\">CommonJS\u003C/h2>\n\u003Cp>先来看下CommonJS模块规范吧。由于这块太过基础，因此就简单带下。CommonJS认为，每个文件都是一个模块。每个模块内都可以获取一些全局变量，用来导入或者导出模块，分别是：module、require、exports。\u003C/p>\n\u003Ch3 id=\"module--exports\">module &#x26; exports\u003C/h3>\n\u003Cp>module代表着当前模块，是一个对象。其中，有一个特殊的字段“exports”，指代着当前模块的导出对象；你可以通过给这个字段赋值来控制当前模块的导出：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// module1.js\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">module\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">exports\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    foo: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'bar'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>同时，exports全局变量也指向着module.exports，因此也可以通过如下方式改变导出的对象：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// module2.js\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">exports\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.foo \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'bar'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"require\">require\u003C/h3>\n\u003Cp>require是一个函数，用来导入模块，其实也就是获取其他模块的module.exports导出的字段：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// module3.js\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> module1\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> require\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'module1.js'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">); \u003C/span>\u003Cspan style=\"color:#6A737D\">/// {foo: 'bar'}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>接下来需要思考的是：如何让MusicFree支持形如:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// pluginNew.js\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> axios\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> require\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'axios'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">module\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">exports\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    platform: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"插件名\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    async\u003C/span>\u003Cspan style=\"color:#B392F0\"> getLyric\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>的插件。\u003C/p>\n\u003Ch2 id=\"模块化的插件\">模块化的插件\u003C/h2>\n\u003Cp>我们可以试下把上述代码贴到浏览器控制台会发生什么：\r\n\u003Cimg src=\"https://i.328888.xyz/2023/03/27/ine1ov.png\" alt=\"ine1ov.png\">\u003C/p>\n\u003Cp>显然，缺少上文提到的三个全局变量：require、module和exports。接下来我们要做的是给加载“插件模块”的过程做一些改造(假定rawCode是上边pluginNew.js内的文本)：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> pluginInstance\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> Function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'use strict';\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        try {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            return ${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">rawCode\u003C/span>\u003Cspan style=\"color:#9ECBFF\">}; // 这里会出问题\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        } catch (e) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            return () => {};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    `\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)()(_require, _module, _exports);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>由于\u003Cstrong>rawCode现在不是函数\u003C/strong>了，为了让插件内部可以获取到三个特定的全局变量，我们需要手动地包一层函数：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> pluginInstance\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> Function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'use strict';\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        try {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            return function(require, module, exports) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                ${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">rawCode\u003C/span>\u003Cspan style=\"color:#9ECBFF\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        } catch (e) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            return () => {};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    `\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)()(_require, _module, _exports);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>现在再分析一下过程：\u003C/p>\n\u003Col>\n\u003Cli>创建一个Function\u003C/li>\n\u003Cli>执行Function，得到函数内部的返回值\u003C/li>\n\u003Cli>执行：\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">require\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">module\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">exports\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ${rawCode}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">})(_require, _module, _exports)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>思考一下，此时rawCode内获取到的require、module和exports是APP内\u003Cstrong>运行时环境下提供给插件\u003C/strong>的，当这个函数执行完毕后，我们可以从module.exports中获取到我们需要的插件返回值；同时也可以用require加载APP内部的npm包。\u003C/p>\n\u003Cp>最后一步要做的，便是重新定义一下require，module和exports了。\u003C/p>\n\u003Ch2 id=\"定义全局变量\">定义全局变量\u003C/h2>\n\u003Cp>根据上文，module和exports其实很好办：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 注意：此段代码是在APP内部ReactNative环境下实现\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> _module\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    exports: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> _exports\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> _module.exports;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>require相对来说复杂点，我们整理一下我们目前的信息：\u003C/p>\n\u003Col>\n\u003Cli>require是个函数\u003C/li>\n\u003Cli>require入参是npm包名（在加载npm包的情况下）\u003C/li>\n\u003Cli>require的返回值会直接被模块使用\u003C/li>\n\u003C/ol>\n\u003Cp>因此，我们可以做一个简单的模拟require:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 注意：此段代码是在APP内部ReactNative环境下实现\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> axios \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'axios'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> cheerio \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'cheerio'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> CryptoJS \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'crypto-js'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 在app内安装的npm包\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> packages\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    axios,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    cheerio\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    'crypto-js'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: CryptoJS,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // ... \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#B392F0\"> _require\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">packageName\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pkg \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> packages[packageName];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pkg;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"总结\">总结\u003C/h2>\n\u003Cp>现在回过头看，新的“模块化插件”已经诞生了，最终的插件信息会挂载到module.exports上：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> axios \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'axios'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> cheerio \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'cheerio'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> CryptoJS \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'crypto-js'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {readFile} \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'react-native-fs'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 在app内安装的npm包\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> packages\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    axios,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    cheerio\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    'crypto-js'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: CryptoJS,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 其他内置的包... \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#B392F0\"> _require\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">packageName\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pkg \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> packages[packageName];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pkg;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 从某个路径加载插件\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">async\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> loadPlugin\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">pluginPath\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> rawCode\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#B392F0\"> readFile\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(pluginPath, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'utf8'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 得到文本格式的代码\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 初始化模块信息\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> _module\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        exports: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> _exports\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> _module.exports;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> pluginInstance\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> Function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'use strict';\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        try {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            return function(require, module, exports) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                ${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">rawCode\u003C/span>\u003Cspan style=\"color:#9ECBFF\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        } catch (e) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            return () => {};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    `\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)()(_require, _module, _exports);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> _module.exports; \u003C/span>\u003Cspan style=\"color:#6A737D\">// 模块的导出\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">loadPlugin\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'pluginNew.js'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)  \u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>仔细看看这段代码，是不是和经常被问到的所谓“commonjs模块原理是什么”差不多呢？\u003C/p>\n\u003Ch1 id=\"代码是用来解决问题的\">代码是用来解决问题的\u003C/h1>\n\u003Cp>这章标题是随便取的，其实也是我的一个小观念。在写了一堆代码之后，自然要看一下这样子一通折腾有没有解决最初的两个问题。\u003C/p>\n\u003Cp>从开发上来说，由于使用了commonjs模块，我可以使用更多的技术去降低开发成本：使用typescript、使用webpack等工程化工具，并且只需要把最终打包时的target设置为CommonJS即可。开发时也不再仅限于“只能写一个单文件”；甚至可以引入一些没有内置的npm包，只需要最终打包时把源码打进插件就可以了。\u003C/p>\n\u003Cp>从调试上来说，nodejs环境下运行插件与APP环境下运行插件几乎无区别，因此可以直接一边开发一边调试以验证插件是否符合预期，大大降低了成本：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/03/27/inFRLk.png\" alt=\"inFRLk.png\">\u003C/p>\n\u003Cp>以及，除了对上述require、module和exports的实现外，也可以用类似的方式屏蔽掉插件内所有的console.log，只需要用类似的方式重新定义一下console对象即可。\u003C/p>\n\u003Ch1 id=\"结尾\">结尾\u003C/h1>\n\u003Cp>本文中的主要代码可以在\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts\">这里\u003C/a>看到。\u003C/p>\n\u003Cp>MusicFree是一个基于GPL3开源的免费音乐播放器，源代码地址：\u003Ca href=\"https://github.com/maotoumao/MusicFree%EF%BC%8C%E6%AC%A2%E8%BF%8E%E7%82%B9%E4%B8%AAstar\">https://github.com/maotoumao/MusicFree，欢迎点个star\u003C/a>~\u003C/p>\n\u003Cp>感兴趣的话也可以\u003Ca href=\"https://wwzb.lanzoue.com/b041xm5fg\">戳这里\u003C/a>下载。个人业余作品，只是用于满足个人需求和技术探索。仅供学习参考，不要用于商业目的~\u003C/p>",{"headings":535,"localImagePaths":569,"remoteImagePaths":570,"frontmatter":571,"imagePaths":573},[536,538,540,542,544,546,548,550,552,553,556,559,561,563,565,566,568],{"depth":283,"slug":537,"text":537},"背景",{"depth":283,"slug":539,"text":539},"插件原理",{"depth":26,"slug":541,"text":541},"从零开始",{"depth":26,"slug":543,"text":543},"勾入运行时环境",{"depth":283,"slug":545,"text":545},"插件与模块",{"depth":26,"slug":547,"text":547},"弊端",{"depth":81,"slug":549,"text":549},"难调试",{"depth":81,"slug":551,"text":551},"难开发",{"depth":26,"slug":198,"text":198},{"depth":26,"slug":554,"text":555},"commonjs","CommonJS",{"depth":81,"slug":557,"text":558},"module--exports","module & exports",{"depth":81,"slug":560,"text":560},"require",{"depth":26,"slug":562,"text":562},"模块化的插件",{"depth":26,"slug":564,"text":564},"定义全局变量",{"depth":26,"slug":262,"text":262},{"depth":283,"slug":567,"text":567},"代码是用来解决问题的",{"depth":283,"slug":517,"text":517},[],[],{"title":526,"pubDate":572,"category":33,"excerpt":528},["Date","2023-03-27T21:59:32.000Z"],[],"一些比较有趣的js题",{"id":574,"data":576,"body":580,"filePath":581,"digest":582,"rendered":583},{"title":577,"pubDate":578,"category":33,"excerpt":579},"一些比较有趣的JS题",["Date","2019-06-25T16:13:57.000Z"],"记一些有意思的js题吧。","**在网上或者群里看到的一些关于js语法的题目，有的自己一时半会也没想清楚，在这里记录下来，方便以后查阅。**\n\n---\n1. 代码的输出结果？\n``` javascript\n    var a = 1.0 - 0.9;\n    if(a === 0.1){\n        console.log(true);\n    }\n    else{\n        console.log(false);\n    }\n    \n    var b = 0.8 - 0.7;\n    if(a === b){\n        console.log(true);\n    }\n    else{\n        console.log(false)\n    }\n```\n答案：false false\n> - js的浮点数运算在计算之后都会有一定的精度损失，因此计算之后的结果，也就是a和b，不会是0.1，而是**近似于0.1**的一个浮点数。  \n> - 当然，a与b也不是绝对不会相等。对于下面这段代码：\n> ``` node\n> var a = 2.0 - 1.9;\n> if(a === 0.1){\n> \tconsole.log(true);\n> }\n> else{\n> \tconsole.log(false);\n> }\n> \n> var b = 3.0 - 2.9;\n> if(a === b){\n> \tconsole.log(true);\n> }\n> else{\n> \tconsole.log(false)\n> }\n> ```\n> 输出的结果即为false和true。因为损失的精度值完全相同。  \n> - 精度损失的问题通常出现在**浮点数运算**与**大整数运算**中。\n> - ++解决精度损失的方案++：对浮点数运算，首先对其放大一定倍数，直至变为整数，再缩小相应倍数，得到精确值。\n\n---\n\n2. 代码的输出结果？\n``` node\n    var x = 30;\n    function test(){\n        console.log(x);\n        var x = 10;\n        console.log(x);\n        x = 20;\n        function x(){}\n        console.log(x);\n    }\n```\n答案：function x(){} 10 20\n> - 出现这个结果的原因是**变量提升**。function在定义时，提升到代码块最顶部的位置，也就是test函数内的第一行。因此，整个代码理解起来相当于：\n> ```node\n>     var x = 30;\n>     function test(){\n>         function x(){}\n>         console.log(x);\n>         var x = 10;\n>         console.log(x);\n>         x = 20;\n>         console.log(x);\n>     }\n> ```\n>因此有上述结果。\n---\n\n3. 代码的输出结果？\n``` node\n    var a = {n : 1}\n    var b = a;\n    a.x = a = {n : 2}\n    console.log(a.x)\n    console.log(b.x)\n```\n答案：undefined {n:2}\n>- 这是由于运算符优先级而导致的问题。  \n在最开始时，a和b共同指向了一个位置A，这个位置存放着{n:1}。\n之后当执行代码：\n> ```node\n>     a.x = a = {n:2}\n> ```\n>时，.运算符比赋值运算符优先级高，因此首先计算a.x，也就是位置A中的x。接下来，按照优先级表，从右向左进行赋值。假设{n:2}存放在位置B，那么第二步就是将a指向位置B。而第三步，由于第一步先计算了位置A中的x，因此第三步是将位置A中的x取出，并指向位置B。因此，计算完成之后，位置A存储的值为：{n:1, x:{n:2}}，而位置B存储的值为：{n:2}。显然，最终的结果是b指向位置A，a指向位置B。故而有上述结果。  \n>- 在写代码时，**不要写连续赋值**。","src/content/posts/一些比较有趣的JS题.md","7c084d694316b667",{"html":584,"metadata":585},"\u003Cp>\u003Cstrong>在网上或者群里看到的一些关于js语法的题目，有的自己一时半会也没想清楚，在这里记录下来，方便以后查阅。\u003C/strong>\u003C/p>\n\u003Chr>\n\u003Col>\n\u003Cli>代码的输出结果？\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> a \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1.0\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0.9\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(a \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0.1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> b \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0.8\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0.7\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(a \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> b){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>答案：false false\u003C/p>\n\u003Cblockquote>\n\u003Cul>\n\u003Cli>js的浮点数运算在计算之后都会有一定的精度损失，因此计算之后的结果，也就是a和b，不会是0.1，而是\u003Cstrong>近似于0.1\u003C/strong>的一个浮点数。\u003C/li>\n\u003Cli>当然，a与b也不是绝对不会相等。对于下面这段代码：\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>var a = 2.0 - 1.9;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>if(a === 0.1){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\tconsole.log(true);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>else{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\tconsole.log(false);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>var b = 3.0 - 2.9;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>if(a === b){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\tconsole.log(true);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>else{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\tconsole.log(false)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>输出的结果即为false和true。因为损失的精度值完全相同。\u003C/p>\n\u003Cul>\n\u003Cli>精度损失的问题通常出现在\u003Cstrong>浮点数运算\u003C/strong>与\u003Cstrong>大整数运算\u003C/strong>中。\u003C/li>\n\u003Cli>++解决精度损失的方案++：对浮点数运算，首先对其放大一定倍数，直至变为整数，再缩小相应倍数，得到精确值。\u003C/li>\n\u003C/ul>\n\u003C/blockquote>\n\u003Chr>\n\u003Col start=\"2\">\n\u003Cli>代码的输出结果？\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    var x = 30;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    function test(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        console.log(x);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        var x = 10;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        console.log(x);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        x = 20;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        function x(){}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        console.log(x);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>答案：function x(){} 10 20\u003C/p>\n\u003Cblockquote>\n\u003Cul>\n\u003Cli>出现这个结果的原因是\u003Cstrong>变量提升\u003C/strong>。function在定义时，提升到代码块最顶部的位置，也就是test函数内的第一行。因此，整个代码理解起来相当于：\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    var x = 30;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    function test(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        function x(){}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        console.log(x);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        var x = 10;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        console.log(x);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        x = 20;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        console.log(x);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>因此有上述结果。\u003C/p>\n\u003C/blockquote>\n\u003Chr>\n\u003Col start=\"3\">\n\u003Cli>代码的输出结果？\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    var a = {n : 1}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    var b = a;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    a.x = a = {n : 2}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    console.log(a.x)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    console.log(b.x)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>答案：undefined {n:2}\u003C/p>\n\u003Cblockquote>\n\u003Cul>\n\u003Cli>这是由于运算符优先级而导致的问题。\u003Cbr>\n在最开始时，a和b共同指向了一个位置A，这个位置存放着{n:1}。\n之后当执行代码：\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    a.x = a = {n:2}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>时，.运算符比赋值运算符优先级高，因此首先计算a.x，也就是位置A中的x。接下来，按照优先级表，从右向左进行赋值。假设{n:2}存放在位置B，那么第二步就是将a指向位置B。而第三步，由于第一步先计算了位置A中的x，因此第三步是将位置A中的x取出，并指向位置B。因此，计算完成之后，位置A存储的值为：{n:1, x:{n:2}}，而位置B存储的值为：{n:2}。显然，最终的结果是b指向位置A，a指向位置B。故而有上述结果。\u003C/p>\n\u003Cul>\n\u003Cli>在写代码时，\u003Cstrong>不要写连续赋值\u003C/strong>。\u003C/li>\n\u003C/ul>\n\u003C/blockquote>",{"headings":586,"localImagePaths":587,"remoteImagePaths":588,"frontmatter":589,"imagePaths":591},[],[],[],{"title":577,"pubDate":590,"category":33,"excerpt":579},["Date","2019-06-25T16:13:57.000Z"],[],"两年前端面试总结",{"id":592,"data":594,"body":599,"filePath":600,"digest":601,"rendered":602},{"title":595,"pubDate":596,"category":597,"excerpt":598},"【写给自己】两年前端面试总结",["Date","2023-06-10T20:51:45.000Z"],"职业/随笔","谈不上什么经验，只是记录一下第一次社招面试，下次跳槽的时候说不定还能用得上。","## 前言\r\n\r\n最近行情确实偏冷。第一次参加社招，面了 2.5 个公司，侥幸都通过了面试。做了一件事情之后，总要总结点什么以备不时之需，所以在此做个记录。不太想罗列八股或者面试题，毕竟这些东西都搜得到，就大概记录一些思路之类的东西吧。\r\n\r\n因为是发在公共平台上，所以还是简单说下自己的情况：C9 本硕 计算机系（众所周知，C9 只有两所学校），21 年毕业之后在阿里工作，技术栈是 React。工作之外有个 1.8k star 的开源项目。\r\n\r\n## 关于计划\r\n\r\n其实大概去年 8 月份的时候就已经考虑好了今年想要离职，也早在那时候就开始了计划，只不过那时候时间还早，所以并没有把主要精力放在准备面试或者刷题上。\r\n\r\n当时定的计划大概是在 2 月份开始准备，所以想在中间这段时间折腾点有意思的东西，一方面是想扩展自己的知识面；另一方面是想做一些能给自己或者身边的朋友带来帮助的、有实用意义的小作品；如果能在 github 上收获一点星星就更好了。\r\n\r\n尽管需求不是凭空产生的，但是平时总会冒出各种各样的小灵感，然后顺手试着做做，所以倒也不缺 idea。当时在学 React Native 玩，然后突然想到在 React Native 中是不是可以通过 ```eval``` 或者 ```new Function``` 加载一些外部的 js 代码执行，验证可行后就想做一个音乐播放器（因为研三快毕业的时候闲着没事学 Flutter，简单做了一个，但是功能并不完善）。\r\n\r\n做了个初版之后，给阮一峰老师投了个稿，后面也有些小伙伴自发安利，慢慢的 star 数也多了起来，也算是给自己简历上加了一个小小的加分项。\r\n\r\n![star history](https://s1.locimg.com/2023/06/10/7775413e0c2b3.png)\r\n\r\n实践起来，从开始准备（大概今年 3 月份开始）到结束大概前后花费 3 个月的时间：前期主要是刷题，简单捡一下基础知识；接下来是总结项目经验，做好简历；然后就开始投递和面试了。\r\n\r\n## 关于基础知识\r\n\r\n简单总结一下，基础知识主要是语言、网络、算法、框架、浏览器原理、工程。\r\n\r\n### 语言\r\n\r\n主要是 javascript 或者 typescript，js 的话翻一下红宝书，或者搜一些八股合集就好了；ts 的话可能会有一些类型编程，但是其实平时主要用的都是 typescript，类型也没少写，所以也不是什么大问题。\r\n\r\ncss 的话，翻一翻八股合集大概也够了。\r\n\r\n不过总之，我没有花很多时间在复习语言上。\r\n\r\n### 网络\r\n\r\n网络其实还是比较容易生疏的，平时工作以需求为主的话，还是要多看一下。简单列一下比较重要的点：\r\n\r\n- http（1.0/1.1/2.0）  https\r\n- 缓存策略（强缓存、协商缓存）\r\n- csrf / xss\r\n- websocket（因为简历上写了）\r\n- cookie\r\n- cdn 原理\r\n\r\n### 算法\r\n\r\nleetcode 中等难度，刷了大概 200 道题。vscode 里面可以装一个 leetcode 插件，插件里面有分类的题库，我基本上都是从里面每个类型挑一些中等难度（偶尔困难）的题刷；动态规划刷的稍多点，因为容易想不出来，特别是状态不好的时候。\r\n\r\n## 框架\r\n\r\n其实我很讨厌啃框架源码。\r\n\r\n## 关于简历\r\n\r\n简历真的很难做\r\n\r\n\r\n## 关于面试\r\n\r\n\r\n## 关于心态","src/content/posts/两年前端面试总结.md","a90ad6db5eff51c7",{"html":603,"metadata":604},"\u003Ch2 id=\"前言\">前言\u003C/h2>\n\u003Cp>最近行情确实偏冷。第一次参加社招，面了 2.5 个公司，侥幸都通过了面试。做了一件事情之后，总要总结点什么以备不时之需，所以在此做个记录。不太想罗列八股或者面试题，毕竟这些东西都搜得到，就大概记录一些思路之类的东西吧。\u003C/p>\n\u003Cp>因为是发在公共平台上，所以还是简单说下自己的情况：C9 本硕 计算机系（众所周知，C9 只有两所学校），21 年毕业之后在阿里工作，技术栈是 React。工作之外有个 1.8k star 的开源项目。\u003C/p>\n\u003Ch2 id=\"关于计划\">关于计划\u003C/h2>\n\u003Cp>其实大概去年 8 月份的时候就已经考虑好了今年想要离职，也早在那时候就开始了计划，只不过那时候时间还早，所以并没有把主要精力放在准备面试或者刷题上。\u003C/p>\n\u003Cp>当时定的计划大概是在 2 月份开始准备，所以想在中间这段时间折腾点有意思的东西，一方面是想扩展自己的知识面；另一方面是想做一些能给自己或者身边的朋友带来帮助的、有实用意义的小作品；如果能在 github 上收获一点星星就更好了。\u003C/p>\n\u003Cp>尽管需求不是凭空产生的，但是平时总会冒出各种各样的小灵感，然后顺手试着做做，所以倒也不缺 idea。当时在学 React Native 玩，然后突然想到在 React Native 中是不是可以通过 \u003Ccode>eval\u003C/code> 或者 \u003Ccode>new Function\u003C/code> 加载一些外部的 js 代码执行，验证可行后就想做一个音乐播放器（因为研三快毕业的时候闲着没事学 Flutter，简单做了一个，但是功能并不完善）。\u003C/p>\n\u003Cp>做了个初版之后，给阮一峰老师投了个稿，后面也有些小伙伴自发安利，慢慢的 star 数也多了起来，也算是给自己简历上加了一个小小的加分项。\u003C/p>\n\u003Cp>\u003Cimg src=\"https://s1.locimg.com/2023/06/10/7775413e0c2b3.png\" alt=\"star history\">\u003C/p>\n\u003Cp>实践起来，从开始准备（大概今年 3 月份开始）到结束大概前后花费 3 个月的时间：前期主要是刷题，简单捡一下基础知识；接下来是总结项目经验，做好简历；然后就开始投递和面试了。\u003C/p>\n\u003Ch2 id=\"关于基础知识\">关于基础知识\u003C/h2>\n\u003Cp>简单总结一下，基础知识主要是语言、网络、算法、框架、浏览器原理、工程。\u003C/p>\n\u003Ch3 id=\"语言\">语言\u003C/h3>\n\u003Cp>主要是 javascript 或者 typescript，js 的话翻一下红宝书，或者搜一些八股合集就好了；ts 的话可能会有一些类型编程，但是其实平时主要用的都是 typescript，类型也没少写，所以也不是什么大问题。\u003C/p>\n\u003Cp>css 的话，翻一翻八股合集大概也够了。\u003C/p>\n\u003Cp>不过总之，我没有花很多时间在复习语言上。\u003C/p>\n\u003Ch3 id=\"网络\">网络\u003C/h3>\n\u003Cp>网络其实还是比较容易生疏的，平时工作以需求为主的话，还是要多看一下。简单列一下比较重要的点：\u003C/p>\n\u003Cul>\n\u003Cli>http（1.0/1.1/2.0）  https\u003C/li>\n\u003Cli>缓存策略（强缓存、协商缓存）\u003C/li>\n\u003Cli>csrf / xss\u003C/li>\n\u003Cli>websocket（因为简历上写了）\u003C/li>\n\u003Cli>cookie\u003C/li>\n\u003Cli>cdn 原理\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"算法\">算法\u003C/h3>\n\u003Cp>leetcode 中等难度，刷了大概 200 道题。vscode 里面可以装一个 leetcode 插件，插件里面有分类的题库，我基本上都是从里面每个类型挑一些中等难度（偶尔困难）的题刷；动态规划刷的稍多点，因为容易想不出来，特别是状态不好的时候。\u003C/p>\n\u003Ch2 id=\"框架\">框架\u003C/h2>\n\u003Cp>其实我很讨厌啃框架源码。\u003C/p>\n\u003Ch2 id=\"关于简历\">关于简历\u003C/h2>\n\u003Cp>简历真的很难做\u003C/p>\n\u003Ch2 id=\"关于面试\">关于面试\u003C/h2>\n\u003Ch2 id=\"关于心态\">关于心态\u003C/h2>",{"headings":605,"localImagePaths":625,"remoteImagePaths":626,"frontmatter":627,"imagePaths":629},[606,607,609,611,613,615,617,619,621,623],{"depth":26,"slug":27,"text":27},{"depth":26,"slug":608,"text":608},"关于计划",{"depth":26,"slug":610,"text":610},"关于基础知识",{"depth":81,"slug":612,"text":612},"语言",{"depth":81,"slug":614,"text":614},"网络",{"depth":81,"slug":616,"text":616},"算法",{"depth":26,"slug":618,"text":618},"框架",{"depth":26,"slug":620,"text":620},"关于简历",{"depth":26,"slug":622,"text":622},"关于面试",{"depth":26,"slug":624,"text":624},"关于心态",[],[],{"title":595,"pubDate":628,"category":597,"excerpt":598},["Date","2023-06-10T20:51:45.000Z"],[],"你生成的ai绘画下一秒就是我的了",{"id":630,"data":632,"body":636,"filePath":637,"digest":638,"rendered":639},{"title":633,"pubDate":634,"category":33,"excerpt":635},"你生成的AI绘画，下一秒就是我的了",["Date","2023-02-20T22:21:46.000Z"],"简单写个爬虫吧。","# 前言\r\n（先说好，本文还是一个技术探索文章！）   \r\n书接上回。上次开了点小脑洞，在AI绘画和ChatGPT的帮助下做了个小程序。其中，AI绘画使用的是MidJourney程序，它帮我生成了一些精美的图片，稍作修改后就用到了我的小程序里。\r\n\r\n![](https://i.328888.xyz/2023/02/20/giTHv.md.png)\r\n\r\nMidJourney架设在Discord网站上，通过给Discord机器人发送指令来生成图片。在下图中的聊天框中输入“/imagine 关键词”指令，过一会你就可以收到下图中的四宫格图片。你可以对其中任意一张图**添加一些细节(upscale)**或者**做一些变动(variation)**，然后MidJourney就会根据这张图片生成一张高清大图:\r\n![](https://i.328888.xyz/2023/03/01/6cMlJ.png)\r\n\r\n然而，MidJourney程序每个新账号只能**免费使用25次（包括四宫格图）**，再用的话就需要氪金了。作为一只铁公鸡，那自然得想想怎么样在*不花钱的情况下多整点AI美图*。我们可以注意到，如果不加设置的话，别人生成的AI画作也会展示在聊天室中，并且貌似也很精美。那不如…… 全都下载下来\r\n![](https://pic.diydoutu.com/bq/006mowZngy1ftqn2dnsctj308b09qmxl.jpg)\r\n\r\n\r\n当然，也要注意一下版权声明，中文版的协议链接[戳这里](https://creativecommons.org/licenses/by-nc/4.0/legalcode.zh-Hans)，至少可以在非商用的场景下可以复制和分享：\r\n![](https://i.328888.xyz/2023/03/01/6mRGP.png)\r\n\r\n# 我全都要\r\n既然这样，那我就不客气了，想办法给它全都下下来。先来看看这个网页的结构吧。\r\n\r\n从下图可以发现，这个网站的所有的聊天信息都在一个ol结点中，其中**每一条消息都是一个li结点**。 \r\n![](https://i.328888.xyz/2023/03/01/6mqkZ.png)\r\n\r\nAI生成图片需要时间，而这段时间内的生成的中间状态的图片为.webp格式，**最终生成的图片是.png格式**：\r\n![](https://i.328888.xyz/2023/03/01/6plAN.png)\r\n![](https://i.328888.xyz/2023/03/01/6pNka.png)\r\n\r\n同时，ol中li结点的数目并不是无限扩大的，**到了一定的数目就会复用**，估计是代码里有限制。同时，更新数据消息是从**websocket**中接收的。\r\n\r\n我们的目的是获取网页中**所有的图片和prompts**。为了达到以上目的，我们有两种思路：\r\n1. **拦截websocket消息**，把里面关于的图片url的部分找出来并下载。\r\n2. 既然dom结构那么规整，那就直接从dom入手，**解析下dom结构**找出所有png格式的图片然后下载。\r\n\r\n显然，第二种成本更低一些。方案敲定，那就开始coding吧~\r\n\r\n# 解析dom\r\n我们先来写个简单的脚本把网页中AI生成的图片全都扒下来。符合要求的图片满足以下条件：\r\n- 在ol标签下的li标签内；\r\n- 图片url在a标签的href属性内；\r\n- **图片消息的发送方是Midjourney Bot**  \r\n\r\n第三点尤为重要，因为Midjourney可以图生图，所以你可能会看到有些老哥突然发了自己的自拍…… \r\n\r\n至于Prompts，我们可以发现它是粗体，被\u003C strong >标签包裹。\r\n\r\n依据以上，我们可以写出一段非常简单的脚本：\r\n``` typescript\r\n// 找到ol，它的class以scrollerInner-开头\r\nconst contentList = document.querySelector('ol[class^=\"scrollerInner-\"]');\r\n// 找到所有的li标签\r\nconst lis = Array.from(contentList.children).filter(\r\n    (item) => item.tagName === \"LI\"\r\n);\r\n\r\nlis.forEach((li) => {\r\n    parseLiNode(li);\r\n})\r\n\r\nfunction parseLiNode(li) {\r\n    // 截取一个唯一的id\r\n    const id = li.id.substring(14);\r\n    // 粗体部分\r\n    const prompts = Array.from(\r\n      li.querySelector(\"div[id^=message-content-]>strong\")?.childNodes ?? []\r\n    )\r\n      .filter((node) => node.nodeType === Node.TEXT_NODE)\r\n      .map((node) => node.textContent)\r\n      .join(\" \");\r\n    // 取出a标签的href\r\n    const url = li.querySelector(\r\n      \"div[class^=messageAttachment] div[class^=imageWrapper] a[data-role=img]\"\r\n    )?.href;\r\n    console.log(id, prompts, url);\r\n}\r\n\r\n\r\n```\r\n贴到控制台，就可以看到这段脚本已经把网页中所有的AI画作的url和prompts打印出来了：\r\n\r\n![](https://i.328888.xyz/2023/03/02/6XiGC.png)\r\n\r\n然而这还只是刚刚开始，这段脚本只能打印**当前出现在页面**中的画作，对于后边新生成的可就无能为力了。为了让它不断的获取到最新生成的画作，我们还得做一些额外的操作。\r\n# MutationObserver\r\n为了达成上一节结尾的目的，第一反应就是使用setInterval，隔段时间重新扫描下页面中的png图片。不过你可能猜到了我肯定没用它，要不然这一章的标题就该改名了。\r\n\r\n没用setInterval的原因相信大家也猜得到：用户生成AI画作的频率不稳定；如果setInternal频率高了，可能会造成浪费；如果频率低了，可能某个时间段内很多用户疯狂生成图片，我们可能会丢失某些图片的信息。\r\n\r\n因此，我们可以使用更精准的方式获取到dom结构的变动——**MutationObserver**。\r\n\r\n## 用法\r\n先看看MDN上的介绍：\r\n\r\n![](https://i.328888.xyz/2023/03/02/6Blg8.png)\r\n\r\n一个MutationObserver对象只有三个方法，使用示例也相对简单 （下边是从mdn上抄的）：\r\n```javascript\r\n // 选择需要观察变动的节点\r\nconst targetNode = document.getElementById('some-id');\r\n\r\n// 观察器的配置（需要观察什么变动）\r\nconst config = { attributes: true, childList: true, subtree: true };\r\n\r\n// 当观察到变动时执行的回调函数\r\nconst callback = function(mutationsList, observer) {\r\n    // Use traditional 'for loops' for IE 11\r\n    for(let mutation of mutationsList) {\r\n        if (mutation.type === 'childList') {\r\n            console.log('A child node has been added or removed.');\r\n        }\r\n        else if (mutation.type === 'attributes') {\r\n            console.log('The ' + mutation.attributeName + ' attribute was modified.');\r\n        }\r\n    }\r\n};\r\n\r\n// 创建一个观察器实例并传入回调函数\r\nconst observer = new MutationObserver(callback);\r\n\r\n// 以上述配置开始观察目标节点\r\nobserver.observe(targetNode, config);\r\n\r\n// 之后，可停止观察\r\nobserver.disconnect();\r\n```\r\n\r\n上边的示例程序翻译成人话就是：\r\n- 新建一个MutationObserver对象\r\n- 它监测targetNode节点\r\n- 在config定义的监测内容发生变化时执行callback\r\n\r\n其中，config定义的监测内容表示：当target**及其子结点(subtree为true)**发生**属性变化时(attribute为true)**，或**其子结点发生新增/删除时(childList为true)**触发回调。\r\n\r\n有了这个东西，获取网页中新生成的图片就容易多了。\r\n\r\n## 实战\r\n前面分析过，discord聊天记录中最大条目是有限制的，因此我们会监测到li结点的新增或者删除。除此之外，因为照片可能会实时更新，因此也可以监测到li内class为imageWrapper的div会有属性变动。这两部分对应的图片可能有交集，因此可以用一个set去重。\r\n\r\n我们只需要获取到新增的li结点，然后找到class变动的div的祖先li结点，取并集之后就可以得到页面中新增的AI画作元素了。\r\n\r\n``` typescript\r\nlet mutationObserver: MutationObserver;\r\nasync function startObserve() {\r\n  mutationObserver = new MutationObserver((records) => {\r\n    records.forEach((record) => {\r\n      const addNodes = record.addedNodes;\r\n      if (\r\n        record.type === \"childList\" &&\r\n        addNodes?.length &&\r\n        (record.target as Element).tagName === \"OL\"\r\n      ) {\r\n        // ol标签的childlist变动，取出其中新增的li结点\r\n        addNodes.forEach((node) => {\r\n          const li = node as HTMLElement;\r\n          if (\r\n            !(li.tagName === \"LI\" && li.id.startsWith(\"chat-messages-\"))\r\n          ) {\r\n            return;\r\n          }\r\n          parseLiNode(li); // 解析这个li结点\r\n        });\r\n      } else if (\r\n        record.type === \"attributes\" &&\r\n        record.attributeName === \"class\" &&\r\n        (record.target as Element).tagName === \"DIV\" &&\r\n        (record.target as Element).className.includes(\"imageWrapper\")\r\n      ) {\r\n        // 属性变动的div\r\n        let li: Element | null | undefined = record.target as Element;\r\n        while (li?.tagName !== \"LI\" && li) {\r\n          li = li.parentElement;\r\n        }\r\n        if (li) {\r\n          parseLiNode(li);\r\n        }\r\n      }\r\n    });\r\n  });\r\n  const contentList = document.querySelector('ol[class^=\"scrollerInner-\"]');\r\n  if (!contentList) {\r\n    return;\r\n  }\r\n  mutationObserver.observe(contentList, {\r\n    attributes: true,\r\n    childList: true,\r\n    subtree: true,\r\n  });\r\n}\r\n\r\nstartObserve();\r\n\r\n```\r\n把这段程序拷到控制台（把类型信息删掉就好了，上边代码是ts），便可以持续不断地打印出新的画作信息了：\r\n![](https://i.328888.xyz/2023/03/02/6XAMJ.png)\r\n\r\n# 下载\r\n获取AI画作的信息是搞定了，接下来就是如何下载了。一张一张下载肯定是不太行（要不然一小会文件夹内就会下载得满是png文件），直接用jszip打包下载一下，使用方式也很方便：\r\n```typescript\r\nimport JSZip from \"jszip\";\r\n\r\nconst zip = new JSZip();\r\n\r\nconst binaryBlob = fetch(\"image-cdn-url\").then(_ => _.blob());\r\n\r\n// 在压缩包内放一个名字是fileName.png的图片，图片是二进制blob\r\nzip.file(`fileName.png`, binaryBlob, {\r\n    binary: true,\r\n});\r\n\r\n// 下边的zipContent就是生成的zip压缩包\r\nzip.generateAsync({ type: \"blob\" }).then(zipContent => {\r\n    saveFile(zipContent, `midjourney-${Date.now()}.zip`) // saveFile的实现略过了~\r\n})\r\n```\r\n\r\n# 结尾（源代码在这里！）\r\n\r\n最后就简单润色下，加上一些规则限制（比如说过滤掉四宫格的图片，只保存大图）、下载限制（每攒80张图下载一次，大概100+M）、用户名检查（有时候Discord机器人会批量发消息，这个时候用户名会被略过）等等，再用esbuild打到一个bundle里，就完成啦。\r\n\r\n28号那天挂了一整天，然后下班回来就收获了满满**2G**（**两千多张**）高清图片……\r\n\r\n![](https://i.328888.xyz/2023/03/01/6mMdv.png)\r\n\r\n\r\n## 代码开源~ 不要干坏事哟：\r\n使用方式在readme里啦。\r\nhttps://github.com/maotoumao/midjourney-downloader\r\n\r\n如果你觉得好玩，不如点个star；如果你觉得有用，那你可以去公众号【一只猫头猫】留言“猫头猫真棒”，我也会夸夸你~\r\n\r\n下次整活的时候再见~\r\n\r\n\r\n# 最最最后放些收集的美图\r\n![](https://i.328888.xyz/2023/03/02/6XRdU.png)\r\n![](https://i.328888.xyz/2023/03/02/6Xcqv.png)\r\n![](https://i.328888.xyz/2023/03/02/6Xp23.png)\r\n![](https://i.328888.xyz/2023/03/02/6XBEy.png)","src/content/posts/你生成的AI绘画，下一秒就是我的了.md","7feed3ff1d81da0e",{"html":640,"metadata":641},"\u003Ch1 id=\"前言\">前言\u003C/h1>\n\u003Cp>（先说好，本文还是一个技术探索文章！）\u003Cbr>\n书接上回。上次开了点小脑洞，在AI绘画和ChatGPT的帮助下做了个小程序。其中，AI绘画使用的是MidJourney程序，它帮我生成了一些精美的图片，稍作修改后就用到了我的小程序里。\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/02/20/giTHv.md.png\" alt=\"\">\u003C/p>\n\u003Cp>MidJourney架设在Discord网站上，通过给Discord机器人发送指令来生成图片。在下图中的聊天框中输入“/imagine 关键词”指令，过一会你就可以收到下图中的四宫格图片。你可以对其中任意一张图\u003Cstrong>添加一些细节(upscale)\u003Cstrong>或者\u003C/strong>做一些变动(variation)\u003C/strong>，然后MidJourney就会根据这张图片生成一张高清大图:\r\n\u003Cimg src=\"https://i.328888.xyz/2023/03/01/6cMlJ.png\" alt=\"\">\u003C/p>\n\u003Cp>然而，MidJourney程序每个新账号只能\u003Cstrong>免费使用25次（包括四宫格图）\u003C/strong>，再用的话就需要氪金了。作为一只铁公鸡，那自然得想想怎么样在\u003Cem>不花钱的情况下多整点AI美图\u003C/em>。我们可以注意到，如果不加设置的话，别人生成的AI画作也会展示在聊天室中，并且貌似也很精美。那不如…… 全都下载下来\r\n\u003Cimg src=\"https://pic.diydoutu.com/bq/006mowZngy1ftqn2dnsctj308b09qmxl.jpg\" alt=\"\">\u003C/p>\n\u003Cp>当然，也要注意一下版权声明，中文版的协议链接\u003Ca href=\"https://creativecommons.org/licenses/by-nc/4.0/legalcode.zh-Hans\">戳这里\u003C/a>，至少可以在非商用的场景下可以复制和分享：\r\n\u003Cimg src=\"https://i.328888.xyz/2023/03/01/6mRGP.png\" alt=\"\">\u003C/p>\n\u003Ch1 id=\"我全都要\">我全都要\u003C/h1>\n\u003Cp>既然这样，那我就不客气了，想办法给它全都下下来。先来看看这个网页的结构吧。\u003C/p>\n\u003Cp>从下图可以发现，这个网站的所有的聊天信息都在一个ol结点中，其中\u003Cstrong>每一条消息都是一个li结点\u003C/strong>。\r\n\u003Cimg src=\"https://i.328888.xyz/2023/03/01/6mqkZ.png\" alt=\"\">\u003C/p>\n\u003Cp>AI生成图片需要时间，而这段时间内的生成的中间状态的图片为.webp格式，\u003Cstrong>最终生成的图片是.png格式\u003C/strong>：\r\n\u003Cimg src=\"https://i.328888.xyz/2023/03/01/6plAN.png\" alt=\"\">\r\n\u003Cimg src=\"https://i.328888.xyz/2023/03/01/6pNka.png\" alt=\"\">\u003C/p>\n\u003Cp>同时，ol中li结点的数目并不是无限扩大的，\u003Cstrong>到了一定的数目就会复用\u003C/strong>，估计是代码里有限制。同时，更新数据消息是从\u003Cstrong>websocket\u003C/strong>中接收的。\u003C/p>\n\u003Cp>我们的目的是获取网页中\u003Cstrong>所有的图片和prompts\u003C/strong>。为了达到以上目的，我们有两种思路：\u003C/p>\n\u003Col>\n\u003Cli>\u003Cstrong>拦截websocket消息\u003C/strong>，把里面关于的图片url的部分找出来并下载。\u003C/li>\n\u003Cli>既然dom结构那么规整，那就直接从dom入手，\u003Cstrong>解析下dom结构\u003C/strong>找出所有png格式的图片然后下载。\u003C/li>\n\u003C/ol>\n\u003Cp>显然，第二种成本更低一些。方案敲定，那就开始coding吧~\u003C/p>\n\u003Ch1 id=\"解析dom\">解析dom\u003C/h1>\n\u003Cp>我们先来写个简单的脚本把网页中AI生成的图片全都扒下来。符合要求的图片满足以下条件：\u003C/p>\n\u003Cul>\n\u003Cli>在ol标签下的li标签内；\u003C/li>\n\u003Cli>图片url在a标签的href属性内；\u003C/li>\n\u003Cli>\u003Cstrong>图片消息的发送方是Midjourney Bot\u003C/strong>\u003C/li>\n\u003C/ul>\n\u003Cp>第三点尤为重要，因为Midjourney可以图生图，所以你可能会看到有些老哥突然发了自己的自拍……\u003C/p>\n\u003Cp>至于Prompts，我们可以发现它是粗体，被&#x3C; strong >标签包裹。\u003C/p>\n\u003Cp>依据以上，我们可以写出一段非常简单的脚本：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 找到ol，它的class以scrollerInner-开头\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> contentList\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> document.\u003C/span>\u003Cspan style=\"color:#B392F0\">querySelector\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'ol[class^=\"scrollerInner-\"]'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 找到所有的li标签\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> lis\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Array.\u003C/span>\u003Cspan style=\"color:#B392F0\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(contentList.children).\u003C/span>\u003Cspan style=\"color:#B392F0\">filter\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    (\u003C/span>\u003Cspan style=\"color:#FFAB70\">item\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> item.tagName \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"LI\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">lis.\u003C/span>\u003Cspan style=\"color:#B392F0\">forEach\u003C/span>\u003Cspan style=\"color:#E1E4E8\">((\u003C/span>\u003Cspan style=\"color:#FFAB70\">li\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    parseLiNode\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(li);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> parseLiNode\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">li\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 截取一个唯一的id\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> id\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> li.id.\u003C/span>\u003Cspan style=\"color:#B392F0\">substring\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">14\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 粗体部分\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> prompts\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Array.\u003C/span>\u003Cspan style=\"color:#B392F0\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      li.\u003C/span>\u003Cspan style=\"color:#B392F0\">querySelector\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"div[id^=message-content-]>strong\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)?.childNodes \u003C/span>\u003Cspan style=\"color:#F97583\">??\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      .\u003C/span>\u003Cspan style=\"color:#B392F0\">filter\u003C/span>\u003Cspan style=\"color:#E1E4E8\">((\u003C/span>\u003Cspan style=\"color:#FFAB70\">node\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> node.nodeType \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Node.\u003C/span>\u003Cspan style=\"color:#79B8FF\">TEXT_NODE\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      .\u003C/span>\u003Cspan style=\"color:#B392F0\">map\u003C/span>\u003Cspan style=\"color:#E1E4E8\">((\u003C/span>\u003Cspan style=\"color:#FFAB70\">node\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> node.textContent)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      .\u003C/span>\u003Cspan style=\"color:#B392F0\">join\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\" \"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 取出a标签的href\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> url\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> li.\u003C/span>\u003Cspan style=\"color:#B392F0\">querySelector\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">      \"div[class^=messageAttachment] div[class^=imageWrapper] a[data-role=img]\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    )?.href;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(id, prompts, url);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>贴到控制台，就可以看到这段脚本已经把网页中所有的AI画作的url和prompts打印出来了：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/03/02/6XiGC.png\" alt=\"\">\u003C/p>\n\u003Cp>然而这还只是刚刚开始，这段脚本只能打印\u003Cstrong>当前出现在页面\u003C/strong>中的画作，对于后边新生成的可就无能为力了。为了让它不断的获取到最新生成的画作，我们还得做一些额外的操作。\u003C/p>\n\u003Ch1 id=\"mutationobserver\">MutationObserver\u003C/h1>\n\u003Cp>为了达成上一节结尾的目的，第一反应就是使用setInterval，隔段时间重新扫描下页面中的png图片。不过你可能猜到了我肯定没用它，要不然这一章的标题就该改名了。\u003C/p>\n\u003Cp>没用setInterval的原因相信大家也猜得到：用户生成AI画作的频率不稳定；如果setInternal频率高了，可能会造成浪费；如果频率低了，可能某个时间段内很多用户疯狂生成图片，我们可能会丢失某些图片的信息。\u003C/p>\n\u003Cp>因此，我们可以使用更精准的方式获取到dom结构的变动——\u003Cstrong>MutationObserver\u003C/strong>。\u003C/p>\n\u003Ch2 id=\"用法\">用法\u003C/h2>\n\u003Cp>先看看MDN上的介绍：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/03/02/6Blg8.png\" alt=\"\">\u003C/p>\n\u003Cp>一个MutationObserver对象只有三个方法，使用示例也相对简单 （下边是从mdn上抄的）：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"> // 选择需要观察变动的节点\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> targetNode\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> document.\u003C/span>\u003Cspan style=\"color:#B392F0\">getElementById\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'some-id'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 观察器的配置（需要观察什么变动）\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> config\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { attributes: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, childList: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, subtree: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 当观察到变动时执行的回调函数\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#B392F0\"> callback\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">mutationsList\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">observer\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // Use traditional 'for loops' for IE 11\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mutation \u003C/span>\u003Cspan style=\"color:#F97583\">of\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mutationsList) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (mutation.type \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'childList'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'A child node has been added or removed.'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#F97583\"> if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (mutation.type \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'attributes'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'The '\u003C/span>\u003Cspan style=\"color:#F97583\"> +\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mutation.attributeName \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ' attribute was modified.'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 创建一个观察器实例并传入回调函数\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> observer\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> new\u003C/span>\u003Cspan style=\"color:#B392F0\"> MutationObserver\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(callback);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 以上述配置开始观察目标节点\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">observer.\u003C/span>\u003Cspan style=\"color:#B392F0\">observe\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(targetNode, config);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 之后，可停止观察\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">observer.\u003C/span>\u003Cspan style=\"color:#B392F0\">disconnect\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>上边的示例程序翻译成人话就是：\u003C/p>\n\u003Cul>\n\u003Cli>新建一个MutationObserver对象\u003C/li>\n\u003Cli>它监测targetNode节点\u003C/li>\n\u003Cli>在config定义的监测内容发生变化时执行callback\u003C/li>\n\u003C/ul>\n\u003Cp>其中，config定义的监测内容表示：当target\u003Cstrong>及其子结点(subtree为true)\u003Cstrong>发生\u003C/strong>属性变化时(attribute为true)\u003C/strong>，或**其子结点发生新增/删除时(childList为true)**触发回调。\u003C/p>\n\u003Cp>有了这个东西，获取网页中新生成的图片就容易多了。\u003C/p>\n\u003Ch2 id=\"实战\">实战\u003C/h2>\n\u003Cp>前面分析过，discord聊天记录中最大条目是有限制的，因此我们会监测到li结点的新增或者删除。除此之外，因为照片可能会实时更新，因此也可以监测到li内class为imageWrapper的div会有属性变动。这两部分对应的图片可能有交集，因此可以用一个set去重。\u003C/p>\n\u003Cp>我们只需要获取到新增的li结点，然后找到class变动的div的祖先li结点，取并集之后就可以得到页面中新增的AI画作元素了。\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mutationObserver\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> MutationObserver\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">async\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> startObserve\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  mutationObserver \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> new\u003C/span>\u003Cspan style=\"color:#B392F0\"> MutationObserver\u003C/span>\u003Cspan style=\"color:#E1E4E8\">((\u003C/span>\u003Cspan style=\"color:#FFAB70\">records\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    records.\u003C/span>\u003Cspan style=\"color:#B392F0\">forEach\u003C/span>\u003Cspan style=\"color:#E1E4E8\">((\u003C/span>\u003Cspan style=\"color:#FFAB70\">record\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> addNodes\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> record.addedNodes;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        record.type \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"childList\"\u003C/span>\u003Cspan style=\"color:#F97583\"> &#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        addNodes?.\u003C/span>\u003Cspan style=\"color:#79B8FF\">length\u003C/span>\u003Cspan style=\"color:#F97583\"> &#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        (record.target \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#B392F0\"> Element\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).tagName \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"OL\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // ol标签的childlist变动，取出其中新增的li结点\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        addNodes.\u003C/span>\u003Cspan style=\"color:#B392F0\">forEach\u003C/span>\u003Cspan style=\"color:#E1E4E8\">((\u003C/span>\u003Cspan style=\"color:#FFAB70\">node\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">          const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> li\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> node \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#B392F0\"> HTMLElement\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">          if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            !\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(li.tagName \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"LI\"\u003C/span>\u003Cspan style=\"color:#F97583\"> &#x26;&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> li.id.\u003C/span>\u003Cspan style=\"color:#B392F0\">startsWith\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"chat-messages-\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">          parseLiNode\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(li); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 解析这个li结点\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      } \u003C/span>\u003Cspan style=\"color:#F97583\">else\u003C/span>\u003Cspan style=\"color:#F97583\"> if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        record.type \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"attributes\"\u003C/span>\u003Cspan style=\"color:#F97583\"> &#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        record.attributeName \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"class\"\u003C/span>\u003Cspan style=\"color:#F97583\"> &#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        (record.target \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#B392F0\"> Element\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).tagName \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"DIV\"\u003C/span>\u003Cspan style=\"color:#F97583\"> &#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        (record.target \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#B392F0\"> Element\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).className.\u003C/span>\u003Cspan style=\"color:#B392F0\">includes\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"imageWrapper\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // 属性变动的div\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> li\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> Element\u003C/span>\u003Cspan style=\"color:#F97583\"> |\u003C/span>\u003Cspan style=\"color:#79B8FF\"> null\u003C/span>\u003Cspan style=\"color:#F97583\"> |\u003C/span>\u003Cspan style=\"color:#79B8FF\"> undefined\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> record.target \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#B392F0\"> Element\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        while\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (li?.tagName \u003C/span>\u003Cspan style=\"color:#F97583\">!==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"LI\"\u003C/span>\u003Cspan style=\"color:#F97583\"> &#x26;&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> li) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          li \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> li.parentElement;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (li) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">          parseLiNode\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(li);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">  const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> contentList\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> document.\u003C/span>\u003Cspan style=\"color:#B392F0\">querySelector\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'ol[class^=\"scrollerInner-\"]'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">  if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">contentList) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  mutationObserver.\u003C/span>\u003Cspan style=\"color:#B392F0\">observe\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(contentList, {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    attributes: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    childList: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    subtree: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">startObserve\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>把这段程序拷到控制台（把类型信息删掉就好了，上边代码是ts），便可以持续不断地打印出新的画作信息了：\r\n\u003Cimg src=\"https://i.328888.xyz/2023/03/02/6XAMJ.png\" alt=\"\">\u003C/p>\n\u003Ch1 id=\"下载\">下载\u003C/h1>\n\u003Cp>获取AI画作的信息是搞定了，接下来就是如何下载了。一张一张下载肯定是不太行（要不然一小会文件夹内就会下载得满是png文件），直接用jszip打包下载一下，使用方式也很方便：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> JSZip \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"jszip\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> zip\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> new\u003C/span>\u003Cspan style=\"color:#B392F0\"> JSZip\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> binaryBlob\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> fetch\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"image-cdn-url\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).\u003C/span>\u003Cspan style=\"color:#B392F0\">then\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">_\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> _.\u003C/span>\u003Cspan style=\"color:#B392F0\">blob\u003C/span>\u003Cspan style=\"color:#E1E4E8\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 在压缩包内放一个名字是fileName.png的图片，图片是二进制blob\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">zip.\u003C/span>\u003Cspan style=\"color:#B392F0\">file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">`fileName.png`\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, binaryBlob, {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    binary: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">});\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 下边的zipContent就是生成的zip压缩包\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">zip.\u003C/span>\u003Cspan style=\"color:#B392F0\">generateAsync\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({ type: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"blob\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> }).\u003C/span>\u003Cspan style=\"color:#B392F0\">then\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">zipContent\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    saveFile\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(zipContent, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">`midjourney-${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">Date\u003C/span>\u003Cspan style=\"color:#9ECBFF\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">now\u003C/span>\u003Cspan style=\"color:#9ECBFF\">()\u003C/span>\u003Cspan style=\"color:#9ECBFF\">}.zip`\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#6A737D\">// saveFile的实现略过了~\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch1 id=\"结尾源代码在这里\">结尾（源代码在这里！）\u003C/h1>\n\u003Cp>最后就简单润色下，加上一些规则限制（比如说过滤掉四宫格的图片，只保存大图）、下载限制（每攒80张图下载一次，大概100+M）、用户名检查（有时候Discord机器人会批量发消息，这个时候用户名会被略过）等等，再用esbuild打到一个bundle里，就完成啦。\u003C/p>\n\u003Cp>28号那天挂了一整天，然后下班回来就收获了满满\u003Cstrong>2G\u003C/strong>（\u003Cstrong>两千多张\u003C/strong>）高清图片……\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/03/01/6mMdv.png\" alt=\"\">\u003C/p>\n\u003Ch2 id=\"代码开源-不要干坏事哟\">代码开源~ 不要干坏事哟：\u003C/h2>\n\u003Cp>使用方式在readme里啦。\r\n\u003Ca href=\"https://github.com/maotoumao/midjourney-downloader\">https://github.com/maotoumao/midjourney-downloader\u003C/a>\u003C/p>\n\u003Cp>如果你觉得好玩，不如点个star；如果你觉得有用，那你可以去公众号【一只猫头猫】留言“猫头猫真棒”，我也会夸夸你~\u003C/p>\n\u003Cp>下次整活的时候再见~\u003C/p>\n\u003Ch1 id=\"最最最后放些收集的美图\">最最最后放些收集的美图\u003C/h1>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/03/02/6XRdU.png\" alt=\"\">\r\n\u003Cimg src=\"https://i.328888.xyz/2023/03/02/6Xcqv.png\" alt=\"\">\r\n\u003Cimg src=\"https://i.328888.xyz/2023/03/02/6Xp23.png\" alt=\"\">\r\n\u003Cimg src=\"https://i.328888.xyz/2023/03/02/6XBEy.png\" alt=\"\">\u003C/p>",{"headings":642,"localImagePaths":665,"remoteImagePaths":666,"frontmatter":667,"imagePaths":669},[643,644,646,648,651,653,655,657,660,663],{"depth":283,"slug":27,"text":27},{"depth":283,"slug":645,"text":645},"我全都要",{"depth":283,"slug":647,"text":647},"解析dom",{"depth":283,"slug":649,"text":650},"mutationobserver","MutationObserver",{"depth":26,"slug":652,"text":652},"用法",{"depth":26,"slug":654,"text":654},"实战",{"depth":283,"slug":656,"text":656},"下载",{"depth":283,"slug":658,"text":659},"结尾源代码在这里","结尾（源代码在这里！）",{"depth":26,"slug":661,"text":662},"代码开源-不要干坏事哟","代码开源~ 不要干坏事哟：",{"depth":283,"slug":664,"text":664},"最最最后放些收集的美图",[],[],{"title":633,"pubDate":668,"category":33,"excerpt":635},["Date","2023-02-20T22:21:46.000Z"],[],"关于js闭包的一点小思考",{"id":670,"data":672,"body":675,"filePath":676,"digest":677,"rendered":678},{"title":670,"pubDate":673,"category":33,"excerpt":674},["Date","2019-04-22T15:27:45.000Z"],"试着理解了一下js的闭包，做一下记录。","今天试了几个例子，尝试理解了一下js闭包的用法，以及垃圾回收机制。尝试的代码放在下边，注释是我对执行结果的理解。\n\n---\n\n例1：\n\n```javascript\nfunction f1(){\n    var n=1;\n    let nAdd=function(){n+=1};\n    let log = function(){console.log(n)};\n\n　　function f2(){\n        console.log(n);\n　　}\n　　return f2;\n}\n\n// 在这个位置写nAdd()是会出错的，因为没有执行f1()，nAdd尚未定义\nf1(); //n=1\nnAdd(); // 由于nAdd是一个全局变量，它内部引用了n，所以上边的f1()不会立即销毁 n=2\nlog(); //n=2\nf1()(); //重新调用f1，调用时，重新执行，nAdd引用了一个新的n，此时上一个f1()对应的n被销毁\nnAdd(); //add引用的n被重置为1, n=2\nlog() //n=2\n```\n\n\n---\n例2：\n\n```javascript\nfunction f1(){\n    var n=1;\n    nAdd = function(){n+=1}\n    log = function(){console.log(n)}\n\n    function f2(){\n        console.log(n);\n    }\n\n    return f2;\n}\n\n// 在这个位置写nAdd()是会出错的，因为没有执行f1()，nAdd尚未定义\nvar a = f1(); //n=1\nnAdd(); // 由于a是一个全局变量，它内部引用了n，所以上边的f1()不会立即销毁 n=2\nlog(); //n=2\nvar b = f1(); //调用f1，b与a是两个变量，变量n位于它们内部，因此互不干扰。\nlog(); //add在定义b的时候被重新赋值，因此指向的n是b内的n，所以此时输出的应该是1\na();\nb(); //互不干扰，输出原本的值\n```\n---\n例3：\n\n问题描述：\n实现函数 makeClosures，调用之后满足如下条件：\n\t\t\t1、返回一个函数数组 result，长度与 arr 相同\n\t\t\t2、运行 result 中第 i 个函数，即result\\[i]()，结果与 fn(arr[i]) 相同。\n\n看到这个问题，我写出了如下代码：\n```javascript\n    result = [];\n    for(var i = 0; i \u003C arr.length; ++i){\n        result.push(function(){\n            // i在这个for循环内是始终存在的，因此如果直接返回fn(arr[i])会全输出NAN因为循环结束后，i=3\n            return (function(n){\n                return fn(arr[n])\n            })(i)\n        })\n    }\n\n    return result\n```\n显然，这个结果是错的。result内部push的函数中，仍然使用了外部发生变化的量i，因此最后的值是NAN（循环结束后i指向arr.length，因此arr[i]其实不存在。\n\n正确做法如下：\n```javascript\n    result = [];\n    for(var i =0; i \u003C arr.length; ++i){\n        // 把动态发生变化的量写在形参里\n        result.push(function(n){\n            return function(){\n                return fn(arr[n])\n            }\n        }(i))\n    }\n\n    return result;\n```\n此时result返回的函数内部没有用到任何发生变化的量（i），因此也就可以返回正确的结果。\n\n---\n\n返回闭包时，一定要想清楚闭包内的变量指向，不要在闭包内引用任何外部的会发生变化的量。慎用闭包，小心内存泄露。","src/content/posts/关于js闭包的一点小思考.md","9a1b253c9bf9a65d",{"html":679,"metadata":680},"\u003Cp>今天试了几个例子，尝试理解了一下js闭包的用法，以及垃圾回收机制。尝试的代码放在下边，注释是我对执行结果的理解。\u003C/p>\n\u003Chr>\n\u003Cp>例1：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> f1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> n\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    let\u003C/span>\u003Cspan style=\"color:#B392F0\"> nAdd\u003C/span>\u003Cspan style=\"color:#F97583\">=function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){n\u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    let\u003C/span>\u003Cspan style=\"color:#B392F0\"> log\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(n)};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">　　function\u003C/span>\u003Cspan style=\"color:#B392F0\"> f2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(n);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">　　}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">　　return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f2;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 在这个位置写nAdd()是会出错的，因为没有执行f1()，nAdd尚未定义\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">f1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(); \u003C/span>\u003Cspan style=\"color:#6A737D\">//n=1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">nAdd\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 由于nAdd是一个全局变量，它内部引用了n，所以上边的f1()不会立即销毁 n=2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(); \u003C/span>\u003Cspan style=\"color:#6A737D\">//n=2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">f1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()(); \u003C/span>\u003Cspan style=\"color:#6A737D\">//重新调用f1，调用时，重新执行，nAdd引用了一个新的n，此时上一个f1()对应的n被销毁\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">nAdd\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(); \u003C/span>\u003Cspan style=\"color:#6A737D\">//add引用的n被重置为1, n=2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() \u003C/span>\u003Cspan style=\"color:#6A737D\">//n=2\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Chr>\n\u003Cp>例2：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> f1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> n\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    nAdd\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){n\u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    log\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(n)}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    function\u003C/span>\u003Cspan style=\"color:#B392F0\"> f2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(n);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f2;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 在这个位置写nAdd()是会出错的，因为没有执行f1()，nAdd尚未定义\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> a \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> f1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(); \u003C/span>\u003Cspan style=\"color:#6A737D\">//n=1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">nAdd\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(); \u003C/span>\u003Cspan style=\"color:#6A737D\">// 由于a是一个全局变量，它内部引用了n，所以上边的f1()不会立即销毁 n=2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(); \u003C/span>\u003Cspan style=\"color:#6A737D\">//n=2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> b \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> f1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(); \u003C/span>\u003Cspan style=\"color:#6A737D\">//调用f1，b与a是两个变量，变量n位于它们内部，因此互不干扰。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(); \u003C/span>\u003Cspan style=\"color:#6A737D\">//add在定义b的时候被重新赋值，因此指向的n是b内的n，所以此时输出的应该是1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">a\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">b\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(); \u003C/span>\u003Cspan style=\"color:#6A737D\">//互不干扰，输出原本的值\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Chr>\n\u003Cp>例3：\u003C/p>\n\u003Cp>问题描述：\n实现函数 makeClosures，调用之后满足如下条件：\n1、返回一个函数数组 result，长度与 arr 相同\n2、运行 result 中第 i 个函数，即result[i]()，结果与 fn(arr[i]) 相同。\u003C/p>\n\u003Cp>看到这个问题，我写出了如下代码：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; i \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> arr.\u003C/span>\u003Cspan style=\"color:#79B8FF\">length\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; \u003C/span>\u003Cspan style=\"color:#F97583\">++\u003C/span>\u003Cspan style=\"color:#E1E4E8\">i){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        result.\u003C/span>\u003Cspan style=\"color:#B392F0\">push\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            // i在这个for循环内是始终存在的，因此如果直接返回fn(arr[i])会全输出NAN因为循环结束后，i=3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">n\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                return\u003C/span>\u003Cspan style=\"color:#B392F0\"> fn\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(arr[n])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            })(i)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>显然，这个结果是错的。result内部push的函数中，仍然使用了外部发生变化的量i，因此最后的值是NAN（循环结束后i指向arr.length，因此arr[i]其实不存在。\u003C/p>\n\u003Cp>正确做法如下：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; i \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> arr.\u003C/span>\u003Cspan style=\"color:#79B8FF\">length\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; \u003C/span>\u003Cspan style=\"color:#F97583\">++\u003C/span>\u003Cspan style=\"color:#E1E4E8\">i){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // 把动态发生变化的量写在形参里\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        result.\u003C/span>\u003Cspan style=\"color:#B392F0\">push\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">n\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                return\u003C/span>\u003Cspan style=\"color:#B392F0\"> fn\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(arr[n])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }(i))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>此时result返回的函数内部没有用到任何发生变化的量（i），因此也就可以返回正确的结果。\u003C/p>\n\u003Chr>\n\u003Cp>返回闭包时，一定要想清楚闭包内的变量指向，不要在闭包内引用任何外部的会发生变化的量。慎用闭包，小心内存泄露。\u003C/p>",{"headings":681,"localImagePaths":682,"remoteImagePaths":683,"frontmatter":684,"imagePaths":686},[],[],[],{"title":670,"pubDate":685,"category":33,"excerpt":674},["Date","2019-04-22T15:27:45.000Z"],[],"写一个全网最全的音乐播放器",{"id":687,"data":689,"body":692,"filePath":693,"digest":694,"rendered":695},{"title":687,"pubDate":690,"category":33,"excerpt":691},["Date","2022-10-04T12:42:01.000Z"],"如题。","![web 1920.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/112345c7ffef475685fffd086a2193d2~tplv-k3u1fbpfcp-watermark.image?)\r\n\r\n\r\n## 前言\r\n\r\n说起音乐播放器，其实目前已经有很多相关的轮子了。之前也看到了很多，无论是多源合一的*聚合类型播放器*，还是精美的*模仿播放器*，或多或少都有些小问题（众口难调嘛 也不奇怪）：\r\n\r\n-   **源不全**：音源可能不稳定，修改或新增源需要开发者修改代码（说不定还有律师函警告）\r\n-   **功能不全**：其实多源聚合的播放器还有蛮多优化空间的，比如怎么解决某些源没有歌词的问题等等\r\n-   **样式有点呆**：这个就……不多说了，虽然我写的也好看不到哪里去。。。\r\n\r\n所以...如标题，不如写一个**全网最全的，专注功能的，不太丑**的音乐播放器。写个播放器既可以巩固学过的知识，多多思考，又能解决的自己问题，还能打发时间，何乐而不为呢，当然，为了解决上述问题，架构还是要好好设计一下的。\r\n\r\n## 技术选型：React Native? Flutter?\r\n\r\n其实我21年就曾经用[flutter写过一个音乐播放器](https://github.com/maotoumao/mixin_music)。当时是想要一个功能简单，能满足日常需求（不用来回切app）的播放器，恰好那会快毕业闲着没事干，就花了几天学了下flutter现学现卖写了一个集成了B站、咪咕和网易云的播放器。App还是很流畅的，但是弊端也很明显：过了几个月当我想再捡起来继续维护的时候，我发现已经看不懂了。在此向这位同学说声抱歉，我真不是故意鸽的，因为我真tm忘了该怎么写了...： ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e73e6b87f82469ab75a155e89197727~tplv-k3u1fbpfcp-zoom-1.image)\r\n\r\n  所以这次我选择了RN。至少在熟悉的技术栈里，我可以更容易地专注于功能和性能。恰好这次想法冒出来的时候RN发布了0.69版本（好像是，懒得看了）；距离我上次使用RN也有了不少啸改动，不妨再试它一次。对于个人开发者来说，似乎也没必要讲究太多，能解决问题的就是好东西。\r\n\r\n## 框架：聚合？解耦?\r\n\r\n首先我们先回到需求，对我个人来说，我的核心诉求也很简单：\r\n\r\n-   **多源聚合**：不想来回切app听歌\r\n-   **扩展性、稳定性**：希望app的音源是可以低成本扩展的，甚至网络上只要可以搜得到的资源都可以播放\r\n-   **尽可能完备**：希望播放器可以对所有音源提供尽可能完整的，且相似的功能（否则扩展性似乎也就不存在了）\r\n\r\n听起来似乎很矛盾：又要尽可能多的源，又要可扩展，还不想写代码，净想好事了。事实上，破局的方法很简单：如果能把音乐相关的操作抽象出来，和app本身的功能解耦开，问题就迎刃而解了。说得再明白一点：对于一个音乐播放器来说，它所需要的核心功能：搜索（音乐、专辑、歌手）、播放、下载、歌词、导入、查看专辑歌手信息等等，这些功能对于不同的音源来说，输入和输出的**结构**是可以**完全一致**的。\r\n\r\n考虑到可扩展性，自然而然就想到把这些核心功能按照特定的协议以插件的形式外置，这样一来，音乐播放器只需要考虑到如何管理音乐媒体，某些时机触发某些核心行为得到固定格式的输出，而所有的核心行为都由插件去实现；如果需要扩展音源或者遇到音源不稳定的情况，也只需要修改插件就好了。换句话说：**只需要通过安装不同的插件就可以播放你能搜到的任何音源**。\r\n\r\n举个例子：当用户搜索“作者 猫头猫”的时候，对于播放器来说，它只需要知道要去调用这样一个函数: \r\n``` typescript\r\nfunction serach(query, type, page): Promise\u003CArtist[]>\r\n```\r\n并把得到的结果渲染到屏幕上；至于这个东西是什么，那就交给插件吧。\r\n\r\n综上所述，我们得到了大概的核心框架图： ![1.drawio.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/274ad02f59b548c8ade875db4128d038~tplv-k3u1fbpfcp-zoom-1.image)\r\n\r\n## 插件：怎么实现？\r\n\r\n在上一节中提到了，插件是实现某些特定功能的一个函数。那么接下来又是一个难题：怎么把插件钩入到app中去？回顾下技术选型，这次选择的是RN，那么这个问题其实很容易解决：反正运行时自带一个js引擎，那就直接读取外部文件，然后直接整个Function呗。试了一下，发现方案可行。具体来说，是这样一个[自执行函数](https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L63)：\r\n\r\n```\r\nconst plugin = Function(`\r\n                'use strict';\r\n                try {\r\n                  return ${funcCode};\r\n                } catch(e) {\r\n                  return null;\r\n                }\r\n    `)()()\r\n```\r\n\r\n其中，funcCode就是从外部读入的插件。方便起见，可以把一些常用的包（网络请求、加密解密、日期转化、html解析等等）通过参数传递给插件，从而减轻插件开发的工作量：\r\n\r\n```\r\nconst plugin = Function(`\r\n                'use strict';\r\n                try {\r\n                  return ${funcCode};\r\n                } catch(e) {\r\n                  return null;\r\n                }\r\n    `)()({CryptoJs, axios, dayjs, cheerio, bigInt, qs})\r\n```\r\n\r\n到这里，从app侧解析插件的工作就做完了。接下来的问题是：插件内部（也就是上边的funcCode）应该长什么样子。所以接下来我们就需要制定具体的**插件协议**了。根据上边的解析方式，插件的基本结构如下：\r\n\r\n```\r\nfunction pluginName(packages){\r\n    // 一些辅助函数或者全局变量\r\n\r\n    return {\r\n      // ... 插件要实现的核心功能\r\n    }\r\n}\r\n```\r\n\r\n插件函数的返回值，也就是我们可以具体在app中获取到的插件信息，可以在这一部分定义一层统一的**插件协议**，以定义某些核心操作所触发的行为。至于什么时候调用交给app统一控制。这里就不赘述协议定义的细节了，大概贴一下demo估计就够了，具体的插件可以参考[这个仓库](https://github.com/maotoumao/MusicFreePlugins)：\r\n\r\n```\r\n// packages里面预置了一些常用的包，包括axios，dayjs，cryptojs和cheerio，应该够用了\r\nfunction pluginName(packages){\r\n    // 在这里可以编写一些逻辑，存储全局变量之类的;\r\n    return {\r\n        platform: '插件名称', // [必选] 插件名，这个名字没取好，于是将错就错了\r\n        cacheControl: 'no-cache', // [可选] 插件的缓存控制方案，用来缓存插件信息\r\n        version: '0.0.0', // [可选] 插件版本号\r\n        primaryKey: ['id'], // [可选] 主键名，可在此字段中填写插件函数入参中必备的字段\r\n        appVersion: '>0.0', // [可选] 兼容此插件的app版本号，预防后续协议更新出现不兼容格式时报错的情况。\r\n        defaultSearchType: 'music', // [可选] 插件在搜索时，首屏默认请求的搜索类型。\r\n        /** 搜索 */\r\n        search: function(query, page, type) { // 三个参数分别为: 查询的keyword，当前页码，搜索类型\r\n            if(type === 'music') {\r\n                // 网络请求\r\n                return {\r\n                    isEnd: true, // 分页请求是否结束\r\n                    data: [], // MusicItem类型的列表\r\n                }\r\n            }\r\n            if(type === 'album') {\r\n                // 网络请求\r\n                return {\r\n                    isEnd: true, // 分页请求是否结束\r\n                    data: [], // AlbumItem类型的列表\r\n                }\r\n            }\r\n            if(type === 'artist') {\r\n                // 网络请求\r\n                return {\r\n                    isEnd: true, // 分页请求是否结束\r\n                    data: [], // ArtistItem类型的列表\r\n                }\r\n            }\r\n        },\r\n        /** 获取真实的播放源 */\r\n        getMediaSource: function (musicItem) { // 入参：搜索结果中MusicItem类型的音乐\r\n            return {\r\n                headers: undefined, // [可选] headers\r\n                url: 'https://', // 真实url,\r\n                userAgent: undefined, // [可选] 如果不填，会取headers的user-agent字段\r\n                \r\n            }\r\n        },\r\n        /** 根据mediaBase信息（包括primaryKey） 获取歌曲的详细信息 [!!此函数暂时用不到 ] */\r\n        getMusicInfo: function (mediaBase) {\r\n            return musicItem;\r\n        },\r\n        /** 获取歌词 */\r\n        getLyric: function (musicItem){\r\n\r\n            return {\r\n                lrc: 'http:///', //歌词源,\r\n                rawLrc: '[00:00.000]这是一句歌词', //纯文本的歌词\r\n            }\r\n        },\r\n        /** 获取专辑详细信息 */\r\n        getAlbumInfo: function (albumItem) {\r\n\r\n            return {\r\n                ...albumItem,\r\n                musicList: []\r\n            }\r\n        },\r\n        /** 查询作者的详细信息 */\r\n        getArtistWorks: function (artistItem, page, type) {\r\n            if(type === 'music') {\r\n                // 网络请求\r\n                return {\r\n                    isEnd: false,\r\n                    data: [], // MusicItem类型音乐列表\r\n                }\r\n            } \r\n            if(type === 'album') {\r\n                // 网络请求\r\n                return {\r\n                    isEnd: false,\r\n                    data: [], // AlbumItem类型音乐列表\r\n                }\r\n            }\r\n        },\r\n        /** 导入单曲 */\r\n        importMusicItem: function (urlLike) {\r\n            return musicItem;\r\n        },\r\n        /** 导入歌单 */\r\n        importMusicSheet: function (urlLike) {\r\n            const musicItems = [];\r\n            return musicItems;\r\n        }\r\n       /** more */\r\n    }\r\n}\r\n```\r\n\r\n由于涉及到缓存，并且其实我们并没有办法完全信任第三方插件的返回结果，因此在app中基于插件又封装了一层[PluginMethods](https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L132)，实际使用的时候调用的是这些方法。当需要开发新的功能（比如获取热门歌单...时），也只需要补充一下插件协议，然后开发对应的页面即可。插件机制在app中的完整实现可以参考[这里](https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L132)。\r\n\r\n最终的效果也确实符合预期（能搜到的都能播），甚至可以播放某K歌的音乐： ![IW58ZJ$40F`3~2SN7~)G43T.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f462be5be74a4f8abff34f047325c48a~tplv-k3u1fbpfcp-zoom-1.image)\r\n\r\n## 播放队列\r\n\r\n音乐的播放使用了[react-native-track-player](https://github.com/doublesymmetry/react-native-track-player)(以下简称rntp)。这是一个功能比较完善的播放器，提供了播放音乐、播放队列管理等功能。首先来看下它的[使用方式](https://react-native-track-player.js.org/docs/basics/getting-started/#adding-tracks-to-the-playback-queue)：\r\n\r\n```\r\nvar track1 = {\r\n    url: 'http://example.com/avaritia.mp3', // Load media from the network\r\n    title: 'Avaritia',\r\n    artist: 'deadmau5',\r\n    album: 'while(1\u003C2)',\r\n    genre: 'Progressive House, Electro House',\r\n    date: '2014-05-20T07:00:00+00:00', // RFC 3339\r\n    artwork: 'http://example.com/cover.png', // Load artwork from the network\r\n    duration: 402 // Duration in seconds\r\n};\r\nawait TrackPlayer.add([track1]);\r\n```\r\n\r\n其中url字段标记着媒体文件的播放源。这里就有了一个隐藏的问题：假如我们需要搜索某首歌（这里搜索一定是通过插件实现的）并点击播放；搜索结果中可能每一首音乐并不包含音频源的url，需要发起额外的网络请求，而这个时候如果我们为搜索结果的每一首歌都发起这样的请求，显然有些过分了。因此，获取某个音频的真实播放源的操作需要放在插件中，并且在播放前（点击播放、继续播放、播放结束切换到下一首）时执行。\r\n\r\nrntp内置的播放队列并不支持在播放前执行一个hook，同时按照文档中的描述，它也不支持在播放时替换正在播放的音频的url。因此在这里，我们需要用一点小小的黑魔法来解决问题——舍弃rntp内置的播放队列，基于它封装一个[符合我们需求的播放队列](https://github.com/maotoumao/MusicFree/blob/master/src/core/musicQueue.ts)。 \r\n\r\n新的播放队列中维护着当前正在播放的音乐列表。每当播放某个音乐(musicItem)的时候，我们都需要首先根据musicItem获取真实的源(调用对应插件的getMediaSource方法)，然后再把音乐信息和源信息一起送给rntp的队列中播放，至此，点击播放的问题就解决了。 \r\n\r\n然而除了点击播放之外，顺序播放依然存在问题：如果正常一首歌曲播放完成，rntp会自动播放其内部队列中的下一首歌，而不会走到封装的播放逻辑。rntp提供了一些事件，比如当歌曲切换时会触发PlaybackTrackChanged事件，播放队列结束时会触发PlaybackQueueEnded事件等等。我们可以让rntp中只存在一首歌，每当触发PlaybackQueueEnded事件时，我们就知道这首歌播放结束了，这个时候就需要自动的执行下一首歌的逻辑了。 \r\n\r\n事实上，在具体代码实现中，是使用了[PlaybackTrackChanged事件](https://github.com/maotoumao/MusicFree/blob/master/src/service/index.ts#L39)来监听播放结束的。这是因为rntp的安卓部分内部使用了exo player，在它的设计中，如果当前播放队列仅仅有一首歌，并且播放模式是顺序播放的话，那么在通知栏里面不会出现切换下一首歌的图标（向右的小箭头）。为此，具体实现中rntp的内部队列始终维护两首歌（当前正在播放，当前的下一首），track变化时便是播放结束的时机，此时执行我们封装好的skipNext函数即可：\r\n\r\n```\r\n TrackPlayer.addEventListener(Event.PlaybackTrackChanged, async evt => {\r\n        if (\r\n            evt.nextTrack === 1 &&\r\n            !(await TrackPlayer.getTrack(evt.nextTrack))?.url\r\n        ) {\r\n            if (MusicQueue.getRepeatMode() === 'SINGLE') {\r\n                await MusicQueue.play(undefined, true);\r\n            } else {\r\n                const queue = await TrackPlayer.getQueue();\r\n                // 要跳到的下一个就是当前的，并且队列里面有多首歌\r\n                if (\r\n                    isSameMediaItem(\r\n                        queue[1] as unknown as ICommon.IMediaBase,\r\n                        MusicQueue.getCurrentMusicItem(),\r\n                    ) &&\r\n                    MusicQueue.getMusicQueue().length > 1\r\n                ) {\r\n                    return;\r\n                }\r\n\r\n                await MusicQueue.skipToNext();\r\n            }\r\n        }\r\n    });\r\n```\r\n\r\n## 歌词关联\r\n\r\n上文中还提到，某些平台并不提供歌词（比如某些视频源）。对于这种情况，其实可以把不同源的歌词关联到一起。举个例子：我要播放B站源的歌曲，但是没有歌词。这个时候，我可以将其他源的歌词（尽管其他源可能没有版权，但是很多翻唱还是有歌词的）关联到这首歌：\r\n\r\n![Screenshot_20221004_173946_fun.upup.musicfree.jpg](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fd52606524ce48c49c299e2241b20e6c~tplv-k3u1fbpfcp-watermark.image?)\r\n\r\n这一部分的逻辑也是封装在[插件方法](https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L248)里的，简单来讲，这些关联的歌词形成了一个链表，关联歌词本质上就是一个链表的递归： ![2.drawio.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa291994f5e44f36bd14900ac3bfdc4a~tplv-k3u1fbpfcp-zoom-1.image) 每次都从链表末尾调用获取歌词的方法即可。需要注意的是，歌词关联可能会形成环路，当递归遇到环路时，需要识别并自动断开环。\r\n\r\n## 其他细节\r\n\r\n不得不说，要做一个完备的播放器要考虑到的东西还是挺多的，包括[歌词解析](https://github.com/maotoumao/MusicFree/blob/master/src/core/lrcParser.ts)、[状态持久化](https://github.com/maotoumao/MusicFree/blob/master/src/core/config.ts)、[下载队列](https://github.com/maotoumao/MusicFree/blob/master/src/core/download.ts)、[缓存](https://github.com/maotoumao/MusicFree/blob/master/src/core/cache.ts)等等，牵扯到不少的知识点（比如递归、LRU、react、native相关甚至js引擎层的知识等等），也踩了不少坑。如果有人想知道的话再写吧，这里就不赘述了（写累了不想写了...）。\r\n\r\n## 结语\r\n\r\n目前这个播放器还是测试版本（但是基本功能已经差不多，日常使用没问题了），插件协议可能还会有变动。代码基于GPL协议开源：\u003Chttps://github.com/maotoumao/MusicFree/> （打不开就github换gitee），下载地址在[github发布页](https://github.com/maotoumao/MusicFree/releases)，使用方式在readme（实在不知道咋用的话直接问我吧...）。之后打算好好维护，能解决自己和身边朋友的问题就已经达到最初的预期了。\r\n\r\n如果你觉得这个项目还不错，欢迎给个star~ 点个关注鼓励一下也行。也可以关注b站：[不想睡觉猫头猫](https://space.bilibili.com/12866223)或者公众号↓（刚整了个还没怎么发东西）；不发水文，平时会更多分享一些自己做的好玩的小东西，学以致用才更有动力。谢谢你看到这里，下次想起来更新的时候再见~\r\n\r\n![httpweixin.q.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62999875eeca415c9428adb6a678ad7a~tplv-k3u1fbpfcp-zoom-1.image)","src/content/posts/写一个全网最全的音乐播放器.md","587aa780480220bd",{"html":696,"metadata":697},"\u003Cp>\u003Cimg src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/112345c7ffef475685fffd086a2193d2~tplv-k3u1fbpfcp-watermark.image?\" alt=\"web 1920.png\">\u003C/p>\n\u003Ch2 id=\"前言\">前言\u003C/h2>\n\u003Cp>说起音乐播放器，其实目前已经有很多相关的轮子了。之前也看到了很多，无论是多源合一的\u003Cem>聚合类型播放器\u003C/em>，还是精美的\u003Cem>模仿播放器\u003C/em>，或多或少都有些小问题（众口难调嘛 也不奇怪）：\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>源不全\u003C/strong>：音源可能不稳定，修改或新增源需要开发者修改代码（说不定还有律师函警告）\u003C/li>\n\u003Cli>\u003Cstrong>功能不全\u003C/strong>：其实多源聚合的播放器还有蛮多优化空间的，比如怎么解决某些源没有歌词的问题等等\u003C/li>\n\u003Cli>\u003Cstrong>样式有点呆\u003C/strong>：这个就……不多说了，虽然我写的也好看不到哪里去。。。\u003C/li>\n\u003C/ul>\n\u003Cp>所以…如标题，不如写一个\u003Cstrong>全网最全的，专注功能的，不太丑\u003C/strong>的音乐播放器。写个播放器既可以巩固学过的知识，多多思考，又能解决的自己问题，还能打发时间，何乐而不为呢，当然，为了解决上述问题，架构还是要好好设计一下的。\u003C/p>\n\u003Ch2 id=\"技术选型react-native-flutter\">技术选型：React Native? Flutter?\u003C/h2>\n\u003Cp>其实我21年就曾经用\u003Ca href=\"https://github.com/maotoumao/mixin_music\">flutter写过一个音乐播放器\u003C/a>。当时是想要一个功能简单，能满足日常需求（不用来回切app）的播放器，恰好那会快毕业闲着没事干，就花了几天学了下flutter现学现卖写了一个集成了B站、咪咕和网易云的播放器。App还是很流畅的，但是弊端也很明显：过了几个月当我想再捡起来继续维护的时候，我发现已经看不懂了。在此向这位同学说声抱歉，我真不是故意鸽的，因为我真tm忘了该怎么写了…： \u003Cimg src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e73e6b87f82469ab75a155e89197727~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"image.png\">\u003C/p>\n\u003Cp>所以这次我选择了RN。至少在熟悉的技术栈里，我可以更容易地专注于功能和性能。恰好这次想法冒出来的时候RN发布了0.69版本（好像是，懒得看了）；距离我上次使用RN也有了不少啸改动，不妨再试它一次。对于个人开发者来说，似乎也没必要讲究太多，能解决问题的就是好东西。\u003C/p>\n\u003Ch2 id=\"框架聚合解耦\">框架：聚合？解耦?\u003C/h2>\n\u003Cp>首先我们先回到需求，对我个人来说，我的核心诉求也很简单：\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>多源聚合\u003C/strong>：不想来回切app听歌\u003C/li>\n\u003Cli>\u003Cstrong>扩展性、稳定性\u003C/strong>：希望app的音源是可以低成本扩展的，甚至网络上只要可以搜得到的资源都可以播放\u003C/li>\n\u003Cli>\u003Cstrong>尽可能完备\u003C/strong>：希望播放器可以对所有音源提供尽可能完整的，且相似的功能（否则扩展性似乎也就不存在了）\u003C/li>\n\u003C/ul>\n\u003Cp>听起来似乎很矛盾：又要尽可能多的源，又要可扩展，还不想写代码，净想好事了。事实上，破局的方法很简单：如果能把音乐相关的操作抽象出来，和app本身的功能解耦开，问题就迎刃而解了。说得再明白一点：对于一个音乐播放器来说，它所需要的核心功能：搜索（音乐、专辑、歌手）、播放、下载、歌词、导入、查看专辑歌手信息等等，这些功能对于不同的音源来说，输入和输出的\u003Cstrong>结构\u003C/strong>是可以\u003Cstrong>完全一致\u003C/strong>的。\u003C/p>\n\u003Cp>考虑到可扩展性，自然而然就想到把这些核心功能按照特定的协议以插件的形式外置，这样一来，音乐播放器只需要考虑到如何管理音乐媒体，某些时机触发某些核心行为得到固定格式的输出，而所有的核心行为都由插件去实现；如果需要扩展音源或者遇到音源不稳定的情况，也只需要修改插件就好了。换句话说：\u003Cstrong>只需要通过安装不同的插件就可以播放你能搜到的任何音源\u003C/strong>。\u003C/p>\n\u003Cp>举个例子：当用户搜索“作者 猫头猫”的时候，对于播放器来说，它只需要知道要去调用这样一个函数:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> serach\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">query\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">page\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> Promise\u003C/span>\u003Cspan style=\"color:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"color:#B392F0\">Artist\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[]>\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>并把得到的结果渲染到屏幕上；至于这个东西是什么，那就交给插件吧。\u003C/p>\n\u003Cp>综上所述，我们得到了大概的核心框架图： \u003Cimg src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/274ad02f59b548c8ade875db4128d038~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"1.drawio.png\">\u003C/p>\n\u003Ch2 id=\"插件怎么实现\">插件：怎么实现？\u003C/h2>\n\u003Cp>在上一节中提到了，插件是实现某些特定功能的一个函数。那么接下来又是一个难题：怎么把插件钩入到app中去？回顾下技术选型，这次选择的是RN，那么这个问题其实很容易解决：反正运行时自带一个js引擎，那就直接读取外部文件，然后直接整个Function呗。试了一下，发现方案可行。具体来说，是这样一个\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L63\">自执行函数\u003C/a>：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>const plugin = Function(`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                'use strict';\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                try {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                  return ${funcCode};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                } catch(e) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                  return null;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    `)()()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>其中，funcCode就是从外部读入的插件。方便起见，可以把一些常用的包（网络请求、加密解密、日期转化、html解析等等）通过参数传递给插件，从而减轻插件开发的工作量：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>const plugin = Function(`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                'use strict';\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                try {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                  return ${funcCode};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                } catch(e) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                  return null;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    `)()({CryptoJs, axios, dayjs, cheerio, bigInt, qs})\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>到这里，从app侧解析插件的工作就做完了。接下来的问题是：插件内部（也就是上边的funcCode）应该长什么样子。所以接下来我们就需要制定具体的\u003Cstrong>插件协议\u003C/strong>了。根据上边的解析方式，插件的基本结构如下：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>function pluginName(packages){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    // 一些辅助函数或者全局变量\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    return {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>      // ... 插件要实现的核心功能\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>插件函数的返回值，也就是我们可以具体在app中获取到的插件信息，可以在这一部分定义一层统一的\u003Cstrong>插件协议\u003C/strong>，以定义某些核心操作所触发的行为。至于什么时候调用交给app统一控制。这里就不赘述协议定义的细节了，大概贴一下demo估计就够了，具体的插件可以参考\u003Ca href=\"https://github.com/maotoumao/MusicFreePlugins\">这个仓库\u003C/a>：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>// packages里面预置了一些常用的包，包括axios，dayjs，cryptojs和cheerio，应该够用了\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>function pluginName(packages){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    // 在这里可以编写一些逻辑，存储全局变量之类的;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    return {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        platform: '插件名称', // [必选] 插件名，这个名字没取好，于是将错就错了\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        cacheControl: 'no-cache', // [可选] 插件的缓存控制方案，用来缓存插件信息\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        version: '0.0.0', // [可选] 插件版本号\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        primaryKey: ['id'], // [可选] 主键名，可在此字段中填写插件函数入参中必备的字段\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        appVersion: '>0.0', // [可选] 兼容此插件的app版本号，预防后续协议更新出现不兼容格式时报错的情况。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        defaultSearchType: 'music', // [可选] 插件在搜索时，首屏默认请求的搜索类型。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        /** 搜索 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        search: function(query, page, type) { // 三个参数分别为: 查询的keyword，当前页码，搜索类型\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            if(type === 'music') {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                // 网络请求\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                return {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    isEnd: true, // 分页请求是否结束\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    data: [], // MusicItem类型的列表\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            if(type === 'album') {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                // 网络请求\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                return {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    isEnd: true, // 分页请求是否结束\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    data: [], // AlbumItem类型的列表\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            if(type === 'artist') {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                // 网络请求\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                return {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    isEnd: true, // 分页请求是否结束\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    data: [], // ArtistItem类型的列表\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        /** 获取真实的播放源 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        getMediaSource: function (musicItem) { // 入参：搜索结果中MusicItem类型的音乐\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            return {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                headers: undefined, // [可选] headers\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                url: 'https://', // 真实url,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                userAgent: undefined, // [可选] 如果不填，会取headers的user-agent字段\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        /** 根据mediaBase信息（包括primaryKey） 获取歌曲的详细信息 [!!此函数暂时用不到 ] */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        getMusicInfo: function (mediaBase) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            return musicItem;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        /** 获取歌词 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        getLyric: function (musicItem){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            return {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                lrc: 'http:///', //歌词源,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                rawLrc: '[00:00.000]这是一句歌词', //纯文本的歌词\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        /** 获取专辑详细信息 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        getAlbumInfo: function (albumItem) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            return {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                ...albumItem,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                musicList: []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        /** 查询作者的详细信息 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        getArtistWorks: function (artistItem, page, type) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            if(type === 'music') {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                // 网络请求\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                return {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    isEnd: false,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    data: [], // MusicItem类型音乐列表\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            } \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            if(type === 'album') {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                // 网络请求\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                return {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    isEnd: false,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    data: [], // AlbumItem类型音乐列表\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        /** 导入单曲 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        importMusicItem: function (urlLike) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            return musicItem;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        /** 导入歌单 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        importMusicSheet: function (urlLike) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            const musicItems = [];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            return musicItems;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>       /** more */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>由于涉及到缓存，并且其实我们并没有办法完全信任第三方插件的返回结果，因此在app中基于插件又封装了一层\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L132\">PluginMethods\u003C/a>，实际使用的时候调用的是这些方法。当需要开发新的功能（比如获取热门歌单…时），也只需要补充一下插件协议，然后开发对应的页面即可。插件机制在app中的完整实现可以参考\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L132\">这里\u003C/a>。\u003C/p>\n\u003Cp>最终的效果也确实符合预期（能搜到的都能播），甚至可以播放某K歌的音乐： \u003Cimg src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f462be5be74a4f8abff34f047325c48a~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"IW58ZJ$40F&#x60;32SN7)G43T.png\">\u003C/p>\n\u003Ch2 id=\"播放队列\">播放队列\u003C/h2>\n\u003Cp>音乐的播放使用了\u003Ca href=\"https://github.com/doublesymmetry/react-native-track-player\">react-native-track-player\u003C/a>(以下简称rntp)。这是一个功能比较完善的播放器，提供了播放音乐、播放队列管理等功能。首先来看下它的\u003Ca href=\"https://react-native-track-player.js.org/docs/basics/getting-started/#adding-tracks-to-the-playback-queue\">使用方式\u003C/a>：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>var track1 = {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    url: 'http://example.com/avaritia.mp3', // Load media from the network\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    title: 'Avaritia',\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    artist: 'deadmau5',\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    album: 'while(1&#x3C;2)',\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    genre: 'Progressive House, Electro House',\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    date: '2014-05-20T07:00:00+00:00', // RFC 3339\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    artwork: 'http://example.com/cover.png', // Load artwork from the network\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    duration: 402 // Duration in seconds\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>await TrackPlayer.add([track1]);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>其中url字段标记着媒体文件的播放源。这里就有了一个隐藏的问题：假如我们需要搜索某首歌（这里搜索一定是通过插件实现的）并点击播放；搜索结果中可能每一首音乐并不包含音频源的url，需要发起额外的网络请求，而这个时候如果我们为搜索结果的每一首歌都发起这样的请求，显然有些过分了。因此，获取某个音频的真实播放源的操作需要放在插件中，并且在播放前（点击播放、继续播放、播放结束切换到下一首）时执行。\u003C/p>\n\u003Cp>rntp内置的播放队列并不支持在播放前执行一个hook，同时按照文档中的描述，它也不支持在播放时替换正在播放的音频的url。因此在这里，我们需要用一点小小的黑魔法来解决问题——舍弃rntp内置的播放队列，基于它封装一个\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/core/musicQueue.ts\">符合我们需求的播放队列\u003C/a>。\u003C/p>\n\u003Cp>新的播放队列中维护着当前正在播放的音乐列表。每当播放某个音乐(musicItem)的时候，我们都需要首先根据musicItem获取真实的源(调用对应插件的getMediaSource方法)，然后再把音乐信息和源信息一起送给rntp的队列中播放，至此，点击播放的问题就解决了。\u003C/p>\n\u003Cp>然而除了点击播放之外，顺序播放依然存在问题：如果正常一首歌曲播放完成，rntp会自动播放其内部队列中的下一首歌，而不会走到封装的播放逻辑。rntp提供了一些事件，比如当歌曲切换时会触发PlaybackTrackChanged事件，播放队列结束时会触发PlaybackQueueEnded事件等等。我们可以让rntp中只存在一首歌，每当触发PlaybackQueueEnded事件时，我们就知道这首歌播放结束了，这个时候就需要自动的执行下一首歌的逻辑了。\u003C/p>\n\u003Cp>事实上，在具体代码实现中，是使用了\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/service/index.ts#L39\">PlaybackTrackChanged事件\u003C/a>来监听播放结束的。这是因为rntp的安卓部分内部使用了exo player，在它的设计中，如果当前播放队列仅仅有一首歌，并且播放模式是顺序播放的话，那么在通知栏里面不会出现切换下一首歌的图标（向右的小箭头）。为此，具体实现中rntp的内部队列始终维护两首歌（当前正在播放，当前的下一首），track变化时便是播放结束的时机，此时执行我们封装好的skipNext函数即可：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan> TrackPlayer.addEventListener(Event.PlaybackTrackChanged, async evt => {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        if (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            evt.nextTrack === 1 &#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            !(await TrackPlayer.getTrack(evt.nextTrack))?.url\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            if (MusicQueue.getRepeatMode() === 'SINGLE') {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                await MusicQueue.play(undefined, true);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            } else {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                const queue = await TrackPlayer.getQueue();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                // 要跳到的下一个就是当前的，并且队列里面有多首歌\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                if (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    isSameMediaItem(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                        queue[1] as unknown as ICommon.IMediaBase,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                        MusicQueue.getCurrentMusicItem(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    ) &#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    MusicQueue.getMusicQueue().length > 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                    return;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                await MusicQueue.skipToNext();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    });\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"歌词关联\">歌词关联\u003C/h2>\n\u003Cp>上文中还提到，某些平台并不提供歌词（比如某些视频源）。对于这种情况，其实可以把不同源的歌词关联到一起。举个例子：我要播放B站源的歌曲，但是没有歌词。这个时候，我可以将其他源的歌词（尽管其他源可能没有版权，但是很多翻唱还是有歌词的）关联到这首歌：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fd52606524ce48c49c299e2241b20e6c~tplv-k3u1fbpfcp-watermark.image?\" alt=\"Screenshot_20221004_173946_fun.upup.musicfree.jpg\">\u003C/p>\n\u003Cp>这一部分的逻辑也是封装在\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/core/pluginManager.ts#L248\">插件方法\u003C/a>里的，简单来讲，这些关联的歌词形成了一个链表，关联歌词本质上就是一个链表的递归： \u003Cimg src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa291994f5e44f36bd14900ac3bfdc4a~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"2.drawio.png\"> 每次都从链表末尾调用获取歌词的方法即可。需要注意的是，歌词关联可能会形成环路，当递归遇到环路时，需要识别并自动断开环。\u003C/p>\n\u003Ch2 id=\"其他细节\">其他细节\u003C/h2>\n\u003Cp>不得不说，要做一个完备的播放器要考虑到的东西还是挺多的，包括\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/core/lrcParser.ts\">歌词解析\u003C/a>、\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/core/config.ts\">状态持久化\u003C/a>、\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/core/download.ts\">下载队列\u003C/a>、\u003Ca href=\"https://github.com/maotoumao/MusicFree/blob/master/src/core/cache.ts\">缓存\u003C/a>等等，牵扯到不少的知识点（比如递归、LRU、react、native相关甚至js引擎层的知识等等），也踩了不少坑。如果有人想知道的话再写吧，这里就不赘述了（写累了不想写了…）。\u003C/p>\n\u003Ch2 id=\"结语\">结语\u003C/h2>\n\u003Cp>目前这个播放器还是测试版本（但是基本功能已经差不多，日常使用没问题了），插件协议可能还会有变动。代码基于GPL协议开源：\u003Ca href=\"https://github.com/maotoumao/MusicFree/\">https://github.com/maotoumao/MusicFree/\u003C/a> （打不开就github换gitee），下载地址在\u003Ca href=\"https://github.com/maotoumao/MusicFree/releases\">github发布页\u003C/a>，使用方式在readme（实在不知道咋用的话直接问我吧…）。之后打算好好维护，能解决自己和身边朋友的问题就已经达到最初的预期了。\u003C/p>\n\u003Cp>如果你觉得这个项目还不错，欢迎给个star~ 点个关注鼓励一下也行。也可以关注b站：\u003Ca href=\"https://space.bilibili.com/12866223\">不想睡觉猫头猫\u003C/a>或者公众号↓（刚整了个还没怎么发东西）；不发水文，平时会更多分享一些自己做的好玩的小东西，学以致用才更有动力。谢谢你看到这里，下次想起来更新的时候再见~\u003C/p>\n\u003Cp>\u003Cimg src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62999875eeca415c9428adb6a678ad7a~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"httpweixin.q.png\">\u003C/p>",{"headings":698,"localImagePaths":717,"remoteImagePaths":718,"frontmatter":719,"imagePaths":721},[699,700,703,706,709,711,713,715],{"depth":26,"slug":27,"text":27},{"depth":26,"slug":701,"text":702},"技术选型react-native-flutter","技术选型：React Native? Flutter?",{"depth":26,"slug":704,"text":705},"框架聚合解耦","框架：聚合？解耦?",{"depth":26,"slug":707,"text":708},"插件怎么实现","插件：怎么实现？",{"depth":26,"slug":710,"text":710},"播放队列",{"depth":26,"slug":712,"text":712},"歌词关联",{"depth":26,"slug":714,"text":714},"其他细节",{"depth":26,"slug":716,"text":716},"结语",[],[],{"title":687,"pubDate":720,"category":33,"excerpt":691},["Date","2022-10-04T12:42:01.000Z"],[],"关于-proto-和prototype的思考",{"id":722,"data":724,"body":728,"filePath":729,"digest":730,"rendered":731},{"title":725,"pubDate":726,"category":33,"excerpt":727},"关于__proto__和prototype的思考",["Date","2019-07-30T16:20:06.000Z"],"学习__proto__和prototype的一个小记录。","### 需要明确的点\n- 对象具有属性__proto__，它指向其构造函数的原型属性(prototype)。\n- prototype只有函数才有，它指向一个对象，这个对象（也就是原型对象）包含了由这个函数所创建的实例的一些共有属性和函数。原型对象包含一个指向原函数的constructor属性。\n\n### 它们是什么？\njs中，除了六种简单数据类型外，其他所有的都是对象，包括我们熟悉的函数，数组等。假设我们有一个对象叫做a，无论a是数组还是函数，既然a是一个对象，那么它一定是由某个构造函数A来创建的。对于这个构造函数A来说，它有一些属于它自己的操作，除此之外，它还有一些公共的操作。而这些公共的操作被存放在构造函数A的prototype中。对于a来说，它的关于A本身的操作可以直接完成，但是关于那些公共属性和函数的操作，由于这些在prototype中，它如果想要使用，需要定义一个专门的变量来引用，这就是__proto__。   \n举个例子： \n``` javascript\n    var a = []; // 数组类型\n    a.__proto__ === Array.prototype; //true\n```\n> a是一个数组，它是由Array()构造函数来构建。为了访问在Array函数中定义的公共变量和函数，a的__proto__属性需要指向Array的prototype区域。\n\n那么我们就要问了，Array也是对象，那它的__proto__又指向哪里呢？  \n根据上面的分析，Array是一个对象，它是由Function创建的，因此，Array的__proto__指向创建这个函数对象的构造函数(也就是Function)的prototype：\n``` javascript\n    Array.__proto__ === Function.prototype; //true\n```\n就针对这个Array来看，它的__proto__指向构造这个对象的prototype，它的prototype定义了一些公有的方法，方便由它创建的对象进行访问。\n\n继续追根溯源。对于Function来说，它也是一个对象。比较特殊的是，一个Function是由一个Function创建的，换句话说，Function由Function构造，它的__proto__属性正是指向Function的prototype属性。\n``` javascript\n    Function.__proto__ === Function.prototype; //true\n```","src/content/posts/关于-proto-和prototype的思考.md","fd761ae5194381e9",{"html":732,"metadata":733},"\u003Ch3 id=\"需要明确的点\">需要明确的点\u003C/h3>\n\u003Cul>\n\u003Cli>对象具有属性__proto__，它指向其构造函数的原型属性(prototype)。\u003C/li>\n\u003Cli>prototype只有函数才有，它指向一个对象，这个对象（也就是原型对象）包含了由这个函数所创建的实例的一些共有属性和函数。原型对象包含一个指向原函数的constructor属性。\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"它们是什么\">它们是什么？\u003C/h3>\n\u003Cp>js中，除了六种简单数据类型外，其他所有的都是对象，包括我们熟悉的函数，数组等。假设我们有一个对象叫做a，无论a是数组还是函数，既然a是一个对象，那么它一定是由某个构造函数A来创建的。对于这个构造函数A来说，它有一些属于它自己的操作，除此之外，它还有一些公共的操作。而这些公共的操作被存放在构造函数A的prototype中。对于a来说，它的关于A本身的操作可以直接完成，但是关于那些公共属性和函数的操作，由于这些在prototype中，它如果想要使用，需要定义一个专门的变量来引用，这就是__proto__。\u003Cbr>\n举个例子：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    var\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> a \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []; \u003C/span>\u003Cspan style=\"color:#6A737D\">// 数组类型\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    a.\u003C/span>\u003Cspan style=\"color:#79B8FF\">__proto__\u003C/span>\u003Cspan style=\"color:#F97583\"> ===\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Array\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">prototype\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; \u003C/span>\u003Cspan style=\"color:#6A737D\">//true\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>a是一个数组，它是由Array()构造函数来构建。为了访问在Array函数中定义的公共变量和函数，a的__proto__属性需要指向Array的prototype区域。\u003C/p>\n\u003C/blockquote>\n\u003Cp>那么我们就要问了，Array也是对象，那它的__proto__又指向哪里呢？\u003Cbr>\n根据上面的分析，Array是一个对象，它是由Function创建的，因此，Array的__proto__指向创建这个函数对象的构造函数(也就是Function)的prototype：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    Array.\u003C/span>\u003Cspan style=\"color:#79B8FF\">__proto__\u003C/span>\u003Cspan style=\"color:#F97583\"> ===\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">prototype\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; \u003C/span>\u003Cspan style=\"color:#6A737D\">//true\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>就针对这个Array来看，它的__proto__指向构造这个对象的prototype，它的prototype定义了一些公有的方法，方便由它创建的对象进行访问。\u003C/p>\n\u003Cp>继续追根溯源。对于Function来说，它也是一个对象。比较特殊的是，一个Function是由一个Function创建的，换句话说，Function由Function构造，它的__proto__属性正是指向Function的prototype属性。\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    Function.\u003C/span>\u003Cspan style=\"color:#79B8FF\">__proto__\u003C/span>\u003Cspan style=\"color:#F97583\"> ===\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">prototype\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; \u003C/span>\u003Cspan style=\"color:#6A737D\">//true\u003C/span>\u003C/span>\u003C/code>\u003C/pre>",{"headings":734,"localImagePaths":740,"remoteImagePaths":741,"frontmatter":742,"imagePaths":744},[735,737],{"depth":81,"slug":736,"text":736},"需要明确的点",{"depth":81,"slug":738,"text":739},"它们是什么","它们是什么？",[],[],{"title":725,"pubDate":743,"category":33,"excerpt":727},["Date","2019-07-30T16:20:06.000Z"],[],"前端node高并发负载均衡策略-网易云课堂听课笔记",{"id":745,"data":747,"body":750,"filePath":751,"digest":752,"rendered":753},{"title":745,"pubDate":748,"category":33,"excerpt":749},["Date","2019-07-09T16:17:36.000Z"],"node负载均衡的听课笔记。","#### 并发与负载均衡\n一般来说，中高级前端可能会问到：有没有处理过高并发问题：访问量高，同时在线，同时访问。  \n负载均衡：把流量分摊到不同的机器上去用以平衡流量。\n\n高级前端还需要掌握redis..等，不直接对接数据库，通过redis缓存。\n\n---\n#### 系统扩展方向  \n例子： 双十一高峰期，并发量，系统流量不断扩大。  \n\n##### 垂直扩展  \n- 随着系统访问量增大，系统处理不了这么大的流量，那么可以通过提高系统部件的能力来实现。  \n比如：增加CPU，增加内存，更换网卡\n\n- 垂直扩展的缺点：\n由于摩尔定律，每一美元能买到的电脑性能随时间不断翻倍。单机扩展性能提高是有限的，并且==成本会不断的提高。==\n\n##### 水平扩展\n目前高并发高可用的系统架构中，最优的方案是==水平扩展==。  \n理论上，在系统能支持水平扩展的前提下，增加服务器数量，部署更多的系统集群，能够带来无限的系统提升。\n\n如何将网络请求分布给多个机器去处理？\n\n---\n#### 负载均衡-Nginx\nnginx：高性能的web服务器和反向代理服务，最常用的软件负载均衡器。\n\n核心概念： 用户请求先到nginx，再由nginx转发请求到后边的应用服务器(如node..)\n\n##### nginx配置\n```\nupstream xx{\n    least_conn; //优先连接最少连接数的连接\n    ip_hash; //优先连接ip地址最相近的\n    server 127.0.0.1:8080 weight=5; //weight表示权重，权重越大访问的几率越高\n    server 127.0.0.1:8081 weight=1;\n}\n// 如果同时写的话，优先使用最后写的规则。\nserver {\n    listen: 80;\n    server_name 127.0.0.1;\n    location /{\n        proxy_pass http://xx //转发请求\n    } // 可以达到不同请求路径请求不同端口的效果\n}\n```\n\n##### nginx调优\nNginx一般能做到十万并发，常用的调优手法：  \n- Nginx参数：  \n进程与CPU绑定worker_cpu_affinity、并发连接数、缓存区、超时时间、压缩、日志  \n- 操作系统的网络参数：  \n能打开的最大文件数、net.ipv4.tcp_keepalive_time、tcp缓冲区/proc/sys/net/ipv4/tcp_mem、rmem、wmem\n> 设置操作系统网络参数的原因：tcp请求先到达操作系统，然后转发到nginx。操作系统内有tcp缓存区，当网络连接过多的时候，显然多出来的溢出缓存的tcp连接就会造成阻塞。nginx可以支持10w并发，因此可以设置操作系统tcp缓冲区的大小，使得缓冲区可以存有更多的数据，减缓阻塞。\n- 为什么只能支持10w并发？  \nnginx通常用在http反向代理的场景，属于网络模型第7层应用层的协议。    \nhttp请求的处理包括解析和封装http内容，要处理更多请求，需要更多内存和cpu资源。  \n所以，nginx需要处理解析和封装http内容，因此nginx运行也受到系统性能的限制。（又回到了垂直扩展的问题）\n\n高配置硬件太贵，通常会组成**集群**来获取更高的处理能力。\n\n---\n#### Nginx集群\n单台Nginx处理能力在10w左右，也就是说它也是有限的，可以通过集群的方式，来获得更高的处理能力。那么谁来将请求分发给Nginx？\n\n##### LVS\nLinux Virtual Server，Linux虚拟服务器，是基于第四层，也就是传输层的软件负载解决方案。  \n- 核心理念：原本请求LVS服务器的数据包，被LVS软件篡改了数据包的目的地，将流量转移到Nginx所在的机器IP，从而实现负载均衡。\n- 为什么LVS比Nginx快？\n传输层所使用的协议比http简单，解析和组装消耗的CPU内存等资源比Nginx低。\n\n---\n#### 如何支持更多的访问？\n硬件设备，例如F5。\n专门的硬件设备。一台F5连接着很多LVS服务器，一个LVS服务器又连接着很多Nginx服务器。\n\n---\n最终的技术：DNS-无限水平扩展  \n一个域名可以对应多个ip。\n\n---\n#### 总结\n- 技术随业务发展而变化\n- 技术选型上，不仅要考虑技术本身，还需要考虑团队能力\n- 行业变化快，需要不断学习技术拓宽视野","src/content/posts/前端node高并发负载均衡策略-网易云课堂听课笔记.md","23c639307930d937",{"html":754,"metadata":755},"\u003Ch4 id=\"并发与负载均衡\">并发与负载均衡\u003C/h4>\n\u003Cp>一般来说，中高级前端可能会问到：有没有处理过高并发问题：访问量高，同时在线，同时访问。\u003Cbr>\n负载均衡：把流量分摊到不同的机器上去用以平衡流量。\u003C/p>\n\u003Cp>高级前端还需要掌握redis..等，不直接对接数据库，通过redis缓存。\u003C/p>\n\u003Chr>\n\u003Ch4 id=\"系统扩展方向\">系统扩展方向\u003C/h4>\n\u003Cp>例子： 双十一高峰期，并发量，系统流量不断扩大。\u003C/p>\n\u003Ch5 id=\"垂直扩展\">垂直扩展\u003C/h5>\n\u003Cul>\n\u003Cli>\n\u003Cp>随着系统访问量增大，系统处理不了这么大的流量，那么可以通过提高系统部件的能力来实现。\u003Cbr>\n比如：增加CPU，增加内存，更换网卡\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>垂直扩展的缺点：\n由于摩尔定律，每一美元能买到的电脑性能随时间不断翻倍。单机扩展性能提高是有限的，并且==成本会不断的提高。==\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Ch5 id=\"水平扩展\">水平扩展\u003C/h5>\n\u003Cp>目前高并发高可用的系统架构中，最优的方案是==水平扩展==。\u003Cbr>\n理论上，在系统能支持水平扩展的前提下，增加服务器数量，部署更多的系统集群，能够带来无限的系统提升。\u003C/p>\n\u003Cp>如何将网络请求分布给多个机器去处理？\u003C/p>\n\u003Chr>\n\u003Ch4 id=\"负载均衡-nginx\">负载均衡-Nginx\u003C/h4>\n\u003Cp>nginx：高性能的web服务器和反向代理服务，最常用的软件负载均衡器。\u003C/p>\n\u003Cp>核心概念： 用户请求先到nginx，再由nginx转发请求到后边的应用服务器(如node..)\u003C/p>\n\u003Ch5 id=\"nginx配置\">nginx配置\u003C/h5>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>upstream xx{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    least_conn; //优先连接最少连接数的连接\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    ip_hash; //优先连接ip地址最相近的\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    server 127.0.0.1:8080 weight=5; //weight表示权重，权重越大访问的几率越高\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    server 127.0.0.1:8081 weight=1;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>// 如果同时写的话，优先使用最后写的规则。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>server {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    listen: 80;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    server_name 127.0.0.1;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    location /{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>        proxy_pass http://xx //转发请求\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    } // 可以达到不同请求路径请求不同端口的效果\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch5 id=\"nginx调优\">nginx调优\u003C/h5>\n\u003Cp>Nginx一般能做到十万并发，常用的调优手法：\u003C/p>\n\u003Cul>\n\u003Cli>Nginx参数：\u003Cbr>\n进程与CPU绑定worker_cpu_affinity、并发连接数、缓存区、超时时间、压缩、日志\u003C/li>\n\u003Cli>操作系统的网络参数：\u003Cbr>\n能打开的最大文件数、net.ipv4.tcp_keepalive_time、tcp缓冲区/proc/sys/net/ipv4/tcp_mem、rmem、wmem\u003C/li>\n\u003C/ul>\n\u003Cblockquote>\n\u003Cp>设置操作系统网络参数的原因：tcp请求先到达操作系统，然后转发到nginx。操作系统内有tcp缓存区，当网络连接过多的时候，显然多出来的溢出缓存的tcp连接就会造成阻塞。nginx可以支持10w并发，因此可以设置操作系统tcp缓冲区的大小，使得缓冲区可以存有更多的数据，减缓阻塞。\u003C/p>\n\u003C/blockquote>\n\u003Cul>\n\u003Cli>为什么只能支持10w并发？\u003Cbr>\nnginx通常用在http反向代理的场景，属于网络模型第7层应用层的协议。\u003Cbr>\nhttp请求的处理包括解析和封装http内容，要处理更多请求，需要更多内存和cpu资源。\u003Cbr>\n所以，nginx需要处理解析和封装http内容，因此nginx运行也受到系统性能的限制。（又回到了垂直扩展的问题）\u003C/li>\n\u003C/ul>\n\u003Cp>高配置硬件太贵，通常会组成\u003Cstrong>集群\u003C/strong>来获取更高的处理能力。\u003C/p>\n\u003Chr>\n\u003Ch4 id=\"nginx集群\">Nginx集群\u003C/h4>\n\u003Cp>单台Nginx处理能力在10w左右，也就是说它也是有限的，可以通过集群的方式，来获得更高的处理能力。那么谁来将请求分发给Nginx？\u003C/p>\n\u003Ch5 id=\"lvs\">LVS\u003C/h5>\n\u003Cp>Linux Virtual Server，Linux虚拟服务器，是基于第四层，也就是传输层的软件负载解决方案。\u003C/p>\n\u003Cul>\n\u003Cli>核心理念：原本请求LVS服务器的数据包，被LVS软件篡改了数据包的目的地，将流量转移到Nginx所在的机器IP，从而实现负载均衡。\u003C/li>\n\u003Cli>为什么LVS比Nginx快？\n传输层所使用的协议比http简单，解析和组装消耗的CPU内存等资源比Nginx低。\u003C/li>\n\u003C/ul>\n\u003Chr>\n\u003Ch4 id=\"如何支持更多的访问\">如何支持更多的访问？\u003C/h4>\n\u003Cp>硬件设备，例如F5。\n专门的硬件设备。一台F5连接着很多LVS服务器，一个LVS服务器又连接着很多Nginx服务器。\u003C/p>\n\u003Chr>\n\u003Cp>最终的技术：DNS-无限水平扩展\u003Cbr>\n一个域名可以对应多个ip。\u003C/p>\n\u003Chr>\n\u003Ch4 id=\"总结\">总结\u003C/h4>\n\u003Cul>\n\u003Cli>技术随业务发展而变化\u003C/li>\n\u003Cli>技术选型上，不仅要考虑技术本身，还需要考虑团队能力\u003C/li>\n\u003Cli>行业变化快，需要不断学习技术拓宽视野\u003C/li>\n\u003C/ul>",{"headings":756,"localImagePaths":782,"remoteImagePaths":783,"frontmatter":784,"imagePaths":786},[757,759,761,763,765,768,770,772,775,778,781],{"depth":57,"slug":758,"text":758},"并发与负载均衡",{"depth":57,"slug":760,"text":760},"系统扩展方向",{"depth":175,"slug":762,"text":762},"垂直扩展",{"depth":175,"slug":764,"text":764},"水平扩展",{"depth":57,"slug":766,"text":767},"负载均衡-nginx","负载均衡-Nginx",{"depth":175,"slug":769,"text":769},"nginx配置",{"depth":175,"slug":771,"text":771},"nginx调优",{"depth":57,"slug":773,"text":774},"nginx集群","Nginx集群",{"depth":175,"slug":776,"text":777},"lvs","LVS",{"depth":57,"slug":779,"text":780},"如何支持更多的访问","如何支持更多的访问？",{"depth":57,"slug":262,"text":262},[],[],{"title":745,"pubDate":785,"category":33,"excerpt":749},["Date","2019-07-09T16:17:36.000Z"],[],"在docker环境下部署webide",{"id":787,"data":789,"body":793,"filePath":794,"digest":795,"rendered":796},{"title":790,"pubDate":791,"category":273,"excerpt":792},"在docker环境下部署webIDE",["Date","2021-07-23T23:33:05.000Z"],"在docker环境中部署WebIDE","## 前言\n买了个matepad11，顺带买了个键盘和鼠标。然后就想在平板上写代码。但是用平板肯定写不了啊，但是我有公网的服务器，所以想要不要用服务器运行一个webIDE，可以编写代码，同时服务器上也有nodejs环境，写个react什么的妥妥的吧。\n\n在服务器上跑通了code-server之后，发现一个致命的问题：code-server可以访问服务器上任意一个文件，这就导致我的服务器上的数据一览无余。。同时，服务器的性能也不能保证。\n\n因此，采用了docker部署在笔记本上，再通过frp进行内网穿透的方案。\n\n## docker\ndocker是一个linux平台的沙箱系统，可以将linux平台的代码打包进docker，做成一个image，这些镜像在任意系统中的表现便都是一致的，同时它也会限制访问者只能在沙箱范围内访问，保证了安全性。\n\n## 步骤\n1. 安装docker windows(官网)\n2. 在docker hub上，使用docker pull安装code-server镜像\n3. 设置端口映射，启动docker，默认用户是coder，超级用户无密码。\n\n---\n## 后记\n草，费了半天劲，还不如直接在电脑上装一个华为电脑管家，直接连电脑，还能把平板当扩展屏，比webIDE可香多了，浪费我时间，气得我截图都不想放了。","src/content/posts/在docker环境下部署webIDE.md","64f36452abd5bebd",{"html":797,"metadata":798},"\u003Ch2 id=\"前言\">前言\u003C/h2>\n\u003Cp>买了个matepad11，顺带买了个键盘和鼠标。然后就想在平板上写代码。但是用平板肯定写不了啊，但是我有公网的服务器，所以想要不要用服务器运行一个webIDE，可以编写代码，同时服务器上也有nodejs环境，写个react什么的妥妥的吧。\u003C/p>\n\u003Cp>在服务器上跑通了code-server之后，发现一个致命的问题：code-server可以访问服务器上任意一个文件，这就导致我的服务器上的数据一览无余。。同时，服务器的性能也不能保证。\u003C/p>\n\u003Cp>因此，采用了docker部署在笔记本上，再通过frp进行内网穿透的方案。\u003C/p>\n\u003Ch2 id=\"docker\">docker\u003C/h2>\n\u003Cp>docker是一个linux平台的沙箱系统，可以将linux平台的代码打包进docker，做成一个image，这些镜像在任意系统中的表现便都是一致的，同时它也会限制访问者只能在沙箱范围内访问，保证了安全性。\u003C/p>\n\u003Ch2 id=\"步骤\">步骤\u003C/h2>\n\u003Col>\n\u003Cli>安装docker windows(官网)\u003C/li>\n\u003Cli>在docker hub上，使用docker pull安装code-server镜像\u003C/li>\n\u003Cli>设置端口映射，启动docker，默认用户是coder，超级用户无密码。\u003C/li>\n\u003C/ol>\n\u003Chr>\n\u003Ch2 id=\"后记\">后记\u003C/h2>\n\u003Cp>草，费了半天劲，还不如直接在电脑上装一个华为电脑管家，直接连电脑，还能把平板当扩展屏，比webIDE可香多了，浪费我时间，气得我截图都不想放了。\u003C/p>",{"headings":799,"localImagePaths":807,"remoteImagePaths":808,"frontmatter":809,"imagePaths":811},[800,801,803,805],{"depth":26,"slug":27,"text":27},{"depth":26,"slug":802,"text":802},"docker",{"depth":26,"slug":804,"text":804},"步骤",{"depth":26,"slug":806,"text":806},"后记",[],[],{"title":790,"pubDate":810,"category":273,"excerpt":792},["Date","2021-07-23T23:33:05.000Z"],[],"开发musicfree插件",{"id":812,"data":814,"body":818,"filePath":819,"digest":820,"rendered":821},{"title":815,"pubDate":816,"category":33,"excerpt":817},"开发MusicFree插件",["Date","2022-09-15T22:34:45.000Z"],"前阵子开发了个听音乐的软件Music Free，这里简单记录一下给软件开发插件的步骤。","# MusicFree插件是什么\r\nMusicFree是一个插件化的音乐播放器。它本身不包含任何音乐源，所有的功能都是通过插件的形式导入的。插件本质上是一个javascript函数，通过实现符合插件协议的javascript函数，即可完成特定音源的播放，这也就意味着只要能搜得到的音乐，那么就都可以播放。\r\n\r\n# 插件的标准协议\r\n一个MusicFree插件的结构如下:\r\n\r\n``` javascript\r\n    // packages里面预置了一些常用的包，包括axios，dayjs，cryptojs和cheerio，应该够用了\r\n    function pluginName(packages){\r\n        // 在这里可以编写一些逻辑，存储全局变量之类的;\r\n        return {\r\n            platform: '插件名称', // [必选] 插件名，这个名字没取好，于是将错就错了\r\n            cacheControl: 'no-cache', // [可选] 插件的缓存控制方案，用来缓存插件信息\r\n            version: '0.0.0', // [可选] 插件版本号\r\n            primaryKey: ['id'], // [可选] 主键名，可在此字段中填写插件函数入参中必备的字段\r\n            appVersion: '>0.0', // [可选] 兼容此插件的app版本号，预防后续协议更新出现不兼容格式时报错的情况。\r\n            defaultSearchType: 'music', // [可选] 插件在搜索时，首屏默认请求的搜索类型。\r\n            /** 搜索 */\r\n            search: function(query, page, type) { // 三个参数分别为: 查询的keyword，当前页码，搜索类型\r\n                if(type === 'music') {\r\n                    // 网络请求\r\n                    return {\r\n                        isEnd: true, // 分页请求是否结束\r\n                        data: [], // MusicItem类型的列表\r\n                    }\r\n                }\r\n                if(type === 'album') {\r\n                    // 网络请求\r\n                    return {\r\n                        isEnd: true, // 分页请求是否结束\r\n                        data: [], // AlbumItem类型的列表\r\n                    }\r\n                }\r\n                if(type === 'artist') {\r\n                    // 网络请求\r\n                    return {\r\n                        isEnd: true, // 分页请求是否结束\r\n                        data: [], // ArtistItem类型的列表\r\n                    }\r\n                }\r\n            },\r\n            /** 获取真实的播放源 */\r\n            getMediaSource: function (musicItem) { // 入参：搜索结果中MusicItem类型的音乐\r\n                return {\r\n                    headers: undefined, // [可选] headers\r\n                    url: 'https://', // 真实url,\r\n                    userAgent: undefined, // [可选] 如果不填，会取headers的user-agent字段\r\n                    \r\n                }\r\n            },\r\n            /** 根据mediaBase信息（包括primaryKey） 获取歌曲的详细信息 [!!此函数暂时用不到 ] */\r\n            getMusicInfo: function (mediaBase) {\r\n                return musicItem;\r\n            },\r\n            /** 获取歌词 */\r\n            getLyric: function (musicItem){\r\n\r\n                return {\r\n                    lrc: 'http:///', //歌词源,\r\n                    rawLrc: '[00:00.000]这是一句歌词', //纯文本的歌词\r\n                }\r\n            },\r\n            /** 获取专辑详细信息 */\r\n            getAlbumInfo: function (albumItem) {\r\n\r\n                return {\r\n                    ...albumItem,\r\n                    musicList: []\r\n                }\r\n            },\r\n            /** 查询作者的详细信息 */\r\n            queryArtistWorks: function (artistItem, page, type) {\r\n                if(type === 'music') {\r\n                    // 网络请求\r\n                    return {\r\n                        isEnd: false,\r\n                        data: [], // MusicItem类型音乐列表\r\n                    }\r\n                } \r\n                if(type === 'album') {\r\n                    // 网络请求\r\n                    return {\r\n                        isEnd: false,\r\n                        data: [], // AlbumItem类型音乐列表\r\n                    }\r\n                }\r\n            },\r\n            /** 导入单曲 */\r\n            importMusicItem: function (urlLike) {\r\n                return musicItem;\r\n            },\r\n            /** 导入歌单 */\r\n            importMusicSheet: function (urlLike) {\r\n                const musicItems = [];\r\n                return musicItems;\r\n            }\r\n\r\n\r\n\r\n        }\r\n    }\r\n```\r\n目前插件中的所有常量/函数如上，只有platform是必选参数，其他均为可选。\r\n\r\n插件中定义了四种基本的媒体类型，分别是:\r\n\r\n- 基础媒体类型：platform和id标识着唯一的一个媒体\r\n``` typescript \r\n    type IMediaBase = {\r\n        id: string;\r\n        platform: string;\r\n        $?: any; // 内部变量，不要给它赋值，会被覆盖\r\n        [k: symbol]: any;\r\n        [k: string]: any;\r\n    };\r\n```\r\n\r\n- 音乐类型\r\n``` typescript\r\n    interface IMusicItemBase extends ICommon.IMediaBase {\r\n        /** 其他属性 */\r\n        [k: keyof IMusicItem]: IMusicItem[k];\r\n    }\r\n    interface IMusicItem {\r\n        /** 歌曲在平台的唯一编号 */\r\n        id: string;\r\n        /** 平台 */\r\n        platform: string;\r\n        /** 作者 */\r\n        artist: string;\r\n        /** 标题 */\r\n        title: string;\r\n        /** 时长(s) */\r\n        duration: number;\r\n        /** 专辑名 */\r\n        album: string;\r\n        /** 专辑封面图 */\r\n        artwork: string;\r\n        /** 音源 */\r\n        url?: string;\r\n        /** 歌词URL */\r\n        lrc?: string;\r\n        /** 歌词 */\r\n        rawLrc?: string;\r\n        /** 其他可以被序列化的信息 */\r\n        [k: string]: any;\r\n        /** 内部信息 */\r\n        [k: symbol]: any;\r\n    }\r\n```\r\n\r\n- 作者类型\r\n``` typescript\r\n    interface IArtistItemBase extends ICommon.IMediaBase {\r\n        name: string;\r\n        id: string;\r\n        fans?: number;\r\n        description?: string;\r\n        platform: string;\r\n        avatar: string;\r\n        worksNum: number;\r\n    }\r\n\r\n    interface IArtistItem extends IArtistItemBase {\r\n        musicList: IMusic.IMusicItemBase;\r\n        albumList: IAlbum.IAlbumItemBase;\r\n        [k: string]: any;\r\n    }\r\n```\r\n\r\n- 专辑类型\r\n``` typescript\r\n    interface IAlbumItemBase extends ICommon.IMediaBase {\r\n        artwork: string;\r\n        title: string;\r\n        date: string;\r\n        artist: string;\r\n        description?: string;\r\n    }\r\n    interface IAlbumItem extends IAlbumItemBase {\r\n        musicList: IMusic.IMusicItem[];\r\n    }\r\n```\r\n\r\n通过编写以上简单的脚本，并通过musicfree的插件导入，就可以使用插件完成对应的音乐行为了。","src/content/posts/开发MusicFree插件.md","91958d096ae1a1b1",{"html":822,"metadata":823},"\u003Ch1 id=\"musicfree插件是什么\">MusicFree插件是什么\u003C/h1>\n\u003Cp>MusicFree是一个插件化的音乐播放器。它本身不包含任何音乐源，所有的功能都是通过插件的形式导入的。插件本质上是一个javascript函数，通过实现符合插件协议的javascript函数，即可完成特定音源的播放，这也就意味着只要能搜得到的音乐，那么就都可以播放。\u003C/p>\n\u003Ch1 id=\"插件的标准协议\">插件的标准协议\u003C/h1>\n\u003Cp>一个MusicFree插件的结构如下:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // packages里面预置了一些常用的包，包括axios，dayjs，cryptojs和cheerio，应该够用了\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    function\u003C/span>\u003Cspan style=\"color:#B392F0\"> pluginName\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">packages\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // 在这里可以编写一些逻辑，存储全局变量之类的;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            platform: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'插件名称'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// [必选] 插件名，这个名字没取好，于是将错就错了\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            cacheControl: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'no-cache'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// [可选] 插件的缓存控制方案，用来缓存插件信息\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            version: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'0.0.0'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// [可选] 插件版本号\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            primaryKey: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'id'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], \u003C/span>\u003Cspan style=\"color:#6A737D\">// [可选] 主键名，可在此字段中填写插件函数入参中必备的字段\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            appVersion: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'>0.0'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// [可选] 兼容此插件的app版本号，预防后续协议更新出现不兼容格式时报错的情况。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            defaultSearchType: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'music'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// [可选] 插件在搜索时，首屏默认请求的搜索类型。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            /** 搜索 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">            search\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">query\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">page\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) { \u003C/span>\u003Cspan style=\"color:#6A737D\">// 三个参数分别为: 查询的keyword，当前页码，搜索类型\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(type \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'music'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    // 网络请求\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        isEnd: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// 分页请求是否结束\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        data: [], \u003C/span>\u003Cspan style=\"color:#6A737D\">// MusicItem类型的列表\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(type \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'album'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    // 网络请求\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        isEnd: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// 分页请求是否结束\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        data: [], \u003C/span>\u003Cspan style=\"color:#6A737D\">// AlbumItem类型的列表\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(type \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'artist'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    // 网络请求\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        isEnd: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// 分页请求是否结束\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        data: [], \u003C/span>\u003Cspan style=\"color:#6A737D\">// ArtistItem类型的列表\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            /** 获取真实的播放源 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">            getMediaSource\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">musicItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) { \u003C/span>\u003Cspan style=\"color:#6A737D\">// 入参：搜索结果中MusicItem类型的音乐\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    headers: \u003C/span>\u003Cspan style=\"color:#79B8FF\">undefined\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// [可选] headers\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    url: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'https://'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// 真实url,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    userAgent: \u003C/span>\u003Cspan style=\"color:#79B8FF\">undefined\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// [可选] 如果不填，会取headers的user-agent字段\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            /** 根据mediaBase信息（包括primaryKey） 获取歌曲的详细信息 [!!此函数暂时用不到 ] */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">            getMusicInfo\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">mediaBase\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> musicItem;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            /** 获取歌词 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">            getLyric\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">musicItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    lrc: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'http:///'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">//歌词源,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    rawLrc: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'[00:00.000]这是一句歌词'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">//纯文本的歌词\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            /** 获取专辑详细信息 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">            getAlbumInfo\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">albumItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                    ...\u003C/span>\u003Cspan style=\"color:#E1E4E8\">albumItem,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    musicList: []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            /** 查询作者的详细信息 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">            queryArtistWorks\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">artistItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">page\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(type \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'music'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    // 网络请求\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        isEnd: \u003C/span>\u003Cspan style=\"color:#79B8FF\">false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        data: [], \u003C/span>\u003Cspan style=\"color:#6A737D\">// MusicItem类型音乐列表\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                } \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(type \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'album'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    // 网络请求\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        isEnd: \u003C/span>\u003Cspan style=\"color:#79B8FF\">false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                        data: [], \u003C/span>\u003Cspan style=\"color:#6A737D\">// AlbumItem类型音乐列表\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            /** 导入单曲 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">            importMusicItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">urlLike\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> musicItem;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            /** 导入歌单 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">            importMusicSheet\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">urlLike\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> musicItems\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> musicItems;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>目前插件中的所有常量/函数如上，只有platform是必选参数，其他均为可选。\u003C/p>\n\u003Cp>插件中定义了四种基本的媒体类型，分别是:\u003C/p>\n\u003Cul>\n\u003Cli>基础媒体类型：platform和id标识着唯一的一个媒体\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    type\u003C/span>\u003Cspan style=\"color:#B392F0\"> IMediaBase\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        id\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        platform\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        $\u003C/span>\u003Cspan style=\"color:#F97583\">?:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; \u003C/span>\u003Cspan style=\"color:#6A737D\">// 内部变量，不要给它赋值，会被覆盖\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        [\u003C/span>\u003Cspan style=\"color:#FFAB70\">k\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> symbol\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        [\u003C/span>\u003Cspan style=\"color:#FFAB70\">k\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    };\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>音乐类型\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    interface\u003C/span>\u003Cspan style=\"color:#B392F0\"> IMusicItemBase\u003C/span>\u003Cspan style=\"color:#F97583\"> extends\u003C/span>\u003Cspan style=\"color:#B392F0\"> ICommon\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">IMediaBase\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 其他属性 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        [\u003C/span>\u003Cspan style=\"color:#FFAB70\">k\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#F97583\"> keyof\u003C/span>\u003Cspan style=\"color:#B392F0\"> IMusicItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> IMusicItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[\u003C/span>\u003Cspan style=\"color:#B392F0\">k\u003C/span>\u003Cspan style=\"color:#E1E4E8\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    interface\u003C/span>\u003Cspan style=\"color:#B392F0\"> IMusicItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 歌曲在平台的唯一编号 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        id\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 平台 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        platform\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 作者 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        artist\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 标题 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        title\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 时长(s) */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        duration\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> number\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 专辑名 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        album\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 专辑封面图 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        artwork\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 音源 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        url\u003C/span>\u003Cspan style=\"color:#F97583\">?:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 歌词URL */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        lrc\u003C/span>\u003Cspan style=\"color:#F97583\">?:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 歌词 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        rawLrc\u003C/span>\u003Cspan style=\"color:#F97583\">?:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 其他可以被序列化的信息 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        [\u003C/span>\u003Cspan style=\"color:#FFAB70\">k\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        /** 内部信息 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        [\u003C/span>\u003Cspan style=\"color:#FFAB70\">k\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> symbol\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>作者类型\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    interface\u003C/span>\u003Cspan style=\"color:#B392F0\"> IArtistItemBase\u003C/span>\u003Cspan style=\"color:#F97583\"> extends\u003C/span>\u003Cspan style=\"color:#B392F0\"> ICommon\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">IMediaBase\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        name\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        id\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        fans\u003C/span>\u003Cspan style=\"color:#F97583\">?:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> number\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        description\u003C/span>\u003Cspan style=\"color:#F97583\">?:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        platform\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        avatar\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        worksNum\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> number\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    interface\u003C/span>\u003Cspan style=\"color:#B392F0\"> IArtistItem\u003C/span>\u003Cspan style=\"color:#F97583\"> extends\u003C/span>\u003Cspan style=\"color:#B392F0\"> IArtistItemBase\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        musicList\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> IMusic\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">IMusicItemBase\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        albumList\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> IAlbum\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">IAlbumItemBase\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        [\u003C/span>\u003Cspan style=\"color:#FFAB70\">k\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>专辑类型\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    interface\u003C/span>\u003Cspan style=\"color:#B392F0\"> IAlbumItemBase\u003C/span>\u003Cspan style=\"color:#F97583\"> extends\u003C/span>\u003Cspan style=\"color:#B392F0\"> ICommon\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">IMediaBase\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        artwork\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        title\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        date\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        artist\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        description\u003C/span>\u003Cspan style=\"color:#F97583\">?:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    interface\u003C/span>\u003Cspan style=\"color:#B392F0\"> IAlbumItem\u003C/span>\u003Cspan style=\"color:#F97583\"> extends\u003C/span>\u003Cspan style=\"color:#B392F0\"> IAlbumItemBase\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        musicList\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> IMusic\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">IMusicItem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>通过编写以上简单的脚本，并通过musicfree的插件导入，就可以使用插件完成对应的音乐行为了。\u003C/p>",{"headings":824,"localImagePaths":830,"remoteImagePaths":831,"frontmatter":832,"imagePaths":834},[825,828],{"depth":283,"slug":826,"text":827},"musicfree插件是什么","MusicFree插件是什么",{"depth":283,"slug":829,"text":829},"插件的标准协议",[],[],{"title":815,"pubDate":833,"category":33,"excerpt":817},["Date","2022-09-15T22:34:45.000Z"],[],"异步编程的回调解决方案",{"id":835,"data":837,"body":840,"filePath":841,"digest":842,"rendered":843},{"title":835,"pubDate":838,"category":33,"excerpt":839},["Date","2019-06-22T16:04:03.000Z"],"关于异步编程的听课笔记。","**异步编程是面试时一定会问的**\n\n---\n\n1. 传统异步编程方案\n2. promise\n\n---\n### 传统异步编程的解决方案\n\njs：事件驱动机制，单线程，异步操作实现阻塞IO\n\n\n#### callback回调函数：\n\n通过参数传入回调，回调时让函数的调用者判断发生了什么。\n缺点：不利于代码的阅读和回复，程序的流程会比较乱，而且每个任务只能指定一个回调函数。\n\n#### 观察者模式（事件发布/订阅模式）：\n\n思想：回调函数的事件化，任务的执行不取决于代码的执行顺序，而取决于某个事件是否发生。\n\n优点：可以绑定多个事件，每个事件可以指定多个回调函数。\n缺点：程序变成事件驱动型，运行流程不清晰。\n\n#### deferred延迟函数：\n\n通过deferred对象给异步操作进行状态绑定，deferred对象提供统一的API，对异步操作的状态操作。\n\n优点：避免了层层嵌套的回调函数deferred对象提供统一的接口，使得控制异步操作更加容易。（Promise的思想）\n缺点：状态不可逆，状态一旦确定，无法更改。\n\n---\n### Promise规范\n\nPromise是异步编程的一种解决方案，简单来说是一个容器，里面保存着一个异步操作的结果。提供统一的API，各种异步操作都可以使用同样的方法进行处理。\n> 参考资料：阮一峰es6教程\n\n经典的数据类型的判断方法：toString.call(),是什么类型，得到的字符串就是[object 类型名]；使用typeof不准确。\n\nPromise， Deferred就是一些容器的语法糖，剩下的就是封装语法糖。\n\n原理：是一个容器，内部封装着一些callbacks，而这个容器有两个方法：add和fire，add用来向容器中添加callback，fire则用来实现依次调用容器内所有的callback。容器有着一些参数，比如once，memory和stopOnFalse。promise和deferred则是这个容器的一些语法糖。","src/content/posts/异步编程的回调解决方案.md","d2e6f539251baf89",{"html":844,"metadata":845},"\u003Cp>\u003Cstrong>异步编程是面试时一定会问的\u003C/strong>\u003C/p>\n\u003Chr>\n\u003Col>\n\u003Cli>传统异步编程方案\u003C/li>\n\u003Cli>promise\u003C/li>\n\u003C/ol>\n\u003Chr>\n\u003Ch3 id=\"传统异步编程的解决方案\">传统异步编程的解决方案\u003C/h3>\n\u003Cp>js：事件驱动机制，单线程，异步操作实现阻塞IO\u003C/p>\n\u003Ch4 id=\"callback回调函数\">callback回调函数：\u003C/h4>\n\u003Cp>通过参数传入回调，回调时让函数的调用者判断发生了什么。\n缺点：不利于代码的阅读和回复，程序的流程会比较乱，而且每个任务只能指定一个回调函数。\u003C/p>\n\u003Ch4 id=\"观察者模式事件发布订阅模式\">观察者模式（事件发布/订阅模式）：\u003C/h4>\n\u003Cp>思想：回调函数的事件化，任务的执行不取决于代码的执行顺序，而取决于某个事件是否发生。\u003C/p>\n\u003Cp>优点：可以绑定多个事件，每个事件可以指定多个回调函数。\n缺点：程序变成事件驱动型，运行流程不清晰。\u003C/p>\n\u003Ch4 id=\"deferred延迟函数\">deferred延迟函数：\u003C/h4>\n\u003Cp>通过deferred对象给异步操作进行状态绑定，deferred对象提供统一的API，对异步操作的状态操作。\u003C/p>\n\u003Cp>优点：避免了层层嵌套的回调函数deferred对象提供统一的接口，使得控制异步操作更加容易。（Promise的思想）\n缺点：状态不可逆，状态一旦确定，无法更改。\u003C/p>\n\u003Chr>\n\u003Ch3 id=\"promise规范\">Promise规范\u003C/h3>\n\u003Cp>Promise是异步编程的一种解决方案，简单来说是一个容器，里面保存着一个异步操作的结果。提供统一的API，各种异步操作都可以使用同样的方法进行处理。\u003C/p>\n\u003Cblockquote>\n\u003Cp>参考资料：阮一峰es6教程\u003C/p>\n\u003C/blockquote>\n\u003Cp>经典的数据类型的判断方法：toString.call(),是什么类型，得到的字符串就是[object 类型名]；使用typeof不准确。\u003C/p>\n\u003Cp>Promise， Deferred就是一些容器的语法糖，剩下的就是封装语法糖。\u003C/p>\n\u003Cp>原理：是一个容器，内部封装着一些callbacks，而这个容器有两个方法：add和fire，add用来向容器中添加callback，fire则用来实现依次调用容器内所有的callback。容器有着一些参数，比如once，memory和stopOnFalse。promise和deferred则是这个容器的一些语法糖。\u003C/p>",{"headings":846,"localImagePaths":861,"remoteImagePaths":862,"frontmatter":863,"imagePaths":865},[847,849,852,855,858],{"depth":81,"slug":848,"text":848},"传统异步编程的解决方案",{"depth":57,"slug":850,"text":851},"callback回调函数","callback回调函数：",{"depth":57,"slug":853,"text":854},"观察者模式事件发布订阅模式","观察者模式（事件发布/订阅模式）：",{"depth":57,"slug":856,"text":857},"deferred延迟函数","deferred延迟函数：",{"depth":81,"slug":859,"text":860},"promise规范","Promise规范",[],[],{"title":835,"pubDate":864,"category":33,"excerpt":839},["Date","2019-06-22T16:04:03.000Z"],[],"微信小程序pc端解密",{"id":866,"data":868,"body":872,"filePath":873,"digest":874,"rendered":875},{"title":869,"pubDate":870,"category":16,"excerpt":871},"微信小程序PC端解密",["Date","2020-09-13T23:09:31.000Z"],"微信小程序PC端是加密过的，因此直接打开wxapkg包是看不到任何有用的信息的，需要解密方可看到代码。","## 小程序包存在哪里\nPC端的包存放在微信文件的默认保存位置，可通过设置->文件管理查看。  \n进入文件夹的/WeChat Files/WeChat Files/Applet目录之后，可以看到，一系列wxblabla格式的文件夹。这些文件夹其实就是对应小程序的appid，点进去可以看到一个名称是随机数字的文件夹，进入之后看到的\\_\\_APP\\_\\_.wxapkg即是对应的小程序的包。  \n当满怀欣喜的打开之后，发现是这样的：\n![图片](http://imgs.maotoumao.xyz/blog-APP.wxapkg.png)\nWTF???这能看出来个毛线? 很明显，这份文件是被加密过的，因此需要解码。\n\n## 加密原理\n在github上搜了一下，找到了一个大佬写的[go语言的解密版本](https://github.com/BlackTrace/pc_wxapkg_decrypt)，以及解密的原理。我把它改成了nodejs的版本，在这里也把学习到的一些东西记录一下。\n\n整体的加密过程是这样的：\n1. 对于原本的包，分成两部分，前1024字节为一部分，记为head，后边所有的字节记为tail。\n2. 对于head部分：\n    2.1 使用pbkdf2密钥派生算法对小程序的id（记为wxid）进行加密，其中算法的输入为：pass是小程序id，salt是8字节字符串\"saltiest\"，迭代次数为1000，生成一个32字节的派生密钥，记为dk。\n    2.2 使用CBC模式的AES算法，以dk为密钥，以16字节字符串\"the iv: 16 bytes\"对head部分进行加密。由于密钥是32字节，也就是256位，因此使用的AES算法是AES-256-CBC。\n3. 对于tail部分：\n    3.1 小程序id的倒数第二位取出，记为xorKey，如果小程序id位数小于2，则xorKey为0x66。\n    3.2 对于tail部分，使用xorKey进行异或。\n4. 写入解密后的文件，顺序依次是：6个字节的字符串：\"V1MMWX\"，加密后的head部分，加密后的tail部分。\n\n## 解密\n由于head部分的加密采用的AES是对称加密算法，类似于钥匙开门，我们可以通过2.1步骤获得这个开门的钥匙，来打开这个门。如果是非对称加密算法，例如RSA，它们是由公开的公钥加密，私钥解密，就类似于，你的大门门口挂着一把用来锁门的钥匙，但是用来开门的钥匙被你随身藏在了鞋垫底下，并且只有你知道。\n\n对于tail部分，异或具有自反性，即：\n```\n    A xor B xor B === A\n```\n因此，我们只需要计算xorKey，再将密文进行异或，即可得到明文。\n\n---\n代码发布在[GitHub](https://github.com/maotoumao/wxpc-miniprogram-decryption)和[Gitee](https://gitee.com/maotoumao/wxpc-miniprogram-decryption)。","src/content/posts/微信小程序PC端解密.md","6fd0b2f752f7bba0",{"html":876,"metadata":877},"\u003Ch2 id=\"小程序包存在哪里\">小程序包存在哪里\u003C/h2>\n\u003Cp>PC端的包存放在微信文件的默认保存位置，可通过设置->文件管理查看。\u003Cbr>\n进入文件夹的/WeChat Files/WeChat Files/Applet目录之后，可以看到，一系列wxblabla格式的文件夹。这些文件夹其实就是对应小程序的appid，点进去可以看到一个名称是随机数字的文件夹，进入之后看到的__APP__.wxapkg即是对应的小程序的包。\u003Cbr>\n当满怀欣喜的打开之后，发现是这样的：\n\u003Cimg src=\"http://imgs.maotoumao.xyz/blog-APP.wxapkg.png\" alt=\"图片\">\nWTF???这能看出来个毛线? 很明显，这份文件是被加密过的，因此需要解码。\u003C/p>\n\u003Ch2 id=\"加密原理\">加密原理\u003C/h2>\n\u003Cp>在github上搜了一下，找到了一个大佬写的\u003Ca href=\"https://github.com/BlackTrace/pc_wxapkg_decrypt\">go语言的解密版本\u003C/a>，以及解密的原理。我把它改成了nodejs的版本，在这里也把学习到的一些东西记录一下。\u003C/p>\n\u003Cp>整体的加密过程是这样的：\u003C/p>\n\u003Col>\n\u003Cli>对于原本的包，分成两部分，前1024字节为一部分，记为head，后边所有的字节记为tail。\u003C/li>\n\u003Cli>对于head部分：\n2.1 使用pbkdf2密钥派生算法对小程序的id（记为wxid）进行加密，其中算法的输入为：pass是小程序id，salt是8字节字符串”saltiest”，迭代次数为1000，生成一个32字节的派生密钥，记为dk。\n2.2 使用CBC模式的AES算法，以dk为密钥，以16字节字符串”the iv: 16 bytes”对head部分进行加密。由于密钥是32字节，也就是256位，因此使用的AES算法是AES-256-CBC。\u003C/li>\n\u003Cli>对于tail部分：\n3.1 小程序id的倒数第二位取出，记为xorKey，如果小程序id位数小于2，则xorKey为0x66。\n3.2 对于tail部分，使用xorKey进行异或。\u003C/li>\n\u003Cli>写入解密后的文件，顺序依次是：6个字节的字符串：“V1MMWX”，加密后的head部分，加密后的tail部分。\u003C/li>\n\u003C/ol>\n\u003Ch2 id=\"解密\">解密\u003C/h2>\n\u003Cp>由于head部分的加密采用的AES是对称加密算法，类似于钥匙开门，我们可以通过2.1步骤获得这个开门的钥匙，来打开这个门。如果是非对称加密算法，例如RSA，它们是由公开的公钥加密，私钥解密，就类似于，你的大门门口挂着一把用来锁门的钥匙，但是用来开门的钥匙被你随身藏在了鞋垫底下，并且只有你知道。\u003C/p>\n\u003Cp>对于tail部分，异或具有自反性，即：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    A xor B xor B === A\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>因此，我们只需要计算xorKey，再将密文进行异或，即可得到明文。\u003C/p>\n\u003Chr>\n\u003Cp>代码发布在\u003Ca href=\"https://github.com/maotoumao/wxpc-miniprogram-decryption\">GitHub\u003C/a>和\u003Ca href=\"https://gitee.com/maotoumao/wxpc-miniprogram-decryption\">Gitee\u003C/a>。\u003C/p>",{"headings":878,"localImagePaths":885,"remoteImagePaths":886,"frontmatter":887,"imagePaths":889},[879,881,883],{"depth":26,"slug":880,"text":880},"小程序包存在哪里",{"depth":26,"slug":882,"text":882},"加密原理",{"depth":26,"slug":884,"text":884},"解密",[],[],{"title":869,"pubDate":888,"category":16,"excerpt":871},["Date","2020-09-13T23:09:31.000Z"],[],"搭建自己的gpt服务",{"id":890,"data":892,"body":897,"filePath":898,"digest":899,"rendered":900},{"title":893,"pubDate":894,"category":895,"excerpt":896},"【完整的练手小项目】搭建自己的GPT服务",["Date","2023-02-16T20:30:25.000Z"],"工具/效率","简单记录一下。","本文首发于公众号【一只猫头猫】，平时记录一些自己做的好玩的东西，随便写写吧~\r\n\r\n---\r\n# 前言\r\n\r\n很久没写小程序了，看到最近ChatGPT比较火，也想整个活玩一玩。于是花了一个周末做了个AI算命微信小程序，乐呵乐呵。先放一下最终的成品效果（小程序名字叫“赛博运势丨AI测命理”，微信直接搜也行）：\r\n\r\n![](https://i.328888.xyz/2023/02/16/pne5k.jpeg)\r\n![](https://i.328888.xyz/2023/02/16/pnBkq.jpeg)\r\n\r\n\r\n# 技术栈\r\n小程序端：Taro + React + sass\r\n服务端：koa + rabbitmq + mongodb + redis\r\n\r\n工程量不大，但麻雀虽小五脏俱全了属于是。本文会简单记录一下一些关键的步骤和实现思路，一些软件的安装服务就略过啦。接下来直入主题。\r\n\r\n# 整体思路\r\n## 需求描述\r\n做一个AI算命的小程序，用户可以输入一些基础的个人信息，小程序需要根据个人信息推算出用户的其他信息，并根据推算信息查询运势。\r\n\r\n\r\n## 实现思路\r\n### 运势生成\r\n首先OpenAI提供了官方的接口，去官网注册个账号，然后申领Key就可以直接通过API调用了。GPT系列目前有4种模型可以使用，分别是Davinci、Curie、Babbage和Ada，从前往后效果**依次变差**，但后边的速度**会更快**，价格会**更便宜**。我试了一下，后边3个模型在我给定的prompt上虽然很快，但表现稀烂，并且貌似只会回答英文，看来省钱是省不了了。\r\n\r\n### 前后端通信\r\n请求OpenAI的部分肯定是得由服务端完成。具体来说，需要小程序端调用服务端的接口，然后由服务端向OpenAI发起请求，等待结果返回后再吐给前端。\r\n\r\n既然是服务端，最基础的就是引入一个启动服务的框架，这里用的是*koa*。\r\n\r\n考虑到土豆般的服务器，以及同时向OpenAI发起的请求数需要有一定的限制，因此需要引入一个消息队列来达到**削峰**的目的；要不然万一一不小心瞬间发送了大量请求，服务可能就崩了。这里使用了*rabbitmq*。 \r\n用消息队列还有个好处是**解耦**，换句话说，就是把*专门使用消息队列处理OpenAI请求*的进程和*直接向小程序端提供服务*的进程解耦开，这样其他应用也可以通过消息队列来直接使用GPT模型。\r\n\r\n由于调OpenAI的**过程很慢**，假设我们从小程序端向服务器请求接口，由服务器发起一个调用OpenAI请求，我们不可能等个一两分钟一直等到这个请求返回结果。因此自然想到，需要把发起请求和查询结果分成两个接口，其中查询结果通过向服务器**轮询**的方式查询OpenAI是否已经给出结果。\r\n\r\n既然是轮询，那肯定要保证**数据在一段时间内能被查询到**。那OpenAI返回的结果肯定要暂存在**数据库**中，简单起见，直接用*mongodb*就好了。考虑到轮询时候的查询性能，每次轮询都查询数据库太浪费了，因此中间需要加一层*redis*做缓冲。\r\n\r\n到这里，整体的后端的技术选型就有了：**koa + rabbitmq + mongodb + redis**。至于小程序端，直接**Taro + React + sass**，和以前做的普通web项目体感没什么不同。\r\n\r\n## 工程架构\r\n大概画一个简单的示意图描述一下整体的架构：\r\n![](https://i.328888.xyz/2023/02/16/pkXBP.png)\r\n\r\n\r\n# 小程序端\r\n小程序端其实没什么可写的，没踩太多坑，就是普通的UI加了一些花里胡哨的动画。唯一就是分享图片的时候，搜了半天没搜到啥靠谱的，还以为小程序canvas上绘制base64图片很麻烦。最后看了下微信官方文档，发现和普通canvas差不多，简单封装个方法：\r\n\r\n```typescript\r\nasync function drawImage(\r\n  canvas: any,\r\n  base64src: string,\r\n  dx: number,\r\n  dy: number,\r\n  width: number,\r\n  height: number\r\n): Promise\u003Cvoid> {\r\n  if (!canvas || !img) {\r\n    return;\r\n  }\r\n  const image = canvas.createImage();\r\n  const ctx: CanvasRenderingContext2D = canvas.getContext(\"2d\");\r\n\r\n  image.src = base64src;\r\n  return new Promise((resolve) => {\r\n    image.onload = () => {\r\n      ctx.drawImage(image, dx, dy, width, height);\r\n      resolve();\r\n    };\r\n  });\r\n}\r\n```\r\n用这个直接在canvas上画就行了。\r\n\r\n# 服务端\r\n根据上边的描述，服务端部分分成了两半，一半是专门用来向OpenAI发请求和处理消息的GPT服务；另一个是和小程序端打交道的Koa服务。\r\n## GPT服务\r\n这块也分成两部分来说，第一部分就是怎么给OpenAI发请求调用GPT模型，第二部分是怎么使用消息队列和数据库。\r\n### 调用GPT模型\r\n这里用到了chatgpt库。这个库使用到了node18的原生fetch，因此它的package.json里有这么一行：\r\n```json\r\n\"engines\": {\r\n    \"node\": \">=18\"\r\n}\r\n```\r\n也就是低于18.x版本的node环境下装这个包可能会报错。但是没关系，可以使用：\r\n```bash\r\nyarn add chatgpt --ignore-engines\r\n```\r\n来忽略环境的不匹配，在实际调用的时候引个polyfill就好了。引入polyfill有两种方式：\r\n- 方法一： 安装node-fetch，然后给全局fetch赋值：\r\n```typescript\r\nimport nodeFetch from 'node-fetch';\r\nimport { ChatGPTAPI } from \"chatgpt\";\r\n\r\nglobalThis.fetch = nodeFetch;\r\n\r\nconst api = new ChatGPTAPI({\r\n    apiKey: YOUR_OPENAI_KEY,\r\n});\r\n```\r\n- 方法二： 这个库的最新版在创建GPT实例的时候可以传入一个fetch参数，也就是：\r\n```typescript\r\nimport nodeFetch from 'node-fetch';\r\nimport { ChatGPTAPI } from \"chatgpt\";\r\n\r\nconst api = new ChatGPTAPI({\r\n    apiKey: YOUR_OPENAI_KEY,\r\n    fetch: nodeFetch\r\n});\r\n```\r\n\r\n接下来就可以通过sendMessage方法去发起请求了：\r\n```typescript\r\napi.sendMessage(\"假如你是一只小狗，你会对我说什么呢？\").then(console.log);\r\n```\r\n等一会之后，就可以看到ChatGPT的回复：\r\n\r\n![](https://i.328888.xyz/2023/02/16/pk1CU.png)\r\n\r\n### 消息队列\r\n安装rabbitmq的过程 网上教程一堆，就略过了~假定消息队列服务已经启动好了，直接说在node中的使用。首先安装一下amqplib库。  \r\n安装完成之后，第一步是**连接消息队列服务**：\r\n```typescript\r\nimport { connect } from 'amqplib';\r\n\r\n// 注意后边带一个heartbeat参数，要不然时间长了无心跳连接可能会被关闭\r\nlet connection = await connect(\"amqp://127.0.0.1?heartbeat=180\");\r\n```\r\n第二步是**创建一个channel**。建立连接以后，所有的消息队列有关的amqp协议操作，都会通过channel完成：\r\n```typescript\r\nlet channel = await connection.createChannel();\r\n```\r\n第三步是**创建一个交换机**，并为它绑定一个队列。在这里采用的是直连，通过duration开启了持久化，从而下次重启的时候，队列中的内容还可以恢复：\r\n```typescript\r\nconst exchangeName = \"chat-gpt-exchange\";\r\nconst key = \"request-queue\";\r\nawait channel.assertExchange(exchangeName, 'direct', {\r\n    durable: true, // 持久化\r\n})\r\n// 创建名为key的队列\r\nawait channel.assertQueue(key);\r\n// 绑定队列，三个参数分别为：队列名，交换机名，路由名\r\nawait channel.bindQueue(key, exchangeName, key);\r\n```\r\n第四步是**削峰和处理逻辑**的部分。需要注意，noAck需要设置为false，一直等到消息处理完成手动触发ack，这时才会在队列中取下一个。\r\n```typescript\r\n// 每次从消息队列中按顺序取出10个进行消费\r\nawait channel.prefetch(10);\r\n// 具体的消费方法，msg是从队列中取出的内容，这里我传来的是一个json\r\nawait channel.consume(key, async msg => {\r\n    try {\r\n        const content = msg.content.toString();\r\n        const jsonContent = JSON.parse(content);\r\n        const result = await chatgptApi.sendMessage(jsonContent.msg, jsonContent.options);\r\n        const id = jsonContent.id;\r\n        // 写入redis, ttl设置为10分钟（直接使用redis包，调用redis.createClient然后就可以直接调了）\r\n        redisClient.set(`${namespace}${id}`, JSON.stringify(result), {\r\n            EX: 600\r\n        });\r\n        // 写入mongodb，略过了\r\n        // ...\r\n        channel.ack(msg);\r\n    } catch {\r\n    }\r\n    channel.ack(msg);\r\n}, {\r\n    noAck: false,\r\n})\r\n```\r\n\r\n### 数据库\r\n为了减少服务器的负担，存储在mongodb和redis中的数据都做了定时删除。操作mongodb用的是mongoose库，定时删除的方法也很简单，在创建Schema的时候设置一下createAt属性就好了：\r\n```typescript\r\nconst resultsSchema = new mongoose.Schema({\r\n    /** 请求ID **/\r\n    reqId: {\r\n        type: String,\r\n        required: true\r\n    },\r\n    /** 请求结果 */\r\n    result: {\r\n        type: Object\r\n    },\r\n    createdAt: {\r\n        type: Date,\r\n        default: Date.now,\r\n        index: {\r\n            expires: '1h' // 设置1小时后自动过期，过期后会自动删除\r\n        }\r\n    }\r\n});\r\n```\r\n\r\n## Koa服务\r\n这个服务就是卡在中间，作用就是处理来自小程序端的请求，不停的往消息队列里面塞信息，不停的查询redis和数据库。具体来说，除去和微信小程序打交道的部分，主要的接口就两个：start（发起调用GPT的申请）和query（查询请求结果）\r\n### 开始查询\r\n这里的逻辑和上边消费的部分其实有些类似，依然是创建连接、创建channel、创建队列，不过是由消费变成了生产：\r\n```typescript\r\nimport { connect } from 'amqplib';\r\n\r\nlet connection = await connect(\"amqp://127.0.0.1?heartbeat=180\");\r\nlet channel = await connection.createChannel();\r\nconst exchangeName = \"chat-gpt-exchange\";\r\nconst key = \"request-queue\";\r\nawait channel.assertExchange(exchangeName, 'direct', {\r\n    durable: true, // 持久化\r\n})\r\n// 创建名为key的队列\r\nawait channel.assertQueue(key);\r\n// 绑定队列，三个参数分别为：队列名，交换机名，路由名\r\nawait channel.bindQueue(key, exchangeName, key);\r\n\r\n/** 以上代码和消费端一模一样 */\r\nconst reqId = 'xxx';\r\n// 生产消息\r\nchannel?.publish(exchangeName, key, Buffer.from(JSON.stringify({\r\n    reqId: reqId,\r\n    msg: '假如你是一只小狗，你会对我说什么？',\r\n    options: {} // chatgpt的options参数\r\n})));\r\n// 在redis中打个标记\r\nredisClient.set(reqId, 1, {\r\n    EX: 600 // 过期时间\r\n});\r\n```\r\n\r\n总结起来使用消息队列也不是很复杂。需要注意的是，在生产消息的同时给redis中打个标记，意思是这条请求已经在处理中了。如果不这样的话，在下边轮询的时候在redis中以reqId为key获取到的值是null，会使得每次查询都无法命中redis，始终穿透到mongodb数据库。这样就失去使用redis的意义了。\r\n\r\n### 查询结果\r\n查询结果的代码就不啰嗦了，总之：第一步查redis，redis中记录了请求的状态；如果没有就查mongodb，如果mongodb还没有，那就证明这个请求已经过期了，直接返回失败。\r\n\r\n# 总结\r\n总结起来，这一个练手的小项目还是用到了不少知识的。通过以上描述，也可以大概搭起一个比较稳定（虽然速度堪忧）的chatgpt服务。之后还可以做什么就自由发挥了~\r\n\r\n最后贴一下这个小程序的二维码，感兴趣的可以去试试算个运势~（仅供娱乐~ 5分钟内应该会返回结果，比较慢）\r\n\r\n![](https://i.328888.xyz/2023/02/16/p00Rt.jpeg)","src/content/posts/搭建自己的GPT服务.md","9586e84da2ea0e9d",{"html":901,"metadata":902},"\u003Cp>本文首发于公众号【一只猫头猫】，平时记录一些自己做的好玩的东西，随便写写吧~\u003C/p>\n\u003Chr>\n\u003Ch1 id=\"前言\">前言\u003C/h1>\n\u003Cp>很久没写小程序了，看到最近ChatGPT比较火，也想整个活玩一玩。于是花了一个周末做了个AI算命微信小程序，乐呵乐呵。先放一下最终的成品效果（小程序名字叫“赛博运势丨AI测命理”，微信直接搜也行）：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/02/16/pne5k.jpeg\" alt=\"\">\r\n\u003Cimg src=\"https://i.328888.xyz/2023/02/16/pnBkq.jpeg\" alt=\"\">\u003C/p>\n\u003Ch1 id=\"技术栈\">技术栈\u003C/h1>\n\u003Cp>小程序端：Taro + React + sass\r\n服务端：koa + rabbitmq + mongodb + redis\u003C/p>\n\u003Cp>工程量不大，但麻雀虽小五脏俱全了属于是。本文会简单记录一下一些关键的步骤和实现思路，一些软件的安装服务就略过啦。接下来直入主题。\u003C/p>\n\u003Ch1 id=\"整体思路\">整体思路\u003C/h1>\n\u003Ch2 id=\"需求描述\">需求描述\u003C/h2>\n\u003Cp>做一个AI算命的小程序，用户可以输入一些基础的个人信息，小程序需要根据个人信息推算出用户的其他信息，并根据推算信息查询运势。\u003C/p>\n\u003Ch2 id=\"实现思路\">实现思路\u003C/h2>\n\u003Ch3 id=\"运势生成\">运势生成\u003C/h3>\n\u003Cp>首先OpenAI提供了官方的接口，去官网注册个账号，然后申领Key就可以直接通过API调用了。GPT系列目前有4种模型可以使用，分别是Davinci、Curie、Babbage和Ada，从前往后效果\u003Cstrong>依次变差\u003C/strong>，但后边的速度\u003Cstrong>会更快\u003C/strong>，价格会\u003Cstrong>更便宜\u003C/strong>。我试了一下，后边3个模型在我给定的prompt上虽然很快，但表现稀烂，并且貌似只会回答英文，看来省钱是省不了了。\u003C/p>\n\u003Ch3 id=\"前后端通信\">前后端通信\u003C/h3>\n\u003Cp>请求OpenAI的部分肯定是得由服务端完成。具体来说，需要小程序端调用服务端的接口，然后由服务端向OpenAI发起请求，等待结果返回后再吐给前端。\u003C/p>\n\u003Cp>既然是服务端，最基础的就是引入一个启动服务的框架，这里用的是\u003Cem>koa\u003C/em>。\u003C/p>\n\u003Cp>考虑到土豆般的服务器，以及同时向OpenAI发起的请求数需要有一定的限制，因此需要引入一个消息队列来达到\u003Cstrong>削峰\u003C/strong>的目的；要不然万一一不小心瞬间发送了大量请求，服务可能就崩了。这里使用了\u003Cem>rabbitmq\u003C/em>。\r\n用消息队列还有个好处是\u003Cstrong>解耦\u003C/strong>，换句话说，就是把\u003Cem>专门使用消息队列处理OpenAI请求\u003C/em>的进程和\u003Cem>直接向小程序端提供服务\u003C/em>的进程解耦开，这样其他应用也可以通过消息队列来直接使用GPT模型。\u003C/p>\n\u003Cp>由于调OpenAI的\u003Cstrong>过程很慢\u003C/strong>，假设我们从小程序端向服务器请求接口，由服务器发起一个调用OpenAI请求，我们不可能等个一两分钟一直等到这个请求返回结果。因此自然想到，需要把发起请求和查询结果分成两个接口，其中查询结果通过向服务器\u003Cstrong>轮询\u003C/strong>的方式查询OpenAI是否已经给出结果。\u003C/p>\n\u003Cp>既然是轮询，那肯定要保证\u003Cstrong>数据在一段时间内能被查询到\u003C/strong>。那OpenAI返回的结果肯定要暂存在\u003Cstrong>数据库\u003C/strong>中，简单起见，直接用\u003Cem>mongodb\u003C/em>就好了。考虑到轮询时候的查询性能，每次轮询都查询数据库太浪费了，因此中间需要加一层\u003Cem>redis\u003C/em>做缓冲。\u003C/p>\n\u003Cp>到这里，整体的后端的技术选型就有了：\u003Cstrong>koa + rabbitmq + mongodb + redis\u003C/strong>。至于小程序端，直接\u003Cstrong>Taro + React + sass\u003C/strong>，和以前做的普通web项目体感没什么不同。\u003C/p>\n\u003Ch2 id=\"工程架构\">工程架构\u003C/h2>\n\u003Cp>大概画一个简单的示意图描述一下整体的架构：\r\n\u003Cimg src=\"https://i.328888.xyz/2023/02/16/pkXBP.png\" alt=\"\">\u003C/p>\n\u003Ch1 id=\"小程序端\">小程序端\u003C/h1>\n\u003Cp>小程序端其实没什么可写的，没踩太多坑，就是普通的UI加了一些花里胡哨的动画。唯一就是分享图片的时候，搜了半天没搜到啥靠谱的，还以为小程序canvas上绘制base64图片很麻烦。最后看了下微信官方文档，发现和普通canvas差不多，简单封装个方法：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">async\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> drawImage\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">  canvas\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">  base64src\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">  dx\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> number\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">  dy\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> number\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">  width\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> number\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">  height\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> number\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> Promise\u003C/span>\u003Cspan style=\"color:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\">void\u003C/span>\u003Cspan style=\"color:#E1E4E8\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">  if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">canvas \u003C/span>\u003Cspan style=\"color:#F97583\">||\u003C/span>\u003Cspan style=\"color:#F97583\"> !\u003C/span>\u003Cspan style=\"color:#E1E4E8\">img) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">  const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> image\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> canvas.\u003C/span>\u003Cspan style=\"color:#B392F0\">createImage\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">  const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> ctx\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> CanvasRenderingContext2D\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> canvas.\u003C/span>\u003Cspan style=\"color:#B392F0\">getContext\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"2d\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  image.src \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> base64src;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">  return\u003C/span>\u003Cspan style=\"color:#F97583\"> new\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Promise\u003C/span>\u003Cspan style=\"color:#E1E4E8\">((\u003C/span>\u003Cspan style=\"color:#FFAB70\">resolve\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    image.\u003C/span>\u003Cspan style=\"color:#B392F0\">onload\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> () \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      ctx.\u003C/span>\u003Cspan style=\"color:#B392F0\">drawImage\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(image, dx, dy, width, height);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">      resolve\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>用这个直接在canvas上画就行了。\u003C/p>\n\u003Ch1 id=\"服务端\">服务端\u003C/h1>\n\u003Cp>根据上边的描述，服务端部分分成了两半，一半是专门用来向OpenAI发请求和处理消息的GPT服务；另一个是和小程序端打交道的Koa服务。\u003C/p>\n\u003Ch2 id=\"gpt服务\">GPT服务\u003C/h2>\n\u003Cp>这块也分成两部分来说，第一部分就是怎么给OpenAI发请求调用GPT模型，第二部分是怎么使用消息队列和数据库。\u003C/p>\n\u003Ch3 id=\"调用gpt模型\">调用GPT模型\u003C/h3>\n\u003Cp>这里用到了chatgpt库。这个库使用到了node18的原生fetch，因此它的package.json里有这么一行：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"json\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"engines\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    \"node\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\">=18\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>也就是低于18.x版本的node环境下装这个包可能会报错。但是没关系，可以使用：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">yarn\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> add\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> chatgpt\u003C/span>\u003Cspan style=\"color:#79B8FF\"> --ignore-engines\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>来忽略环境的不匹配，在实际调用的时候引个polyfill就好了。引入polyfill有两种方式：\u003C/p>\n\u003Cul>\n\u003Cli>方法一： 安装node-fetch，然后给全局fetch赋值：\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nodeFetch \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'node-fetch'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { ChatGPTAPI } \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"chatgpt\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">globalThis.fetch \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nodeFetch;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> api\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> new\u003C/span>\u003Cspan style=\"color:#B392F0\"> ChatGPTAPI\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    apiKey: \u003C/span>\u003Cspan style=\"color:#79B8FF\">YOUR_OPENAI_KEY\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">});\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>方法二： 这个库的最新版在创建GPT实例的时候可以传入一个fetch参数，也就是：\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nodeFetch \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'node-fetch'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { ChatGPTAPI } \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"chatgpt\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> api\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> new\u003C/span>\u003Cspan style=\"color:#B392F0\"> ChatGPTAPI\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    apiKey: \u003C/span>\u003Cspan style=\"color:#79B8FF\">YOUR_OPENAI_KEY\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    fetch: nodeFetch\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">});\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>接下来就可以通过sendMessage方法去发起请求了：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">api.\u003C/span>\u003Cspan style=\"color:#B392F0\">sendMessage\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"假如你是一只小狗，你会对我说什么呢？\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).\u003C/span>\u003Cspan style=\"color:#B392F0\">then\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(console.log);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>等一会之后，就可以看到ChatGPT的回复：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/02/16/pk1CU.png\" alt=\"\">\u003C/p>\n\u003Ch3 id=\"消息队列\">消息队列\u003C/h3>\n\u003Cp>安装rabbitmq的过程 网上教程一堆，就略过了~假定消息队列服务已经启动好了，直接说在node中的使用。首先安装一下amqplib库。\u003Cbr>\n安装完成之后，第一步是\u003Cstrong>连接消息队列服务\u003C/strong>：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { connect } \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'amqplib'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 注意后边带一个heartbeat参数，要不然时间长了无心跳连接可能会被关闭\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> connection \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#B392F0\"> connect\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"amqp://127.0.0.1?heartbeat=180\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>第二步是\u003Cstrong>创建一个channel\u003C/strong>。建立连接以后，所有的消息队列有关的amqp协议操作，都会通过channel完成：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> channel \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> connection.\u003C/span>\u003Cspan style=\"color:#B392F0\">createChannel\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>第三步是\u003Cstrong>创建一个交换机\u003C/strong>，并为它绑定一个队列。在这里采用的是直连，通过duration开启了持久化，从而下次重启的时候，队列中的内容还可以恢复：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> exchangeName\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"chat-gpt-exchange\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> key\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"request-queue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> channel.\u003C/span>\u003Cspan style=\"color:#B392F0\">assertExchange\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(exchangeName, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'direct'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    durable: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// 持久化\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 创建名为key的队列\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> channel.\u003C/span>\u003Cspan style=\"color:#B392F0\">assertQueue\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(key);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 绑定队列，三个参数分别为：队列名，交换机名，路由名\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> channel.\u003C/span>\u003Cspan style=\"color:#B392F0\">bindQueue\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(key, exchangeName, key);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>第四步是\u003Cstrong>削峰和处理逻辑\u003C/strong>的部分。需要注意，noAck需要设置为false，一直等到消息处理完成手动触发ack，这时才会在队列中取下一个。\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 每次从消息队列中按顺序取出10个进行消费\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> channel.\u003C/span>\u003Cspan style=\"color:#B392F0\">prefetch\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">10\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 具体的消费方法，msg是从队列中取出的内容，这里我传来的是一个json\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> channel.\u003C/span>\u003Cspan style=\"color:#B392F0\">consume\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(key, \u003C/span>\u003Cspan style=\"color:#F97583\">async\u003C/span>\u003Cspan style=\"color:#FFAB70\"> msg\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> content\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> msg.content.\u003C/span>\u003Cspan style=\"color:#B392F0\">toString\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> jsonContent\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#79B8FF\"> JSON\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">parse\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(content);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> result\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> chatgptApi.\u003C/span>\u003Cspan style=\"color:#B392F0\">sendMessage\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(jsonContent.msg, jsonContent.options);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> id\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> jsonContent.id;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // 写入redis, ttl设置为10分钟（直接使用redis包，调用redis.createClient然后就可以直接调了）\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        redisClient.\u003C/span>\u003Cspan style=\"color:#B392F0\">set\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">`${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">namespace\u003C/span>\u003Cspan style=\"color:#9ECBFF\">}${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">id\u003C/span>\u003Cspan style=\"color:#9ECBFF\">}`\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">JSON\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">stringify\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(result), {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            EX: \u003C/span>\u003Cspan style=\"color:#79B8FF\">600\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // 写入mongodb，略过了\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        channel.\u003C/span>\u003Cspan style=\"color:#B392F0\">ack\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(msg);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    } \u003C/span>\u003Cspan style=\"color:#F97583\">catch\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    channel.\u003C/span>\u003Cspan style=\"color:#B392F0\">ack\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(msg);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}, {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    noAck: \u003C/span>\u003Cspan style=\"color:#79B8FF\">false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"数据库\">数据库\u003C/h3>\n\u003Cp>为了减少服务器的负担，存储在mongodb和redis中的数据都做了定时删除。操作mongodb用的是mongoose库，定时删除的方法也很简单，在创建Schema的时候设置一下createAt属性就好了：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> resultsSchema\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> new\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mongoose.\u003C/span>\u003Cspan style=\"color:#B392F0\">Schema\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    /** 请求ID **/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    reqId: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        type: String,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        required: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    /** 请求结果 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        type: Object\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    createdAt: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        type: Date,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        default: Date.now,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        index: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            expires: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'1h'\u003C/span>\u003Cspan style=\"color:#6A737D\"> // 设置1小时后自动过期，过期后会自动删除\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">});\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"koa服务\">Koa服务\u003C/h2>\n\u003Cp>这个服务就是卡在中间，作用就是处理来自小程序端的请求，不停的往消息队列里面塞信息，不停的查询redis和数据库。具体来说，除去和微信小程序打交道的部分，主要的接口就两个：start（发起调用GPT的申请）和query（查询请求结果）\u003C/p>\n\u003Ch3 id=\"开始查询\">开始查询\u003C/h3>\n\u003Cp>这里的逻辑和上边消费的部分其实有些类似，依然是创建连接、创建channel、创建队列，不过是由消费变成了生产：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { connect } \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'amqplib'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> connection \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#B392F0\"> connect\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"amqp://127.0.0.1?heartbeat=180\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> channel \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> connection.\u003C/span>\u003Cspan style=\"color:#B392F0\">createChannel\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> exchangeName\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"chat-gpt-exchange\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> key\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"request-queue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> channel.\u003C/span>\u003Cspan style=\"color:#B392F0\">assertExchange\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(exchangeName, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'direct'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    durable: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// 持久化\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 创建名为key的队列\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> channel.\u003C/span>\u003Cspan style=\"color:#B392F0\">assertQueue\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(key);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 绑定队列，三个参数分别为：队列名，交换机名，路由名\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> channel.\u003C/span>\u003Cspan style=\"color:#B392F0\">bindQueue\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(key, exchangeName, key);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/** 以上代码和消费端一模一样 */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> reqId\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'xxx'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 生产消息\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">channel?.\u003C/span>\u003Cspan style=\"color:#B392F0\">publish\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(exchangeName, key, Buffer.\u003C/span>\u003Cspan style=\"color:#B392F0\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">JSON\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">stringify\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    reqId: reqId,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    msg: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'假如你是一只小狗，你会对我说什么？'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    options: {} \u003C/span>\u003Cspan style=\"color:#6A737D\">// chatgpt的options参数\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">})));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// 在redis中打个标记\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">redisClient.\u003C/span>\u003Cspan style=\"color:#B392F0\">set\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(reqId, \u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    EX: \u003C/span>\u003Cspan style=\"color:#79B8FF\">600\u003C/span>\u003Cspan style=\"color:#6A737D\"> // 过期时间\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">});\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>总结起来使用消息队列也不是很复杂。需要注意的是，在生产消息的同时给redis中打个标记，意思是这条请求已经在处理中了。如果不这样的话，在下边轮询的时候在redis中以reqId为key获取到的值是null，会使得每次查询都无法命中redis，始终穿透到mongodb数据库。这样就失去使用redis的意义了。\u003C/p>\n\u003Ch3 id=\"查询结果\">查询结果\u003C/h3>\n\u003Cp>查询结果的代码就不啰嗦了，总之：第一步查redis，redis中记录了请求的状态；如果没有就查mongodb，如果mongodb还没有，那就证明这个请求已经过期了，直接返回失败。\u003C/p>\n\u003Ch1 id=\"总结\">总结\u003C/h1>\n\u003Cp>总结起来，这一个练手的小项目还是用到了不少知识的。通过以上描述，也可以大概搭起一个比较稳定（虽然速度堪忧）的chatgpt服务。之后还可以做什么就自由发挥了~\u003C/p>\n\u003Cp>最后贴一下这个小程序的二维码，感兴趣的可以去试试算个运势~（仅供娱乐~ 5分钟内应该会返回结果，比较慢）\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/02/16/p00Rt.jpeg\" alt=\"\">\u003C/p>",{"headings":903,"localImagePaths":939,"remoteImagePaths":940,"frontmatter":941,"imagePaths":943},[904,905,907,909,910,912,914,916,918,920,921,924,927,929,931,934,936,938],{"depth":283,"slug":27,"text":27},{"depth":283,"slug":906,"text":906},"技术栈",{"depth":283,"slug":908,"text":908},"整体思路",{"depth":26,"slug":29,"text":29},{"depth":26,"slug":911,"text":911},"实现思路",{"depth":81,"slug":913,"text":913},"运势生成",{"depth":81,"slug":915,"text":915},"前后端通信",{"depth":26,"slug":917,"text":917},"工程架构",{"depth":283,"slug":919,"text":919},"小程序端",{"depth":283,"slug":273,"text":273},{"depth":26,"slug":922,"text":923},"gpt服务","GPT服务",{"depth":81,"slug":925,"text":926},"调用gpt模型","调用GPT模型",{"depth":81,"slug":928,"text":928},"消息队列",{"depth":81,"slug":930,"text":930},"数据库",{"depth":26,"slug":932,"text":933},"koa服务","Koa服务",{"depth":81,"slug":935,"text":935},"开始查询",{"depth":81,"slug":937,"text":937},"查询结果",{"depth":283,"slug":262,"text":262},[],[],{"title":893,"pubDate":942,"category":895,"excerpt":896},["Date","2023-02-16T20:30:25.000Z"],[],"摸鱼小技巧一个chrome插件把网页变成拼图游戏",{"id":944,"data":946,"body":950,"filePath":951,"digest":952,"rendered":953},{"title":947,"pubDate":948,"category":33,"excerpt":949},"摸鱼小技巧——一个chrome插件把网页变成拼图游戏",["Date","2021-12-04T21:40:27.000Z"],"开发一个有趣的Chrome插件，给紧张的工作增加一些乐趣。。。","# 前言\n前一阵子一直在忙双十一，空余时间去学了一些图形学的课（学了个半吊子），最近又开始了瞎折腾，也就又开始了随笔记录。\n\n先说一下做了个什么东西吧：开发了一个chrome插件，在chrome打开任意一个**网页**的时候，你可以点击插件的图标，并把网页变成一个拼图游戏，原来的网页会被隐藏；当你正确的复原拼图时，页面复原。\n\n# 效果\n本来想录个视频随便加个字幕，然后忘了Pr怎么用，突然想起来b站有个云剪辑，就随便剪了一下发了上去，反正常年0播放，把b站当成个存视频的地方也不错。（吐槽一下这个云剪辑好像有bug，比如每次撤销的时候项目中的文字都会跑到默认位置去）\n\n\u003Ciframe src=\"//player.bilibili.com/player.html?aid=719530466&bvid=BV18Q4y1i7Ex&cid=454758362&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> \u003C/iframe>\n\n# 原理\n主要涉及到的技术有两个，其一是Chrome插件的开发，这个就按照官方文档提供的规范开发即可。其二是为了将网页转化为游戏，直接使用canvas的API也太要命了，需要用到游戏引擎，这里使用了[Eva.js](https://eva.js.org/)。接下来先来看一下如何去开发一个Chrome插件~\n\n## Chrome插件开发概述\n每一个Chrome插件都有一个manifest.json文件，它记录着关于这个插件的一系列信息，以这次开发的插件为例：\n``` json\n{\n  \"name\": \"Frozen Blocks\",\n  \"description\": \"Reset the blocks to unfreeze your website!\",\n  \"version\": \"1.0.0\",\n  \"manifest_version\": 3,\n  \"permissions\": [\n    \"storage\",\n    \"tabs\",\n    \"activeTab\",\n    \"contextMenus\",\n    \"scripting\"\n  ],\n  \"host_permissions\": [\n    \"*://*/*\"\n  ],\n  \"action\": {\n    \"default_icon\": \"favicon.png\",\n    \"default_title\": \"来点我一下试试啊\"\n  },\n  \"background\": {\n      \"service_worker\": \"background.js\"\n  }\n}\n\n```\n其中，name标记着插件的名字，description是插件的说明；version表示插件的版本号；manifest_version表示这个json文件的版本，可选项有2和3，其中版本2的json格式（比如service_worker）和版本3有区别，除此之外，对一些比如说加载外部js文件的处理也不相同。尽管目前看上去，现有的插件都是以版本2为主，但是我还是用3来试试水。permissions里面记录着插件需要的权限，这里用到了五个，包括存储（需要存储游戏的难度状态）、标签页、当前标签页（插件在所有标签页都会生效，需要获取当前标签页的截图来生成拼图）、contextMenus（需要点击右键设置难度）、scripting（游戏逻辑需要编辑脚本）；host_permissions表示在符合匹配的url中会请求额外的权限，这里的这个pattern表示全部的url。action中包括了插件的默认图标、悬浮在插件时的提示信息等基本操作。接下来是重头戏了：background的service_worker中记录着一个脚本（也就是我这里声明的background.js），它会在后台全局执行，也就是在这里，我们处理了和插件有关的所有交互。\n\n在background.js中，我们需要做如下事情：\n\n1. 绑定右键菜单，用于选择难度\n2. 左键单击插件时，执行脚本。\n\ntodo...","src/content/posts/摸鱼小技巧——一个chrome插件把网页变成拼图游戏.md","b324cad73b339b38",{"html":954,"metadata":955},"\u003Ch1 id=\"前言\">前言\u003C/h1>\n\u003Cp>前一阵子一直在忙双十一，空余时间去学了一些图形学的课（学了个半吊子），最近又开始了瞎折腾，也就又开始了随笔记录。\u003C/p>\n\u003Cp>先说一下做了个什么东西吧：开发了一个chrome插件，在chrome打开任意一个\u003Cstrong>网页\u003C/strong>的时候，你可以点击插件的图标，并把网页变成一个拼图游戏，原来的网页会被隐藏；当你正确的复原拼图时，页面复原。\u003C/p>\n\u003Ch1 id=\"效果\">效果\u003C/h1>\n\u003Cp>本来想录个视频随便加个字幕，然后忘了Pr怎么用，突然想起来b站有个云剪辑，就随便剪了一下发了上去，反正常年0播放，把b站当成个存视频的地方也不错。（吐槽一下这个云剪辑好像有bug，比如每次撤销的时候项目中的文字都会跑到默认位置去）\u003C/p>\n\u003Ciframe src=\"//player.bilibili.com/player.html?aid=719530466&#x26;bvid=BV18Q4y1i7Ex&#x26;cid=454758362&#x26;page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> \u003C/iframe>\n\u003Ch1 id=\"原理\">原理\u003C/h1>\n\u003Cp>主要涉及到的技术有两个，其一是Chrome插件的开发，这个就按照官方文档提供的规范开发即可。其二是为了将网页转化为游戏，直接使用canvas的API也太要命了，需要用到游戏引擎，这里使用了\u003Ca href=\"https://eva.js.org/\">Eva.js\u003C/a>。接下来先来看一下如何去开发一个Chrome插件~\u003C/p>\n\u003Ch2 id=\"chrome插件开发概述\">Chrome插件开发概述\u003C/h2>\n\u003Cp>每一个Chrome插件都有一个manifest.json文件，它记录着关于这个插件的一系列信息，以这次开发的插件为例：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"json\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"name\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Frozen Blocks\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"description\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Reset the blocks to unfreeze your website!\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"version\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"1.0.0\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"manifest_version\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"permissions\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"storage\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"tabs\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"activeTab\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"contextMenus\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"scripting\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  ],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"host_permissions\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"*://*/*\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  ],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"action\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    \"default_icon\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"favicon.png\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    \"default_title\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"来点我一下试试啊\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"background\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"service_worker\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"background.js\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>其中，name标记着插件的名字，description是插件的说明；version表示插件的版本号；manifest_version表示这个json文件的版本，可选项有2和3，其中版本2的json格式（比如service_worker）和版本3有区别，除此之外，对一些比如说加载外部js文件的处理也不相同。尽管目前看上去，现有的插件都是以版本2为主，但是我还是用3来试试水。permissions里面记录着插件需要的权限，这里用到了五个，包括存储（需要存储游戏的难度状态）、标签页、当前标签页（插件在所有标签页都会生效，需要获取当前标签页的截图来生成拼图）、contextMenus（需要点击右键设置难度）、scripting（游戏逻辑需要编辑脚本）；host_permissions表示在符合匹配的url中会请求额外的权限，这里的这个pattern表示全部的url。action中包括了插件的默认图标、悬浮在插件时的提示信息等基本操作。接下来是重头戏了：background的service_worker中记录着一个脚本（也就是我这里声明的background.js），它会在后台全局执行，也就是在这里，我们处理了和插件有关的所有交互。\u003C/p>\n\u003Cp>在background.js中，我们需要做如下事情：\u003C/p>\n\u003Col>\n\u003Cli>绑定右键菜单，用于选择难度\u003C/li>\n\u003Cli>左键单击插件时，执行脚本。\u003C/li>\n\u003C/ol>\n\u003Cp>todo…\u003C/p>",{"headings":956,"localImagePaths":965,"remoteImagePaths":966,"frontmatter":967,"imagePaths":969},[957,958,960,962],{"depth":283,"slug":27,"text":27},{"depth":283,"slug":959,"text":959},"效果",{"depth":283,"slug":961,"text":961},"原理",{"depth":26,"slug":963,"text":964},"chrome插件开发概述","Chrome插件开发概述",[],[],{"title":947,"pubDate":968,"category":33,"excerpt":949},["Date","2021-12-04T21:40:27.000Z"],[],"毕设论文定时备份脚本",{"id":970,"data":972,"body":975,"filePath":976,"digest":977,"rendered":978},{"title":970,"pubDate":973,"category":895,"excerpt":974},["Date","2021-03-20T12:11:25.000Z"],"毕设论文自动备份的batch脚本","最近一直在搞毕设论文，在gitee上边建了一个私有仓库，然后每天把毕设论文推送上去，这样子省的万一什么时候电脑gg了不至于数据全都丢了。但是有的时候会忘记同步，因此就写了个小脚本每天定时的去同步一下。\n\n---\n\n# 原理\n因为每次提交其实就只是重复的执行git指令：\n``` batchfile\ngit add .\ngit commit -m \"message\"\ngit push\n```\n\n所以只需要写一段批处理脚本让它可以执行这几个命令，再将这些命令定时执行就好了。\n\n在windows系统中，已经提供了定时执行任务的功能（直接搜任务计划程序）：\n![定时任务](http://imgs.maotoumao.xyz/dingshirenwu.png)\n它可以使得程序在某个特定条件被触发的时候执行。\n\n# 批处理脚本\n首先新建一个配置文件config.ini，用来存放本地路径和远程仓库的地址：\n``` ini\nREMOTE_PATH=远程git仓库的地址\nLOCAL_PATH=本地论文所在文件夹的路径\n```\n接下来新建一个批处理文件auto-backup.cmd:\n``` batchfile\n@echo off\nchcp 65001\n\nfor /f \"tokens=1,2 delims==\" %%i in (%~dp0/config.ini) do (\n    set %%i=%%j\n)\n\necho %REMOTE_PATH%\ncd /d %LOCAL_PATH%\n\nif exist ./.git (\n    git add .\n    git commit -m \"备份: %date%\"\n    git push origin master\n) else (\n    git init\n    git add .\n    git commit -m \"初始化\"\n    git remote add origin %REMOTE_PATH%\n    git push -u origin master\n)\n\necho done\n```\n这段脚本首先将字符集编码设置成了UTF-8编码（不然中文会乱码），接下来读取了配置文件的参数，最后判断本地论文路径是否存在git仓库，如果有的话，就进行提交，如果没有的话，就新建一个git仓库。它可以帮我们完成自动提交的命令，接下来只需要设置定时执行这段脚本了。编写完成后，可以先双击执行测试一下。一般情况下是可以正常执行的。\n\n# 设置定时执行\n在任务计划程序的窗口中点击右侧创建基本任务，就可以创建一个计划任务：\n![创建基本任务](http://imgs.maotoumao.xyz/chuangjian.png)\n\n触发器指的是任务执行的条件，在这里设置一个定时时间就好了：\n![触发器](http://imgs.maotoumao.xyz/chufaqi.png)\n\n![触发器](http://imgs.maotoumao.xyz/chufaqi-time.png)\n\n接下来设置一下触发器被触发时的操作，我们这里就是启动程序，并把脚本的路径复制进去就好了：\n![操作](http://imgs.maotoumao.xyz/caozuo.png)\n![程序](http://imgs.maotoumao.xyz/jiaobenscript.png)\n\n最后是完成。完成之后，点击任务计划程序库，就可以看到刚才添加的任务了：\n![完成](http://imgs.maotoumao.xyz/dingshirenwuku.png)\n\n这样就再也不怕忘记备份论文啦：\n![结果](http://imgs.maotoumao.xyz/jieguo.png)\n\n---\n[github地址](https://github.com/maotoumao/thesis-auto-backup)\n\n[gitee地址](https://gitee.com/maotoumao/thesis-auto-backup)","src/content/posts/毕设论文定时备份脚本.md","201e0a04b3309852",{"html":979,"metadata":980},"\u003Cp>最近一直在搞毕设论文，在gitee上边建了一个私有仓库，然后每天把毕设论文推送上去，这样子省的万一什么时候电脑gg了不至于数据全都丢了。但是有的时候会忘记同步，因此就写了个小脚本每天定时的去同步一下。\u003C/p>\n\u003Chr>\n\u003Ch1 id=\"原理\">原理\u003C/h1>\n\u003Cp>因为每次提交其实就只是重复的执行git指令：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>git add .\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>git commit -m \"message\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>git push\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>所以只需要写一段批处理脚本让它可以执行这几个命令，再将这些命令定时执行就好了。\u003C/p>\n\u003Cp>在windows系统中，已经提供了定时执行任务的功能（直接搜任务计划程序）：\n\u003Cimg src=\"http://imgs.maotoumao.xyz/dingshirenwu.png\" alt=\"定时任务\">\n它可以使得程序在某个特定条件被触发的时候执行。\u003C/p>\n\u003Ch1 id=\"批处理脚本\">批处理脚本\u003C/h1>\n\u003Cp>首先新建一个配置文件config.ini，用来存放本地路径和远程仓库的地址：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ini\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">REMOTE_PATH\u003C/span>\u003Cspan style=\"color:#E1E4E8\">=远程git仓库的地址\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">LOCAL_PATH\u003C/span>\u003Cspan style=\"color:#E1E4E8\">=本地论文所在文件夹的路径\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>接下来新建一个批处理文件auto-backup.cmd:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>@echo off\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>chcp 65001\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>for /f \"tokens=1,2 delims==\" %%i in (%~dp0/config.ini) do (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    set %%i=%%j\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>echo %REMOTE_PATH%\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>cd /d %LOCAL_PATH%\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>if exist ./.git (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    git add .\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    git commit -m \"备份: %date%\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    git push origin master\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>) else (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    git init\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    git add .\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    git commit -m \"初始化\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    git remote add origin %REMOTE_PATH%\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    git push -u origin master\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>echo done\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>这段脚本首先将字符集编码设置成了UTF-8编码（不然中文会乱码），接下来读取了配置文件的参数，最后判断本地论文路径是否存在git仓库，如果有的话，就进行提交，如果没有的话，就新建一个git仓库。它可以帮我们完成自动提交的命令，接下来只需要设置定时执行这段脚本了。编写完成后，可以先双击执行测试一下。一般情况下是可以正常执行的。\u003C/p>\n\u003Ch1 id=\"设置定时执行\">设置定时执行\u003C/h1>\n\u003Cp>在任务计划程序的窗口中点击右侧创建基本任务，就可以创建一个计划任务：\n\u003Cimg src=\"http://imgs.maotoumao.xyz/chuangjian.png\" alt=\"创建基本任务\">\u003C/p>\n\u003Cp>触发器指的是任务执行的条件，在这里设置一个定时时间就好了：\n\u003Cimg src=\"http://imgs.maotoumao.xyz/chufaqi.png\" alt=\"触发器\">\u003C/p>\n\u003Cp>\u003Cimg src=\"http://imgs.maotoumao.xyz/chufaqi-time.png\" alt=\"触发器\">\u003C/p>\n\u003Cp>接下来设置一下触发器被触发时的操作，我们这里就是启动程序，并把脚本的路径复制进去就好了：\n\u003Cimg src=\"http://imgs.maotoumao.xyz/caozuo.png\" alt=\"操作\">\n\u003Cimg src=\"http://imgs.maotoumao.xyz/jiaobenscript.png\" alt=\"程序\">\u003C/p>\n\u003Cp>最后是完成。完成之后，点击任务计划程序库，就可以看到刚才添加的任务了：\n\u003Cimg src=\"http://imgs.maotoumao.xyz/dingshirenwuku.png\" alt=\"完成\">\u003C/p>\n\u003Cp>这样就再也不怕忘记备份论文啦：\n\u003Cimg src=\"http://imgs.maotoumao.xyz/jieguo.png\" alt=\"结果\">\u003C/p>\n\u003Chr>\n\u003Cp>\u003Ca href=\"https://github.com/maotoumao/thesis-auto-backup\">github地址\u003C/a>\u003C/p>\n\u003Cp>\u003Ca href=\"https://gitee.com/maotoumao/thesis-auto-backup\">gitee地址\u003C/a>\u003C/p>",{"headings":981,"localImagePaths":987,"remoteImagePaths":988,"frontmatter":989,"imagePaths":991},[982,983,985],{"depth":283,"slug":961,"text":961},{"depth":283,"slug":984,"text":984},"批处理脚本",{"depth":283,"slug":986,"text":986},"设置定时执行",[],[],{"title":970,"pubDate":990,"category":895,"excerpt":974},["Date","2021-03-20T12:11:25.000Z"],[],"用chatgpt和ai绘画做一个微信小程序",{"id":992,"data":994,"body":998,"filePath":999,"digest":1000,"rendered":1001},{"title":995,"pubDate":996,"category":33,"excerpt":997},"用ChatGPT和AI绘画做一个微信小程序",["Date","2023-02-20T22:21:46.000Z"],"简单的想法记录。","# 前言\r\n题目或许有些标题党，先大概交代一下上下文吧。一周多前用ChatGPT做了一个AI算命的微信小程序：“赛博运势丨AI测命理”。后来觉得似乎有点单调，差点意思。于是趁周末又加了一个**每日运势**的小功能。这个小功能在**ChatGPT**和**AI绘画程序MidJourney**的帮助下，花费两天时间就做的差不多了。这里还是大概总结一下过程，然后记录一些想法，大概是关于这些工具能给个人开发者带来什么样的加成。（个人总结向）\r\n\r\n正式开始之前，先猜猜看下边成品图中哪些部分和ChatGPT或者AI绘画有关吧：  \r\n\r\n![](https://i.328888.xyz/2023/02/20/XuKKx.jpeg)\r\n\r\n应该还是比较明显的，除了年份、今日运势这几个字以外，其他部分的**文案和设计**都和ChatGPT/AI绘画有关。我想先从个人工作流开始写起，一步步记录一下这些AI工具在整个小产品上线的过程中到底做了什么。\r\n\r\n# 个人工作流\r\n在公司里要做一个需求时，通常会纠集一批不同角色的人去讨论，搞各种各样的评审、写各种各样的文档。作为个人开发者来说，在这一方面还是非常自由的 —— 因为只有自己一个人。但在整个“产品”迭代上线的过程中，我们仍然会需要在不同的阶段扮演“产品经理、设计师、前端、后端、运营、测试”等不同的角色。以这次做的“每日运势”小需求为例（只是示意，不一定严格按下边的顺序）：\r\n\r\n1. 最开始时需要**明确整体的需求**：想做一个每日运势，每天进来点一下可以看到当天的运势、幸运色、幸运数字，并且需要做出一些解释。（产品）\r\n\r\n2. 然后大概**设计一下要做成什么样子**：界面大概是个比较神秘又有点可爱的画风，因为毕竟是娱乐为主，所以色调不能太严肃。上半部分需要展示一个整体的运势，下半部分展示类似签文或者解释之类的东西（设计）\r\n\r\n3. 接下来想一想**文案怎么搞**：每日运势有4种，可以调整概率；幸运数字有10个，幸运颜色有几十个，它们对应的签文或者解签的文案都是可能会在后期不断的添加。（产品&运营）\r\n\r\n4. 整体设计的差不多了，接下来看看**界面怎么写**：在Pixso/Figma/PhotoShop上简单比划几下，然后想想页面拆分和模块设计，在哪调接口怎么存数据之类的。（前端&设计）\r\n\r\n5. 前端好像做的差不多了，想一想**数据要怎么处理**吧：写几个接口，组织一下数据存到数据库/redis。UV没几个，凑合过吧。（后端）\r\n\r\n6. 试试看**功能有没有坏**：好像没有专门的测试阶段，因为在开发的过程中已经在顺便测试了。（测试）\r\n\r\n以上过程每个阶段都还是比较占时间的。对于部分个人开发者的业余项目来说，可能在实际做的时候，流程就变成了：\r\n\r\n1. 冒出个好玩点子！\r\n2. 想想具体做成啥样，周末去做一下。\r\n3. 设计成啥样呢，怎么配色都不好看，画的图也又土又丑...\r\n4. 画图就画了两三个小时，还是没改好。。。算了，功能优先...\r\n5. 要这么多文案，百度直接抄好像也不太好... 那还是写个爬虫爬一下吧，不过也不是原创的...\r\n6. 写个自己都嫌弃的前端，再写个自己都嫌弃的后端，甚至还没来得及写完一个周末就过去了\r\n7. 算了，不做了。。。\r\n\r\n但现在，有了ChatGPT和AI绘画模型的帮助，中间的某些阶段或许可以稍微简化一点，或者少浪费一点时间、少费点脑子。回到最初的目标，需求已经明确了，接下来想一想要界面要长什么样子。\r\n\r\n\r\n# 设计：AI绘画\r\n## 过程\r\n这里直接说是怎么用的了。我的想法是：界面需要比较神秘又有点可爱的画风，不要太严肃。由于是每日运势，所以界面可以长得像个日历。简单翻译一下给几个关键词：\r\n```\r\nGenerate a cute anime style daily calendar UI, Mystical\r\n```\r\n把这段Prompt喂给AI绘画程序（这里用的是MidJourney网站），然后我们就可以去做别的事情了（比如其他和设计阶段无关的事情）。过了一会就给出了一些候选项：\r\n\r\n![](https://i.328888.xyz/2023/02/20/giTHv.md.png)\r\n\r\n看上去都还是比较符合预期风格的，**做背景图**比较合适，并且**配色**也都比较完美（比我自己瞎写的好多了..）。由于最终的页面上需要展示比较多的元素，因此需要背景图中有**多一些的空白区域**。因此最终选择了**主体形象最小**的右上角图，尽管这个猫有三只耳朵。接下来就可以根据这张缩略图生成一张1024x1536的大图了：\r\n\r\n![](https://i.328888.xyz/2023/02/20/gViAF.png)\r\n\r\n从这张图中我们可以得出以下信息：\r\n1. 图中上半部分含义不明的**文字部分**可以**抹去**，变成我们自己的UI区域，用来放一些文字信息；下半部分颜色太杂，就用一个**模糊遮罩**盖住；这样我们就有了三大块文字区域；\r\n2. **文字颜色**可以用#F5BB9B或#835B5B（直接取图中的色号）；\r\n3. 为了让内容区域大一些，需要做一些**裁剪**；\r\n4. 需要稍微修剪一下猫耳朵。\r\n\r\n\r\n接下来就比较省事了：\r\n- 1、4用PhotoShop搞定（相对来说，要抹去或者修剪的部分以纯色为主，并且删总是比添快的）\r\n- 接下来导出图片，直接拖到Pixso里面，并建一个750x1624的画板，发现放上去内容区域正好差不多够，于是3搞定。\r\n- 最后打两行文本，画一个带透明度和模糊的圆角矩形，简单的设计稿就做完了：\r\n\r\n![](https://i.328888.xyz/2023/02/21/gVHiV.png)\r\n\r\n除此之外，一些素材也可以用AI绘画+AI抠图搞定，比如生成一些神秘的筒筒：\r\n![gzfsV.png](https://i.328888.xyz/2023/02/21/gzfsV.png)\r\n\r\n## 总结\r\n- 速度：从拿到AI画的图，到最终做完一个简单的视觉稿，加起来不过十几分钟。\r\n- 效率：对于个人项目来说，可以轻轻松松拿到一个**无版权风险的、低重复的、符合想象的底图**；并且可以**直接根据底图获取到合适的配色**。  \r\n\r\n以上这两点足以增加个人项目的精美度、减少个人在这种不擅长的事情上浪费的时间。反正不管怎么说，给我一个星期我也画不出来这样的背景图。\r\n\r\n\r\n# 文案：ChatGPT\r\n## 实时调用与离线数据\r\n这个小程序的另一半功能：AI测运势，是直接**实时调用**的ChatGPT的API。具体可以看[上一篇文章](https://juejin.cn/post/7200773486795718693)。调这个API其实还是有很多限制的：比如每个key每秒请求数、每秒token数等，如果要用它做一些小服务之类的，要么给OpenAI氪金（充钱限制会少一点），要么给验证码收发平台氪金（多申请几个账号做账号池）。但无论哪种，速度都比较慢。  \r\n\r\n但是如果我们需要的数据是**离线**的，使用ChatGPT的成本似乎会更低一些：如果把它当作一个拥有很强的创造力，并且大多数情况下会给出正确答案的“百科全书” —— 我们可以用它**预先生成**大量的数据存储起来，然后接下来对ChatGPT创作出来的“素材仓库”做文字游戏。最重要的是，我们可以调教它生成**特定结构的文本**，这可以大大减少后续处理花费的时间。\r\n\r\n## 批量生成离线数据\r\n还是以这次的小程序为例。我需要大量的签文以及不同幸运数字、不同幸运色的解释文案。恰好以前做过类似的需求，可以对比一下：\r\n\r\n如果用人工配置，会需要花费至少**1天**的时间引经据典搜集文案，并把这些批量添加到配置平台中去。而这些搜索到的文案也往往**受限于我们的“想象力”** —— 因为我们的搜索结果肯定是和我们的输入相关，甚至最后搜不出来用比较尬的文案凑上。\r\n\r\n对于类似这样的事情，ChatGPT可以很好的辅助解决。比如对于生成幸运色的文案，我们可以这样问：（总共有55种幸运颜色，每个颜色都需要>10条文案）\r\n\r\n```\r\n假如你是一个算命先生，请帮我测算一下我今天的幸运色，并进行详细的解析。候选颜色有：天蓝、米白、金黄、粉红。你的回答需要以“今天的幸运色是……；它代表着……”为开头。请开始吧。\r\n```\r\nChatGPT会对此给出一段十分规整的回答：\r\n![](https://i.328888.xyz/2023/02/21/gxGVX.png)\r\n\r\n接下来就好办了：只需要一段循环、一段正则：\r\n```javascript\r\nimport fetch from \"node-fetch\";\r\nimport fs from 'fs/promises';\r\nimport path from 'path';\r\nimport { ChatGPTAPI } from \"chatgpt\";\r\nimport { fileURLToPath } from \"url\";\r\n\r\nconst chatgpt = new ChatGPTAPI({\r\n    apiKey: YOUR_API_KEY,\r\n    fetch\r\n});\r\n\r\nconst allColors = ['星灰', '玫瑰灰', '枫红','樱草紫', '冰山蓝', '月影白', ...]; // 略过了\r\n\r\n/** 循环生成文案 **/\r\nasync function query(){\r\n    for(let color of allColors) {\r\n        // 每个颜色生成15条文案\r\n        for(let i = 0; i \u003C 15; ++i) {\r\n            try {\r\n                const color = allColors[i];\r\n                const result = await chatgpt.sendMessage(`假如你是一个算命先生，请帮我测算一下我今天的幸运色，并进行详细的解析。候选颜色有：${color}。你的回答需要以“今天的幸运色是……；它代表着……”为开头。请开始吧。`, {\r\n                    promptPrefix: ' ',\r\n                    promptSuffix: ' '\r\n                });\r\n                \r\n                // 写入文件，略过了\r\n\r\n            } catch {\r\n\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/** 处理文案 **/\r\nasync function handle(){\r\n    // 读入文件，略过了\r\n    const raw = await fs.readFile('xxx', 'utf-8');\r\n    const [_, _colorName, _colorDesc] = raw.match(/今天你的幸运色是(.+?)色?[；，;。](.*)/) ?? [];\r\n\r\n    // 还可以做一些简单的正则替换，比如把两个字的XX替换为XX色\r\n    const format = (n) => n.length === 2 ? n + '色' : n;\r\n    let colorDesc = _colorDesc.replace(new RegExp(`${_colorName}(?!色)`, 'g'), format(_colorName));\r\n\r\n    // 保存文件 略过了\r\n}\r\n```\r\n\r\n需要注意的是，如果给定一系列的候选颜色，那ChatGPT的回复结果**不是均匀分布**的，而会是更倾向于其中的某一个或某几个颜色，我试了好几组，大概几百组数据（花掉了一个号的额度）都是如此。因此为了保证每个颜色都有足够的文案，直接把候选颜色设置成1个就可以精确控制了（也就是query函数中做的那样）。\r\n\r\n同时，为了省钱，其实还可以一次让ChatGPT多生成几条文案，无非是到时候我们正则匹配时候的规则变一变：\r\n\r\n![](https://i.328888.xyz/2023/02/21/geH1J.png)\r\n\r\n## 总结\r\n- 离线文本：ChatGPT可以**快速生成满足特定结构的文本**，这些文本可以被很方便地处理用于后续操作；\r\n- 不均匀：如果给定ChatGPT一系列（可能没有正确答案的）选项，它的回答的分布可能是**不均匀**的；\r\n- 批量：可以通过特定的用语诱导ChatGPT按照预期的行为回答，也可以一次生成**多条文案**。\r\n\r\n除了ChatGPT以外，顺带还试了一下New Bing，感觉被它拿捏的死死的...\r\n![](https://i.328888.xyz/2023/02/21/gembq.png)\r\n\r\n\r\n# 开发\r\n相对来说，以上两节中提到的内容和开发阶段对比，如果没有ChatGPT和MidJourney的帮助，花费的时间应该是差不多的。ChatGPT暂时在直接写项目代码方面可能还不太行，（比如某次我让问它一个css效果怎么实现，它告诉我用background-image: url图片...)  \r\n但如果把它当作除了google和stackoverflow以外的“第三种搜索引擎”，那效果还是很不错的，比如：\r\n\r\n![geuMA.png](https://i.328888.xyz/2023/02/21/geuMA.png)\r\n\r\n前端和后端的开发部分就普普通通了，和上次写的没啥区别，就正常的业务代码。简单写一些关于前端部分的小点：  \r\n1. 我们AI绘画生成的背景图顶部和底部都是比较规律的颜色，因此如果我们需要让这个页面的高度大于底图的高度，我们可以直接把背景图的底部裁下来一点，然后 background-repeat: repeat-y; 就可以把多出来的部分填满了。\r\n2. 尽管AI生成的图虽然不可以直接变成动图/视频，但是我们仍然可以通过一些简单的特效让它看起来好像有动画。比如上边生成的抽签筒素材，我们只需要简单的加个filter的动画就能营造出近似发光的效果：\r\n```\r\n@keyframes button-shine {\r\n    0% {\r\n      filter: brightness(0.9);\r\n    }\r\n    50% {\r\n      filter: brightness(1.3);\r\n    }\r\n    100% {\r\n      filter: brightness(0.9);\r\n    }\r\n}\r\n```\r\n\r\n![gztww.gif](https://i.328888.xyz/2023/02/21/gztww.gif)\r\n\r\n# 总结\r\n到这里就结束了。从这个小项目总结下来，体感上AI绘画可以在视觉上提供一些参考，比如背景图、配色；也可以生成一些素材；ChatGPT除了可以提供一些创意、当作搜索引擎之外，还可以辅助我们生成大量我们需要的文本素材。\r\n\r\n或许以后text2img还可以做text2ui；对于想做一些小游戏的个人开发者来说，这些工具还可以辅助直接生成想要的素材和背景；说不定以后还会有由AI制作的vtuber和galgame之类的吧。。。反正能降低自己折腾的成本的东西都是好东西~\r\n\r\n随便写写~ demo直接微信小程序搜“赛博运势丨AI测命理”，不贴二维码了~","src/content/posts/用ChatGPT和AI绘画做一个微信小程序.md","0d3ed0f13b57c58b",{"html":1002,"metadata":1003},"\u003Ch1 id=\"前言\">前言\u003C/h1>\n\u003Cp>题目或许有些标题党，先大概交代一下上下文吧。一周多前用ChatGPT做了一个AI算命的微信小程序：“赛博运势丨AI测命理”。后来觉得似乎有点单调，差点意思。于是趁周末又加了一个\u003Cstrong>每日运势\u003C/strong>的小功能。这个小功能在\u003Cstrong>ChatGPT\u003C/strong>和\u003Cstrong>AI绘画程序MidJourney\u003C/strong>的帮助下，花费两天时间就做的差不多了。这里还是大概总结一下过程，然后记录一些想法，大概是关于这些工具能给个人开发者带来什么样的加成。（个人总结向）\u003C/p>\n\u003Cp>正式开始之前，先猜猜看下边成品图中哪些部分和ChatGPT或者AI绘画有关吧：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/02/20/XuKKx.jpeg\" alt=\"\">\u003C/p>\n\u003Cp>应该还是比较明显的，除了年份、今日运势这几个字以外，其他部分的\u003Cstrong>文案和设计\u003C/strong>都和ChatGPT/AI绘画有关。我想先从个人工作流开始写起，一步步记录一下这些AI工具在整个小产品上线的过程中到底做了什么。\u003C/p>\n\u003Ch1 id=\"个人工作流\">个人工作流\u003C/h1>\n\u003Cp>在公司里要做一个需求时，通常会纠集一批不同角色的人去讨论，搞各种各样的评审、写各种各样的文档。作为个人开发者来说，在这一方面还是非常自由的 —— 因为只有自己一个人。但在整个“产品”迭代上线的过程中，我们仍然会需要在不同的阶段扮演“产品经理、设计师、前端、后端、运营、测试”等不同的角色。以这次做的“每日运势”小需求为例（只是示意，不一定严格按下边的顺序）：\u003C/p>\n\u003Col>\n\u003Cli>\n\u003Cp>最开始时需要\u003Cstrong>明确整体的需求\u003C/strong>：想做一个每日运势，每天进来点一下可以看到当天的运势、幸运色、幸运数字，并且需要做出一些解释。（产品）\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>然后大概\u003Cstrong>设计一下要做成什么样子\u003C/strong>：界面大概是个比较神秘又有点可爱的画风，因为毕竟是娱乐为主，所以色调不能太严肃。上半部分需要展示一个整体的运势，下半部分展示类似签文或者解释之类的东西（设计）\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>接下来想一想\u003Cstrong>文案怎么搞\u003C/strong>：每日运势有4种，可以调整概率；幸运数字有10个，幸运颜色有几十个，它们对应的签文或者解签的文案都是可能会在后期不断的添加。（产品&#x26;运营）\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>整体设计的差不多了，接下来看看\u003Cstrong>界面怎么写\u003C/strong>：在Pixso/Figma/PhotoShop上简单比划几下，然后想想页面拆分和模块设计，在哪调接口怎么存数据之类的。（前端&#x26;设计）\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>前端好像做的差不多了，想一想\u003Cstrong>数据要怎么处理\u003C/strong>吧：写几个接口，组织一下数据存到数据库/redis。UV没几个，凑合过吧。（后端）\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>试试看\u003Cstrong>功能有没有坏\u003C/strong>：好像没有专门的测试阶段，因为在开发的过程中已经在顺便测试了。（测试）\u003C/p>\n\u003C/li>\n\u003C/ol>\n\u003Cp>以上过程每个阶段都还是比较占时间的。对于部分个人开发者的业余项目来说，可能在实际做的时候，流程就变成了：\u003C/p>\n\u003Col>\n\u003Cli>冒出个好玩点子！\u003C/li>\n\u003Cli>想想具体做成啥样，周末去做一下。\u003C/li>\n\u003Cli>设计成啥样呢，怎么配色都不好看，画的图也又土又丑…\u003C/li>\n\u003Cli>画图就画了两三个小时，还是没改好。。。算了，功能优先…\u003C/li>\n\u003Cli>要这么多文案，百度直接抄好像也不太好… 那还是写个爬虫爬一下吧，不过也不是原创的…\u003C/li>\n\u003Cli>写个自己都嫌弃的前端，再写个自己都嫌弃的后端，甚至还没来得及写完一个周末就过去了\u003C/li>\n\u003Cli>算了，不做了。。。\u003C/li>\n\u003C/ol>\n\u003Cp>但现在，有了ChatGPT和AI绘画模型的帮助，中间的某些阶段或许可以稍微简化一点，或者少浪费一点时间、少费点脑子。回到最初的目标，需求已经明确了，接下来想一想要界面要长什么样子。\u003C/p>\n\u003Ch1 id=\"设计ai绘画\">设计：AI绘画\u003C/h1>\n\u003Ch2 id=\"过程\">过程\u003C/h2>\n\u003Cp>这里直接说是怎么用的了。我的想法是：界面需要比较神秘又有点可爱的画风，不要太严肃。由于是每日运势，所以界面可以长得像个日历。简单翻译一下给几个关键词：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>Generate a cute anime style daily calendar UI, Mystical\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>把这段Prompt喂给AI绘画程序（这里用的是MidJourney网站），然后我们就可以去做别的事情了（比如其他和设计阶段无关的事情）。过了一会就给出了一些候选项：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/02/20/giTHv.md.png\" alt=\"\">\u003C/p>\n\u003Cp>看上去都还是比较符合预期风格的，\u003Cstrong>做背景图\u003C/strong>比较合适，并且\u003Cstrong>配色\u003C/strong>也都比较完美（比我自己瞎写的好多了..）。由于最终的页面上需要展示比较多的元素，因此需要背景图中有\u003Cstrong>多一些的空白区域\u003C/strong>。因此最终选择了\u003Cstrong>主体形象最小\u003C/strong>的右上角图，尽管这个猫有三只耳朵。接下来就可以根据这张缩略图生成一张1024x1536的大图了：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/02/20/gViAF.png\" alt=\"\">\u003C/p>\n\u003Cp>从这张图中我们可以得出以下信息：\u003C/p>\n\u003Col>\n\u003Cli>图中上半部分含义不明的\u003Cstrong>文字部分\u003C/strong>可以\u003Cstrong>抹去\u003C/strong>，变成我们自己的UI区域，用来放一些文字信息；下半部分颜色太杂，就用一个\u003Cstrong>模糊遮罩\u003C/strong>盖住；这样我们就有了三大块文字区域；\u003C/li>\n\u003Cli>\u003Cstrong>文字颜色\u003C/strong>可以用#F5BB9B或#835B5B（直接取图中的色号）；\u003C/li>\n\u003Cli>为了让内容区域大一些，需要做一些\u003Cstrong>裁剪\u003C/strong>；\u003C/li>\n\u003Cli>需要稍微修剪一下猫耳朵。\u003C/li>\n\u003C/ol>\n\u003Cp>接下来就比较省事了：\u003C/p>\n\u003Cul>\n\u003Cli>1、4用PhotoShop搞定（相对来说，要抹去或者修剪的部分以纯色为主，并且删总是比添快的）\u003C/li>\n\u003Cli>接下来导出图片，直接拖到Pixso里面，并建一个750x1624的画板，发现放上去内容区域正好差不多够，于是3搞定。\u003C/li>\n\u003Cli>最后打两行文本，画一个带透明度和模糊的圆角矩形，简单的设计稿就做完了：\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/02/21/gVHiV.png\" alt=\"\">\u003C/p>\n\u003Cp>除此之外，一些素材也可以用AI绘画+AI抠图搞定，比如生成一些神秘的筒筒：\r\n\u003Cimg src=\"https://i.328888.xyz/2023/02/21/gzfsV.png\" alt=\"gzfsV.png\">\u003C/p>\n\u003Ch2 id=\"总结\">总结\u003C/h2>\n\u003Cul>\n\u003Cli>速度：从拿到AI画的图，到最终做完一个简单的视觉稿，加起来不过十几分钟。\u003C/li>\n\u003Cli>效率：对于个人项目来说，可以轻轻松松拿到一个\u003Cstrong>无版权风险的、低重复的、符合想象的底图\u003C/strong>；并且可以\u003Cstrong>直接根据底图获取到合适的配色\u003C/strong>。\u003C/li>\n\u003C/ul>\n\u003Cp>以上这两点足以增加个人项目的精美度、减少个人在这种不擅长的事情上浪费的时间。反正不管怎么说，给我一个星期我也画不出来这样的背景图。\u003C/p>\n\u003Ch1 id=\"文案chatgpt\">文案：ChatGPT\u003C/h1>\n\u003Ch2 id=\"实时调用与离线数据\">实时调用与离线数据\u003C/h2>\n\u003Cp>这个小程序的另一半功能：AI测运势，是直接\u003Cstrong>实时调用\u003C/strong>的ChatGPT的API。具体可以看\u003Ca href=\"https://juejin.cn/post/7200773486795718693\">上一篇文章\u003C/a>。调这个API其实还是有很多限制的：比如每个key每秒请求数、每秒token数等，如果要用它做一些小服务之类的，要么给OpenAI氪金（充钱限制会少一点），要么给验证码收发平台氪金（多申请几个账号做账号池）。但无论哪种，速度都比较慢。\u003C/p>\n\u003Cp>但是如果我们需要的数据是\u003Cstrong>离线\u003C/strong>的，使用ChatGPT的成本似乎会更低一些：如果把它当作一个拥有很强的创造力，并且大多数情况下会给出正确答案的“百科全书” —— 我们可以用它\u003Cstrong>预先生成\u003C/strong>大量的数据存储起来，然后接下来对ChatGPT创作出来的“素材仓库”做文字游戏。最重要的是，我们可以调教它生成\u003Cstrong>特定结构的文本\u003C/strong>，这可以大大减少后续处理花费的时间。\u003C/p>\n\u003Ch2 id=\"批量生成离线数据\">批量生成离线数据\u003C/h2>\n\u003Cp>还是以这次的小程序为例。我需要大量的签文以及不同幸运数字、不同幸运色的解释文案。恰好以前做过类似的需求，可以对比一下：\u003C/p>\n\u003Cp>如果用人工配置，会需要花费至少\u003Cstrong>1天\u003C/strong>的时间引经据典搜集文案，并把这些批量添加到配置平台中去。而这些搜索到的文案也往往\u003Cstrong>受限于我们的“想象力”\u003C/strong> —— 因为我们的搜索结果肯定是和我们的输入相关，甚至最后搜不出来用比较尬的文案凑上。\u003C/p>\n\u003Cp>对于类似这样的事情，ChatGPT可以很好的辅助解决。比如对于生成幸运色的文案，我们可以这样问：（总共有55种幸运颜色，每个颜色都需要>10条文案）\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>假如你是一个算命先生，请帮我测算一下我今天的幸运色，并进行详细的解析。候选颜色有：天蓝、米白、金黄、粉红。你的回答需要以“今天的幸运色是……；它代表着……”为开头。请开始吧。\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>ChatGPT会对此给出一段十分规整的回答：\r\n\u003Cimg src=\"https://i.328888.xyz/2023/02/21/gxGVX.png\" alt=\"\">\u003C/p>\n\u003Cp>接下来就好办了：只需要一段循环、一段正则：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fetch \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"node-fetch\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fs \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'fs/promises'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> path \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'path'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { ChatGPTAPI } \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"chatgpt\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { fileURLToPath } \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"url\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> chatgpt\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> new\u003C/span>\u003Cspan style=\"color:#B392F0\"> ChatGPTAPI\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    apiKey: \u003C/span>\u003Cspan style=\"color:#79B8FF\">YOUR_API_KEY\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    fetch\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">});\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> allColors\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'星灰'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'玫瑰灰'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'枫红'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'樱草紫'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'冰山蓝'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'月影白'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">...\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]; \u003C/span>\u003Cspan style=\"color:#6A737D\">// 略过了\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/** 循环生成文案 **/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">async\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> query\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> color \u003C/span>\u003Cspan style=\"color:#F97583\">of\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> allColors) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // 每个颜色生成15条文案\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        for\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; i \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 15\u003C/span>\u003Cspan style=\"color:#E1E4E8\">; \u003C/span>\u003Cspan style=\"color:#F97583\">++\u003C/span>\u003Cspan style=\"color:#E1E4E8\">i) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            try\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> color\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> allColors[i];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> result\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> chatgpt.\u003C/span>\u003Cspan style=\"color:#B392F0\">sendMessage\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">`假如你是一个算命先生，请帮我测算一下我今天的幸运色，并进行详细的解析。候选颜色有：${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">color\u003C/span>\u003Cspan style=\"color:#9ECBFF\">}。你的回答需要以“今天的幸运色是……；它代表着……”为开头。请开始吧。`\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    promptPrefix: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">' '\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    promptSuffix: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">' '\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                // 写入文件，略过了\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            } \u003C/span>\u003Cspan style=\"color:#F97583\">catch\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/** 处理文案 **/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">async\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> handle\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 读入文件，略过了\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> raw\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fs.\u003C/span>\u003Cspan style=\"color:#B392F0\">readFile\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'xxx'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'utf-8'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">_\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">_colorName\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">_colorDesc\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> raw.\u003C/span>\u003Cspan style=\"color:#B392F0\">match\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">/\u003C/span>\u003Cspan style=\"color:#DBEDFF\">今天你的幸运色是(\u003C/span>\u003Cspan style=\"color:#79B8FF\">.\u003C/span>\u003Cspan style=\"color:#F97583\">+?\u003C/span>\u003Cspan style=\"color:#DBEDFF\">)色\u003C/span>\u003Cspan style=\"color:#F97583\">?\u003C/span>\u003Cspan style=\"color:#79B8FF\">[；，;。]\u003C/span>\u003Cspan style=\"color:#DBEDFF\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">.\u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#DBEDFF\">)\u003C/span>\u003Cspan style=\"color:#9ECBFF\">/\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">??\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 还可以做一些简单的正则替换，比如把两个字的XX替换为XX色\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#B392F0\"> format\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">n\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> n.\u003C/span>\u003Cspan style=\"color:#79B8FF\">length\u003C/span>\u003Cspan style=\"color:#F97583\"> ===\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 2\u003C/span>\u003Cspan style=\"color:#F97583\"> ?\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> n \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> '色'\u003C/span>\u003Cspan style=\"color:#F97583\"> :\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> n;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> colorDesc \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> _colorDesc.\u003C/span>\u003Cspan style=\"color:#B392F0\">replace\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">new\u003C/span>\u003Cspan style=\"color:#B392F0\"> RegExp\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">`${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">_colorName\u003C/span>\u003Cspan style=\"color:#9ECBFF\">}(?!色)`\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'g'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">), \u003C/span>\u003Cspan style=\"color:#B392F0\">format\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(_colorName));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 保存文件 略过了\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>需要注意的是，如果给定一系列的候选颜色，那ChatGPT的回复结果\u003Cstrong>不是均匀分布\u003C/strong>的，而会是更倾向于其中的某一个或某几个颜色，我试了好几组，大概几百组数据（花掉了一个号的额度）都是如此。因此为了保证每个颜色都有足够的文案，直接把候选颜色设置成1个就可以精确控制了（也就是query函数中做的那样）。\u003C/p>\n\u003Cp>同时，为了省钱，其实还可以一次让ChatGPT多生成几条文案，无非是到时候我们正则匹配时候的规则变一变：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/02/21/geH1J.png\" alt=\"\">\u003C/p>\n\u003Ch2 id=\"总结-1\">总结\u003C/h2>\n\u003Cul>\n\u003Cli>离线文本：ChatGPT可以\u003Cstrong>快速生成满足特定结构的文本\u003C/strong>，这些文本可以被很方便地处理用于后续操作；\u003C/li>\n\u003Cli>不均匀：如果给定ChatGPT一系列（可能没有正确答案的）选项，它的回答的分布可能是\u003Cstrong>不均匀\u003C/strong>的；\u003C/li>\n\u003Cli>批量：可以通过特定的用语诱导ChatGPT按照预期的行为回答，也可以一次生成\u003Cstrong>多条文案\u003C/strong>。\u003C/li>\n\u003C/ul>\n\u003Cp>除了ChatGPT以外，顺带还试了一下New Bing，感觉被它拿捏的死死的…\r\n\u003Cimg src=\"https://i.328888.xyz/2023/02/21/gembq.png\" alt=\"\">\u003C/p>\n\u003Ch1 id=\"开发\">开发\u003C/h1>\n\u003Cp>相对来说，以上两节中提到的内容和开发阶段对比，如果没有ChatGPT和MidJourney的帮助，花费的时间应该是差不多的。ChatGPT暂时在直接写项目代码方面可能还不太行，（比如某次我让问它一个css效果怎么实现，它告诉我用background-image: url图片…)\u003Cbr>\n但如果把它当作除了google和stackoverflow以外的“第三种搜索引擎”，那效果还是很不错的，比如：\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/02/21/geuMA.png\" alt=\"geuMA.png\">\u003C/p>\n\u003Cp>前端和后端的开发部分就普普通通了，和上次写的没啥区别，就正常的业务代码。简单写一些关于前端部分的小点：\u003C/p>\n\u003Col>\n\u003Cli>我们AI绘画生成的背景图顶部和底部都是比较规律的颜色，因此如果我们需要让这个页面的高度大于底图的高度，我们可以直接把背景图的底部裁下来一点，然后 background-repeat: repeat-y; 就可以把多出来的部分填满了。\u003C/li>\n\u003Cli>尽管AI生成的图虽然不可以直接变成动图/视频，但是我们仍然可以通过一些简单的特效让它看起来好像有动画。比如上边生成的抽签筒素材，我们只需要简单的加个filter的动画就能营造出近似发光的效果：\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>@keyframes button-shine {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    0% {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>      filter: brightness(0.9);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    50% {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>      filter: brightness(1.3);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    100% {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>      filter: brightness(0.9);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cimg src=\"https://i.328888.xyz/2023/02/21/gztww.gif\" alt=\"gztww.gif\">\u003C/p>\n\u003Ch1 id=\"总结-2\">总结\u003C/h1>\n\u003Cp>到这里就结束了。从这个小项目总结下来，体感上AI绘画可以在视觉上提供一些参考，比如背景图、配色；也可以生成一些素材；ChatGPT除了可以提供一些创意、当作搜索引擎之外，还可以辅助我们生成大量我们需要的文本素材。\u003C/p>\n\u003Cp>或许以后text2img还可以做text2ui；对于想做一些小游戏的个人开发者来说，这些工具还可以辅助直接生成想要的素材和背景；说不定以后还会有由AI制作的vtuber和galgame之类的吧。。。反正能降低自己折腾的成本的东西都是好东西~\u003C/p>\n\u003Cp>随便写写~ demo直接微信小程序搜“赛博运势丨AI测命理”，不贴二维码了~\u003C/p>",{"headings":1004,"localImagePaths":1027,"remoteImagePaths":1028,"frontmatter":1029,"imagePaths":1031},[1005,1006,1008,1011,1013,1014,1017,1019,1021,1023,1025],{"depth":283,"slug":27,"text":27},{"depth":283,"slug":1007,"text":1007},"个人工作流",{"depth":283,"slug":1009,"text":1010},"设计ai绘画","设计：AI绘画",{"depth":26,"slug":1012,"text":1012},"过程",{"depth":26,"slug":262,"text":262},{"depth":283,"slug":1015,"text":1016},"文案chatgpt","文案：ChatGPT",{"depth":26,"slug":1018,"text":1018},"实时调用与离线数据",{"depth":26,"slug":1020,"text":1020},"批量生成离线数据",{"depth":26,"slug":1022,"text":262},"总结-1",{"depth":283,"slug":1024,"text":1024},"开发",{"depth":283,"slug":1026,"text":262},"总结-2",[],[],{"title":995,"pubDate":1030,"category":33,"excerpt":997},["Date","2023-02-20T22:21:46.000Z"],[],"设置阴阳师游戏为桌面壁纸",{"id":1032,"data":1034,"body":1037,"filePath":1038,"digest":1039,"rendered":1040},{"title":1032,"pubDate":1035,"category":33,"excerpt":1036},["Date","2021-12-18T22:52:32.000Z"],"Electron + rust把阴阳师小游戏设置成桌面壁纸。","咕咕咕。","src/content/posts/设置阴阳师游戏为桌面壁纸.md","dae52a9bd6cbc31f",{"html":1041,"metadata":1042},"\u003Cp>咕咕咕。\u003C/p>",{"headings":1043,"localImagePaths":1044,"remoteImagePaths":1045,"frontmatter":1046,"imagePaths":1048},[],[],[],{"title":1032,"pubDate":1047,"category":33,"excerpt":1036},["Date","2021-12-18T22:52:32.000Z"],[],"离职日记",{"id":1049,"data":1051,"body":1054,"filePath":1055,"digest":1056,"rendered":1057},{"title":1049,"pubDate":1052,"category":597,"excerpt":1053},["Date","2023-07-04T23:19:22.000Z"],"第一段工作经历结束了。","在一周之前，我的第一段工作结束了。曾经幻想过很多次要怎么写内网离职贴，为此观察了很久其他同事的写作风格。\r\n\r\n总体看来，离职贴有几种类型。第一种是“墓志铭型”，在帖子里详细地回顾自己职场生涯的起起伏伏，另加一些对自己来说有纪念意义的文字或者照片；\r\n\r\n第二种是“感恩戴德型”，风格主要是感谢公司，感谢老板，感谢同事；\r\n\r\n第三种是“慷慨陈词型”，把自己看到的问题说出来，一吐为快。这种帖子往往会容易引起大家的共鸣，很快上到热贴榜，然后又归于平静；\r\n\r\n第四种是“火力全开型”，工作中受了委屈，在离职前也就不怕撕破脸，这种帖子会被吃瓜群众火速顶起，然后高层火速介入，开展调查。不过自从之前某件事情之后，看起来吃瓜群众的态度也更倾向于“让子弹飞一会”了。\r\n\r\n最后一种离职贴简单粗暴：山高路远，江湖再见，加个微信。\r\n\r\n考虑了很久，秉承着好聚好散的原则，在内网写了一篇“抽象乐子人”风格的帖子。希望能给看到我的离职贴的前同事们带来点乐子，工作已经这么苦了，再不开心那就太惨了。\r\n\r\n除此之外，有些话也并不适合在内网说。今天是入职新公司的第一天，所以在这里随便写写，权当和过去告个别，然后开始新的生活。\r\n\r\n### 心态和思考\r\n\r\n先从个人感受开始，写点比较虚的吧。一直以来心态都不是很好，容易紧张或者陷入负面情绪，甚至自己 PUA 自己。不过在这两年经历的一些事情以及自己的一些胡思乱想中，反倒有了一些改变。\r\n\r\n不知道大家有没有玩过 2021 年淘宝的双十一互动游戏，玩法大概是丢喵糖抢地盘，那是我参与实际上线的第一个项目。上线第一天晚上值班的时候出了点小问题，我在值班室排查问题时手都在发抖。后来师兄告诉我说，不用这么紧张，遇到问题解决就是了。道理虽然简单，但那时候我才意识到，逃避和紧张都不是解决问题的办法。除非甩锅，不然该来的迟早是要来的。\r\n\r\n工作中的责任感和边界感是学校里难以体会到的，这也迫使我戴上假面，硬着头皮做一些事情，扮演一个“符合价值观”的“正面向上”的角色。虽然不喜欢，但那时候更追求别人口中的“完美”：所有事情都想要尽力做好，除此之外还要想办法做一些所谓的“沉淀”，以至于下班时间都会被工作时的思考占据一些时间。\r\n\r\n这种状态持续了多半年，一直到 2022 年的 5 月。经历了一些小规模的“正常汰换”。一些熟悉的同事离开了，留下的其他人也陷入了危机感。日常的聊天内容掺杂着：“听说XXX走了”，“XXX有裁员消息没”…… 在做完一个大需求后，看着周围发生的一切，我又陷入了迷茫。这种迷茫一度让我很焦虑。我害怕自己在几年之后还是个被抓手赋能沉淀和向上管理填满的螺丝工人，或者说，害怕这个看得到的未来。也就是那时候，我有了离职的念头，但更多的是一种冲动。\r\n\r\n一团乱麻之下，无法向内心寻求帮助，只好寻找外在的力量。那时候看到了一些其他公司的招聘帖，就尝试联系了一下，说了下自己的情况和想法。很庆幸遇到了好人，聊完之后我冷静下来，试图理清头绪，穷则思变。\r\n\r\n焦虑来自于几乎无法实现的期待，所以我尝试弄清楚自己真正想要什么。我给自己做了很多二选一的选择题，其中最关键的一个是：在精力非常有限的情况下，如果一定要把工作和生活二选一，我会选择什么。或许在刚入职时，我会犹豫着选择工作，但在这时起，我的答案已经变成了毫不犹豫地选择生活。既然这样，对工作也就不抱太多期待了，追求的事情也变成了用最小的力气把事情做好。工作之外的时间是属于我的，我要用来做我想做的事情。\r\n\r\n记得之前在网上看到过，工作任务可以分成四种：紧急且重要、紧急但不重要、重要但不紧急、不重要也不紧急。同样，那些占据我业余时间的消息也可以分为这四种。紧急且重要的事情一定会电话通知，而其他类别的事情似乎并不急着当晚一定要解决，记下来尽快解决就好了。\r\n\r\n想开之后，我卸载了钉钉。或许很难想象，竟然有人在一年的时间里，没有在自己的手机里安装公司内部的通讯软件。但我在挥霍我的业余时间时确实安心了许多。\r\n\r\n对我来说，还有两句话也很受用。第一句是和一位前辈聊天时学到的：不要试图用加班解决问题。\r\n\r\n\r\n第二句是我自己悟出来的，用即将离职的心态对待工作。\r\n\r\n---\r\n\r\n\r\n## 思考\r\n\r\n## A 面和 B 面\r\n\r\n不知道该庆幸还是该遗憾，我没有用“阿里员工”这个身份为自己谋取一些关注。和一位前辈聊天的时候曾经聊起过这个话题。她告诉我，要分清自己的能力和平台的能力，很多时候你能做成事情只是因为你依托于这个平台，一旦离开这个平台，你可能会发现自己什么都没有。\r\n\r\n于是，我希望有一些脱离公司存在的真正属于我自己的东西，无论是我学到的技能，或者是其他一些有意义的，值得我投入的事情。这大概也是我做一些业余项目的一部分动力：找一片真正能让自己快乐的场地。\r\n\r\n\r\n\r\n## 价值观\r\n\r\n## 离职计划\r\n\r\n> 2025年更新:\r\n> \r\n> 时间太久已经忘了当时想写什么了... 总之人生短短几十年，没必要为自己设限，也没必要让自己委屈。观察到太多自我以上人人平等，自我以下阶级分明的例子了。\r\n> 没有谁真的比谁高一等。如果工作最终会把人异化为冷漠、自私、没有同理心、富有攻击性的生物，那我还是更想做个人。\r\n> 尝试改变一下环境吧，如果无法改变环境，那就保护好自己，远离有毒的一切。\r\n> 不要活在别人的评价下，那不是我的生活。成为我想成为的人，那就够了。\r\n \r\n\r\n是时候和过去告别了。尽管前方是一片未知，但未知至少还有一点可能存在的希望。最后，希望自己脾气能再变好一点点，不因为无关的人伤害自己，也不让自己伤害在意的人。\r\n\r\n晚安。","src/content/posts/离职日记.md","8b53a735bfc8f111",{"html":1058,"metadata":1059},"\u003Cp>在一周之前，我的第一段工作结束了。曾经幻想过很多次要怎么写内网离职贴，为此观察了很久其他同事的写作风格。\u003C/p>\n\u003Cp>总体看来，离职贴有几种类型。第一种是“墓志铭型”，在帖子里详细地回顾自己职场生涯的起起伏伏，另加一些对自己来说有纪念意义的文字或者照片；\u003C/p>\n\u003Cp>第二种是“感恩戴德型”，风格主要是感谢公司，感谢老板，感谢同事；\u003C/p>\n\u003Cp>第三种是“慷慨陈词型”，把自己看到的问题说出来，一吐为快。这种帖子往往会容易引起大家的共鸣，很快上到热贴榜，然后又归于平静；\u003C/p>\n\u003Cp>第四种是“火力全开型”，工作中受了委屈，在离职前也就不怕撕破脸，这种帖子会被吃瓜群众火速顶起，然后高层火速介入，开展调查。不过自从之前某件事情之后，看起来吃瓜群众的态度也更倾向于“让子弹飞一会”了。\u003C/p>\n\u003Cp>最后一种离职贴简单粗暴：山高路远，江湖再见，加个微信。\u003C/p>\n\u003Cp>考虑了很久，秉承着好聚好散的原则，在内网写了一篇“抽象乐子人”风格的帖子。希望能给看到我的离职贴的前同事们带来点乐子，工作已经这么苦了，再不开心那就太惨了。\u003C/p>\n\u003Cp>除此之外，有些话也并不适合在内网说。今天是入职新公司的第一天，所以在这里随便写写，权当和过去告个别，然后开始新的生活。\u003C/p>\n\u003Ch3 id=\"心态和思考\">心态和思考\u003C/h3>\n\u003Cp>先从个人感受开始，写点比较虚的吧。一直以来心态都不是很好，容易紧张或者陷入负面情绪，甚至自己 PUA 自己。不过在这两年经历的一些事情以及自己的一些胡思乱想中，反倒有了一些改变。\u003C/p>\n\u003Cp>不知道大家有没有玩过 2021 年淘宝的双十一互动游戏，玩法大概是丢喵糖抢地盘，那是我参与实际上线的第一个项目。上线第一天晚上值班的时候出了点小问题，我在值班室排查问题时手都在发抖。后来师兄告诉我说，不用这么紧张，遇到问题解决就是了。道理虽然简单，但那时候我才意识到，逃避和紧张都不是解决问题的办法。除非甩锅，不然该来的迟早是要来的。\u003C/p>\n\u003Cp>工作中的责任感和边界感是学校里难以体会到的，这也迫使我戴上假面，硬着头皮做一些事情，扮演一个“符合价值观”的“正面向上”的角色。虽然不喜欢，但那时候更追求别人口中的“完美”：所有事情都想要尽力做好，除此之外还要想办法做一些所谓的“沉淀”，以至于下班时间都会被工作时的思考占据一些时间。\u003C/p>\n\u003Cp>这种状态持续了多半年，一直到 2022 年的 5 月。经历了一些小规模的“正常汰换”。一些熟悉的同事离开了，留下的其他人也陷入了危机感。日常的聊天内容掺杂着：“听说XXX走了”，“XXX有裁员消息没”…… 在做完一个大需求后，看着周围发生的一切，我又陷入了迷茫。这种迷茫一度让我很焦虑。我害怕自己在几年之后还是个被抓手赋能沉淀和向上管理填满的螺丝工人，或者说，害怕这个看得到的未来。也就是那时候，我有了离职的念头，但更多的是一种冲动。\u003C/p>\n\u003Cp>一团乱麻之下，无法向内心寻求帮助，只好寻找外在的力量。那时候看到了一些其他公司的招聘帖，就尝试联系了一下，说了下自己的情况和想法。很庆幸遇到了好人，聊完之后我冷静下来，试图理清头绪，穷则思变。\u003C/p>\n\u003Cp>焦虑来自于几乎无法实现的期待，所以我尝试弄清楚自己真正想要什么。我给自己做了很多二选一的选择题，其中最关键的一个是：在精力非常有限的情况下，如果一定要把工作和生活二选一，我会选择什么。或许在刚入职时，我会犹豫着选择工作，但在这时起，我的答案已经变成了毫不犹豫地选择生活。既然这样，对工作也就不抱太多期待了，追求的事情也变成了用最小的力气把事情做好。工作之外的时间是属于我的，我要用来做我想做的事情。\u003C/p>\n\u003Cp>记得之前在网上看到过，工作任务可以分成四种：紧急且重要、紧急但不重要、重要但不紧急、不重要也不紧急。同样，那些占据我业余时间的消息也可以分为这四种。紧急且重要的事情一定会电话通知，而其他类别的事情似乎并不急着当晚一定要解决，记下来尽快解决就好了。\u003C/p>\n\u003Cp>想开之后，我卸载了钉钉。或许很难想象，竟然有人在一年的时间里，没有在自己的手机里安装公司内部的通讯软件。但我在挥霍我的业余时间时确实安心了许多。\u003C/p>\n\u003Cp>对我来说，还有两句话也很受用。第一句是和一位前辈聊天时学到的：不要试图用加班解决问题。\u003C/p>\n\u003Cp>第二句是我自己悟出来的，用即将离职的心态对待工作。\u003C/p>\n\u003Chr>\n\u003Ch2 id=\"思考\">思考\u003C/h2>\n\u003Ch2 id=\"a-面和-b-面\">A 面和 B 面\u003C/h2>\n\u003Cp>不知道该庆幸还是该遗憾，我没有用“阿里员工”这个身份为自己谋取一些关注。和一位前辈聊天的时候曾经聊起过这个话题。她告诉我，要分清自己的能力和平台的能力，很多时候你能做成事情只是因为你依托于这个平台，一旦离开这个平台，你可能会发现自己什么都没有。\u003C/p>\n\u003Cp>于是，我希望有一些脱离公司存在的真正属于我自己的东西，无论是我学到的技能，或者是其他一些有意义的，值得我投入的事情。这大概也是我做一些业余项目的一部分动力：找一片真正能让自己快乐的场地。\u003C/p>\n\u003Ch2 id=\"价值观\">价值观\u003C/h2>\n\u003Ch2 id=\"离职计划\">离职计划\u003C/h2>\n\u003Cblockquote>\n\u003Cp>2025年更新:\u003C/p>\n\u003Cp>时间太久已经忘了当时想写什么了… 总之人生短短几十年，没必要为自己设限，也没必要让自己委屈。观察到太多自我以上人人平等，自我以下阶级分明的例子了。\r\n没有谁真的比谁高一等。如果工作最终会把人异化为冷漠、自私、没有同理心、富有攻击性的生物，那我还是更想做个人。\r\n尝试改变一下环境吧，如果无法改变环境，那就保护好自己，远离有毒的一切。\r\n不要活在别人的评价下，那不是我的生活。成为我想成为的人，那就够了。\u003C/p>\n\u003C/blockquote>\n\u003Cp>是时候和过去告别了。尽管前方是一片未知，但未知至少还有一点可能存在的希望。最后，希望自己脾气能再变好一点点，不因为无关的人伤害自己，也不让自己伤害在意的人。\u003C/p>\n\u003Cp>晚安。\u003C/p>",{"headings":1060,"localImagePaths":1072,"remoteImagePaths":1073,"frontmatter":1074,"imagePaths":1076},[1061,1063,1065,1068,1070],{"depth":81,"slug":1062,"text":1062},"心态和思考",{"depth":26,"slug":1064,"text":1064},"思考",{"depth":26,"slug":1066,"text":1067},"a-面和-b-面","A 面和 B 面",{"depth":26,"slug":1069,"text":1069},"价值观",{"depth":26,"slug":1071,"text":1071},"离职计划",[],[],{"title":1049,"pubDate":1075,"category":597,"excerpt":1053},["Date","2023-07-04T23:19:22.000Z"],[],"服务器迁移到centos",{"id":1077,"data":1079,"body":1082,"filePath":1083,"digest":1084,"rendered":1085},{"title":1077,"pubDate":1080,"category":273,"excerpt":1081},["Date","2020-08-01T11:59:14.000Z"],"把服务器从windows迁移到了cent os，然后做了一点记录。","1. 下载的话可以用wget，还挺方便的。\n2. npm出于安全考虑，不允许以root用户运行，如果是root的话，会自动切换到一个默认的什么权限都没有的nobody用户，参考：https://docs.npmjs.com/misc/config#unsafe-perm，在执行npm install的时候这样写就好了：\n``` javascript\n    npm install --unsafe-perm\n```\n3. 迁移的时候遇到了一个问题: 之前写的博客自动部署的服务，只要使用pm2开启进程守护，那么就会无法clone，搞不清楚是谁的bug。不过目测是因为pm2不能执行开启终端之类的操作吧，因为我把进程守护工具换成forever，它就没问题了。。。但是在pm2的github的issues里面也没发现有人提出过类似的问题，就很奇怪。","src/content/posts/服务器迁移到centos.md","9f70bf2ee84f8912",{"html":1086,"metadata":1087},"\u003Col>\n\u003Cli>下载的话可以用wget，还挺方便的。\u003C/li>\n\u003Cli>npm出于安全考虑，不允许以root用户运行，如果是root的话，会自动切换到一个默认的什么权限都没有的nobody用户，参考：\u003Ca href=\"https://docs.npmjs.com/misc/config#unsafe-perm%EF%BC%8C%E5%9C%A8%E6%89%A7%E8%A1%8Cnpm\">https://docs.npmjs.com/misc/config#unsafe-perm，在执行npm\u003C/a> install的时候这样写就好了：\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    npm install \u003C/span>\u003Cspan style=\"color:#F97583\">--\u003C/span>\u003Cspan style=\"color:#E1E4E8\">unsafe\u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\">perm\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Col start=\"3\">\n\u003Cli>迁移的时候遇到了一个问题: 之前写的博客自动部署的服务，只要使用pm2开启进程守护，那么就会无法clone，搞不清楚是谁的bug。不过目测是因为pm2不能执行开启终端之类的操作吧，因为我把进程守护工具换成forever，它就没问题了。。。但是在pm2的github的issues里面也没发现有人提出过类似的问题，就很奇怪。\u003C/li>\n\u003C/ol>",{"headings":1088,"localImagePaths":1089,"remoteImagePaths":1090,"frontmatter":1091,"imagePaths":1093},[],[],[],{"title":1077,"pubDate":1092,"category":273,"excerpt":1081},["Date","2020-08-01T11:59:14.000Z"],[],"阴阳师妖怪屋-你的式神是怎么被剪出来的",{"id":1094,"data":1096,"body":1100,"filePath":1101,"digest":1102,"rendered":1103},{"title":1097,"pubDate":1098,"category":16,"excerpt":1099},"【阴阳师妖怪屋】你的式神是怎么被剪出来的？",["Date","2020-10-18T18:44:16.000Z"],"阴阳师妖怪屋游戏中，关于抽卡时剪纸路径的算法。","## 前言\n玩过阴阳师妖怪屋的小伙伴们都知道，妖怪屋的一个核心玩法就是抽卡。和阴阳师不一样，妖怪屋的“抽卡”是通过剪纸的方式进行的。话不多说，我们看一下游戏规则吧。\n\n## 游戏规则\n### 基本规则\n基本规则就是给一个可可爱爱没有脑袋的小纸人剪出它的头。玩家拿着一把剪刀，在有效区域内，从起点开始，一笔画出任意一条路径到达终点。用剪刀沿着起点到终点的这一条路径剪过去，得到的最终路径，就是小纸人的脑袋啦。然后，小纸人的脑袋上会冒出来两朵红色的小啾啾，然后它就变成了你的式神。\n\n如果还没有明白我的意思的话，那就看一下下面这个视频叭：\n\n\u003Cvideo src=\"http://imgs.maotoumao.xyz/video-ygw-chouka1.mp4\" controls=\"controls\">\u003C/video>\n\n### 注意事项\n尽管看视频好像很简单的样子，但是仔细思考一下，发现事情好像并没有这么简单——\n\n![酒吞](http://imgs.maotoumao.xyz/jiutun.jpg)\n\n通过大量的实验（其实就十次，因为没剪刀了），我们可以得到以下结论：\n1. 路径的起点是固定的，在起点周围的一个范围内滑动屏幕的时候会触发开始剪纸；而如果在范围外滑动则不会记录路径;\n2. 路径的终点也是固定的，我们可以看到当我们的画笔在任意一个位置停下来的时候，它会自动的连一条从当前位置到小纸人的脖子和右脸的交叉点的线。\n3. 只能在小纸人的脖子上方开剪，超出这个区域的路径是不会被记录的；而路径的起点和终点，恰好在这个可剪区域的边界上（以实际一张纸为例的话，就是说起点和终点在这张纸的某一条边上，玩家只能在纸上沿任意路径从起点剪到终点）。\n4. 无论怎么乱七八糟的剪，最终剪出来的效果都与你真真正正的拿着一张纸从起点沿着你画的路径剪过去一直到终点的效果是一样的。并且呢，剪刀剪出来的路径一定是你画出来路径的一部分。\n5. 第五点是具体实现时的小细节：当我们在这个画布上画画（剪纸）的时候，其实它并没有把我们所有的路径都完整的存下来，而是隔一段时间获取一下当前触摸点的位置，然后用直线近似的代替曲线路径。换句话说，我们剪纸的路径，其实是坐标系中一个个的坐标点，相邻的坐标点使用直线进行连接。为了体现这一点呢，我们可以以单身18年的手速画一个曲线，可以发现，最终展示到屏幕上的却是一个直线。\n6. 小纸人头顶的小啾啾始终在沿着小纸人裆部竖直向上的最高点位置冒出。\n\n## 分析\n到此为止，我们知道了游戏规则和一些注意的点。我们需要做的，其实只是需要在玩家绘制的路径中挑选出最**靠内**的，或者说剪出的形状内部不存在其他路径的一条路径。那么我们如何将这条路径挑选出来呢？\n\n根据注意事项小节中的第五点，玩家绘制的路径实际上可以看作一个拥有两个固定点（起点、终点）的无向图，我们要做的是在这个无向图上挑选部分边构成目标路径。我们做个假设，假如说有一个小蚂蚁要从起点沿着目标路径爬向终点，在当前只有一条路的时候，目标路径的可能选择是唯一的，但是当遇到分叉路口时，我们就需要考虑一下怎么选择了。于是问题又进一步的简化成了：在无向图中，从起点走向终点时，当前结点的下一个结点的选择问题。\n![路径示意图](http://imgs.maotoumao.xyz/ygw-chouka-shiyitu.png?v=1)\n\n这个时候，我们观察到，以上图为例，我们在挑选目标路径的时候，为了挑出最靠内的一条路径，我们可以与选取与当前前进方向顺时针夹角最大的方向为目标方向，即可解决问题。用图中的例子说就是：对于从$A$点爬到$B$点的小蚂蚁，由于边$\\vec{BC}$与$\\vec{AB}$之间的的顺时针夹角比边$\\vec{BD}$与$\\vec{AB}$之间的的顺时针夹角大，因此小蚂蚁的下一个目标点是$D$点。直观的想一下，对于每一个结点来说，它的下一个结点肯定是弯的越狠越好，因为在它外边的肯定就被剪掉了嘛。这种策略其实是一种贪心策略，从初始结点出发，每一次选择都是当前看来最好的选择。\n\n不过我们知道，贪心策略可能得到的并不是最优解，我们需要想办法证明我们的贪心策略的正确性。证明过程也很容易理解，利用反证法：\n\n![证明](http://imgs.maotoumao.xyz/ygw-chouka-zhengming.png)\n对于任意结点$B$，假如结点$C$是$B$的所有邻居结点中与$B$的连线和$\\vec{AB}$顺时针夹角最大的结点，如果存在一个结点$D$，使得：$\\langle\\vec{AB}, \\vec{BC}\\rangle > \\langle\\vec{AB}, \\vec{BD}\\rangle$，但是结点$D$是$B$结点的下一个目标结点。此时：\n\n根据注意事项2，我们知道无论经由$C$结点还是$D$结点，最终都会通往相同的终点。因此对于$B \\rightarrow C$和$B \\rightarrow D$方向的路径来说，总会在至少一个结点交叉。对于第一个交叉结点$X$，考虑由$BCDX$构成的闭合图形，如果$D$结点在目标路径上，那么$C$结点一定在目标路径内，这就与我们的要求：起点经由目标路径到终点的内部不存在其他路径相矛盾。\n\n## 实现\n### 实现步骤\n简单实现一下这个过程，我们把以上描述梳理成如下步骤：\n1. 对玩家绘制的一系列线段，求两两之间的交点，并根据结点将线段拆分成除了线段的起点或终点外不互相交的线段；\n2. 根据步骤1得到的结果构建一个无向图；\n3. 从起点开始按照贪心策略寻找后继结点，直到终点；\n4. 将得到的一系列路径按次序连接起来，得到最终的路径；\n5. 给小纸人画上小啾啾。\n\n对于第一步，我们可以通过快速排斥实验快速排除不交叉的两条线段，再将通过快速排斥实验的两条线段进行跨立实验，如果存在交点则计算交点。\n\n对于第二步，设计一个数据结构进行存储：\n```typescript\ninterface Node {\n    point: Point, // 坐标\n    neighbor: Node[], // 相邻结点\n    status?: boolean\n}\n```\n对于第三步，只需要对第二步中neighbor数组内的结点进行判定即可。\n\n第四步就是一个简单的canvas绘制过程。\n\n第五步其实就遍历一遍就好啦。\n\n整个实现过程由于涉及到了向量的计算，因此使用到了mathjs库，除此之外，项目使用了pixijs渲染框架。具体代码中，用到的比较多的是两条线段点积和叉积的计算，以及一些简单的判断和循环，逻辑还是很清楚的。实现的demo效果如下，感觉和游戏中的剪纸还是有几分相似的(但是!!有bug!!!不知道是上边思路的漏洞还是实现有问题。。但是没空检查就这样8)：\n\n### 剪纸路径demo\n\n![剪纸路径](http://imgs.maotoumao.xyz/ygw-chouka-test-path.png)\n\n### 剪纸效果demo\n\n![抽卡demo](http://imgs.maotoumao.xyz/ygw-chouka-test1.png)\n\n## 体验地址及代码地址\n体验地址在这里：[妖怪屋抽卡](http://tools.maotoumao.xyz/ygw-chouka/)\n\n代码地址： [gitee地址戳这里](https://gitee.com/maotoumao/ygw-chouka), [github地址戳这里](https://github.com/maotoumao/ygw-chouka)","src/content/posts/阴阳师妖怪屋-你的式神是怎么被剪出来的.md","b021dd363d90f183",{"html":1104,"metadata":1105},"\u003Ch2 id=\"前言\">前言\u003C/h2>\n\u003Cp>玩过阴阳师妖怪屋的小伙伴们都知道，妖怪屋的一个核心玩法就是抽卡。和阴阳师不一样，妖怪屋的“抽卡”是通过剪纸的方式进行的。话不多说，我们看一下游戏规则吧。\u003C/p>\n\u003Ch2 id=\"游戏规则\">游戏规则\u003C/h2>\n\u003Ch3 id=\"基本规则\">基本规则\u003C/h3>\n\u003Cp>基本规则就是给一个可可爱爱没有脑袋的小纸人剪出它的头。玩家拿着一把剪刀，在有效区域内，从起点开始，一笔画出任意一条路径到达终点。用剪刀沿着起点到终点的这一条路径剪过去，得到的最终路径，就是小纸人的脑袋啦。然后，小纸人的脑袋上会冒出来两朵红色的小啾啾，然后它就变成了你的式神。\u003C/p>\n\u003Cp>如果还没有明白我的意思的话，那就看一下下面这个视频叭：\u003C/p>\n\u003Cp>\u003Cvideo src=\"http://imgs.maotoumao.xyz/video-ygw-chouka1.mp4\" controls>\u003C/video>\u003C/p>\n\u003Ch3 id=\"注意事项\">注意事项\u003C/h3>\n\u003Cp>尽管看视频好像很简单的样子，但是仔细思考一下，发现事情好像并没有这么简单——\u003C/p>\n\u003Cp>\u003Cimg src=\"http://imgs.maotoumao.xyz/jiutun.jpg\" alt=\"酒吞\">\u003C/p>\n\u003Cp>通过大量的实验（其实就十次，因为没剪刀了），我们可以得到以下结论：\u003C/p>\n\u003Col>\n\u003Cli>路径的起点是固定的，在起点周围的一个范围内滑动屏幕的时候会触发开始剪纸；而如果在范围外滑动则不会记录路径;\u003C/li>\n\u003Cli>路径的终点也是固定的，我们可以看到当我们的画笔在任意一个位置停下来的时候，它会自动的连一条从当前位置到小纸人的脖子和右脸的交叉点的线。\u003C/li>\n\u003Cli>只能在小纸人的脖子上方开剪，超出这个区域的路径是不会被记录的；而路径的起点和终点，恰好在这个可剪区域的边界上（以实际一张纸为例的话，就是说起点和终点在这张纸的某一条边上，玩家只能在纸上沿任意路径从起点剪到终点）。\u003C/li>\n\u003Cli>无论怎么乱七八糟的剪，最终剪出来的效果都与你真真正正的拿着一张纸从起点沿着你画的路径剪过去一直到终点的效果是一样的。并且呢，剪刀剪出来的路径一定是你画出来路径的一部分。\u003C/li>\n\u003Cli>第五点是具体实现时的小细节：当我们在这个画布上画画（剪纸）的时候，其实它并没有把我们所有的路径都完整的存下来，而是隔一段时间获取一下当前触摸点的位置，然后用直线近似的代替曲线路径。换句话说，我们剪纸的路径，其实是坐标系中一个个的坐标点，相邻的坐标点使用直线进行连接。为了体现这一点呢，我们可以以单身18年的手速画一个曲线，可以发现，最终展示到屏幕上的却是一个直线。\u003C/li>\n\u003Cli>小纸人头顶的小啾啾始终在沿着小纸人裆部竖直向上的最高点位置冒出。\u003C/li>\n\u003C/ol>\n\u003Ch2 id=\"分析\">分析\u003C/h2>\n\u003Cp>到此为止，我们知道了游戏规则和一些注意的点。我们需要做的，其实只是需要在玩家绘制的路径中挑选出最\u003Cstrong>靠内\u003C/strong>的，或者说剪出的形状内部不存在其他路径的一条路径。那么我们如何将这条路径挑选出来呢？\u003C/p>\n\u003Cp>根据注意事项小节中的第五点，玩家绘制的路径实际上可以看作一个拥有两个固定点（起点、终点）的无向图，我们要做的是在这个无向图上挑选部分边构成目标路径。我们做个假设，假如说有一个小蚂蚁要从起点沿着目标路径爬向终点，在当前只有一条路的时候，目标路径的可能选择是唯一的，但是当遇到分叉路口时，我们就需要考虑一下怎么选择了。于是问题又进一步的简化成了：在无向图中，从起点走向终点时，当前结点的下一个结点的选择问题。\n\u003Cimg src=\"http://imgs.maotoumao.xyz/ygw-chouka-shiyitu.png?v=1\" alt=\"路径示意图\">\u003C/p>\n\u003Cp>这个时候，我们观察到，以上图为例，我们在挑选目标路径的时候，为了挑出最靠内的一条路径，我们可以与选取与当前前进方向顺时针夹角最大的方向为目标方向，即可解决问题。用图中的例子说就是：对于从$A$点爬到$B$点的小蚂蚁，由于边$\\vec{BC}$与$\\vec{AB}$之间的的顺时针夹角比边$\\vec{BD}$与$\\vec{AB}$之间的的顺时针夹角大，因此小蚂蚁的下一个目标点是$D$点。直观的想一下，对于每一个结点来说，它的下一个结点肯定是弯的越狠越好，因为在它外边的肯定就被剪掉了嘛。这种策略其实是一种贪心策略，从初始结点出发，每一次选择都是当前看来最好的选择。\u003C/p>\n\u003Cp>不过我们知道，贪心策略可能得到的并不是最优解，我们需要想办法证明我们的贪心策略的正确性。证明过程也很容易理解，利用反证法：\u003C/p>\n\u003Cp>\u003Cimg src=\"http://imgs.maotoumao.xyz/ygw-chouka-zhengming.png\" alt=\"证明\">\n对于任意结点$B$，假如结点$C$是$B$的所有邻居结点中与$B$的连线和$\\vec{AB}$顺时针夹角最大的结点，如果存在一个结点$D$，使得：$\\langle\\vec{AB}, \\vec{BC}\\rangle > \\langle\\vec{AB}, \\vec{BD}\\rangle$，但是结点$D$是$B$结点的下一个目标结点。此时：\u003C/p>\n\u003Cp>根据注意事项2，我们知道无论经由$C$结点还是$D$结点，最终都会通往相同的终点。因此对于$B \\rightarrow C$和$B \\rightarrow D$方向的路径来说，总会在至少一个结点交叉。对于第一个交叉结点$X$，考虑由$BCDX$构成的闭合图形，如果$D$结点在目标路径上，那么$C$结点一定在目标路径内，这就与我们的要求：起点经由目标路径到终点的内部不存在其他路径相矛盾。\u003C/p>\n\u003Ch2 id=\"实现\">实现\u003C/h2>\n\u003Ch3 id=\"实现步骤\">实现步骤\u003C/h3>\n\u003Cp>简单实现一下这个过程，我们把以上描述梳理成如下步骤：\u003C/p>\n\u003Col>\n\u003Cli>对玩家绘制的一系列线段，求两两之间的交点，并根据结点将线段拆分成除了线段的起点或终点外不互相交的线段；\u003C/li>\n\u003Cli>根据步骤1得到的结果构建一个无向图；\u003C/li>\n\u003Cli>从起点开始按照贪心策略寻找后继结点，直到终点；\u003C/li>\n\u003Cli>将得到的一系列路径按次序连接起来，得到最终的路径；\u003C/li>\n\u003Cli>给小纸人画上小啾啾。\u003C/li>\n\u003C/ol>\n\u003Cp>对于第一步，我们可以通过快速排斥实验快速排除不交叉的两条线段，再将通过快速排斥实验的两条线段进行跨立实验，如果存在交点则计算交点。\u003C/p>\n\u003Cp>对于第二步，设计一个数据结构进行存储：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">interface\u003C/span>\u003Cspan style=\"color:#B392F0\"> Node\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    point\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> Point\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\">// 坐标\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    neighbor\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> Node\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[], \u003C/span>\u003Cspan style=\"color:#6A737D\">// 相邻结点\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    status\u003C/span>\u003Cspan style=\"color:#F97583\">?:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> boolean\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>对于第三步，只需要对第二步中neighbor数组内的结点进行判定即可。\u003C/p>\n\u003Cp>第四步就是一个简单的canvas绘制过程。\u003C/p>\n\u003Cp>第五步其实就遍历一遍就好啦。\u003C/p>\n\u003Cp>整个实现过程由于涉及到了向量的计算，因此使用到了mathjs库，除此之外，项目使用了pixijs渲染框架。具体代码中，用到的比较多的是两条线段点积和叉积的计算，以及一些简单的判断和循环，逻辑还是很清楚的。实现的demo效果如下，感觉和游戏中的剪纸还是有几分相似的(但是!!有bug!!!不知道是上边思路的漏洞还是实现有问题。。但是没空检查就这样8)：\u003C/p>\n\u003Ch3 id=\"剪纸路径demo\">剪纸路径demo\u003C/h3>\n\u003Cp>\u003Cimg src=\"http://imgs.maotoumao.xyz/ygw-chouka-test-path.png\" alt=\"剪纸路径\">\u003C/p>\n\u003Ch3 id=\"剪纸效果demo\">剪纸效果demo\u003C/h3>\n\u003Cp>\u003Cimg src=\"http://imgs.maotoumao.xyz/ygw-chouka-test1.png\" alt=\"抽卡demo\">\u003C/p>\n\u003Ch2 id=\"体验地址及代码地址\">体验地址及代码地址\u003C/h2>\n\u003Cp>体验地址在这里：\u003Ca href=\"http://tools.maotoumao.xyz/ygw-chouka/\">妖怪屋抽卡\u003C/a>\u003C/p>\n\u003Cp>代码地址： \u003Ca href=\"https://gitee.com/maotoumao/ygw-chouka\">gitee地址戳这里\u003C/a>, \u003Ca href=\"https://github.com/maotoumao/ygw-chouka\">github地址戳这里\u003C/a>\u003C/p>",{"headings":1106,"localImagePaths":1126,"remoteImagePaths":1127,"frontmatter":1128,"imagePaths":1130},[1107,1108,1110,1112,1114,1116,1118,1120,1122,1124],{"depth":26,"slug":27,"text":27},{"depth":26,"slug":1109,"text":1109},"游戏规则",{"depth":81,"slug":1111,"text":1111},"基本规则",{"depth":81,"slug":1113,"text":1113},"注意事项",{"depth":26,"slug":1115,"text":1115},"分析",{"depth":26,"slug":1117,"text":1117},"实现",{"depth":81,"slug":1119,"text":1119},"实现步骤",{"depth":81,"slug":1121,"text":1121},"剪纸路径demo",{"depth":81,"slug":1123,"text":1123},"剪纸效果demo",{"depth":26,"slug":1125,"text":1125},"体验地址及代码地址",[],[],{"title":1097,"pubDate":1129,"category":16,"excerpt":1099},["Date","2020-10-18T18:44:16.000Z"],[],"阴阳师妖怪屋中的背包问题",{"id":1131,"data":1133,"body":1136,"filePath":1137,"digest":1138,"rendered":1139},{"title":1131,"pubDate":1134,"category":16,"excerpt":1135},["Date","2020-10-01T17:07:46.000Z"],"阴阳师妖怪屋游戏中，关于计算最大羁绊的算法。","## 前言\n阴阳师妖怪屋小游戏作为阴阳师系列的第四部作品在前几天正式发布上线了，作为阴阳师老玩家的我，自然也要凑一个热闹。游戏的整体玩法是抽卡、弹球和养成，我们今天要说的，就是关于获取食材喂养式神的主要途径——探索。\n\n## 规则\n探索玩法的规则是这样子的：我们需要派出我们的小式神组建一个小队，其中部分式神之间具有羁绊，不同的羁绊会有不同的加成比例。探索队伍的坑位和通过的关卡数有关，小队内最多有8个式神。所有式神之间的羁绊规则如下表：\n\n羁绊名|相关式神|加成\n-|-|-\n春天在哪里|樱花妖, 桃花妖| 2%\n干了这杯酒|酒吞童子, 茨木童子| 4%\n锅蛙赛跑|山兔, 孟婆| 2%\n黑白无常|鬼使黑, 鬼使白| 2%\n欢喜叠叠乐| 镰鼬, 铁鼠| 2%\n来自崇天高云| 少羽大天狗, 大天狗| 4%\n老板您说| 鬼使黑, 鬼使白, 阎魔| 3%\n女孩当自强| 白狼, 妖刀姬, 萤草| 4%\n女子修炼组合| 白狼, 妖刀姬| 3%\n三途川一日游| 傀儡师, 阎魔| 3%\n诵经爱好者| 独眼小僧, 蝴蝶精| 2%\n天邪鬼四| 天邪鬼赤, 天邪鬼青, 天邪鬼黄, 天邪鬼绿| 2%\n为了大义| 大天狗, 雪女| 3%\n我的偶像| 萤草, 白狼| 2%\n养狗还是养猫| 九命猫, 犬神| 2%\n捉蝴蝶的妖| 蝴蝶精, 巫蛊师| 2%\n\n比如说，我在8个坑位中派出下面这个队伍：\n\n![妖怪屋队伍](http://imgs.maotoumao.xyz/blog-ygw-biandui.jpg)\n\n在这个队伍中，因为我派出的式神凑齐了上边表格中的“女子修炼组合(3%)”、“我的偶像(2%)”，“黑白无常(2%)”，“女孩当自强(4%)”，“老板您说(3%)”以及“三途川一日游(3%)”，加起来也就是凑够了17%的加成：\n\n![妖怪屋羁绊](http://imgs.maotoumao.xyz/blog-ygw-jiban.jpg)\n\n当然，羁绊的加成越高，那也就意味着我们的收益越高。手算怎么获取最大加成，对我这种没抽齐卡池的，算起来还是比较花时间的。那么，我们可不可以自动的去根据我们已有的式神，计算探索队伍的最优项呢？\n\n## 分析\n到此为止，游戏规则我们已经清楚了。试着把表述的再简洁一些的话，那就是：对于式神集合$ \\Omega = \\{ \\omega_0, \\omega_1, ... \\}$来说，在羁绊规则函数：$ f(\\omega^i),   (\\omega \\in \\Omega , 2 \\le i \\le 4)$的约束下，选取$k, (k \\le 8)$个式神，尽可能的让所选式神构成的$ f(\\omega^i) $之和最大。  \n\n观察刚才的问题描述，我们需要在8个坑位挑选不超过8个式神，使得总加成最大。很直接的，我们可以想到0-1背包问题。在这里我们回顾一下0-1背包问题：  \n> 假如我们有$n$种物品，每种物品只有1个，其中物品$j$的重量为$w_j$，价值为$v_j$，背包最多能承受的重量为$W$，我们希望在背包内尽可能装下总价值更高的物品。\n\n看看，是不是差不多对应上了：$n$个物品对应$n$个式神，每一个式神$j$的“重量”$w_j$都是1，“价值”，也就是羁绊加成，由羁绊规则来确定；在探索队伍这个容量为$W$背包下，希望让价值最大化。这其中，唯一没有对应上的就是“物品”的“价值\"，根据羁绊规则，当两个或者多个式神凑在一起的时候，“物品”才有了价值，单独的一个式神是没有任何加成的。因此，我们需要对羁绊规则进行进一步分析。\n\n根据羁绊规则表，我们最终的选择显然是满足以下条件的：\n- 当前没有的式神，一定不是最终队伍中选择的式神；\n- 最终队伍中选择的式神，一定是羁绊列表中列出的式神。\n\n两句话看似废话，其实可以告诉我们很多信息：首先，由于我们的式神并没有覆盖全卡池，因此假如说我没有茨木童子，那么对于“干了这杯酒”这个羁绊来说，我肯定是凑不齐的了。因此，我们根据已有卡池，在羁绊规则中过滤掉与我们没有抽到的式神相关的羁绊，从而删除了无效羁绊。\n\n第二：我们在选择候选式神的时候，只需要从羁绊列表中选取部分羁绊规则，使得这些羁绊的加成最大，并且羁绊中涉及到的式神数不超过最大坑位数。\n\n那么，如果从羁绊规则的角度考虑的话，我们可以把每一个羁绊规则看作一个“物品”，它的“重量”指的是规则中涉及的式神数量，“价值”指的是这个羁绊对应的加成。这样一来，就完美的对上了0-1背包问题。\n\n但是，这其中还有一个小问题：把每一个羁绊规则看作一个“物品”时，不同的“物品”之间可能有重叠。举个例子：“女孩当自强”这个羁绊中涉及到了白狼、妖刀姬和萤草，但是对于“我的偶像”这个羁绊，它也涉及到了白狼和萤草。而这两个羁绊中涉及到的白狼和萤草其实是同样的式神。换言之，物品的重量可能会相互影响。\n\n为了解决这个问题，其实我们只需要在每次选择一个规则的时候，重置一下其他规则的“重量”： 比如说当我们选中“女孩当自强”这个羁绊规则的时候，也就意味着我们选中了白狼、妖刀姬和萤草。那么，选中它之后，我们临时将白狼、萤草、妖刀姬的“重量”都置为0，于是，在探索队伍中选中“女孩当自强”这个羁绊的情况下，“我的偶像”这个羁绊的“重量”就变成了0。对于背包问题来说，我们优化的目标是尽可能的在包里塞下贵的东西，一个重量为0但是又有价值的东西来说，为什么不把它装在包里呢？\n\n综合以上，我们得出了我们的递归公式：\n$g(k, rules) = max(g(k-rule.weight, handler(rules, rule)))$，\n其中：$rule$表示羁绊规则中的任意一条羁绊，$handler()$表示一个函数，它将根据选中的羁绊，重置全部羁绊规则。\n\n## 演示\n根据上边的分析，下一步当然就是实现啦。主要就是根据上述分析，实现了个递归，然后写了个网页。效果图大概是这样的：\n![羁绊计算器](http://imgs.maotoumao.xyz/blog-ygw-jsq.jpg)\n\n## 代码\n页面的体验地址[点击这里](http://tools.maotoumao.xyz/ygw-jiban/)(http://tools.maotoumao.xyz/ygw-jiban/)；\n代码就不贴了，github地址[点击这里](https://github.com/maotoumao/ygw-jiban)；gitee地址[点击这里](https://gitee.com/maotoumao/ygw-jiban)，有兴趣的自己看叭。","src/content/posts/阴阳师妖怪屋中的背包问题.md","c9acff46038474e8",{"html":1140,"metadata":1141},"\u003Ch2 id=\"前言\">前言\u003C/h2>\n\u003Cp>阴阳师妖怪屋小游戏作为阴阳师系列的第四部作品在前几天正式发布上线了，作为阴阳师老玩家的我，自然也要凑一个热闹。游戏的整体玩法是抽卡、弹球和养成，我们今天要说的，就是关于获取食材喂养式神的主要途径——探索。\u003C/p>\n\u003Ch2 id=\"规则\">规则\u003C/h2>\n\u003Cp>探索玩法的规则是这样子的：我们需要派出我们的小式神组建一个小队，其中部分式神之间具有羁绊，不同的羁绊会有不同的加成比例。探索队伍的坑位和通过的关卡数有关，小队内最多有8个式神。所有式神之间的羁绊规则如下表：\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>羁绊名\u003C/th>\u003Cth>相关式神\u003C/th>\u003Cth>加成\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>春天在哪里\u003C/td>\u003Ctd>樱花妖, 桃花妖\u003C/td>\u003Ctd>2%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>干了这杯酒\u003C/td>\u003Ctd>酒吞童子, 茨木童子\u003C/td>\u003Ctd>4%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>锅蛙赛跑\u003C/td>\u003Ctd>山兔, 孟婆\u003C/td>\u003Ctd>2%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>黑白无常\u003C/td>\u003Ctd>鬼使黑, 鬼使白\u003C/td>\u003Ctd>2%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>欢喜叠叠乐\u003C/td>\u003Ctd>镰鼬, 铁鼠\u003C/td>\u003Ctd>2%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>来自崇天高云\u003C/td>\u003Ctd>少羽大天狗, 大天狗\u003C/td>\u003Ctd>4%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>老板您说\u003C/td>\u003Ctd>鬼使黑, 鬼使白, 阎魔\u003C/td>\u003Ctd>3%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>女孩当自强\u003C/td>\u003Ctd>白狼, 妖刀姬, 萤草\u003C/td>\u003Ctd>4%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>女子修炼组合\u003C/td>\u003Ctd>白狼, 妖刀姬\u003C/td>\u003Ctd>3%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>三途川一日游\u003C/td>\u003Ctd>傀儡师, 阎魔\u003C/td>\u003Ctd>3%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>诵经爱好者\u003C/td>\u003Ctd>独眼小僧, 蝴蝶精\u003C/td>\u003Ctd>2%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>天邪鬼四\u003C/td>\u003Ctd>天邪鬼赤, 天邪鬼青, 天邪鬼黄, 天邪鬼绿\u003C/td>\u003Ctd>2%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>为了大义\u003C/td>\u003Ctd>大天狗, 雪女\u003C/td>\u003Ctd>3%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>我的偶像\u003C/td>\u003Ctd>萤草, 白狼\u003C/td>\u003Ctd>2%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>养狗还是养猫\u003C/td>\u003Ctd>九命猫, 犬神\u003C/td>\u003Ctd>2%\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>捉蝴蝶的妖\u003C/td>\u003Ctd>蝴蝶精, 巫蛊师\u003C/td>\u003Ctd>2%\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Cp>比如说，我在8个坑位中派出下面这个队伍：\u003C/p>\n\u003Cp>\u003Cimg src=\"http://imgs.maotoumao.xyz/blog-ygw-biandui.jpg\" alt=\"妖怪屋队伍\">\u003C/p>\n\u003Cp>在这个队伍中，因为我派出的式神凑齐了上边表格中的“女子修炼组合(3%)”、“我的偶像(2%)”，“黑白无常(2%)”，“女孩当自强(4%)”，“老板您说(3%)”以及“三途川一日游(3%)”，加起来也就是凑够了17%的加成：\u003C/p>\n\u003Cp>\u003Cimg src=\"http://imgs.maotoumao.xyz/blog-ygw-jiban.jpg\" alt=\"妖怪屋羁绊\">\u003C/p>\n\u003Cp>当然，羁绊的加成越高，那也就意味着我们的收益越高。手算怎么获取最大加成，对我这种没抽齐卡池的，算起来还是比较花时间的。那么，我们可不可以自动的去根据我们已有的式神，计算探索队伍的最优项呢？\u003C/p>\n\u003Ch2 id=\"分析\">分析\u003C/h2>\n\u003Cp>到此为止，游戏规则我们已经清楚了。试着把表述的再简洁一些的话，那就是：对于式神集合$ \\Omega = { \\omega_0, \\omega_1, … }$来说，在羁绊规则函数：$ f(\\omega^i),   (\\omega \\in \\Omega , 2 \\le i \\le 4)$的约束下，选取$k, (k \\le 8)$个式神，尽可能的让所选式神构成的$ f(\\omega^i) $之和最大。\u003C/p>\n\u003Cp>观察刚才的问题描述，我们需要在8个坑位挑选不超过8个式神，使得总加成最大。很直接的，我们可以想到0-1背包问题。在这里我们回顾一下0-1背包问题：\u003C/p>\n\u003Cblockquote>\n\u003Cp>假如我们有$n$种物品，每种物品只有1个，其中物品$j$的重量为$w_j$，价值为$v_j$，背包最多能承受的重量为$W$，我们希望在背包内尽可能装下总价值更高的物品。\u003C/p>\n\u003C/blockquote>\n\u003Cp>看看，是不是差不多对应上了：$n$个物品对应$n$个式神，每一个式神$j$的“重量”$w_j$都是1，“价值”，也就是羁绊加成，由羁绊规则来确定；在探索队伍这个容量为$W$背包下，希望让价值最大化。这其中，唯一没有对应上的就是“物品”的“价值”，根据羁绊规则，当两个或者多个式神凑在一起的时候，“物品”才有了价值，单独的一个式神是没有任何加成的。因此，我们需要对羁绊规则进行进一步分析。\u003C/p>\n\u003Cp>根据羁绊规则表，我们最终的选择显然是满足以下条件的：\u003C/p>\n\u003Cul>\n\u003Cli>当前没有的式神，一定不是最终队伍中选择的式神；\u003C/li>\n\u003Cli>最终队伍中选择的式神，一定是羁绊列表中列出的式神。\u003C/li>\n\u003C/ul>\n\u003Cp>两句话看似废话，其实可以告诉我们很多信息：首先，由于我们的式神并没有覆盖全卡池，因此假如说我没有茨木童子，那么对于“干了这杯酒”这个羁绊来说，我肯定是凑不齐的了。因此，我们根据已有卡池，在羁绊规则中过滤掉与我们没有抽到的式神相关的羁绊，从而删除了无效羁绊。\u003C/p>\n\u003Cp>第二：我们在选择候选式神的时候，只需要从羁绊列表中选取部分羁绊规则，使得这些羁绊的加成最大，并且羁绊中涉及到的式神数不超过最大坑位数。\u003C/p>\n\u003Cp>那么，如果从羁绊规则的角度考虑的话，我们可以把每一个羁绊规则看作一个“物品”，它的“重量”指的是规则中涉及的式神数量，“价值”指的是这个羁绊对应的加成。这样一来，就完美的对上了0-1背包问题。\u003C/p>\n\u003Cp>但是，这其中还有一个小问题：把每一个羁绊规则看作一个“物品”时，不同的“物品”之间可能有重叠。举个例子：“女孩当自强”这个羁绊中涉及到了白狼、妖刀姬和萤草，但是对于“我的偶像”这个羁绊，它也涉及到了白狼和萤草。而这两个羁绊中涉及到的白狼和萤草其实是同样的式神。换言之，物品的重量可能会相互影响。\u003C/p>\n\u003Cp>为了解决这个问题，其实我们只需要在每次选择一个规则的时候，重置一下其他规则的“重量”： 比如说当我们选中“女孩当自强”这个羁绊规则的时候，也就意味着我们选中了白狼、妖刀姬和萤草。那么，选中它之后，我们临时将白狼、萤草、妖刀姬的“重量”都置为0，于是，在探索队伍中选中“女孩当自强”这个羁绊的情况下，“我的偶像”这个羁绊的“重量”就变成了0。对于背包问题来说，我们优化的目标是尽可能的在包里塞下贵的东西，一个重量为0但是又有价值的东西来说，为什么不把它装在包里呢？\u003C/p>\n\u003Cp>综合以上，我们得出了我们的递归公式：\n$g(k, rules) = max(g(k-rule.weight, handler(rules, rule)))$，\n其中：$rule$表示羁绊规则中的任意一条羁绊，$handler()$表示一个函数，它将根据选中的羁绊，重置全部羁绊规则。\u003C/p>\n\u003Ch2 id=\"演示\">演示\u003C/h2>\n\u003Cp>根据上边的分析，下一步当然就是实现啦。主要就是根据上述分析，实现了个递归，然后写了个网页。效果图大概是这样的：\n\u003Cimg src=\"http://imgs.maotoumao.xyz/blog-ygw-jsq.jpg\" alt=\"羁绊计算器\">\u003C/p>\n\u003Ch2 id=\"代码\">代码\u003C/h2>\n\u003Cp>页面的体验地址\u003Ca href=\"http://tools.maotoumao.xyz/ygw-jiban/\">点击这里\u003C/a>(\u003Ca href=\"http://tools.maotoumao.xyz/ygw-jiban/)%EF%BC%9B\">http://tools.maotoumao.xyz/ygw-jiban/)；\u003C/a>\n代码就不贴了，github地址\u003Ca href=\"https://github.com/maotoumao/ygw-jiban\">点击这里\u003C/a>；gitee地址\u003Ca href=\"https://gitee.com/maotoumao/ygw-jiban\">点击这里\u003C/a>，有兴趣的自己看叭。\u003C/p>",{"headings":1142,"localImagePaths":1151,"remoteImagePaths":1152,"frontmatter":1153,"imagePaths":1155},[1143,1144,1146,1147,1149],{"depth":26,"slug":27,"text":27},{"depth":26,"slug":1145,"text":1145},"规则",{"depth":26,"slug":1115,"text":1115},{"depth":26,"slug":1148,"text":1148},"演示",{"depth":26,"slug":1150,"text":1150},"代码",[],[],{"title":1131,"pubDate":1154,"category":16,"excerpt":1135},["Date","2020-10-01T17:07:46.000Z"],[],"微信一笔画完小游戏的解题算法",{"id":1156,"data":1158,"body":1161,"filePath":1162,"digest":1163,"rendered":1164},{"title":1156,"pubDate":1159,"category":16,"excerpt":1160},["Date","2019-05-03T15:42:01.000Z"],"微信一笔画完小游戏的挂机算法。","前一阵子事情比较杂，因此停了很久才来更新博客。\n\n最近在微信看到一个一笔画完的小游戏，大概规则是，在一个长方形的地图上，只画一笔遍历所有可达点。于是我用递归的思路，使用python写出了解题算法。\n\n小游戏的截图：\n![base_img](http://imgs.maotoumao.xyz/57089349-daeae700-6d36-11e9-8706-6d765129e2a2.jpg)\n\n算法思路如下：\n\n地图可以表示为一个矩阵map，这个矩阵中，0表示该位置不可达，1则表示该位置是可达的。特殊地，初始点所在的位置记为1。\n\n除此之外，我们需要一个与map相同大小的矩阵，来记录当前的位置是否被访问过。\n\n接下来，我们用递归的思路去解决这个问题。\n从初始点开始，每一个位置都有四种可能的方向。我们循环对这四种方向进行尝试，即从一个新的点去继续搜索，直至搜索不到返回false或者返回一个操作序列。\n\n代码如下：\n``` python\nclass OneLine(object):\n\n    def __init__(self, row, col):\n        '''\n        map 是原地图 0表示位置不可用，1表示可用\n        status 表示已经访问过的点，1表示未访问，0表示已访问\n        :param row: 行\n        :param col: 列\n        '''\n        self.map = np.zeros((row, col))\n        self.status = np.ones((row, col))\n        self.init = None\n\n    def set_position_available(self, x, y):\n        self.map[x][y] = 1\n\n    def set_map(self, map):\n        self.map = map\n\n    def set_init_point(self, point):\n        self.init = point\n        self.status[point[0], point[1]] = 0\n        self.state = self.map * self.status\n\n    def is_finished(self, state):\n        if (np.sum(state) == 0):\n            return True\n        else:\n            return False\n\n    def move_to(self, map, status, curr_point, op_code):\n        next_status = copy.copy(status)\n\n        if (op_code == 'r'):  # 右划\n            next_point = [curr_point[0], curr_point[1] + 1]\n        elif (op_code == 'l'):  # 左划\n            next_point = [curr_point[0], curr_point[1] - 1]\n        elif (op_code == 'u'):  # 上划\n            next_point = [curr_point[0] - 1, curr_point[1]]\n        elif (op_code == 'd'):  # 下划\n            next_point = [curr_point[0] + 1, curr_point[1]]\n        else:\n            next_point = curr_point\n\n        next_status[next_point[0], next_point[1]] = 0\n        next_state = map * next_status\n        return {'map': map, 'status': next_status, 'state': next_state, 'curr_point': next_point}\n\n    def get_available_operation(self, state, curr_point):\n        op_list = []\n        dim = state.shape\n        if (curr_point[0] > 0 and state[curr_point[0] - 1, curr_point[1]] == 1):\n            op_list.append('u')\n        if (curr_point[0] \u003C dim[0] - 1 and state[curr_point[0] + 1, curr_point[1]] == 1):\n            op_list.append('d')\n        if (curr_point[1] > 0 and state[curr_point[0], curr_point[1] - 1] == 1):\n            op_list.append('l')\n        if (curr_point[1] \u003C dim[1] - 1 and state[curr_point[0], curr_point[1] + 1] == 1):\n            op_list.append('r')\n        return op_list\n\n    def search_path(self, map, status, state, curr_point, path):\n        # 如果找到解，返回\n        if (self.is_finished(state)):\n            return path\n        # 否则进行尝试\n        available_op = self.get_available_operation(state, curr_point)\n        # 如果当前没走到死路\n        while (len(available_op) != 0):\n            op = available_op.pop()\n            mov = self.move_to(map, status, curr_point, op)\n            path.append(op)\n            p = self.search_path(mov['map'], mov['status'], mov['state'], mov['curr_point'], path)\n            if (p != False):\n                return p\n        path.pop()\n        return False\n\n    def start_find(self):\n        return self.search_path(self.map, self.status, self.state, self.init, [])\n\n\n```\n\n[完整代码指路github](https://github.com/Stranger-97/one_line_helper/)","src/content/posts/微信一笔画完小游戏的解题算法.md","eb5233761b0f2b59",{"html":1165,"metadata":1166},"\u003Cp>前一阵子事情比较杂，因此停了很久才来更新博客。\u003C/p>\n\u003Cp>最近在微信看到一个一笔画完的小游戏，大概规则是，在一个长方形的地图上，只画一笔遍历所有可达点。于是我用递归的思路，使用python写出了解题算法。\u003C/p>\n\u003Cp>小游戏的截图：\n\u003Cimg src=\"http://imgs.maotoumao.xyz/57089349-daeae700-6d36-11e9-8706-6d765129e2a2.jpg\" alt=\"base_img\">\u003C/p>\n\u003Cp>算法思路如下：\u003C/p>\n\u003Cp>地图可以表示为一个矩阵map，这个矩阵中，0表示该位置不可达，1则表示该位置是可达的。特殊地，初始点所在的位置记为1。\u003C/p>\n\u003Cp>除此之外，我们需要一个与map相同大小的矩阵，来记录当前的位置是否被访问过。\u003C/p>\n\u003Cp>接下来，我们用递归的思路去解决这个问题。\n从初始点开始，每一个位置都有四种可能的方向。我们循环对这四种方向进行尝试，即从一个新的点去继续搜索，直至搜索不到返回false或者返回一个操作序列。\u003C/p>\n\u003Cp>代码如下：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">class\u003C/span>\u003Cspan style=\"color:#B392F0\"> OneLine\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">object\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#79B8FF\"> __init__\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, row, col):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        '''\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        map 是原地图 0表示位置不可用，1表示可用\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        status 表示已经访问过的点，1表示未访问，0表示已访问\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        :param row: 行\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        :param col: 列\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        '''\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.map \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> np.zeros((row, col))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.status \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> np.ones((row, col))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.init \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> None\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> set_position_available\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, x, y):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.map[x][y] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> set_map\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, map):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.map \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> map\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> set_init_point\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, point):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.init \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> point\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.status[point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.state \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.map \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.status\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> is_finished\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, state):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (np.sum(state) \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> False\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> move_to\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, map, status, curr_point, op_code):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        next_status \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> copy.copy(status)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (op_code \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'r'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):  \u003C/span>\u003Cspan style=\"color:#6A737D\"># 右划\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            next_point \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (op_code \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'l'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):  \u003C/span>\u003Cspan style=\"color:#6A737D\"># 左划\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            next_point \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (op_code \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'u'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):  \u003C/span>\u003Cspan style=\"color:#6A737D\"># 上划\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            next_point \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (op_code \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'd'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):  \u003C/span>\u003Cspan style=\"color:#6A737D\"># 下划\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            next_point \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            next_point \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> curr_point\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        next_status[next_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], next_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        next_state \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> map\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> next_status\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'map'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">map\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'status'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: next_status, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'state'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: next_state, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'curr_point'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: next_point}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> get_available_operation\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, state, curr_point):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        op_list \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        dim \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> state.shape\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#F97583\"> and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> state[curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]] \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            op_list.append(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'u'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dim[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#F97583\"> and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> state[curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]] \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            op_list.append(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'d'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#F97583\"> and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> state[curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            op_list.append(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'l'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dim[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#F97583\"> and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> state[curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], curr_point[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            op_list.append(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'r'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> op_list\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> search_path\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, map, status, state, curr_point, path):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # 如果找到解，返回\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.is_finished(state)):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # 否则进行尝试\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        available_op \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.get_available_operation(state, curr_point)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # 如果当前没走到死路\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        while\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#79B8FF\">len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(available_op) \u003C/span>\u003Cspan style=\"color:#F97583\">!=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            op \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> available_op.pop()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            mov \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.move_to(\u003C/span>\u003Cspan style=\"color:#79B8FF\">map\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, status, curr_point, op)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            path.append(op)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            p \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.search_path(mov[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'map'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], mov[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'status'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], mov[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'state'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], mov[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'curr_point'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (p \u003C/span>\u003Cspan style=\"color:#F97583\">!=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> p\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        path.pop()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> False\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> start_find\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.search_path(\u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.map, \u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.status, \u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.state, \u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.init, [])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ca href=\"https://github.com/Stranger-97/one_line_helper/\">完整代码指路github\u003C/a>\u003C/p>",{"headings":1167,"localImagePaths":1168,"remoteImagePaths":1169,"frontmatter":1170,"imagePaths":1172},[],[],[],{"title":1156,"pubDate":1171,"category":16,"excerpt":1160},["Date","2019-05-03T15:42:01.000Z"],[],"使用electron开发脚本管理器",{"id":1173,"data":1175,"body":1178,"filePath":1179,"digest":1180,"rendered":1181},{"title":1173,"pubDate":1176,"category":33,"excerpt":1177},["Date","2021-02-27T23:45:05.000Z"],"自己写了一系列Python脚本工具，但是管理起来比较麻烦，改参数什么的也挺复杂，所以直接写了个桌面程序来管理python脚本。","# 设计思路\n目的其实是设计一个桌面工具，用来方便地执行脚本和设置参数，这样这些脚本就也可以给小白用了。毕竟可视化的设置比控制台或者源代码改参数要方便且直观的多，我想这也是低代码当今大行其道的原因之一吧。\n\n由于每一个python脚本都是一个工程(在一个单独的文件夹下)，因此，仿照package.json，自定义一个script.json，用来定义脚本的名称、说明以及传入的参数。\n\n由于主要运行在windows桌面端，为了编写一个windows应用程序，可行的思路有：\n- pyQt\n- C# winForm程序，调用Python脚本\n- electron调用Python脚本\n\n前边两个已经好几年没动过都忘了，目前对electron相对更熟悉一些，除此之外，nodejs可以通过child_process的spawn来开启一个子进程，传入参数执行对应的命令，并且可以实时的获取到子进程中的数据流。100%确定可行，因此选定了这个方案。\n\n# 实现细节\n在这一小节记录一下遇到的几个小坑点\n## 工程搭建\n方便起见，直接使用了[electron-react-boilerplate](https://github.com/electron-react-boilerplate/electron-react-boilerplate)来进行工程搭建。模板中已经内置了react和react-router-dom等一系列工具，默认语言是ts。（吐槽一句，我还是不太喜欢ts，大概是因为类型编码真的很烦吧，写代码的时候脑子里对应好了每一个变量的类型，写出来就变成了any）\n\n## electron实现多窗口\n在开发过程中，我需要一个主窗口，还需要一个设置窗口。项目的模板是一个spa，只有一个index.html。这时有两种解决思路：\n- 修改react变成一个多页的应用，在electron主进程中加载不同的页面。\n- 使用react router，为不同的窗口需要的页面设置不同的路由，electron主进程加载时加载相同的html，但是是不同的路由。\n\n显然，方案二更加简单，因此采用了方案二去实现。模板中默认的router是BrowserRouter，BrowserRouter的原理是使用html的history API，让页面UI和url同步，它需要后端进行配合支持，因为所有路由都是真实的路由，只是后端通过配置把所有的请求都转到index.html，并由react router拦截并渲染出ui。然而我们在electron中加载的是file协议的本地的html，并没有后端。这种情况下，再采用BrowserRouter，只会定位到一个不存在的路由，导致什么都输出不了。\n另一种Router是HashRouter，它是使用了url中的hash部分去获取进行路由控制。hash我的理解是相当于页面的锚，不会被后端服务读取，只是由前端获取到了url的hash，并进行解析。因此在这里应当使用HashRouter，并在设置窗口加载html时的路径改写为：\n```javascript\n    settingWindow.loadURL(`file://${__dirname}/index.html#/setting`);\n```\n\n## 渲染进程动态引入json\n在主窗口（渲染进程）中，需要读取每一个python脚本的配置文件，也就是上边提到的script.json。在创建主窗口时，我已经在配置里设置了在渲染进程中集成node环境，因此这里可以直接使用commonjs的语法引入node环境的包和文件，比如fs和path等等，当然也包括json。但是问题就出在这个require。\n\n在使用fs进行了一系列操作之后，我使用path拼接出了script.json的路径，然而此时再加载的时候，竟然报错了，说没找到这个json文件，但是这个文件又确实存在。于是我另外开启了一个node环境，发现此时可以成功引入。然后我又在渲染进程中引入了remote对象，使用remote.require进行引入，发现此时竟然可以成功引入。因此，得出一个结论：electron渲染进程集成的node中的require和主进程的require是不同的。主进程当然就是一个正常的node环境，但是，渲染进程中集成的require实际上是一个函数，它通过向主进程的ELECTRON_BROWSER_REQUIRE信道发送信号来表示导入包，可能还有一些其他的操作。这就导致在windows环境下的进程间通信的时候，反斜杠\\出现了问题，所以找不到包。\n\n## 使用child_process执行python脚本\nnodejs可以通过child_process包的exec()和spawn()来创建子进程执行python脚本。这里采用spawn创建子进程，\n\n创建完成之后，可以监听process.stdout上的data事件从而获取python的stdout，也就是print的输出。\n这里需要注意： 由于python的编码问题，需要设置std的编码为utf8编码：\n``` python\n    sys.stdout = io.TextIOWrapper(sys.stdout.detach(), encoding='utf-8')\n```\n在输出的时候需要刷新缓冲区，不然会导致输出缓冲区满了才会监听到一串数据，即：\n``` python\n    print('xxx', flush=True)\n```\n\n## react获取到过时的state\n出现问题的代码是这样的一个函数：\n``` typescript\nconst onScriptStart = (script: any) => {\n      const process = spawn(store.get('pythonPath') as string || 'python', [\n        script.entry,\n        ...(script.args?.map((arg: any) => arg.value))\n      ]);\n\n      process.on('exit', (code) => {\n          if(code === 0){\n              new remote.Notification({\n                  title: '脚本管理器',\n                  body: `任务${running?.name}已完成` // 当脚本执行完成时，这里是undefined\n              }).show();\n          }\n      })\n  \n      setRunning({\n        ...script,\n        process\n      })\n}\n```\n整个函数是一个点击事件，绑定在按钮上。根据[react官网的描述](https://zh-hans.reactjs.org/docs/hooks-faq.html#why-am-i-seeing-stale-props-or-state-inside-my-function)，我们在这里拿到了过时的state。其中提到，组件内部的任何函数，包括事件处理函数和effect，都是从它被创建的那次渲染中看到的，也就是组件内部拿到的总是定义它的那次渲染中的state和props。\n\n在这里面，当我们点击按钮时，running这个状态是一个undefined，同时创建了一个process对象，并在它的回调函数中写了读取了这个running。而我们的running全程都是undefined。正确的方法应该是使用setRunning，传入一个函数，如果不想修改状态，就把形参返回即可读取到最新的state。采用参数传递的方式不会读取到闭包中的state，从而可以获取到当前最新的state。\n\n## 打包\n### 版本控制\n可以看到，整个项目中有两个package.json，外部的是管理整个项目的，内部的其实可以看作是react的package.json。安装包的版本是由里面的package.json中的信息决定的，所以记得改里面的应用名称和版本。\n\n### package.json\n在windows环境下，根目录下package.json中的打包脚本package中，由于不存在rm -rf指令，因此可以安装rimraf包，然后把rm -rf改成rimraf，即：\n```\n    \"package\": \"rimraf release && rimraf src/dist && npm run build && electron-builder build --publish never\",\n```\n\n### 执行package命令\n刚开始执行package会下载一堆东西，下就是了。下到最后会发现，报了一个奇怪的错误，原因是路径中有中文字符。但是用户名就是中文字符呀没办法，所以参考这个链接中的方法，修改了node_modules中一个编码就好了。[解决办法](https://blog.csdn.net/kyq0417/article/details/111266776)","src/content/posts/使用electron开发脚本管理器.md","35672b6d1cbc50ab",{"html":1182,"metadata":1183},"\u003Ch1 id=\"设计思路\">设计思路\u003C/h1>\n\u003Cp>目的其实是设计一个桌面工具，用来方便地执行脚本和设置参数，这样这些脚本就也可以给小白用了。毕竟可视化的设置比控制台或者源代码改参数要方便且直观的多，我想这也是低代码当今大行其道的原因之一吧。\u003C/p>\n\u003Cp>由于每一个python脚本都是一个工程(在一个单独的文件夹下)，因此，仿照package.json，自定义一个script.json，用来定义脚本的名称、说明以及传入的参数。\u003C/p>\n\u003Cp>由于主要运行在windows桌面端，为了编写一个windows应用程序，可行的思路有：\u003C/p>\n\u003Cul>\n\u003Cli>pyQt\u003C/li>\n\u003Cli>C# winForm程序，调用Python脚本\u003C/li>\n\u003Cli>electron调用Python脚本\u003C/li>\n\u003C/ul>\n\u003Cp>前边两个已经好几年没动过都忘了，目前对electron相对更熟悉一些，除此之外，nodejs可以通过child_process的spawn来开启一个子进程，传入参数执行对应的命令，并且可以实时的获取到子进程中的数据流。100%确定可行，因此选定了这个方案。\u003C/p>\n\u003Ch1 id=\"实现细节\">实现细节\u003C/h1>\n\u003Cp>在这一小节记录一下遇到的几个小坑点\u003C/p>\n\u003Ch2 id=\"工程搭建\">工程搭建\u003C/h2>\n\u003Cp>方便起见，直接使用了\u003Ca href=\"https://github.com/electron-react-boilerplate/electron-react-boilerplate\">electron-react-boilerplate\u003C/a>来进行工程搭建。模板中已经内置了react和react-router-dom等一系列工具，默认语言是ts。（吐槽一句，我还是不太喜欢ts，大概是因为类型编码真的很烦吧，写代码的时候脑子里对应好了每一个变量的类型，写出来就变成了any）\u003C/p>\n\u003Ch2 id=\"electron实现多窗口\">electron实现多窗口\u003C/h2>\n\u003Cp>在开发过程中，我需要一个主窗口，还需要一个设置窗口。项目的模板是一个spa，只有一个index.html。这时有两种解决思路：\u003C/p>\n\u003Cul>\n\u003Cli>修改react变成一个多页的应用，在electron主进程中加载不同的页面。\u003C/li>\n\u003Cli>使用react router，为不同的窗口需要的页面设置不同的路由，electron主进程加载时加载相同的html，但是是不同的路由。\u003C/li>\n\u003C/ul>\n\u003Cp>显然，方案二更加简单，因此采用了方案二去实现。模板中默认的router是BrowserRouter，BrowserRouter的原理是使用html的history API，让页面UI和url同步，它需要后端进行配合支持，因为所有路由都是真实的路由，只是后端通过配置把所有的请求都转到index.html，并由react router拦截并渲染出ui。然而我们在electron中加载的是file协议的本地的html，并没有后端。这种情况下，再采用BrowserRouter，只会定位到一个不存在的路由，导致什么都输出不了。\n另一种Router是HashRouter，它是使用了url中的hash部分去获取进行路由控制。hash我的理解是相当于页面的锚，不会被后端服务读取，只是由前端获取到了url的hash，并进行解析。因此在这里应当使用HashRouter，并在设置窗口加载html时的路径改写为：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    settingWindow.\u003C/span>\u003Cspan style=\"color:#B392F0\">loadURL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">`file://${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">__dirname\u003C/span>\u003Cspan style=\"color:#9ECBFF\">}/index.html#/setting`\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"渲染进程动态引入json\">渲染进程动态引入json\u003C/h2>\n\u003Cp>在主窗口（渲染进程）中，需要读取每一个python脚本的配置文件，也就是上边提到的script.json。在创建主窗口时，我已经在配置里设置了在渲染进程中集成node环境，因此这里可以直接使用commonjs的语法引入node环境的包和文件，比如fs和path等等，当然也包括json。但是问题就出在这个require。\u003C/p>\n\u003Cp>在使用fs进行了一系列操作之后，我使用path拼接出了script.json的路径，然而此时再加载的时候，竟然报错了，说没找到这个json文件，但是这个文件又确实存在。于是我另外开启了一个node环境，发现此时可以成功引入。然后我又在渲染进程中引入了remote对象，使用remote.require进行引入，发现此时竟然可以成功引入。因此，得出一个结论：electron渲染进程集成的node中的require和主进程的require是不同的。主进程当然就是一个正常的node环境，但是，渲染进程中集成的require实际上是一个函数，它通过向主进程的ELECTRON_BROWSER_REQUIRE信道发送信号来表示导入包，可能还有一些其他的操作。这就导致在windows环境下的进程间通信的时候，反斜杠\\出现了问题，所以找不到包。\u003C/p>\n\u003Ch2 id=\"使用child_process执行python脚本\">使用child_process执行python脚本\u003C/h2>\n\u003Cp>nodejs可以通过child_process包的exec()和spawn()来创建子进程执行python脚本。这里采用spawn创建子进程，\u003C/p>\n\u003Cp>创建完成之后，可以监听process.stdout上的data事件从而获取python的stdout，也就是print的输出。\n这里需要注意： 由于python的编码问题，需要设置std的编码为utf8编码：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    sys.stdout \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> io.TextIOWrapper(sys.stdout.detach(), \u003C/span>\u003Cspan style=\"color:#FFAB70\">encoding\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'utf-8'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>在输出的时候需要刷新缓冲区，不然会导致输出缓冲区满了才会监听到一串数据，即：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'xxx'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">flush\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"react获取到过时的state\">react获取到过时的state\u003C/h2>\n\u003Cp>出现问题的代码是这样的一个函数：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"typescript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#B392F0\"> onScriptStart\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">script\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> process\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> spawn\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(store.\u003C/span>\u003Cspan style=\"color:#B392F0\">get\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'pythonPath'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#F97583\"> ||\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'python'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        script.entry,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        ...\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(script.args?.\u003C/span>\u003Cspan style=\"color:#B392F0\">map\u003C/span>\u003Cspan style=\"color:#E1E4E8\">((\u003C/span>\u003Cspan style=\"color:#FFAB70\">arg\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> arg.value))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      ]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      process.\u003C/span>\u003Cspan style=\"color:#B392F0\">on\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'exit'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, (\u003C/span>\u003Cspan style=\"color:#FFAB70\">code\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">          if\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(code \u003C/span>\u003Cspan style=\"color:#F97583\">===\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">){\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">              new\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> remote.\u003C/span>\u003Cspan style=\"color:#B392F0\">Notification\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                  title: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'脚本管理器'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                  body: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">`任务${\u003C/span>\u003Cspan style=\"color:#E1E4E8\">running\u003C/span>\u003Cspan style=\"color:#9ECBFF\">?.\u003C/span>\u003Cspan style=\"color:#E1E4E8\">name\u003C/span>\u003Cspan style=\"color:#9ECBFF\">}已完成`\u003C/span>\u003Cspan style=\"color:#6A737D\"> // 当脚本执行完成时，这里是undefined\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">              }).\u003C/span>\u003Cspan style=\"color:#B392F0\">show\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">      setRunning\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        ...\u003C/span>\u003Cspan style=\"color:#E1E4E8\">script,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        process\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>整个函数是一个点击事件，绑定在按钮上。根据\u003Ca href=\"https://zh-hans.reactjs.org/docs/hooks-faq.html#why-am-i-seeing-stale-props-or-state-inside-my-function\">react官网的描述\u003C/a>，我们在这里拿到了过时的state。其中提到，组件内部的任何函数，包括事件处理函数和effect，都是从它被创建的那次渲染中看到的，也就是组件内部拿到的总是定义它的那次渲染中的state和props。\u003C/p>\n\u003Cp>在这里面，当我们点击按钮时，running这个状态是一个undefined，同时创建了一个process对象，并在它的回调函数中写了读取了这个running。而我们的running全程都是undefined。正确的方法应该是使用setRunning，传入一个函数，如果不想修改状态，就把形参返回即可读取到最新的state。采用参数传递的方式不会读取到闭包中的state，从而可以获取到当前最新的state。\u003C/p>\n\u003Ch2 id=\"打包\">打包\u003C/h2>\n\u003Ch3 id=\"版本控制\">版本控制\u003C/h3>\n\u003Cp>可以看到，整个项目中有两个package.json，外部的是管理整个项目的，内部的其实可以看作是react的package.json。安装包的版本是由里面的package.json中的信息决定的，所以记得改里面的应用名称和版本。\u003C/p>\n\u003Ch3 id=\"packagejson\">package.json\u003C/h3>\n\u003Cp>在windows环境下，根目录下package.json中的打包脚本package中，由于不存在rm -rf指令，因此可以安装rimraf包，然后把rm -rf改成rimraf，即：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>    \"package\": \"rimraf release &#x26;&#x26; rimraf src/dist &#x26;&#x26; npm run build &#x26;&#x26; electron-builder build --publish never\",\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"执行package命令\">执行package命令\u003C/h3>\n\u003Cp>刚开始执行package会下载一堆东西，下就是了。下到最后会发现，报了一个奇怪的错误，原因是路径中有中文字符。但是用户名就是中文字符呀没办法，所以参考这个链接中的方法，修改了node_modules中一个编码就好了。\u003Ca href=\"https://blog.csdn.net/kyq0417/article/details/111266776\">解决办法\u003C/a>\u003C/p>",{"headings":1184,"localImagePaths":1207,"remoteImagePaths":1208,"frontmatter":1209,"imagePaths":1211},[1185,1186,1188,1190,1192,1194,1196,1198,1200,1202,1205],{"depth":283,"slug":295,"text":295},{"depth":283,"slug":1187,"text":1187},"实现细节",{"depth":26,"slug":1189,"text":1189},"工程搭建",{"depth":26,"slug":1191,"text":1191},"electron实现多窗口",{"depth":26,"slug":1193,"text":1193},"渲染进程动态引入json",{"depth":26,"slug":1195,"text":1195},"使用child_process执行python脚本",{"depth":26,"slug":1197,"text":1197},"react获取到过时的state",{"depth":26,"slug":1199,"text":1199},"打包",{"depth":81,"slug":1201,"text":1201},"版本控制",{"depth":81,"slug":1203,"text":1204},"packagejson","package.json",{"depth":81,"slug":1206,"text":1206},"执行package命令",[],[],{"title":1173,"pubDate":1210,"category":33,"excerpt":1177},["Date","2021-02-27T23:45:05.000Z"],[],"速通b站硬核会员",{"id":1212,"data":1214,"body":1218,"filePath":1219,"digest":1220,"rendered":1221},{"title":1215,"pubDate":1216,"category":33,"excerpt":1217},"两分钱速通B站硬核会员",["Date","2024-10-13T22:44:42.000Z"],"我也要硬核会员！","## 前言\n\n前阵子不知道为啥，一直用的域名突然被阿里云封了，申诉也不给解封，只好换个域名。正好整理一下博客，太久没更新都吃灰了，新的博客地址是 https://blog.catcat.work\n\n## 需求\n\nB 站 6 级之后可以通过在**手机端**答题升级为 “硬核会员”。题库分为几个分区，用户可以选择其中的一个或几个分区去答题，总共 100 道题，2 小时内答对 60 道就算通过。题目都是选择题。对我来说，直接答题太困难了，百度搜 100 道题又太费时间，不如直接写个脚本，自动 “搜索” 参考答案。\n\n## 思路\n\n期望的效果是：界面出现题目后，脚本可以自动获取参考答案。细化一些考虑，问题首先可以被拆分成两步：\n\n- 第一步：获取界面中展示的题目和选项的**文字**内容\n- 第二步：根据题目和选项获取参考答案\n\n第一步可以使用无障碍、OCR等工具实现获取屏幕中的文字内容，简单起见使用OCR就够了。\n\n第二步的话，很久以前写过一个微信读书自动答题的脚本，是用的百度搜索，但效果太差了。大模型做这种问答类的题目其实效果还是蛮不错的，毕竟经过大量的数据训练，学习过大量的知识。ChatGPT 还是有些贵的，为了降低成本，直接用便宜的国产大模型\n\n我们的最终目标是答对 60 题，对于题目类别的话，尽可能选取一些答案比较确定或者参考资料比较多的。如果是鬼畜区什么的，出现了什么新的梗 GPT 可能不知道，正确率也就保证不了了。(下图是网上搜的)\n\n![硬核会员](/images/bilibili-硬核会员.png)\n\n相对来说，文史类的答案可能会更容易搜到一些（至少参考资料会多一些），就它了！\n\n## 实现\n\n先说下开发环境，脚本是在 Python 3.12 环境下开发的。进入正题~\n\n### 获取窗口截图\n\n识别题目的第一步是获取截图。我们可以连接真机，在手机上打开 adb 调试，然后使用 `adb shell screencap` 命令获取截图。也可以直接在电脑装个模拟器（这里装的是 Mumu 模拟器），直接给模拟器窗口截图。后者简单很多，我们直接用后者实现。\n\n为了截取屏幕上某个窗口的画面，我们首先需要知道窗口的位置和大小，这可以使用 `pygetwindow` 库，导入这个库后就可以直接根据黄口标题搜索窗口：\n\n``` python\nimport pygetwindow as gw\n\n# 获取所有名字为 “MuMu模拟器” 的窗口\nwindow_list = gw.getWindowWithTitle(\"MuMu模拟器\")\n\n# 简单一些，只取第一个\nwindow = window_list[0]\n\n# 输出窗口的坐标\nprint(window.x, window.y, window.width, window.height)\n```\n\n上面几行代码就可以直接输出模拟器窗口的位置和大小。知道了窗口的位置和大小之后，我们就可以使用 `Pillow` 截图啦：\n\n``` python\nfrom PIL import ImageGrab\n\nscreenshot = ImageGrab.grab(bbox=(window.x, window.y, window.width, window.height))\n```\n\n到这里，截图的代码就写完了。也可以调整截取区域的 `y` 坐标和高度，截取的区域小一些，后面调用 OCR 识别文字也会快一些，效果：\n\n![会员截图](/images/bilibili-答题截图.jpg)\n\n### 识别题目\n\n图截完了，下一步是获取题目和内容。这里使用 `Paddlepaddle` 提供的 OCR 模型进行识别。`PaddleOCR v4` 提供了文本检测、文本识别、文本方向识别三类模型。其中文本检测是用来识别图片里哪里存在文字， 文本识别是来识别图片中文字的具体内容是什么，文本方向识别用来识别图片中文字的方向。为了识别截图中文字的内容和位置，我们三个模型都要用到。\n\n每类模型还分成轻量型、高精度型等等，官网上也分别提供了几个模型文件的下载。以中文文本检测模型为例，轻量版推理模型的大小为 4.7M，而高精度版推理模型的大小是 110M。在使用体验上，高精度版的效果可能会更好，但速度会更慢。我直接在 CPU 上跑的，实测轻量版效果完全够用，并且速度还能接受（识别一张图片的文字大概不到 3 秒）。\n\n接下来进行代码实现：\n\n``` python\nfrom paddleocr import PaddleOCR\nimport numpy as np\n\n# 加载 OCR 模型\nocr = PaddleOCR(use_angle_cls=True, lang=\"ch\", det_model_dir='文本检测模型的目录', rec_model_dir='文本识别模型的目录', cls_model_dir='文本方向识别模型的目录')\n\nimg_array = np.array(screenshot) # 还记得上面截图得到的 screenshot 嘛，在这里被转化成了 numpy 数组\nresult = ocr.ocr(img_array, cls=True) # OCR 识别\n```\n\n这样图片中的文字就识别好了。我们也可以使用 `paddleocr` 提供的 `draw_ocr` 把识别到的文字画出来：\n\n``` python\nfrom paddleocr import draw_ocr\n\nfor idx in range(len(result)):\n    res = result[idx]\n    for line in res:\n        boxes = line[0]\n        text = line[1][0]\n\n    # 显示结果\n    result = result[0]\n    image = img.convert('RGB')\n    boxes = [line[0] for line in result]\n    txts = [line[1][0] for line in result]\n    scores = [line[1][1] for line in result]\n    im_show = draw_ocr(image, boxes, txts, scores)\n    im_show = Image.fromarray(im_show)\n    im_show.save('result.jpg')\n```\n\n![会员截图](/images/bilibili-答题ocr截图.jpg)\n\n至于如何分辨文字是题目还是选项，直接根据位置特征来就好啦。题目部分文字的左边界始终在距离左侧屏幕大约 100 像素以内的位置；选项部分的位置特征也很明显，每行文字距离顶部一定超过 64 个像素，并且距离左侧边界的位置比较远。\n\n以图中为例，我们通过上面这种策略就可以组合出问题和答案 --   \n\n问题是: 为你千千万万遍\" 出自以下哪一部文学作品？  \n选项分别是：《Flipped》、《追风筝的人》、《简爱》和《我的天才女友》\n\n### 自动答题\n\n自动答题这一步，我们使用大模型来做。首先给大模型定义一个角色，告诉它它是一个答题专家（定义 system role）：\n\n```\n- 你是一个通晓古今的百科全书，拥有丰富的学识和答题经验。现在需要你根据用户输入的问题 \u003CQuestion> 以及选项 \u003COption> 选出一个最合适的选项 \u003CAnswer>，然后输出选项的内容。\n- 需要注意，你的答案仅能是从选项中选择，不能自由发挥。\n- 题目类型都是选择题，一部分是问题选项，另一部分需要你从选项中选出一个最合适的填补题目的空缺。题目的空缺会用连续的下划线__表示。\n- 你只需要回答你认为正确的选项，不需要做出任何解释。你的答案需要有理论依据，不可以回答虚构的答案。\n```\n\n接下来，可以给它一些样例输入，让它有些参考依据：\n\n```\n- 用户输入：\n\u003CQuestion>最古老的文学体裁是什么？\n\u003COption>诗歌\n\u003COption>小说\n\u003COption>散文\n\n- 输出：\n\u003CAnswer>诗歌\n```\n\n剩下要做的就是调接口啦：\n\n``` python\nimport requests\nimport json\n\n\nkey = \"sk-xxxxxxx\"\n\nurl = \"https://api.xxxxxx.com/chat/completions\" # 避免打广告，不写具体的模型厂商了~ 换任何一家的大模型按文档来都可以\n\ndef llm(questionBody):\n    payload = json.dumps({\n        \"messages\": [\n            {\n                \"content\": \"- 你是一个通晓古今的百科全书，拥有丰富的学识和答题经验。现在需要你根据用户输入的问题 \u003CQuestion> 以及选项 \u003COption> 选出一个最合适的选项 \u003CAnswer>，然后输出选项的内容。\\n- 需要注意，你的答案仅能是从选项中选择，不能自由发挥。\\n- 题目类型都是选择题，一部分是问题选项，另一部分需要你从选项中选出一个最合适的填补题目的空缺。题目的空缺会用连续的下划线__表示。\\n- 你只需要回答你认为正确的选项，不需要做出任何解释。你的答案需要有理论依据，不可以回答虚构的答案。\\n\",\n                \"role\": \"system\"\n            },\n            {\n                \"content\": \"\u003CQuestion>最古老的文学体裁是什么？\\n\u003COption>诗歌\\n\u003COption>小说\\n\u003COption>散文\\n\",\n                \"role\": \"user\"\n            },\n            {\n                \"content\": \"\u003CAnswer>诗歌\",\n                \"role\": \"assistant\"\n            },\n            {\n                \"content\": f'\u003CQuestion>{questionBody}',\n                \"role\": \"user\"\n            }\n        ],\n        \"model\": \"xxxxxx\", # 避免打广告，不写具体的模型了~\n        \"frequency_penalty\": 0,\n        \"max_tokens\": 2048,\n        \"presence_penalty\": 0,\n        \"response_format\": {\n            \"type\": \"text\"\n        },\n        \"stop\": None,\n        \"stream\": False,\n        \"stream_options\": None,\n        \"temperature\": 1,\n        \"top_p\": 1,\n        \"tools\": None,\n        \"tool_choice\": \"none\",\n        \"logprobs\": False,\n        \"top_logprobs\": None\n    })\n\n    headers = {\n        'Content-Type': 'application/json',\n        'Accept': 'application/json',\n        'Authorization': f'Bearer {key}'\n    }\n\n    response = requests.request(\"POST\", url, headers=headers, data=payload)\n    return response.json()[\"choices\"][0][\"message\"][\"content\"]\n\n```\n\n调一下接口尝试一下：\n\n``` python\nans = llm('为你千千万万遍\" 出自以下哪一部文学作品？\\n\u003COption>《Flipped》\\n\u003COption>《追风筝的人》\\n\u003COption>《简爱》\\n\u003COption>《我的天才女友》')\n\nprint(ans)\n```\n\n![会员截图](/images/bilibili-答案.jpg)\n\n好了，这道题选B~\n\n## 效果\n\n最后只需要把上面的过程串起来就好啦，把 OCR 识别出的题目和答案送给大模型，让大模型帮忙选个答案。有了这个助手，分分钟通关硬核会员~\n\n![会员截图](/images/bilibili-通关截图.png)\n\n而成本只有不到两分钱：\n\n![花费截图](/images/bilibili-花费截图.png)\n\n完结撒花","src/content/posts/速通B站硬核会员.md","ced013e25bc9b6c1",{"html":1222,"metadata":1223},"\u003Ch2 id=\"前言\">前言\u003C/h2>\n\u003Cp>前阵子不知道为啥，一直用的域名突然被阿里云封了，申诉也不给解封，只好换个域名。正好整理一下博客，太久没更新都吃灰了，新的博客地址是 \u003Ca href=\"https://blog.catcat.work\">https://blog.catcat.work\u003C/a>\u003C/p>\n\u003Ch2 id=\"需求\">需求\u003C/h2>\n\u003Cp>B 站 6 级之后可以通过在\u003Cstrong>手机端\u003C/strong>答题升级为 “硬核会员”。题库分为几个分区，用户可以选择其中的一个或几个分区去答题，总共 100 道题，2 小时内答对 60 道就算通过。题目都是选择题。对我来说，直接答题太困难了，百度搜 100 道题又太费时间，不如直接写个脚本，自动 “搜索” 参考答案。\u003C/p>\n\u003Ch2 id=\"思路\">思路\u003C/h2>\n\u003Cp>期望的效果是：界面出现题目后，脚本可以自动获取参考答案。细化一些考虑，问题首先可以被拆分成两步：\u003C/p>\n\u003Cul>\n\u003Cli>第一步：获取界面中展示的题目和选项的\u003Cstrong>文字\u003C/strong>内容\u003C/li>\n\u003Cli>第二步：根据题目和选项获取参考答案\u003C/li>\n\u003C/ul>\n\u003Cp>第一步可以使用无障碍、OCR等工具实现获取屏幕中的文字内容，简单起见使用OCR就够了。\u003C/p>\n\u003Cp>第二步的话，很久以前写过一个微信读书自动答题的脚本，是用的百度搜索，但效果太差了。大模型做这种问答类的题目其实效果还是蛮不错的，毕竟经过大量的数据训练，学习过大量的知识。ChatGPT 还是有些贵的，为了降低成本，直接用便宜的国产大模型\u003C/p>\n\u003Cp>我们的最终目标是答对 60 题，对于题目类别的话，尽可能选取一些答案比较确定或者参考资料比较多的。如果是鬼畜区什么的，出现了什么新的梗 GPT 可能不知道，正确率也就保证不了了。(下图是网上搜的)\u003C/p>\n\u003Cp>\u003Cimg src=\"/images/bilibili-%E7%A1%AC%E6%A0%B8%E4%BC%9A%E5%91%98.png\" alt=\"硬核会员\">\u003C/p>\n\u003Cp>相对来说，文史类的答案可能会更容易搜到一些（至少参考资料会多一些），就它了！\u003C/p>\n\u003Ch2 id=\"实现\">实现\u003C/h2>\n\u003Cp>先说下开发环境，脚本是在 Python 3.12 环境下开发的。进入正题~\u003C/p>\n\u003Ch3 id=\"获取窗口截图\">获取窗口截图\u003C/h3>\n\u003Cp>识别题目的第一步是获取截图。我们可以连接真机，在手机上打开 adb 调试，然后使用 \u003Ccode>adb shell screencap\u003C/code> 命令获取截图。也可以直接在电脑装个模拟器（这里装的是 Mumu 模拟器），直接给模拟器窗口截图。后者简单很多，我们直接用后者实现。\u003C/p>\n\u003Cp>为了截取屏幕上某个窗口的画面，我们首先需要知道窗口的位置和大小，这可以使用 \u003Ccode>pygetwindow\u003C/code> 库，导入这个库后就可以直接根据黄口标题搜索窗口：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pygetwindow \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> gw\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># 获取所有名字为 “MuMu模拟器” 的窗口\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">window_list \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> gw.getWindowWithTitle(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"MuMu模拟器\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># 简单一些，只取第一个\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">window \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> window_list[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># 输出窗口的坐标\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(window.x, window.y, window.width, window.height)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>上面几行代码就可以直接输出模拟器窗口的位置和大小。知道了窗口的位置和大小之后，我们就可以使用 \u003Ccode>Pillow\u003C/code> 截图啦：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#79B8FF\"> PIL\u003C/span>\u003Cspan style=\"color:#F97583\"> import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ImageGrab\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">screenshot \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ImageGrab.grab(\u003C/span>\u003Cspan style=\"color:#FFAB70\">bbox\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(window.x, window.y, window.width, window.height))\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>到这里，截图的代码就写完了。也可以调整截取区域的 \u003Ccode>y\u003C/code> 坐标和高度，截取的区域小一些，后面调用 OCR 识别文字也会快一些，效果：\u003C/p>\n\u003Cp>\u003Cimg src=\"/images/bilibili-%E7%AD%94%E9%A2%98%E6%88%AA%E5%9B%BE.jpg\" alt=\"会员截图\">\u003C/p>\n\u003Ch3 id=\"识别题目\">识别题目\u003C/h3>\n\u003Cp>图截完了，下一步是获取题目和内容。这里使用 \u003Ccode>Paddlepaddle\u003C/code> 提供的 OCR 模型进行识别。\u003Ccode>PaddleOCR v4\u003C/code> 提供了文本检测、文本识别、文本方向识别三类模型。其中文本检测是用来识别图片里哪里存在文字， 文本识别是来识别图片中文字的具体内容是什么，文本方向识别用来识别图片中文字的方向。为了识别截图中文字的内容和位置，我们三个模型都要用到。\u003C/p>\n\u003Cp>每类模型还分成轻量型、高精度型等等，官网上也分别提供了几个模型文件的下载。以中文文本检测模型为例，轻量版推理模型的大小为 4.7M，而高精度版推理模型的大小是 110M。在使用体验上，高精度版的效果可能会更好，但速度会更慢。我直接在 CPU 上跑的，实测轻量版效果完全够用，并且速度还能接受（识别一张图片的文字大概不到 3 秒）。\u003C/p>\n\u003Cp>接下来进行代码实现：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> paddleocr \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> PaddleOCR\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> numpy \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> np\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># 加载 OCR 模型\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">ocr \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> PaddleOCR(\u003C/span>\u003Cspan style=\"color:#FFAB70\">use_angle_cls\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">lang\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"ch\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">det_model_dir\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'文本检测模型的目录'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">rec_model_dir\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'文本识别模型的目录'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">cls_model_dir\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'文本方向识别模型的目录'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">img_array \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> np.array(screenshot) \u003C/span>\u003Cspan style=\"color:#6A737D\"># 还记得上面截图得到的 screenshot 嘛，在这里被转化成了 numpy 数组\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ocr.ocr(img_array, \u003C/span>\u003Cspan style=\"color:#FFAB70\">cls\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#6A737D\"># OCR 识别\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>这样图片中的文字就识别好了。我们也可以使用 \u003Ccode>paddleocr\u003C/code> 提供的 \u003Ccode>draw_ocr\u003C/code> 把识别到的文字画出来：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> paddleocr \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> draw_ocr\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> idx \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#79B8FF\"> range\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(result)):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    res \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result[idx]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> line \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> res:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        boxes \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> line[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        text \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> line[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">][\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # 显示结果\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    image \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> img.convert(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'RGB'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    boxes \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [line[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> line \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    txts \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [line[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">][\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> line \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    scores \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [line[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">][\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> line \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    im_show \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> draw_ocr(image, boxes, txts, scores)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    im_show \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Image.fromarray(im_show)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    im_show.save(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'result.jpg'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cimg src=\"/images/bilibili-%E7%AD%94%E9%A2%98ocr%E6%88%AA%E5%9B%BE.jpg\" alt=\"会员截图\">\u003C/p>\n\u003Cp>至于如何分辨文字是题目还是选项，直接根据位置特征来就好啦。题目部分文字的左边界始终在距离左侧屏幕大约 100 像素以内的位置；选项部分的位置特征也很明显，每行文字距离顶部一定超过 64 个像素，并且距离左侧边界的位置比较远。\u003C/p>\n\u003Cp>以图中为例，我们通过上面这种策略就可以组合出问题和答案 —\u003C/p>\n\u003Cp>问题是: 为你千千万万遍” 出自以下哪一部文学作品？\u003Cbr>\n选项分别是：《Flipped》、《追风筝的人》、《简爱》和《我的天才女友》\u003C/p>\n\u003Ch3 id=\"自动答题\">自动答题\u003C/h3>\n\u003Cp>自动答题这一步，我们使用大模型来做。首先给大模型定义一个角色，告诉它它是一个答题专家（定义 system role）：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>- 你是一个通晓古今的百科全书，拥有丰富的学识和答题经验。现在需要你根据用户输入的问题 &#x3C;Question> 以及选项 &#x3C;Option> 选出一个最合适的选项 &#x3C;Answer>，然后输出选项的内容。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- 需要注意，你的答案仅能是从选项中选择，不能自由发挥。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- 题目类型都是选择题，一部分是问题选项，另一部分需要你从选项中选出一个最合适的填补题目的空缺。题目的空缺会用连续的下划线__表示。\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- 你只需要回答你认为正确的选项，不需要做出任何解释。你的答案需要有理论依据，不可以回答虚构的答案。\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>接下来，可以给它一些样例输入，让它有些参考依据：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>- 用户输入：\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>&#x3C;Question>最古老的文学体裁是什么？\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>&#x3C;Option>诗歌\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>&#x3C;Option>小说\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>&#x3C;Option>散文\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- 输出：\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>&#x3C;Answer>诗歌\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>剩下要做的就是调接口啦：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> json\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">key \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"sk-xxxxxxx\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">url \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"https://api.xxxxxx.com/chat/completions\"\u003C/span>\u003Cspan style=\"color:#6A737D\"> # 避免打广告，不写具体的模型厂商了~ 换任何一家的大模型按文档来都可以\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> llm\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(questionBody):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    payload \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> json.dumps({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"messages\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"- 你是一个通晓古今的百科全书，拥有丰富的学识和答题经验。现在需要你根据用户输入的问题 &#x3C;Question> 以及选项 &#x3C;Option> 选出一个最合适的选项 &#x3C;Answer>，然后输出选项的内容。\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">- 需要注意，你的答案仅能是从选项中选择，不能自由发挥。\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">- 题目类型都是选择题，一部分是问题选项，另一部分需要你从选项中选出一个最合适的填补题目的空缺。题目的空缺会用连续的下划线__表示。\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">- 你只需要回答你认为正确的选项，不需要做出任何解释。你的答案需要有理论依据，不可以回答虚构的答案。\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"role\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"system\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"&#x3C;Question>最古老的文学体裁是什么？\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">&#x3C;Option>诗歌\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">&#x3C;Option>小说\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">&#x3C;Option>散文\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"role\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"user\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"&#x3C;Answer>诗歌\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"role\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"assistant\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'&#x3C;Question>\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">questionBody\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"role\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"user\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        ],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"model\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"xxxxxx\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#6A737D\"># 避免打广告，不写具体的模型了~\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"frequency_penalty\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"max_tokens\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">2048\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"presence_penalty\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"response_format\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            \"type\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"text\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"stop\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">None\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"stream\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"stream_options\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">None\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"temperature\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"top_p\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"tools\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">None\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"tool_choice\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"none\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"logprobs\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"top_logprobs\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">None\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    headers \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'Content-Type'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'application/json'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'Accept'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'application/json'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'Authorization'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Bearer \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">key\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests.request(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"POST\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, url, \u003C/span>\u003Cspan style=\"color:#FFAB70\">headers\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">headers, \u003C/span>\u003Cspan style=\"color:#FFAB70\">data\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">payload)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.json()[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"choices\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">][\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">][\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"message\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">][\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>调一下接口尝试一下：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">ans \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> llm(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'为你千千万万遍\" 出自以下哪一部文学作品？\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">&#x3C;Option>《Flipped》\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">&#x3C;Option>《追风筝的人》\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">&#x3C;Option>《简爱》\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">&#x3C;Option>《我的天才女友》'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(ans)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cimg src=\"/images/bilibili-%E7%AD%94%E6%A1%88.jpg\" alt=\"会员截图\">\u003C/p>\n\u003Cp>好了，这道题选B~\u003C/p>\n\u003Ch2 id=\"效果\">效果\u003C/h2>\n\u003Cp>最后只需要把上面的过程串起来就好啦，把 OCR 识别出的题目和答案送给大模型，让大模型帮忙选个答案。有了这个助手，分分钟通关硬核会员~\u003C/p>\n\u003Cp>\u003Cimg src=\"/images/bilibili-%E9%80%9A%E5%85%B3%E6%88%AA%E5%9B%BE.png\" alt=\"会员截图\">\u003C/p>\n\u003Cp>而成本只有不到两分钱：\u003C/p>\n\u003Cp>\u003Cimg src=\"/images/bilibili-%E8%8A%B1%E8%B4%B9%E6%88%AA%E5%9B%BE.png\" alt=\"花费截图\">\u003C/p>\n\u003Cp>完结撒花\u003C/p>",{"headings":1224,"localImagePaths":1238,"remoteImagePaths":1239,"frontmatter":1240,"imagePaths":1242},[1225,1226,1228,1230,1231,1233,1235,1237],{"depth":26,"slug":27,"text":27},{"depth":26,"slug":1227,"text":1227},"需求",{"depth":26,"slug":1229,"text":1229},"思路",{"depth":26,"slug":1117,"text":1117},{"depth":81,"slug":1232,"text":1232},"获取窗口截图",{"depth":81,"slug":1234,"text":1234},"识别题目",{"depth":81,"slug":1236,"text":1236},"自动答题",{"depth":26,"slug":959,"text":959},[],[],{"title":1215,"pubDate":1241,"category":33,"excerpt":1217},["Date","2024-10-13T22:44:42.000Z"],[],"在浏览器环境下加载cnn进行手写数字识别",{"id":1243,"data":1245,"body":1249,"filePath":1250,"digest":1251,"rendered":1252},{"title":1246,"pubDate":1247,"category":16,"excerpt":1248},"浏览器环境下加载CNN进行手写数字识别，并部署到gitee page",["Date","2021-09-25T01:34:42.000Z"],"用Pytorch训练LeNet-5实现手写数字识别，并将模型在浏览器端进行加载。","# 前言\n尝试一下用Mnist数据集训练一个简单的CNN网络，然后搭建一个静态页面，在浏览器端加载模型使用canvas区域的内容预测手写数字。模型使用Pytorch编写，用cpu训了10个epoch之后导出为onnx模型。之后在浏览器端通过onnxruntime-web进行加载，并进行预测。\n\n![这是一个2](https://ss.im5i.com/2021/09/25/lJsvm.jpg)\n![这是一个7](https://ss.im5i.com/2021/09/25/lJJeq.jpg)\n\n# 模型\n模型代码其实网络上已经有很多了，原理和细节也不再赘述；需要注意的是，输入是一个Batchsize x 1 x 28 x 28 的矩阵，输出为Batchsize x 10的矩阵也就是说第一维是动态的，这就决定了我们在导出为onnx模型时的写法：\n``` python\ndef transformToOnnx(model, batch_size, name='mnist.onnx'):\n    model.eval()\n    x = torch.randn(batch_size, 1, 28, 28)\n    torch.onnx.export(model, x, name, export_params=True, opset_version=11, do_constant_folding=True, input_names=[\n                      'input'], output_names=['output'], dynamic_axes={'input': {0: 'batch_size'}, 'output': {0: 'batch_size'}})\n```\n首先需要使用model.eval()将模型切换为预测模式，接下来我们随机生成一个输入的参数，也就是Batchsize x 1 x 28 x 28大小的一个随机矩阵。在导出时需要指定导出的路径，输入和输出的符号（上边的写法意思是在后续加载模型的时候，输入变量名为input，输出变量名为output）。同时由于输入和输出的第一维都是batchsize，因此把它们指定为动态轴。\n\n# 前端实现\n## 初始化工程\n首先采用vite初始化一个react-ts项目，这一步没有太多注意事项。\n\n## 模型的加载和预测\n为了加载模型，我们需要使用onnxruntime-web。onnxruntime-web是一个可以在浏览器环境下和nodejs环境下加载onnx模型的库，可以在CPU和GPU上运行，CPU使用web assambly来加载模型，而GPU使用Webgl来加载，默认运行在CPU上。两种方案支持的符号集不同，wasm方式支持全部的符号集，而webgl方式仅仅支持一部分符号集（具体的说明参考文献[1]）；除此之外，在ios的chrome、edge和safari浏览器中仅支持wasm。本次小实验导出的模型如果采用webgl加载，就会遇到上边提到的符号集的问题，因此采用wasm加载模型。我们只需要：\n```\nyarn add onnxruntime-web\n```\n便可以在工程中安装这个包了。\n\n接下来我们需要对vite工程进行一些配置。由于vite在启动server时有一个pre-bundle的过程，使用esbuild将各种非标准的模块转化为es6模块。onnxruntime-web中使用到了export namespace xx的写法，这些会在pre-bundle的时候报错，因此我们可以选择通过pre-bundle过程；\n\n同时，即便我们跳过了pre-bundle的过程，我们会发现在项目启动之后，onnxruntime-web会自动的去static/js路径下去找两个wasm文件，而在启动服务和打包的时候并不会自动的加入这两个文件。而如果我们引入cdn上的onnxruntime-web库，我们会发现它会自动地去cdn地址请求wasm文件，cdn上这两个文件自然是存在的。参考onnxruntime给出的demo[2]，可以看到，官方在使用webpack打包的时候也是使用了CopyWebpackPlugin将对应的文件拷贝到打包之后的目录中。为了方便开发和打包，建议首先跳过pre-bundle过程，然后采用cdn加载onnxruntime-web包，并在vite.config.js中声明该包为external，即：\n``` javascript\n// vite.config.js\nimport { defineConfig } from 'vite'\nimport react from '@vitejs/plugin-react'\nimport { viteExternalsPlugin } from 'vite-plugin-externals'\n\n// https://vitejs.dev/config/\nexport default defineConfig({\n  plugins: [\n    react(),\n    viteExternalsPlugin({ // 声明为external\n      'onnxruntime-web': 'ort'\n    })\n  ],\n  optimizeDeps: {\n    exclude: [ // 跳过pre-bundle\n      'onnxruntime-web'\n    ] \n  },\n  base: '/mnist-demo/'\n})\n```\n然后在index.html中加上库的cdn地址：\n``` html\n\u003Cscript src=\"https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js\">\u003C/script>\n\n```\n\n接下来的过程其实就很简单了，我们成功的引入了onnxruntime-web库，然后需要用它来加载模型，并进行预测：\n``` javascript\n...\n    // 加载模型\n    const session = await ort.InferenceSession.create(model);\n    // 输入数据，第一个参数是数据类型，第二个参数inputArray是一个一维数组，第三个参数表示的是维度，注意需要和之前模型导出时定义的维度相一致，即：dynamic x 1 x 28 x 28\n    const inputs = new ort.Tensor(\"float32\", inputArray, [1, 1, 28, 28]);\n    // 使用run进行预测，需要注意的是，输入和输出与之前导出时定义的输入输出变量名一致\n    const outputs = await session.run({\n        input: inputs,\n      });\n    // 预测结果\n    console.log(outputs.output.data);\n```\n\n到此为止，在浏览器加载模型的部分就完成了，接下来只需要想个办法获取到用户输入的数据，并使用这些数据进行预测。\n\n## 获取输入数据\n模型输入是1x28x28的图片，而让人在屏幕上手动的去在一个28像素x28像素的区域内绘制肯定是个不现实的事情（太小了）。因此我们需要把输入的canvas放大（这里采用的是300x300），在预测时对画布的输入进行缩小,并转化为单通道。\n\n为了获取到这个300x300区域内的像素数据，我们使用canvas.getImageData()获取到这个区域内的rgba数组。接下来，我们需要将它缩放为28x28的大小。这里引入了pica库，使用pica的resizeBuffer函数对像素区域进行缩放。\n\n由于canvas的默认颜色是黑色透明，因此我们拿到的数组的非画笔区域的rgba值为(0,0,0,0)。同时注意到模型的输入中，灰度的取值范围为-1-1，因此为了保留单通道，我们保留a，并将其根据是否为0，简单地映射到-1和1就够了。\n\n还需要注意的是，由于画布会从300x300缩放到28x28，因此canvas画笔的粗细也是一个影响效果的因素：如果画笔过细，缩放之后画布区域的像素值都是0，也就没有效果了；如果画笔过粗，可能缩放之后，原本隔着很远的两个区域变成了邻居，也会影响效果。\n\n最后，我们只需要根据上述操作，根据缩放、处理过后的数组构建输入的Tensor，并传入模型进行预测就可以了。\n\n## 总结\n到这里，其实模型的加载、预测和如何获取输入数据都已经完成了。最后就是把以上的东西串起来。实际的效果就是最上边两张图的样式，我把它放在了gitee page上，实测网络请求的速度还可以接受：\n![加载速度](https://ss.im5i.com/2021/09/25/lJEUs.png)\n同时我也把它部署在我的服务器中，模型丢到cdn上，速度也还可以接受（gzip对模型好像压不了多少呀。。）：\n![加载速度](https://ss.im5i.com/2021/09/25/lJUiQ.png)\n\n也就是说，对于一些简单的模型，我们完全可以丢到gitee page上进行使用，还是蛮好玩的。\n\n最后丢个页面地址和仓库地址，有人需要的话我再去补readme，球球点个关注和star吧：\n\n### 页面地址：\n\n[Gitee Page版本](http://maotoumao.gitee.io/mnist-demo/)\n\n[部署到nginx的版本](http://example.upup.fun/mnist)\n\n\n### 仓库地址：\n\n[Github仓库](https://github.com/maotoumao/mnist-demo/)\n\n[Gitee仓库](https://gitee.com/maotoumao/mnist-demo)\n\n[个人博客](http://blog.upup.fun)\n\n[原文地址](http://blog.upup.fun/2021/09/25/%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%8A%A0%E8%BD%BDCNN%E8%BF%9B%E8%A1%8C%E6%89%8B%E5%86%99%E6%95%B0%E5%AD%97%E8%AF%86%E5%88%AB/)\n\n---\n\n### 参考文献\n[1] onnxruntime web: https://www.npmjs.com/package/onnxruntime-web#Operators\n\n[2] onnxruntime-web使用demo https://github.com/microsoft/onnxruntime-inference-examples/tree/main/js/quick-start_onnxruntime-web-bundler","src/content/posts/在浏览器环境下加载CNN进行手写数字识别.md","e904b89dda2304b9",{"html":1253,"metadata":1254},"\u003Ch1 id=\"前言\">前言\u003C/h1>\n\u003Cp>尝试一下用Mnist数据集训练一个简单的CNN网络，然后搭建一个静态页面，在浏览器端加载模型使用canvas区域的内容预测手写数字。模型使用Pytorch编写，用cpu训了10个epoch之后导出为onnx模型。之后在浏览器端通过onnxruntime-web进行加载，并进行预测。\u003C/p>\n\u003Cp>\u003Cimg src=\"https://ss.im5i.com/2021/09/25/lJsvm.jpg\" alt=\"这是一个2\">\n\u003Cimg src=\"https://ss.im5i.com/2021/09/25/lJJeq.jpg\" alt=\"这是一个7\">\u003C/p>\n\u003Ch1 id=\"模型\">模型\u003C/h1>\n\u003Cp>模型代码其实网络上已经有很多了，原理和细节也不再赘述；需要注意的是，输入是一个Batchsize x 1 x 28 x 28 的矩阵，输出为Batchsize x 10的矩阵也就是说第一维是动态的，这就决定了我们在导出为onnx模型时的写法：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> transformToOnnx\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(model, batch_size, name\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'mnist.onnx'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    model.eval()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    x \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> torch.randn(batch_size, \u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">28\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">28\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    torch.onnx.export(model, x, name, \u003C/span>\u003Cspan style=\"color:#FFAB70\">export_params\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">opset_version\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">11\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">do_constant_folding\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">input_names\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                      'input'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], \u003C/span>\u003Cspan style=\"color:#FFAB70\">output_names\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'output'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], \u003C/span>\u003Cspan style=\"color:#FFAB70\">dynamic_axes\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'input'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'batch_size'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'output'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'batch_size'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}})\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>首先需要使用model.eval()将模型切换为预测模式，接下来我们随机生成一个输入的参数，也就是Batchsize x 1 x 28 x 28大小的一个随机矩阵。在导出时需要指定导出的路径，输入和输出的符号（上边的写法意思是在后续加载模型的时候，输入变量名为input，输出变量名为output）。同时由于输入和输出的第一维都是batchsize，因此把它们指定为动态轴。\u003C/p>\n\u003Ch1 id=\"前端实现\">前端实现\u003C/h1>\n\u003Ch2 id=\"初始化工程\">初始化工程\u003C/h2>\n\u003Cp>首先采用vite初始化一个react-ts项目，这一步没有太多注意事项。\u003C/p>\n\u003Ch2 id=\"模型的加载和预测\">模型的加载和预测\u003C/h2>\n\u003Cp>为了加载模型，我们需要使用onnxruntime-web。onnxruntime-web是一个可以在浏览器环境下和nodejs环境下加载onnx模型的库，可以在CPU和GPU上运行，CPU使用web assambly来加载模型，而GPU使用Webgl来加载，默认运行在CPU上。两种方案支持的符号集不同，wasm方式支持全部的符号集，而webgl方式仅仅支持一部分符号集（具体的说明参考文献[1]）；除此之外，在ios的chrome、edge和safari浏览器中仅支持wasm。本次小实验导出的模型如果采用webgl加载，就会遇到上边提到的符号集的问题，因此采用wasm加载模型。我们只需要：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>yarn add onnxruntime-web\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>便可以在工程中安装这个包了。\u003C/p>\n\u003Cp>接下来我们需要对vite工程进行一些配置。由于vite在启动server时有一个pre-bundle的过程，使用esbuild将各种非标准的模块转化为es6模块。onnxruntime-web中使用到了export namespace xx的写法，这些会在pre-bundle的时候报错，因此我们可以选择通过pre-bundle过程；\u003C/p>\n\u003Cp>同时，即便我们跳过了pre-bundle的过程，我们会发现在项目启动之后，onnxruntime-web会自动的去static/js路径下去找两个wasm文件，而在启动服务和打包的时候并不会自动的加入这两个文件。而如果我们引入cdn上的onnxruntime-web库，我们会发现它会自动地去cdn地址请求wasm文件，cdn上这两个文件自然是存在的。参考onnxruntime给出的demo[2]，可以看到，官方在使用webpack打包的时候也是使用了CopyWebpackPlugin将对应的文件拷贝到打包之后的目录中。为了方便开发和打包，建议首先跳过pre-bundle过程，然后采用cdn加载onnxruntime-web包，并在vite.config.js中声明该包为external，即：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// vite.config.js\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { defineConfig } \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'vite'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> react \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> '@vitejs/plugin-react'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { viteExternalsPlugin } \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'vite-plugin-externals'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// https://vitejs.dev/config/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">export\u003C/span>\u003Cspan style=\"color:#F97583\"> default\u003C/span>\u003Cspan style=\"color:#B392F0\"> defineConfig\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  plugins: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    react\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    viteExternalsPlugin\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({ \u003C/span>\u003Cspan style=\"color:#6A737D\">// 声明为external\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">      'onnxruntime-web'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'ort'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  ],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  optimizeDeps: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    exclude: [ \u003C/span>\u003Cspan style=\"color:#6A737D\">// 跳过pre-bundle\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">      'onnxruntime-web'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ] \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  base: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'/mnist-demo/'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>然后在index.html中加上库的cdn地址：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"html\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"color:#85E89D\">script\u003C/span>\u003Cspan style=\"color:#B392F0\"> src\u003C/span>\u003Cspan style=\"color:#E1E4E8\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">>&#x3C;/\u003C/span>\u003Cspan style=\"color:#85E89D\">script\u003C/span>\u003Cspan style=\"color:#E1E4E8\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>接下来的过程其实就很简单了，我们成功的引入了onnxruntime-web库，然后需要用它来加载模型，并进行预测：\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 加载模型\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> session\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ort.InferenceSession.\u003C/span>\u003Cspan style=\"color:#B392F0\">create\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(model);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 输入数据，第一个参数是数据类型，第二个参数inputArray是一个一维数组，第三个参数表示的是维度，注意需要和之前模型导出时定义的维度相一致，即：dynamic x 1 x 28 x 28\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> inputs\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> new\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ort.\u003C/span>\u003Cspan style=\"color:#B392F0\">Tensor\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"float32\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, inputArray, [\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">28\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">28\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 使用run进行预测，需要注意的是，输入和输出与之前导出时定义的输入输出变量名一致\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> outputs\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> session.\u003C/span>\u003Cspan style=\"color:#B392F0\">run\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        input: inputs,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    // 预测结果\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.\u003C/span>\u003Cspan style=\"color:#B392F0\">log\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(outputs.output.data);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>到此为止，在浏览器加载模型的部分就完成了，接下来只需要想个办法获取到用户输入的数据，并使用这些数据进行预测。\u003C/p>\n\u003Ch2 id=\"获取输入数据\">获取输入数据\u003C/h2>\n\u003Cp>模型输入是1x28x28的图片，而让人在屏幕上手动的去在一个28像素x28像素的区域内绘制肯定是个不现实的事情（太小了）。因此我们需要把输入的canvas放大（这里采用的是300x300），在预测时对画布的输入进行缩小,并转化为单通道。\u003C/p>\n\u003Cp>为了获取到这个300x300区域内的像素数据，我们使用canvas.getImageData()获取到这个区域内的rgba数组。接下来，我们需要将它缩放为28x28的大小。这里引入了pica库，使用pica的resizeBuffer函数对像素区域进行缩放。\u003C/p>\n\u003Cp>由于canvas的默认颜色是黑色透明，因此我们拿到的数组的非画笔区域的rgba值为(0,0,0,0)。同时注意到模型的输入中，灰度的取值范围为-1-1，因此为了保留单通道，我们保留a，并将其根据是否为0，简单地映射到-1和1就够了。\u003C/p>\n\u003Cp>还需要注意的是，由于画布会从300x300缩放到28x28，因此canvas画笔的粗细也是一个影响效果的因素：如果画笔过细，缩放之后画布区域的像素值都是0，也就没有效果了；如果画笔过粗，可能缩放之后，原本隔着很远的两个区域变成了邻居，也会影响效果。\u003C/p>\n\u003Cp>最后，我们只需要根据上述操作，根据缩放、处理过后的数组构建输入的Tensor，并传入模型进行预测就可以了。\u003C/p>\n\u003Ch2 id=\"总结\">总结\u003C/h2>\n\u003Cp>到这里，其实模型的加载、预测和如何获取输入数据都已经完成了。最后就是把以上的东西串起来。实际的效果就是最上边两张图的样式，我把它放在了gitee page上，实测网络请求的速度还可以接受：\n\u003Cimg src=\"https://ss.im5i.com/2021/09/25/lJEUs.png\" alt=\"加载速度\">\n同时我也把它部署在我的服务器中，模型丢到cdn上，速度也还可以接受（gzip对模型好像压不了多少呀。。）：\n\u003Cimg src=\"https://ss.im5i.com/2021/09/25/lJUiQ.png\" alt=\"加载速度\">\u003C/p>\n\u003Cp>也就是说，对于一些简单的模型，我们完全可以丢到gitee page上进行使用，还是蛮好玩的。\u003C/p>\n\u003Cp>最后丢个页面地址和仓库地址，有人需要的话我再去补readme，球球点个关注和star吧：\u003C/p>\n\u003Ch3 id=\"页面地址\">页面地址：\u003C/h3>\n\u003Cp>\u003Ca href=\"http://maotoumao.gitee.io/mnist-demo/\">Gitee Page版本\u003C/a>\u003C/p>\n\u003Cp>\u003Ca href=\"http://example.upup.fun/mnist\">部署到nginx的版本\u003C/a>\u003C/p>\n\u003Ch3 id=\"仓库地址\">仓库地址：\u003C/h3>\n\u003Cp>\u003Ca href=\"https://github.com/maotoumao/mnist-demo/\">Github仓库\u003C/a>\u003C/p>\n\u003Cp>\u003Ca href=\"https://gitee.com/maotoumao/mnist-demo\">Gitee仓库\u003C/a>\u003C/p>\n\u003Cp>\u003Ca href=\"http://blog.upup.fun\">个人博客\u003C/a>\u003C/p>\n\u003Cp>\u003Ca href=\"http://blog.upup.fun/2021/09/25/%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%8A%A0%E8%BD%BDCNN%E8%BF%9B%E8%A1%8C%E6%89%8B%E5%86%99%E6%95%B0%E5%AD%97%E8%AF%86%E5%88%AB/\">原文地址\u003C/a>\u003C/p>\n\u003Chr>\n\u003Ch3 id=\"参考文献\">参考文献\u003C/h3>\n\u003Cp>[1] onnxruntime web: \u003Ca href=\"https://www.npmjs.com/package/onnxruntime-web#Operators\">https://www.npmjs.com/package/onnxruntime-web#Operators\u003C/a>\u003C/p>\n\u003Cp>[2] onnxruntime-web使用demo \u003Ca href=\"https://github.com/microsoft/onnxruntime-inference-examples/tree/main/js/quick-start_onnxruntime-web-bundler\">https://github.com/microsoft/onnxruntime-inference-examples/tree/main/js/quick-start_onnxruntime-web-bundler\u003C/a>\u003C/p>",{"headings":1255,"localImagePaths":1275,"remoteImagePaths":1276,"frontmatter":1277,"imagePaths":1279},[1256,1257,1259,1261,1263,1265,1267,1268,1271,1274],{"depth":283,"slug":27,"text":27},{"depth":283,"slug":1258,"text":1258},"模型",{"depth":283,"slug":1260,"text":1260},"前端实现",{"depth":26,"slug":1262,"text":1262},"初始化工程",{"depth":26,"slug":1264,"text":1264},"模型的加载和预测",{"depth":26,"slug":1266,"text":1266},"获取输入数据",{"depth":26,"slug":262,"text":262},{"depth":81,"slug":1269,"text":1270},"页面地址","页面地址：",{"depth":81,"slug":1272,"text":1273},"仓库地址","仓库地址：",{"depth":81,"slug":419,"text":419},[],[],{"title":1246,"pubDate":1278,"category":16,"excerpt":1248},["Date","2021-09-25T01:34:42.000Z"],[]]