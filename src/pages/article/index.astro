---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Search from 'lucide-astro/Search';
import { getCollection } from 'astro:content';
import { normalizeCategories } from '../../utils/content';
import { SITE_TITLE } from '../../utils/site';

const articleLogPrefix = '[article-index]';
const articleStart = Date.now();

console.time(`${articleLogPrefix} getCollection(posts)`);
const posts = (await getCollection('posts')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
console.timeEnd(`${articleLogPrefix} getCollection(posts)`);

console.time(`${articleLogPrefix} map posts -> articles`);
const articles = posts.map((post) => ({
  id: post.id,
  title: post.data.title,
  date: post.data.pubDate.toISOString(),
  categories: normalizeCategories(post.data.category),
  excerpt: post.data.excerpt,
}));
console.timeEnd(`${articleLogPrefix} map posts -> articles`);

console.time(`${articleLogPrefix} build categories`);
const categories = ['全部', ...new Set(articles.flatMap((article) => article.categories))];
console.timeEnd(`${articleLogPrefix} build categories`);

console.log(`${articleLogPrefix} total SSR prep`, `${Date.now() - articleStart}ms`);
---
<BaseLayout title={`文章 · ${SITE_TITLE}`}>
  <div class="py-20 max-w-2xl mx-auto">
    <div class="animate-slide-up">
      <h1 class="font-serif text-4xl mb-8 text-center text-warm-text dark:text-night-text">文章</h1>

      <div class="mb-12 space-y-6">
        <div class="relative">
          <Search size={18} strokeWidth={1.6} class="absolute left-3 top-1/2 -translate-y-1/2 text-warm-text/40 dark:text-night-text/40" />
          <input
            id="archive-search"
            type="text"
            placeholder="搜索标题..."
            class="w-full pl-10 pr-4 py-3 bg-white/80 dark:bg-night-surface/80 border border-warm-text/10 dark:border-night-text/10 rounded-md focus:outline-none focus:border-warm-accent/60 dark:focus:border-warm-accent/60 focus:ring-2 focus:ring-warm-accent/20 dark:focus:ring-warm-accent/20 shadow-sm hover:shadow-md transition-all font-sans text-warm-text dark:text-night-text placeholder:text-warm-text/40 dark:placeholder:text-night-text/40"
          />
        </div>

        <div id="archive-filters" class="flex flex-wrap gap-2 justify-center">
          {categories.map((cat) => (
            <button
              type="button"
              data-category={cat}
              class={`px-4 py-1 text-sm rounded-full transition-all duration-300 border ${cat === '全部'
                ? 'bg-warm-text text-warm-bg dark:bg-night-text dark:text-night-bg border-transparent'
                : 'bg-transparent text-warm-text/60 dark:text-night-text/60 border-warm-text/10 dark:border-night-text/10 hover:border-warm-text/30'}`}
            >
              {cat}
            </button>
          ))}
        </div>
      </div>

      <div id="archive-list" class="space-y-12 min-h-[400px]"></div>
      <div id="archive-pagination"></div>
    </div>
  </div>

  <script is:inline define:vars={{ articles }}>
    const ALL_ARTICLES = articles;
    const ITEMS_PER_PAGE = 5;

    const searchInput = document.getElementById('archive-search');
    const filters = document.getElementById('archive-filters');
    const list = document.getElementById('archive-list');
    const pagination = document.getElementById('archive-pagination');

    let currentPage = 1;
    let selectedCategory = '全部';

    const formatDate = (iso) => new Date(iso).toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });

    const getFiltered = () => {
      const term = searchInput.value.trim().toLowerCase();
      return ALL_ARTICLES.filter((article) => {
        const matchesSearch = article.title.toLowerCase().includes(term);
        const matchesCategory = selectedCategory === '全部' || article.categories.includes(selectedCategory);
        return matchesSearch && matchesCategory;
      });
    };

    const getMaxPageButtons = () => {
      const width = window.innerWidth;
      if (width < 480) return 5;
      if (width < 768) return 7;
      if (width < 1024) return 9;
      return 10;
    };

    const render = () => {
      const filtered = getFiltered();
      const totalPages = Math.max(1, Math.ceil(filtered.length / ITEMS_PER_PAGE));
      currentPage = Math.min(currentPage, totalPages);

      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const pageItems = filtered.slice(start, start + ITEMS_PER_PAGE);

      const grouped = pageItems.reduce((acc, article) => {
        const year = new Date(article.date).getFullYear();
        acc[year] = acc[year] || [];
        acc[year].push(article);
        return acc;
      }, {});

      const years = Object.keys(grouped).sort((a, b) => b - a);

      if (years.length === 0) {
        list.innerHTML = '<div class="text-center text-warm-text/40 italic py-12">没有找到相关文章...</div>';
      } else {
        list.innerHTML = years
          .map((year) => {
            const items = grouped[year]
              .map((article) => `
                <div class="group flex items-baseline justify-between border-b border-warm-text/5 dark:border-night-text/5 pb-2 hover:border-warm-accent/30 transition-colors">
                  <a href="/article/${article.id}" class="font-serif text-lg text-warm-text dark:text-night-text group-hover:text-warm-accent transition-colors">
                    ${article.title}
                  </a>
                  <span class="font-mono text-xs text-warm-text/40 dark:text-night-text/40 whitespace-nowrap ml-4">
                    ${formatDate(article.date)}
                  </span>
                </div>
              `)
              .join('');

            return `
              <div>
                <h2 class="font-serif text-2xl text-warm-text/20 dark:text-night-text/20 mb-6">${year}</h2>
                <div class="space-y-6">${items}</div>
              </div>
            `;
          })
          .join('');
      }

      pagination.innerHTML = '';
      if (totalPages <= 1) return;

      const maxButtons = Math.min(getMaxPageButtons(), totalPages);
      const half = Math.floor(maxButtons / 2);
      let startPage = Math.max(1, currentPage - half);
      let endPage = startPage + maxButtons - 1;
      if (endPage > totalPages) {
        endPage = totalPages;
        startPage = Math.max(1, endPage - maxButtons + 1);
      }
      const pages = Array.from({ length: endPage - startPage + 1 }, (_, i) => startPage + i);
      const prevDisabled = currentPage === 1;
      const nextDisabled = currentPage === totalPages;

      pagination.innerHTML = `
        <div class="flex justify-center items-center gap-4 mt-20 pt-12 border-t border-warm-text/10 dark:border-night-text/10 font-serif">
          <button
            type="button"
            ${prevDisabled ? 'disabled' : ''}
            class="p-2 text-warm-text/60 ${prevDisabled ? 'text-warm-text/20 cursor-not-allowed' : 'hover:text-warm-accent'} transition-colors"
            data-page="prev"
            aria-label="Previous Page"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
              <path d="M15 18l-6-6 6-6"></path>
            </svg>
          </button>
          <div class="flex gap-2">
            ${pages.map((page) => `
              <button
                type="button"
                data-page="${page}"
                class="w-8 h-8 flex items-center justify-center rounded-full transition-all duration-300 ${page === currentPage
                  ? 'bg-warm-text text-warm-bg dark:bg-night-text dark:text-night-bg'
                  : 'text-warm-text/60 hover:bg-warm-text/5 dark:text-night-text/60 dark:hover:bg-night-text/10'}"
              >
                ${page}
              </button>
            `).join('')}
          </div>
          <button
            type="button"
            ${nextDisabled ? 'disabled' : ''}
            class="p-2 text-warm-text/60 ${nextDisabled ? 'text-warm-text/20 cursor-not-allowed' : 'hover:text-warm-accent'} transition-colors"
            data-page="next"
            aria-label="Next Page"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
              <path d="M9 18l6-6-6-6"></path>
            </svg>
          </button>
        </div>
      `;
    };

    const setCategory = (category) => {
      selectedCategory = category;
      currentPage = 1;
      filters.querySelectorAll('button').forEach((button) => {
        const isActive = button.dataset.category === category;
        button.classList.toggle('bg-warm-text', isActive);
        button.classList.toggle('text-warm-bg', isActive);
        button.classList.toggle('dark:bg-night-text', isActive);
        button.classList.toggle('dark:text-night-bg', isActive);
        button.classList.toggle('border-transparent', isActive);
        button.classList.toggle('bg-transparent', !isActive);
        button.classList.toggle('text-warm-text/60', !isActive);
        button.classList.toggle('dark:text-night-text/60', !isActive);
      });
      render();
    };

    filters.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-category]');
      if (!button) return;
      setCategory(button.dataset.category);
    });

    searchInput.addEventListener('input', () => {
      currentPage = 1;
      render();
    });

    pagination.addEventListener('click', (event) => {
      const button = event.target.closest('[data-page]');
      if (!button) return;
      const value = button.dataset.page;
      if (value === 'prev') {
        currentPage = Math.max(1, currentPage - 1);
      } else if (value === 'next') {
        currentPage = currentPage + 1;
      } else {
        currentPage = Number.parseInt(value, 10);
      }
      render();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    window.addEventListener('resize', () => {
      render();
    });

    render();
  </script>
</BaseLayout>
